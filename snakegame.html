<!doctype html><html lang=zh-cn><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>炫酷贪吃蛇</title><link rel=stylesheet href=styles.css><link rel=stylesheet href=styles3.css><link rel=stylesheet href=styles4.css><link rel=stylesheet href=styles5.css><link rel=stylesheet href=styles6.css><script src=script3.js></script><script src=script4.js></script><script src=script5.js></script><script src=script6.js></script><script src=script7.js></script><script src=script8.js></script><script src=script9.js></script><script src=script10.js></script><script src=script11.js></script><script src=script13.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js></script><link href=message.min.css rel=stylesheet><script src=message.min.js></script><button id=back class=custom-button style=position:fixed;top:10px;left:10px;z-index:10 onclick=goBackOrHome()>返回</button><style>body{margin:0;padding:0;display:flex;justify-content:center;align-items:center;height:100vh;background:linear-gradient(135deg,#1a2a6c,#b21f1f,#fdbb2d);font-family:arial,sans-serif;overflow:hidden;touch-action:none}.game-container{position:relative;width:100vw;height:100vh;overflow:hidden;background-color:#000000b2;transform:scale(0.8);opacity:0;animation:containerEnter 1s forwards .5s}@keyframes containerEnter{0%{transform:scale(0.8);opacity:0}70%{transform:scale(1.05);opacity:1}100%{transform:scale(1);opacity:1}}#game-board{width:100%;height:100%;position:relative}.snake-segment{position:absolute;width:20px;height:20px;background:linear-gradient(45deg,#4CAF50,#8BC34A);border-radius:50%;box-shadow:0 0 10px #4caf50;transition:all .1s ease-out;z-index:2}.snake-head{background:linear-gradient(45deg,#FF5722,#FF9800);box-shadow:0 0 15px #ff5722;transform:scale(1.2);z-index:3}.food{position:absolute;width:20px;height:20px;background:linear-gradient(45deg,#4CAF50,#8BC34A);border-radius:50%;box-shadow:0 0 10px #4caf50;animation:pulse 1s infinite alternate;z-index:1}.special-food{position:absolute;width:24px;height:24px;border-radius:50%;z-index:2;box-shadow:0 0 15px #fff}@keyframes rainbowPulse{0%{background:linear-gradient(45deg,#FF0000,#FF7F00);box-shadow:0 0 15px red}14%{background:linear-gradient(45deg,#FF7F00,#FFFF00);box-shadow:0 0 15px #ff7f00}28%{background:linear-gradient(45deg,#FFFF00,#00FF00);box-shadow:0 0 15px #ff0}42%{background:linear-gradient(45deg,#00FF00,#0000FF);box-shadow:0 0 15px #0f0}57%{background:linear-gradient(45deg,#0000FF,#4B0082);box-shadow:0 0 15px #00f}71%{background:linear-gradient(45deg,#4B0082,#9400D3);box-shadow:0 0 15px indigo}85%{background:linear-gradient(45deg,#9400D3,#FF0000);box-shadow:0 0 15px #9400d3}100%{background:linear-gradient(45deg,#FF0000,#FF7F00);box-shadow:0 0 15px red}}@keyframes rotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}@keyframes pulse{from{transform:scale(1)}to{transform:scale(1.2)}}@keyframes pulse{from{transform:scale(1)}to{transform:scale(1.3)}}.score-board{position:absolute;top:20px;left:20px;color:#fff;font-size:18px;text-shadow:0 0 5px #00000080;z-index:4;transform:translateY(-50px);opacity:0;animation:scoreEnter .5s forwards 1.5s}@keyframes scoreEnter{to{transform:translateY(0);opacity:1}}.game-over{position:absolute;top:0;left:0;width:100%;height:100%;background-color:#000c;display:flex;flex-direction:column;justify-content:center;align-items:center;color:#fff;font-size:36px;z-index:5;opacity:0;pointer-events:none;transition:opacity .5s}.game-over.show{opacity:1;pointer-events:all}.restart-btn{margin-top:20px;padding:10px 30px;background:linear-gradient(45deg,#2196F3,#00BCD4);border:none;border-radius:50px;color:#fff;font-size:18px;cursor:pointer;box-shadow:0 0 15px #2196f380;transition:all .3s;transform:scale(0);animation:buttonPop .5s forwards .3s}.start-btn{display:block!important;opacity:1!important;visibility:visible!important;transform:scale(1)!important}@keyframes buttonPop{0%{transform:scale(0)}70%{transform:scale(1.1)}100%{transform:scale(1)}}.restart-btn:hover{transform:scale(1.1);box-shadow:0 0 25px #2196f3cc}.start-screen{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,rgba(26,42,108,0.9),rgba(178,31,31,0.9),rgba(253,187,45,0.9));display:flex;flex-direction:column;justify-content:center;align-items:center;color:#fff;z-index:10;transition:all .5s}.start-screen.hide{opacity:0;pointer-events:none}.game-title{font-size:48px;margin-bottom:30px;text-shadow:0 0 10px #00000080;animation:titleBounce 2s infinite;transform:translateY(-50px);opacity:0;animation:titleEnter 1s forwards .2s,titleBounce 2s infinite 1.2s}@keyframes titleEnter{to{transform:translateY(0);opacity:1}}@keyframes titleBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}.start-btn{padding:15px 40px;background:linear-gradient(45deg,#FF5722,#FF9800);border:none;border-radius:50px;color:#fff;font-size:24px;cursor:pointer;box-shadow:0 0 20px #ff572280;transition:all .3s;transform:scale(0);opacity:0;animation:buttonPop .5s forwards .8s}.start-btn:hover{transform:scale(1.1);box-shadow:0 0 30px #ff5722cc}.instructions{margin-top:30px;font-size:16px;text-align:center;opacity:.8;transform:translateY(50px);opacity:0;animation:instructionsEnter .8s forwards 1s}@keyframes instructionsEnter{to{transform:translateY(0);opacity:.8}}.particles{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0}.particle{position:absolute;width:5px;height:5px;background-color:#ffffff80;border-radius:50%;animation:float 10s infinite linear}@keyframes float{0%{transform:translateY(0) translateX(0);opacity:0}10%{opacity:1}90%{opacity:1}100%{transform:translateY(-500px) translateX(100px);opacity:0}}.snake-enter{animation:snakeEnter .8s forwards}@keyframes snakeEnter{0%{transform:scale(0) rotate(0deg);opacity:0}70%{transform:scale(1.2) rotate(360deg);opacity:1}100%{transform:scale(1) rotate(360deg);opacity:1}}.food-enter{animation:foodEnter .8s forwards}@keyframes foodEnter{0%{transform:scale(0) rotate(0deg);opacity:0}70%{transform:scale(1.3) rotate(360deg);opacity:1}100%{transform:scale(1) rotate(360deg);opacity:1}}.bg-element{position:absolute;border-radius:50%;filter:blur(10px);opacity:.1;z-index:-1;animation:bgFloat 20s infinite linear}@keyframes bgFloat{0%{transform:translate(0,0) rotate(0deg)}50%{transform:translate(50px,50px) rotate(180deg)}100%{transform:translate(0,0) rotate(360deg)}}.special-food{position:absolute;width:20px;height:20px;border-radius:50%;box-shadow:0 0 15px #fff;animation:rainbowPulse 2s infinite alternate,rotate 5s infinite linear;z-index:1}@keyframes rainbowPulse{0%{background:linear-gradient(45deg,#FF0000,#FF7F00);box-shadow:0 0 15px red}14%{background:linear-gradient(45deg,#FF7F00,#FFFF00);box-shadow:0 0 15px #ff7f00}28%{background:linear-gradient(45deg,#FFFF00,#00FF00);box-shadow:0 0 15px #ff0}42%{background:linear-gradient(45deg,#00FF00,#0000FF);box-shadow:0 0 15px #0f0}57%{background:linear-gradient(45deg,#0000FF,#4B0082);box-shadow:0 0 15px #00f}71%{background:linear-gradient(45deg,#4B0082,#9400D3);box-shadow:0 0 15px indigo}85%{background:linear-gradient(45deg,#9400D3,#FF0000);box-shadow:0 0 15px #9400d3}100%{background:linear-gradient(45deg,#FF0000,#FF7F00);box-shadow:0 0 15px red}}@keyframes rotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}.fps-counter{position:absolute;bottom:20px;right:20px;color:#fff;font-size:18px;text-shadow:0 0 5px #00000080;z-index:4;background-color:#00000080;padding:5px 10px;border-radius:5px;font-family:monospace;display:flex;align-items:center}.fps-counter::before{content:"";display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px;background-color:#4caf50}.fps-counter.low{color:#ff5722}.fps-counter.low::before{background-color:#ff5722}</style><div class=game-container><div class=start-screen><h1 class=game-title>🐍 贪吃蛇 🐍</h1><button class=start-btn>开始游戏</button><div class=instructions><p>使用方向键或WASD控制蛇的移动<p>吃到彩色色食物可以增加分数<p>不要撞到墙壁或自己的身体!</div></div><div class=particles id=particles></div><div id=game-board></div><div class=fps-counter id=fps-counter><span id=fps>--</span> FPS</div><div class=score-board><div>当前分数: <span id=current-score>0</span></div><div>最高分数: <span id=high-score>0</span></div><a onclick=goBackOrHome()>返回</a></div><div class=game-over><h2>游戏结束!</h2><div>你的分数: <span id=final-score>0</span></div><button class=restart-btn>再来一局</button></div></div><script>let snake=[];let food={};let specialFood=null;let direction='right';let nextDirection='right';let gameInterval;let gameSpeed=150;let score=0;let highScore=localStorage.getItem('snakeHighScore')||0;let gameStarted=false;let specialFoodTimer;let specialFoodActive=false;let lastTime=0;const gameBoard=document.getElementById('game-board');const startBtn=document.querySelector('.start-btn');const restartBtn=document.querySelector('.restart-btn');const currentScoreEl=document.getElementById('current-score');const highScoreEl=document.getElementById('high-score');const finalScoreEl=document.getElementById('final-score');const gameOverScreen=document.querySelector('.game-over');const startScreen=document.querySelector('.start-screen');const particlesContainer=document.getElementById('particles');const backButton=document.getElementById("back");const fpsElement=document.getElementById('fps');const fpsCounter=document.getElementById('fps-counter');let lastFpsUpdate=performance.now();let frameCount=0;let fps=0;let lastFrameTime=performance.now();const fpsHistory=[];const HISTORY_SIZE=10;function updateFPS(){const now=performance.now();frameCount++;const frameTime=now-lastFrameTime;lastFrameTime=now;if(now>=lastFpsUpdate){fpsHistory.push(frameCount*1000/(now-lastFpsUpdate));if(fpsHistory.length>HISTORY_SIZE){fpsHistory.shift();}
const smoothedFPS=Math.round(fpsHistory.reduce((a,b)=>a+b,0)/fpsHistory.length);fpsElement.textContent=Math.round(smoothedFPS);if(smoothedFPS<30){fpsCounter.classList.add('low');}else{fpsCounter.classList.remove('low');}
frameCount=0;lastFpsUpdate=now;}
requestAnimationFrame(updateFPS);}
document.addEventListener('DOMContentLoaded',function(){highScore=localStorage.getItem('snakeHighScore')||0;highScoreEl.textContent=highScore;checkAndPromptUpload();});function checkAndPromptUpload(){const localHighScore=parseInt(localStorage.getItem('snakeHighScore'))||0;fetch('https://jbcfz.serveo.net/get-all-custom-data').then(response=>response.json()).then(data=>{if(data.success){const username=localStorage.getItem('username');let serverHighScore=0;if(username){const currentUser=data.data.find(user=>user.username===username);if(currentUser&&currentUser.customData&&currentUser.customData.startsWith('gamesnack_maxscore:')){serverHighScore=parseInt(currentUser.customData.split(':')[1])||0;}}
if(localHighScore>serverHighScore){setTimeout(()=>{swal({title:"发现更高分数",text:`你的本地最高分(${localHighScore})高于服务器记录(${serverHighScore})，要上传吗?`,type:"info",showCancelButton:true,confirmButtonText:"上传",cancelButtonText:"不上传",closeOnConfirm:false,showLoaderOnConfirm:true},function(){uploadScore(localHighScore);});},0);}}}).catch(error=>{console.log('检查服务器分数失败:',error);});}
const leaderboardHTML=`
<div id="leaderboard-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>贪吃蛇排行榜</h2>
        <div id="leaderboard-status"></div>
        <div id="leaderboard-list"></div>
    </div>
</div>
<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 20;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
    }
    
    .modal-content {
        background: linear-gradient(135deg, #1a2a6c, #b21f1f);
        margin: 5% auto;
        padding: 20px;
        border-radius: 10px;
        width: 80%;
        max-width: 500px;
        color: white;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        position: relative;
    }
    
    .close {
        color: white;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover {
        color: #ccc;
    }
    
    #leaderboard-list {
        margin-top: 20px;
    }
    
    .leaderboard-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        margin-bottom: 5px;
        background-color: rgba(255,255,255,0.1);
        border-radius: 5px;
    }
    
    .leaderboard-item.me {
        background-color: rgba(255,215,0,0.3);
        font-weight: bold;
    }
    
    .leaderboard-rank {
        width: 30px;
        text-align: center;
    }
    
    .leaderboard-name {
        flex-grow: 1;
        margin: 0 10px;
    }
    
    .leaderboard-score {
        width: 80px;
        text-align: right;
    }
    
    #show-leaderboard {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        z-index: 4;
    }
        .loading-status {
    text-align: center;
    padding: 20px;
    color: rgba(255,255,255,0.7);
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

</style>
<button id="show-leaderboard">排行榜</button>
`;document.body.insertAdjacentHTML('beforeend',leaderboardHTML);document.getElementById('show-leaderboard').addEventListener('click',function(){updateLeaderboard();document.getElementById('leaderboard-modal').style.display='block';});document.querySelector('.close').addEventListener('click',function(){document.getElementById('leaderboard-modal').style.display='none';});function updateLeaderboard(){fetch('https://jbcfz.serveo.net/get-all-custom-data').then(response=>response.json()).then(data=>{if(data.success){const leaderboardList=document.getElementById('leaderboard-list');leaderboardList.innerHTML='';const scores=data.data.map(user=>{let score=0;if(user.customData&&user.customData.startsWith('gamesnack_maxscore:')){score=parseInt(user.customData.split(':')[1])||0;}
return{username:user.username,score:score,avatar:user.avatarUrl,isMe:user.id===localStorage.getItem('userId')};});scores.sort((a,b)=>b.score-a.score);const topScores=scores.slice(0,20);const localHighScore=localStorage.getItem('snakeHighScore')||0;const userId=localStorage.getItem('userId');if(localHighScore>0&&!topScores.some(item=>item.isMe)){topScores.push({username:'我 (本地记录)',score:parseInt(localHighScore),avatar:'',isMe:true});}
topScores.forEach((item,index)=>{const itemElement=document.createElement('div');itemElement.className=`leaderboard-item ${item.isMe?'me':''}`;itemElement.innerHTML=`
                    <div class="leaderboard-rank">${index+1}</div>
                    <div class="leaderboard-name">${item.username}</div>
                    <div class="leaderboard-score">${item.score}分</div>
                `;leaderboardList.appendChild(itemElement);});if(topScores.length===0){leaderboardList.innerHTML='<div style="text-align:center;padding:20px;">暂无排行榜数据</div>';}}else{console.error('获取排行榜数据失败:',data.message);}}).catch(error=>{console.error('获取排行榜数据出错:',error);});}
function clearBoard(){while(gameBoard.firstChild){gameBoard.removeChild(gameBoard.firstChild);}}
function generateFood(){const boardWidth=gameBoard.clientWidth;const boardHeight=gameBoard.clientHeight;const maxX=Math.floor((boardWidth-20)/20);const maxY=Math.floor((boardHeight-20)/20);let validPosition=false;let foodX,foodY;while(!validPosition){foodX=Math.floor(Math.random()*maxX)*20;foodY=Math.floor(Math.random()*maxY)*20;validPosition=true;for(const segment of snake){if(segment.x===foodX&&segment.y===foodY){validPosition=false;break;}}}
food={x:foodX,y:foodY,type:'normal'};}function drawSnake(withAnimation=false){snake.forEach((segment,index)=>{const segmentElement=document.createElement('div');segmentElement.className='snake-segment';if(index===0)segmentElement.classList.add('snake-head');if(withAnimation){segmentElement.classList.add('snake-enter');segmentElement.style.animationDelay=`${index*0.1}s`;}
segmentElement.style.left=`${segment.x}px`;segmentElement.style.top=`${segment.y}px`;if(index>0){const hue=(120+index*5)%360;segmentElement.style.background=`linear-gradient(45deg, hsl(${hue}, 70%, 50%), hsl(${hue}, 90%, 60%))`;}
gameBoard.appendChild(segmentElement);});}
function drawFood(withAnimation=false){const foodElement=document.createElement('div');foodElement.className='food';if(withAnimation){foodElement.classList.add('food-enter');}
foodElement.style.left=`${food.x}px`;foodElement.style.top=`${food.y}px`;foodElement.style.background='linear-gradient(45deg, #4CAF50, #8BC34A)';foodElement.style.boxShadow='0 0 10px #4CAF50';gameBoard.appendChild(foodElement);}
function initGame(){requestAnimationFrame(updateFPS);backButton.style.display="none";document.getElementById('show-leaderboard').style.display='block';updateLeaderboard();clearBoard();snake=[{x:100,y:100},{x:80,y:100},{x:60,y:100}];direction='right';nextDirection='right';score=0;currentScoreEl.textContent=score;highScoreEl.textContent=highScore;generateFood();if(specialFoodTimer)clearTimeout(specialFoodTimer);if(specialFoodActive){clearTimeout(specialFoodTimer);specialFoodActive=false;}
startSpecialFoodTimer();drawSnake(true);drawFood(true);gameOverScreen.classList.remove('show');if(gameInterval)clearInterval(gameInterval);gameInterval=setInterval(gameLoop,gameSpeed);gameStarted=true;createBackgroundElements();requestFullscreen();}
function requestFullscreen(){const elem=document.documentElement;if(elem.requestFullscreen){elem.requestFullscreen();}else if(elem.webkitRequestFullscreen){elem.webkitRequestFullscreen();}else if(elem.msRequestFullscreen){elem.msRequestFullscreen();}}
function startSpecialFoodTimer(){specialFoodTimer=setTimeout(()=>{generateSpecialFood();},15000+Math.random()*15000);}
function generateSpecialFood(){const boardWidth=gameBoard.clientWidth;const boardHeight=gameBoard.clientHeight;const maxX=Math.floor((boardWidth-20)/20);const maxY=Math.floor((boardHeight-20)/20);let validPosition=false;let foodX,foodY;while(!validPosition){foodX=Math.floor(Math.random()*maxX)*20;foodY=Math.floor(Math.random()*maxY)*20;validPosition=true;for(const segment of snake){if(segment.x===foodX&&segment.y===foodY){validPosition=false;break;}}
if(validPosition&&food.x===foodX&&food.y===foodY){validPosition=false;}}
specialFood={x:foodX,y:foodY,type:'special'};specialFoodActive=true;drawSpecialFood();setTimeout(()=>{if(specialFoodActive){specialFoodActive=false;specialFood=null;clearBoard();drawSnake();drawFood();startSpecialFoodTimer();}},10000);}
function drawSpecialFood(){if(!specialFoodActive)return;const foodElement=document.createElement('div');foodElement.className='special-food';foodElement.style.left=`${specialFood.x}px`;foodElement.style.top=`${specialFood.y}px`;foodElement.style.animation='rainbowPulse 2s infinite, rotate 5s infinite';gameBoard.appendChild(foodElement);}
function gameLoop(){frameCount++;const now=performance.now();if(now>=lastTime+1000){fps=Math.round((frameCount*1000)/(now-lastTime));fpsElement.textContent=fps;frameCount=0;lastTime=now;}
direction=nextDirection;const head={...snake[0]};switch(direction){case 'up':head.y-=20;break;case 'down':head.y+=20;break;case 'left':head.x-=20;break;case 'right':head.x+=20;break;}
const boardWidth=gameBoard.clientWidth;const boardHeight=gameBoard.clientHeight;if(head.x<0)head.x=boardWidth-20;if(head.x>=boardWidth)head.x=0;if(head.y<0)head.y=boardHeight-20;if(head.y>=boardHeight)head.y=0;if(checkSelfCollision(head)){gameOver();return;}
snake.unshift(head);if(Math.abs(head.x-food.x)<20&&Math.abs(head.y-food.y)<20){score+=10;currentScoreEl.textContent=score;createParticles(food.x+10,food.y+10,20,'#FF5722');currentScoreEl.style.transform='scale(1.5)';currentScoreEl.style.color='#FFD700';setTimeout(()=>{currentScoreEl.style.transform='scale(1)';currentScoreEl.style.color='white';},300);generateFood();if(gameSpeed>50&&score%50===0){gameSpeed-=5;clearInterval(gameInterval);gameInterval=setInterval(gameLoop,gameSpeed);showNotice('速度提升!','#FF5722');}}
else if(specialFoodActive&&head.x===specialFood.x&&head.y===specialFood.y){score+=100;currentScoreEl.textContent=score;createParticles(specialFood.x+10,specialFood.y+10,50,'#FFD700');currentScoreEl.style.transform='scale(1.5)';currentScoreEl.style.color='#FFD700';setTimeout(()=>{currentScoreEl.style.transform='scale(1)';currentScoreEl.style.color='white';},300);specialFoodActive=false;specialFood=null;showNotice('+100分!','#FFD700');startSpecialFoodTimer();}
else{snake.pop();}
clearBoard();drawSnake();drawFood();if(specialFoodActive)drawSpecialFood();}
function checkSelfCollision(head){for(let i=1;i<snake.length;i++){if(head.x===snake[i].x&&head.y===snake[i].y){return true;}}
return false;}
function showNotice(text,color){const notice=document.createElement('div');notice.textContent=text;notice.style.position='absolute';notice.style.left='50%';notice.style.top='50%';notice.style.transform='translate(-50%, -50%)';notice.style.color=color;notice.style.fontSize='24px';notice.style.fontWeight='bold';notice.style.textShadow='0 0 5px white';notice.style.animation='fadeOut 1s forwards';gameBoard.appendChild(notice);setTimeout(()=>{notice.remove();},1000);}
function gameOver(){backButton.style.display="block";clearInterval(gameInterval);gameStarted=false;let isNewRecord=false;if(score>highScore){highScore=score;localStorage.setItem('snakeHighScore',highScore);highScoreEl.textContent=highScore;isNewRecord=true;for(let i=0;i<50;i++){setTimeout(()=>{createParticles(Math.random()*gameBoard.clientWidth,Math.random()*gameBoard.clientHeight,10,`hsl(${Math.random()*360}, 100%, 50%)`);},i*100);}}
finalScoreEl.textContent=score;gameOverScreen.classList.add('show');const localHighScore=parseInt(localStorage.getItem('snakeHighScore'))||0;fetch('https://jbcfz.serveo.net/get-all-custom-data').then(response=>response.json()).then(data=>{if(data.success){const username=localStorage.getItem('username');let serverHighScore=0;if(username){const currentUser=data.data.find(user=>user.username===username);if(currentUser&&currentUser.customData&&currentUser.customData.startsWith('gamesnack_maxscore:')){serverHighScore=parseInt(currentUser.customData.split(':')[1])||0;}}
if(localHighScore>serverHighScore){setTimeout(()=>{swal({title:"新纪录！d",text:`你的本地最高分(${localHighScore})高于服务器记录(${serverHighScore})，要上传吗?`,type:"info",showCancelButton:true,confirmButtonText:"上传",cancelButtonText:"不上传",closeOnConfirm:false,showLoaderOnConfirm:true},function(){uploadScore(localHighScore);});},0);}}}).catch(error=>{console.log('检查服务器分数失败:',error);});}
function uploadScore(score){const userId=localStorage.getItem('userid');if(!userId){swal("上传失败","请先登录","error");return;}
const customData=`gamesnack_maxscore:${score}`;fetch('https://jbcfz.serveo.net/update-custom-data',{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify({userId:userId,customData:customData})}).then(response=>{const contentType=response.headers.get('content-type');if(!contentType||!contentType.includes('application/json')){return response.text().then(text=>{throw new Error(`服务器返回了非JSON数据: ${text.substring(0,100)}...`);});}
return response.json();}).then(data=>{if(data&&data.success){localStorage.setItem('uploadedHighScore',score);swal("上传成功","你的分数已记录到排行榜","success");updateLeaderboard();}else{throw new Error(data?.message||"未知错误");}}).catch(error=>{console.error('上传分数错误:',error);let errorMsg=error.message;if(errorMsg.includes('<!DOCTYPE')){errorMsg="服务器返回了错误页面，请检查网络连接";}else if(errorMsg.includes('Failed to fetch')){errorMsg="网络连接失败，请检查网络设置";}
swal("上传失败",errorMsg,"error");});}
function createParticles(x,y,count,color){for(let i=0;i<count;i++){const particle=document.createElement('div');particle.className='particle';particle.style.left=`${x}px`;particle.style.top=`${y}px`;particle.style.backgroundColor=color;particle.style.animationDuration=`${2+Math.random()*3}s`;particle.style.animationDelay=`${Math.random()*0.5}s`;const size=2+Math.random()*6;particle.style.width=`${size}px`;particle.style.height=`${size}px`;const angle=Math.random()*Math.PI*2;const distance=5+Math.random()*20;particle.style.setProperty('--tx',`${Math.cos(angle)*distance}px`);particle.style.setProperty('--ty',`${Math.sin(angle)*distance}px`);particlesContainer.appendChild(particle);setTimeout(()=>{particle.remove();},3000);}}
function createBackgroundElements(){const colors=['#FF5722','#2196F3','#4CAF50','#FFC107','#9C27B0'];for(let i=0;i<8;i++){const element=document.createElement('div');element.className='bg-element';const left=Math.random()*100;const top=Math.random()*100;const size=50+Math.random()*150;const color=colors[Math.floor(Math.random()*colors.length)];element.style.left=`${left}%`;element.style.top=`${top}%`;element.style.width=`${size}px`;element.style.height=`${size}px`;element.style.backgroundColor=color;element.style.animationDuration=`${15+Math.random()*30}s`;element.style.animationDelay=`${Math.random()*5}s`;document.body.appendChild(element);}}
function createBackgroundParticles(){for(let i=0;i<30;i++){const particle=document.createElement('div');particle.className='particle';particle.style.left=`${Math.random()*100}%`;particle.style.top=`${Math.random()*100}%`;particle.style.animationDuration=`${10+Math.random()*20}s`;particle.style.animationDelay=`${Math.random()*5}s`;const hue=Math.random()*360;particle.style.backgroundColor=`hsla(${hue}, 100%, 70%, 0.7)`;particlesContainer.appendChild(particle);}}
document.addEventListener('keydown',(e)=>{if(!gameStarted)return;switch(e.key){case 'ArrowUp':case 'w':case 'W':if(direction!=='down')nextDirection='up';break;case 'ArrowDown':case 's':case 'S':if(direction!=='up')nextDirection='down';break;case 'ArrowLeft':case 'a':case 'A':if(direction!=='right')nextDirection='left';break;case 'ArrowRight':case 'd':case 'D':if(direction!=='left')nextDirection='right';break;}});let touchStartX=0;let touchStartY=0;gameBoard.addEventListener('touchstart',(e)=>{touchStartX=e.touches[0].clientX;touchStartY=e.touches[0].clientY;});gameBoard.addEventListener('touchmove',(e)=>{if(!gameStarted)return;e.preventDefault();const touchEndX=e.touches[0].clientX;const touchEndY=e.touches[0].clientY;const dx=touchEndX-touchStartX;const dy=touchEndY-touchStartY;if(Math.abs(dx)>Math.abs(dy)){if(dx>0&&direction!=='left')nextDirection='right';else if(dx<0&&direction!=='right')nextDirection='left';}else{if(dy>0&&direction!=='up')nextDirection='down';else if(dy<0&&direction!=='down')nextDirection='up';}});startBtn.addEventListener('click',()=>{startBtn.style.animation='buttonClick 0.5s forwards';startScreen.style.animation='startScreenExit 0.8s forwards';setTimeout(()=>{startScreen.classList.add('hide');initGame();},800);});restartBtn.addEventListener('click',()=>{gameOverScreen.classList.remove('show');setTimeout(()=>{initGame();},300);});createBackgroundParticles();const style=document.createElement('style');style.textContent=`
            @keyframes fadeOut {
                to { opacity: 0; transform: translate(-50%, -100%); }
            }
            @keyframes snakeShake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
            @keyframes buttonClick {
                50% { transform: scale(0.9); }
                100% { transform: scale(1); }
            }
            @keyframes startScreenExit {
                to { opacity: 0; transform: scale(1.2); }
            }
        `;document.head.appendChild(style);</script>