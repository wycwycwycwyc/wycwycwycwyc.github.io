<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒäººè´ªåƒè›‡å¤§ä½œæˆ˜</title>
<script src="/config/serverUrl.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/styles_button.css">
    <script src="/js/script4_goBackOrHome.js"></script>
    <script src="/js/script13_checkIslogin.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>
    <link href="/css/message.min.css" rel="stylesheet" />
    <script src="/js/message.min.js"></script>
<button id="back" class="custom-button" style="position: fixed; top: 120px; left: 10px;z-index: 10;" onclick="goBackOrHome()">è¿”å›</button>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }
        
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            touch-action: none;
        }
        
        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0.7);
            transform: scale(0.8);
            opacity: 0;
            animation: containerEnter 1s forwards 0.5s;
        }
        
        @keyframes containerEnter {
            0% { transform: scale(0.8); opacity: 0; }
            70% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        #game-board {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .snake-segment {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            transition: all 0.1s ease-out;
            z-index: 2;
        }
        
        .snake-head {
            transform: scale(1.2);
            z-index: 3;
        }
        
    .snake-segment.snake1 {
        background: linear-gradient(45deg, #FF5722, #FF9800);
        box-shadow: 0 0 10px #FF5722;
    }
    
    .snake-segment.snake2 {
        background: linear-gradient(45deg, #2196F3, #00BCD4);
        box-shadow: 0 0 10px #2196F3;
    }
    
    .snake-segment.snake1.snake-head {
        background: linear-gradient(45deg, #FF5722, #FF9800);
        box-shadow: 0 0 15px #FF5722;
        transform: scale(1.2);
        z-index: 3;
    }
    
    .snake-segment.snake2.snake-head {
        background: linear-gradient(45deg, #2196F3, #00BCD4);
        box-shadow: 0 0 15px #2196F3;
        transform: scale(1.2);
        z-index: 3;
    }
        .food {
            position: absolute;
            width: 20px;
            height: 20px;
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            border-radius: 50%;
            box-shadow: 0 0 10px #4CAF50;
            animation: pulse 1s infinite alternate;
            z-index: 1;
        }

        .special-food {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            z-index: 2;
            box-shadow: 0 0 15px white;
            animation: rainbowPulse 2s infinite alternate, rotate 5s infinite linear;
        }

        @keyframes rainbowPulse {
            0% { background: linear-gradient(45deg, #FF0000, #FF7F00); box-shadow: 0 0 15px #FF0000; }
            14% { background: linear-gradient(45deg, #FF7F00, #FFFF00); box-shadow: 0 0 15px #FF7F00; }
            28% { background: linear-gradient(45deg, #FFFF00, #00FF00); box-shadow: 0 0 15px #FFFF00; }
            42% { background: linear-gradient(45deg, #00FF00, #0000FF); box-shadow: 0 0 15px #00FF00; }
            57% { background: linear-gradient(45deg, #0000FF, #4B0082); box-shadow: 0 0 15px #0000FF; }
            71% { background: linear-gradient(45deg, #4B0082, #9400D3); box-shadow: 0 0 15px #4B0082; }
            85% { background: linear-gradient(45deg, #9400D3, #FF0000); box-shadow: 0 0 15px #9400D3; }
            100% { background: linear-gradient(45deg, #FF0000, #FF7F00); box-shadow: 0 0 15px #FF0000; }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.3); }
        }
        
        .score-board {
            position: absolute;
            top: 20px;
            width: 100%; /* æ”¹ä¸ºå…¨å®½åº¦ */
            display: flex;
            justify-content: space-between; /* ä¸¤ç«¯å¯¹é½ */
            padding: 0 20px; /* å·¦å³å†…è¾¹è· */
            color: white;
            font-size: 18px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            z-index: 4;
            transform: translateY(-50px);
            opacity: 0;
            animation: scoreEnter 0.5s forwards 1.5s;
            box-sizing: border-box;
        }
        
        /* ç§»é™¤åŸæ¥çš„å·¦å³å®šä½ */
        .player-score {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            padding: 10px 15px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            min-width: 150px;
        }
        
        .health-bar {
            width: 100px;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .health-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        
        .player-1 .health-fill {
            background: linear-gradient(to right, #FF5722, #FF9800);
        }
        
        .player-2 .health-fill {
            background: linear-gradient(to right, #2196F3, #00BCD4);
        }
        
        @keyframes scoreEnter {
            to { transform: translateY(0); opacity: 1; }
        }
        
        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 36px;
            z-index: 5;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        
        .game-over.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .restart-btn {
            margin-top: 20px;
            padding: 15px 40px;
            background: linear-gradient(45deg, #2196F3, #00BCD4);
            border: none;
            border-radius: 50px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.5);
            transition: all 0.3s;
            transform: scale(0);
            animation: buttonPop 0.5s forwards 0.3s;
        }
        
        @keyframes buttonPop {
            0% { transform: scale(0); }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .restart-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 25px rgba(33, 150, 243, 0.8);
        }
        
        .start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(26, 42, 108, 0.9), rgba(178, 31, 31, 0.9), rgba(253, 187, 45, 0.9));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10;
            transition: all 0.5s;
        }
        
        .start-screen.hide {
            opacity: 0;
            pointer-events: none;
        }
        
        .game-title {
            font-size: 48px;
            margin-bottom: 30px;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            animation: titleBounce 2s infinite;
            transform: translateY(-50px);
            opacity: 0;
            animation: titleEnter 1s forwards 0.2s, titleBounce 2s infinite 1.2s;
        }
        
        @keyframes titleEnter {
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes titleBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        .start-btn {
            padding: 15px 40px;
            background: linear-gradient(45deg, #FF5722, #FF9800);
            border: none;
            border-radius: 50px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 87, 34, 0.5);
            transition: all 0.3s;
            transform: scale(0);
            opacity: 0;
            animation: buttonPop 0.5s forwards 0.8s;
        }
        
        .start-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(255, 87, 34, 0.8);
        }
        .start-btn {
        /* ç¡®ä¿è¿™äº›å±æ€§å­˜åœ¨ */
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
        transform: scale(1) !important;
        }
        .instructions {
            margin-top: 30px;
            font-size: 16px;
            text-align: center;
            opacity: 0.8;
            transform: translateY(50px);
            opacity: 0;
            animation: instructionsEnter 0.8s forwards 1s;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            max-width: 500px;
        }
        
        .player-instructions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            gap: 40px;
        }
        
        .player-instruction {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .player-1-instruction {
            border: 2px solid #FF5722;
        }
        
        .player-2-instruction {
            border: 2px solid #2196F3;
        }
        
        .key {
            display: inline-block;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin: 5px;
            text-align: center;
            line-height: 40px;
            font-weight: bold;
        }
        
        @keyframes instructionsEnter {
            to { transform: translateY(0); opacity: 0.8; }
        }
        
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        
        .particle {
            position: absolute;
            width: 5px;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 10s infinite linear;
        }
        
        @keyframes float {
            0% { transform: translateY(0) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-500px) translateX(100px); opacity: 0; }
        }
        
        .snake-enter {
            animation: snakeEnter 0.8s forwards;
        }
        
        @keyframes snakeEnter {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            70% { transform: scale(1.2) rotate(360deg); opacity: 1; }
            100% { transform: scale(1) rotate(360deg); opacity: 1; }
        }
        
        .food-enter {
            animation: foodEnter 0.8s forwards;
        }
        
        @keyframes foodEnter {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            70% { transform: scale(1.3) rotate(360deg); opacity: 1; }
            100% { transform: scale(1) rotate(360deg); opacity: 1; }
        }
        
        .bg-element {
            position: absolute;
            border-radius: 50%;
            filter: blur(10px);
            opacity: 0.1;
            z-index: -1;
            animation: bgFloat 20s infinite linear;
        }
        
        @keyframes bgFloat {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(50px, 50px) rotate(180deg); }
            100% { transform: translate(0, 0) rotate(360deg); }
        }
        
        .winner-banner {
            font-size: 60px;
            margin-bottom: 30px;
            text-shadow: 0 0 20px currentColor;
            animation: winnerPulse 2s infinite;
        }
        
        @keyframes winnerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .player-1-win {
            color: #FF5722;
        }
        
        .player-2-win {
            color: #2196F3;
        }
                .player-score {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            padding: 10px 15px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            min-width: 150px;
        }
        
        .score-display {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        
        .score-text {
            font-size: 16px;
            font-weight: bold;
        }
                .character-selection {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(26, 42, 108, 0.9), rgba(178, 31, 31, 0.9), rgba(253, 187, 45, 0.9));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 9;
            opacity: 0;
            pointer-events: none;
            transition: all 0.5s;
        }
        
        .character-selection.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .selection-title {
            font-size: 36px;
            margin-bottom: 30px;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .player-selections {
            display: flex;
            gap: 50px;
            margin-bottom: 40px;
        }
        
        .player-selection {
            text-align: center;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            width: 250px;
        }
        
        .player-label {
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .snake-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .snake-option {
            padding: 12px 20px;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .snake-option:hover {
            transform: scale(1.05);
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .snake-option.selected {
            border-color: white;
            box-shadow: 0 0 15px white;
        }
        
        .speed-snake {
            border-color: #FFD700;
        }
        
        .tough-snake {
            border-color: #C0C0C0;
        }
        
        .snake-type {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .snake-desc {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .start-game-btn {
            padding: 15px 40px;
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            border: none;
            border-radius: 50px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
            transition: all 0.3s;
        }
        
        .start-game-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.8);
        }
        
        .start-game-btn:disabled {
            background: linear-gradient(45deg, #9E9E9E, #757575);
            cursor: not-allowed;
            transform: scale(1);
            box-shadow: 0 0 20px rgba(158, 158, 158, 0.5);
        }
        
        /* ç‰¹æ®Šç‰©å“æ ·å¼ */
        .immunity-ball {
            background: linear-gradient(45deg, #FFFF00, #FFD700) !important;
            box-shadow: 0 0 15px #FFFF00 !important;
            animation: pulse 1s infinite alternate !important;
        }
        
        .health-ball {
            background: linear-gradient(45deg, #FF0000, #e31010) !important;
            box-shadow: 0 0 15px #FF0000 !important;
            animation: pulse 1s infinite alternate !important;
        }
        
        .reverse-ball {
            background: linear-gradient(45deg, #001e80, #7079da) !important;
            box-shadow: 0 0 15px #002280 !important;
            animation: pulse 1s infinite alternate !important;
        }
        
        .status-effect {
            position: absolute;
            top: 10px;
            right: 20px;
            color: white;
            font-size: 14px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 10;
        }
        
        .player-1-effect {
            top: 50px;
        }
        
        .player-2-effect {
            top: 80px;
        }
                .ball-storage {
            position: absolute;
            bottom: 20px;
            display: flex;
            gap: 10px;
            z-index: 4;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
        }
        
        .player-1-storage {
            left: 20px;
        }
        
        .player-2-storage {
            right: 20px;
        }
        
        .storage-title {
            color: white;
            font-size: 14px;
            margin-right: 10px;
            display: flex;
            align-items: center;
        }
        
        .ball-slot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            position: relative;
            border: 2px solid transparent;
        }
        
        .ball-slot.filled {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            box-shadow: 0 0 10px #4CAF50;
        }
        
        .ball-slot.key-hint {
            position: absolute;
            bottom: -20px;
            font-size: 12px;
            color: white;
            width: 100%;
            text-align: center;
            left: 0;
        }
        
        /* çŠ¶æ€æ•ˆæœæ˜¾ç¤º */
        .status-effect {
            position: absolute;
            top: 10px;
            right: 20px;
            color: white;
            font-size: 14px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 10;
        }
        
        .player-1-effect {
            top: 50px;
            left: 20px;
            right: auto;
        }
        
        .player-2-effect {
            top: 80px;
            right: 20px;
        }
        
        /* é‡Šæ”¾æ•ˆæœåŠ¨ç”» */
        @keyframes releaseEffect {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }
        
        .release-effect {
            position: absolute;
            border-radius: 50%;
            animation: releaseEffect 0.5s forwards;
            z-index: 3;
        }
                .ball-storage {
            position: absolute;
            bottom: 20px;
            display: flex;
            gap: 10px;
            z-index: 4;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
        }
        
        .player-1-storage {
            left: 20px;
        }
        
        .player-2-storage {
            right: 20px;
        }
        
        .storage-title {
            color: white;
            font-size: 14px;
            margin-right: 10px;
            display: flex;
            align-items: center;
        }
        
        .ball-slot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            position: relative;
            border: 2px solid transparent;
        }
        
        .ball-slot.filled {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            box-shadow: 0 0 10px #4CAF50;
        }
        
        .ball-slot.key-hint {
            position: absolute;
            bottom: -20px;
            font-size: 12px;
            color: white;
            width: 100%;
            text-align: center;
            left: 0;
        }
        
        /* çŠ¶æ€æ•ˆæœæ˜¾ç¤º */
        .status-effect {
            position: absolute;
            top: 10px;
            right: 20px;
            color: white;
            font-size: 14px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 10;
        }
        
        .player-1-effect {
            top: 50px;
            left: 20px;
            right: auto;
        }
        
        .player-2-effect {
            top: 80px;
            right: 20px;
        }
        
        /* é‡Šæ”¾æ•ˆæœåŠ¨ç”» */
        @keyframes releaseEffect {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }
        
        .release-effect {
            position: absolute;
            border-radius: 50%;
            animation: releaseEffect 0.5s forwards;
            z-index: 3;
        }
        .magic-snake {
            border-color: #9C27B0;
        }
        .player-score .player-name {
            font-weight: bold;
            margin-right: 5px;
        }
        /* è›‡ç±»è¯¦æƒ…å¼¹çª—æ ·å¼ */
.modal {
    display: none;
    position: fixed;
    z-index: 100;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
}

.modal-content {
    background: linear-gradient(135deg, #1a2a6c, #b21f1f);
    margin: 10% auto;
    padding: 20px;
    border-radius: 15px;
    width: 80%;
    max-width: 600px;
    color: white;
    position: relative;
}

.close-modal {
    position: absolute;
    right: 20px;
    top: 10px;
    font-size: 28px;
    cursor: pointer;
}

/* è›‡ç±»è¯¦æƒ…å†…å®¹æ ·å¼ */
.snake-type-title {
    font-size: 24px;
    margin: 15px 0;
    padding-bottom: 5px;
    border-bottom: 2px solid;
}

.snake-attribute {
    margin: 10px 0;
    display: flex;
}

.attribute-name {
    font-weight: bold;
    width: 120px;
}

.attribute-value {
    flex: 1;
}

/* å›¾æ ‡æ ·å¼ */
.speed-icon {
    width: 20px;
    height: 20px;
    display: inline-block;
    background: linear-gradient(45deg, #FFD700, #FFA500);
    border-radius: 50%;
    margin-right: 5px;
}

.health-icon {
    width: 20px;
    height: 20px;
    display: inline-block;
    background: linear-gradient(45deg, #FF0000, #FF6B6B);
    border-radius: 50%;
    margin-right: 5px;
}

.magic-icon {
    width: 20px;
    height: 20px;
    display: inline-block;
    background: linear-gradient(45deg, #9C27B0, #DA70D6);
    border-radius: 50%;
    margin-right: 5px;
}

.tough-icon {
    width: 20px;
    height: 20px;
    display: inline-block;
    background: linear-gradient(45deg, #C0C0C0, #A9A9A9);
    border-radius: 50%;
    margin-right: 5px;
}

/* æ˜Ÿçº§è¯„åˆ†æ ·å¼ */
.star-rating {
    display: inline-flex;
    align-items: center;
    margin-right: 15px;
}

.star {
    font-size: 16px;
    margin-right: 2px;
}

.rating-value {
    margin-left: 5px;
    font-size: 14px;
}

.health-rating .star { 
    color: #FF6B6B;
}

.speed-rating .star { 
    color: #FFD700;
}

.magic-rating .star { 
    color: #DA70D6;
}

.health-rating .rating-value { color: #FF6B6B; }
.speed-rating .rating-value { color: #FFD700; }
.magic-rating .rating-value { color: #DA70D6; }

/* è§’è‰²é€‰æ‹©ç•Œé¢æ ·å¼ */
.snake-option {
    cursor: pointer;
    transition: all 0.3s;
}

.snake-option:hover {
    transform: scale(1.05);
}

.snake-type {
    font-weight: bold;
    font-size: 18px;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
}

.snake-desc {
    font-size: 14px;
    opacity: 0.8;
}    
/* æŒ‰é’®å®¹å™¨æ ·å¼ */
.buttons-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
}

/* ä¸Šä¼ æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
.upload-btn {
    background: linear-gradient(45deg, #4CAF50, #8BC34A) !important;
}

.upload-btn:hover {
    box-shadow: 0 0 20px rgba(76, 175, 80, 0.7) !important;
}
/* æˆ˜ç»©æŸ¥è¯¢æ¨¡æ€æ¡†æ ·å¼ */
#records-modal .modal-content {
    background: linear-gradient(135deg, #1a2a6c, #b21f1f);
    color: white;
    padding: 20px;
    border-radius: 15px;
    max-height: 80vh;
    overflow-y: auto;
}

.search-controls {
    display: flex;
    margin-bottom: 20px;
    gap: 10px;
}

.search-controls input {
    flex: 1;
    padding: 10px;
    border-radius: 5px;
    border: none;
    background-color: rgba(255,255,255,0.2);
    color: white;
}

.search-controls button {
    padding: 10px 20px;
    background: linear-gradient(45deg, #2196F3, #00BCD4);
    border: none;
    border-radius: 5px;
    color: white;
    cursor: pointer;
}

/* æˆ˜ç»©è®°å½•æ ·å¼ */
.record-item {
    background-color: rgba(0,0,0,0.3);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
}

.record-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-right: 15px;
    object-fit: cover;
    border: 2px solid white;
}

.record-details {
    flex: 1;
}

.record-username {
    font-weight: bold;
    font-size: 18px;
    margin-bottom: 5px;
}

.record-data {
    font-size: 14px;
    opacity: 0.8;
}

.record-match {
    margin-top: 10px;
    padding: 8px;
    background-color: rgba(255,255,255,0.1);
    border-radius: 5px;
}

.record-match-opponent {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
}

.record-match-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    margin-right: 10px;
    border: 1px solid white;
}

.record-stats {
    display: flex;
    gap: 15px;
    margin-top: 5px;
}

.record-stat {
    background-color: rgba(255,255,255,0.1);
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 12px;
}
/* æ¸¸æˆç»“æŸç•Œé¢æ ·å¼ */
.game-over {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    z-index: 100;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s;
    backdrop-filter: blur(5px);
}

.game-over.show {
    opacity: 1;
    pointer-events: all;
}

.game-over-content {
    text-align: center;
    max-width: 600px;
    width: 90%;
    animation: fadeInUp 0.8s;
}

.winner-container {
    margin-bottom: 30px;
}

.trophy-icon {
    font-size: 80px;
    margin-bottom: 20px;
    animation: bounce 1s infinite alternate;
}

.winner-banner {
    font-size: 48px;
    margin-bottom: 10px;
    text-shadow: 0 0 15px currentColor;
    animation: pulse 2s infinite;
}

.stats-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 30px 0;
    gap: 20px;
}

.player-stats {
    flex: 1;
    padding: 20px;
    border-radius: 15px;
    background: rgba(255, 255, 255, 0.1);
    transition: transform 0.3s;
}

.player-stats:hover {
    transform: translateY(-5px);
}

.player-1-stats {
    border: 2px solid #FF5722;
    box-shadow: 0 0 15px rgba(255, 87, 34, 0.3);
}

.player-2-stats {
    border: 2px solid #2196F3;
    box-shadow: 0 0 15px rgba(33, 150, 243, 0.3);
}

.player-avatar {
    font-size: 40px;
    margin-bottom: 10px;
}

.player-name {
    font-size: 20px;
    margin-bottom: 5px;
    font-weight: bold;
}

.win-count {
    font-size: 28px;
    font-weight: bold;
    margin: 10px 0;
}

.progress-bar {
    height: 10px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 5px;
    overflow: hidden;
    margin-top: 10px;
}

.progress-fill {
    height: 100%;
    border-radius: 5px;
    transition: width 1s ease-out;
}

.vs-text {
    font-size: 24px;
    font-weight: bold;
    margin: 0 10px;
}

.buttons-container {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 30px;
}

.restart-btn {
    padding: 15px 30px;
    border: none;
    border-radius: 50px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 10px;
}

.restart-btn i {
    font-size: 20px;
}

.restart-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.upload-btn {
    background: linear-gradient(45deg, #4CAF50, #8BC34A);
}

.restart-btn:not(.upload-btn) {
    background: linear-gradient(45deg, #2196F3, #00BCD4);
}

/* åº†ç¥ç²’å­æ•ˆæœ */
.celebration-particle {
    position: absolute;
    border-radius: 50%;
    pointer-events: none;
    animation: celebrate linear forwards;
    z-index: 101;
}

@keyframes celebrate {
    to {
        transform: translate(var(--tx), var(--ty));
        opacity: 0;
    }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes bounce {
    to {
        transform: translateY(-20px);
    }
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
}
/* æ¸¸æˆç»“æŸæ¶ˆæ¯æ ·å¼ */
.game-over-message {
    margin: 15px 0;
    padding: 10px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 5px;
    text-align: center;
    font-weight: bold;
    transition: opacity 0.5s;
}

/* å½“å‰èƒœåˆ©æ¬¡æ•°æç¤º */
.win-count .current-win {
    color: #4CAF50;
    font-weight: bold;
    margin-left: 5px;
    animation: pulse 1s infinite;
}

/* èƒœåˆ©æ¬¡æ•°æ ·å¼ */
.win-count {
    font-size: 28px;
    font-weight: bold;
    margin: 10px 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.history-wins {
    color: white;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.2);
    }
}
.map-selection {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(26, 42, 108, 0.9), rgba(178, 31, 31, 0.9), rgba(253, 187, 45, 0.9));
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    z-index: 8;
    opacity: 0;
    pointer-events: none;
    transition: all 0.5s;
}

.map-selection.show {
    opacity: 1;
    pointer-events: all;
}

.map-options {
    display: flex;
    gap: 30px;
    margin-bottom: 40px;
}

.map-option {
    padding: 20px;
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 15px;
    width: 250px;
    cursor: pointer;
    transition: all 0.3s;
}

.map-option:hover {
    transform: scale(1.05);
    background-color: rgba(255, 255, 255, 0.1);
}

.map-option.selected {
    border: 2px solid white;
    box-shadow: 0 0 15px white;
}

.map-preview {
    width: 100%;
    height: 150px;
    border-radius: 10px;
    margin-bottom: 15px;
}

.map-name {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 5px;
}

.map-desc {
    font-size: 14px;
    opacity: 0.8;
}

/* ç«å±±æ ·å¼ */
.volcano {
    position: absolute;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: radial-gradient(circle, #8B0000, #FF4500);
    z-index: 1;
    box-shadow: 0 0 15px #FF4500;
}

.lava {
    position: absolute;
    width: 20px;
    height: 20px;
    background: linear-gradient(45deg, #FF4500, #FF8C00);
    border-radius: 50%;
    z-index: 1;
    animation: lavaPulse 1s infinite alternate;
}

@keyframes lavaPulse {
    from { opacity: 0.7; transform: scale(1); }
    to { opacity: 1; transform: scale(1.1); }
}

.warning-volcano {
    animation: volcanoWarning 0.5s infinite alternate;
}

@keyframes volcanoWarning {
    from { box-shadow: 0 0 15px #FF4500; }
    to { box-shadow: 0 0 30px #FFFF00; }
}
        /* åŸºåœ°çš„æ ·å¼ */
        .home-base {
            position: absolute;
            border: 3px solid;
            border-radius: 15px;
            z-index: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 3px rgba(0,0,0,0.8);
            transition: all 0.3s ease;
        }
        
        .home-base.player1 {
            border-color: #FF5722;
            background: linear-gradient(135deg, rgba(255, 87, 34, 0.3), rgba(255, 152, 0, 0.2));
            box-shadow: 0 0 20px rgba(255, 87, 34, 0.5);
            left: 20px;
            top: 20px;
        }
        
        .home-base.player2 {
            border-color: #2196F3;
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.3), rgba(0, 188, 212, 0.2));
            box-shadow: 0 0 20px rgba(33, 150, 243, 0.5);
            right: 20px;
            bottom: 20px;
        }
        
        .home-health-bar {
            position: absolute;
            bottom: -15px;
            left: 10%;
            width: 80%;
            height: 6px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .home-health-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }
        
        .home1-health-fill {
            background: linear-gradient(to right, #FF5722, #FF9800);
        }
        
        .home2-health-fill {
            background: linear-gradient(to right, #2196F3, #00BCD4);
        }
        
        .home-health-text {
            position: absolute;
            top: -20px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 12px;
            color: white;
        }
        
        /* åŸºåœ°è¢«æ”»å‡»æ•ˆæœ */
        .home-under-attack {
            animation: homeUnderAttack 0.5s infinite alternate;
        }
        
        @keyframes homeUnderAttack {
            from { box-shadow: 0 0 20px; }
            to { box-shadow: 0 0 40px; }
        }
        
        /* åŸºåœ°è¢«æ‘§æ¯æ•ˆæœ */
        .home-destroyed {
            opacity: 0.3;
            filter: grayscale(100%);
            box-shadow: none;
        }
        
        /* åœ¨åŸºåœ°ä¸­çš„æ•ˆæœ */
        .in-home-effect {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 15px;
            background: radial-gradient(circle, transparent 50%, rgba(255,255,255,0.1) 100%);
            animation: homeHealing 2s infinite linear;
            z-index: -1;
        }
        
        @keyframes homeHealing {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- æ·»åŠ åˆ°character-selection divä¹‹å -->
<div class="map-selection">
    <h2 class="selection-title">é€‰æ‹©åœ°å›¾</h2>
    <div class="map-options">
        <div class="map-option" data-map="default">
            <div class="map-preview" style="background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);"></div>
            <div class="map-name">é»˜è®¤åœ°å›¾</div>
            <div class="map-desc">ç»å…¸åŒè›‡å¯¹æˆ˜åœ°å›¾</div>
        </div>
        <div class="map-option" data-map="snow">
            <div class="map-preview" style="background: linear-gradient(135deg, #1e3c72, #2a5298, #7b4397);"></div>
            <div class="map-name">é›ªå±±åœ°å›¾</div>
            <div class="map-desc">æš´é£é›ªå¤©æ°”æŒ‘æˆ˜</div>
        </div>
        <div class="map-option" data-map="volcano">
            <div class="map-preview" style="background: linear-gradient(135deg, #8B0000, #FF4500, #FF8C00);"></div>
            <div class="map-name">ç«å±±åœ°å›¾</div>
            <div class="map-desc">ç«å±±å–·å‘æŒ‘æˆ˜</div>
        </div>        
    </div>
    <button class="start-game-btn" disabled>å¼€å§‹æ¸¸æˆ</button>
</div>
    <button id="view-records"style="position: absolute;top: 20px;right: 20px; background: rgba(255,255,255,0.2);border: none;color: white;padding: 5px 10px;border-radius: 5px;cursor: pointer;z-index: 10;">æŸ¥çœ‹æˆ˜ç»©</button>
            <div id="records-modal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <span class="close-modal">&times;</span>
                <h2>ç©åŸºåœ°å¯¹æˆ˜è®°å½•</h2>
                <div class="search-controls">
                    <input type="text" id="search-username" placeholder="æœç´¢ç©åŸºåœ°...">
                    <button id="refresh-records">åˆ·æ–°</button>
                </div>
                <div id="records-container"></div>
            </div>
        </div>
    <div class="game-container">
        <div class="start-screen">
            <h1 class="game-title">ğŸ åŒäººè´ªåƒè›‡ ğŸ</h1>
            <button class="start-btn">å¼€å§‹æ¸¸æˆ</button>
            <div class="instructions">
                <p>ä¸¤æ¡è›‡å„æœ‰10ç‚¹ç”Ÿå‘½å€¼ï¼Œæ’åˆ°å¯¹æ–¹è›‡èº«ä¼šæ‰£è¡€å¹¶ç¼©çŸ­</p>
                <p>æ´»åˆ°æœ€åçš„ç©åŸºåœ°è·èƒœï¼</p>
                
                <div class="player-instructions">
                    <div class="player-instruction player-1-instruction">
                        <h3><i class="fas fa-fire"></i> ç©åŸºåœ°1 (æ©™è‰²)</h3>
                        <p>ä½¿ç”¨WASDæ§åˆ¶</p>
                        <div>
                            <div class="key">W</div>
                            <div class="key">A</div>
                            <div class="key">S</div>
                            <div class="key">D</div>
                        </div>
                    </div>
                    
                    <div class="player-instruction player-2-instruction">
                        <h3><i class="fas fa-tint"></i> ç©åŸºåœ°2 (è“è‰²)</h3>
                        <p>ä½¿ç”¨æ–¹å‘é”®æ§åˆ¶</p>
                        <div>
                            <div class="key">â†‘</div>
                            <div class="key">â†</div>
                            <div class="key">â†“</div>
                            <div class="key">â†’</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="particles" id="particles"></div>
        
        <div id="game-board"></div>
        
        <!-- çŠ¶æ€æ•ˆæœæ˜¾ç¤º -->
        <div class="status-effect player-1-effect" id="player1-effect"></div>
        <div class="status-effect player-2-effect" id="player2-effect"></div>
        
    <div class="game-over">
        <h2 class="winner-banner" id="winner-banner">æ¸¸æˆç»“æŸ!</h2>
        <!-- æ–°å¢æ¯”åˆ†æ˜¾ç¤º -->
        <div class="score-display">
            <div id="winner-name">è·èƒœè€…: <span id="winner-player"></span></div>
            <div class="final-score" id="final-score">0:0</div>
        </div>
        <div class="buttons-container">
            <button class="restart-btn upload-btn" id="upload-record">ä¸Šä¼ æˆ˜ç»©</button>
            <button class="restart-btn">å†æ¥ä¸€å±€</button>
        </div>
    </div>
    </div>
        <div class="score-board">
            <div class="player-score player-1">
                <div class="score-display">
                    <span class="player-name" id="player1-name">ç©åŸºåœ°1: </span>
                    <span class="score-text" id="score-1">0åˆ†</span>
                </div>
                <div class="health-display">
                    <span>ç”Ÿå‘½å€¼: </span>
                    <div class="health-bar">
                        <div class="health-fill" id="health-1" style="width: 100%;"></div>
                    </div>
                    <span id="health-text-1">10HP</span>
                </div>
            </div>
            <div class="player-score player-2">
                <div class="score-display">
                    <span class="player-name" id="player2-name">ç©åŸºåœ°2: </span>
                    <span class="score-text" id="score-2">0åˆ†</span>
                </div>
                <div class="health-display">
                    <span>ç”Ÿå‘½å€¼: </span>
                    <div class="health-bar">
                        <div class="health-fill" id="health-2" style="width: 100%;"></div>
                    </div>
                    <span id="health-text-2">10HP</span>
                </div>
            </div>
        </div>
        <div class="ball-storage player-1-storage">
            <div id ="storage-title1" class="storage-title">ç©åŸºåœ°1å‚¨å­˜:</div>
            <div class="ball-slot" id="p1-slot-1"><span class="key-hint">1</span></div>
            <div class="ball-slot" id="p1-slot-2"><span class="key-hint">2</span></div>
            <div class="ball-slot" id="p1-slot-3"><span class="key-hint">3</span></div>
            <div class="ball-slot" id="p1-slot-4"><span class="key-hint">4</span></div>
            <div class="ball-slot" id="p1-slot-5"><span class="key-hint">5</span></div>
        </div>
        
        <div class="ball-storage player-2-storage">
            <div id ="storage-title2" class="storage-title">ç©åŸºåœ°2å‚¨å­˜:</div>
            <div class="ball-slot" id="p2-slot-1"><span class="key-hint">6</span></div>
            <div class="ball-slot" id="p2-slot-2"><span class="key-hint">7</span></div>
            <div class="ball-slot" id="p2-slot-3"><span class="key-hint">8</span></div>
            <div class="ball-slot" id="p2-slot-4"><span class="key-hint">9</span></div>
            <div class="ball-slot" id="p2-slot-5"><span class="key-hint">0</span></div>
        </div>       
        <!-- è§’è‰²é€‰æ‹©ç•Œé¢ -->
        <div class="character-selection">
            <h2 class="selection-title">é€‰æ‹©ä½ çš„è›‡</h2>
            
            <div class="player-selections">
<div class="player-selection">
    <div class="player-label" id="player-label1">ç©åŸºåœ°1 (æ©™è‰²)</div>
    <div class="snake-options">
        <div class="snake-option speed-snake" data-player="1" data-type="speed">
            <div class="snake-type" style="color: #FFD700;">
                é€Ÿåº¦è›‡ <span class="speed-rating">â˜…â˜…â˜…â˜…â˜…</span>
            </div>
            <div class="snake-desc">
                <span class="health-rating">ç”Ÿå‘½: â˜…â˜…â˜†â˜†â˜†</span> | 
                <span class="magic-rating">é­”æ³•: â˜…â˜†â˜†â˜†â˜†</span>
            </div>
        </div>
        
        <div class="snake-option tough-snake" data-player="1" data-type="tough">
            <div class="snake-type" style="color: #C0C0C0;">
                åšç¡¬è›‡ <span class="health-rating">ç”Ÿå‘½: â˜…â˜…â˜…â˜…â˜…</span>
            </div>
            <div class="snake-desc">
                <span class="speed-rating">é€Ÿåº¦: â˜…â˜…â˜†â˜†â˜†</span> | 
                <span class="magic-rating">é­”æ³•: â˜…â˜†â˜†â˜†â˜†</span>
            </div>
        </div>
        
        <div class="snake-option magic-snake" data-player="1" data-type="magic">
            <div class="snake-type" style="color: #9C27B0;">
                é­”æ³•è›‡ <span class="magic-rating">é­”æ³•: â˜…â˜…â˜…â˜…â˜…</span>
            </div>
            <div class="snake-desc">
                <span class="health-rating">ç”Ÿå‘½: â˜…â˜…â˜…â˜†â˜†</span> | 
                <span class="speed-rating">é€Ÿåº¦: â˜…â˜…â˜…â˜†â˜†</span>
            </div>
        </div>
    </div>
</div>

<div class="player-selection">
    <div class="player-label" id="player-label2">ç©åŸºåœ°2 (è“è‰²)</div>
    <div class="snake-options">
        <div class="snake-option speed-snake" data-player="2" data-type="speed">
            <div class="snake-type" style="color: #FFD700;">
                é€Ÿåº¦è›‡ <span class="speed-rating">â˜…â˜…â˜…â˜…â˜…</span>
            </div>
            <div class="snake-desc">
                <span class="health-rating">ç”Ÿå‘½: â˜…â˜…â˜†â˜†â˜†</span> | 
                <span class="magic-rating">é­”æ³•: â˜…â˜†â˜†â˜†â˜†</span>
            </div>
        </div>
        
        <div class="snake-option tough-snake" data-player="2" data-type="tough">
            <div class="snake-type" style="color: #C0C0C0;">
                åšç¡¬è›‡ <span class="health-rating">ç”Ÿå‘½: â˜…â˜…â˜…â˜…â˜…</span>
            </div>
            <div class="snake-desc">
                <span class="speed-rating">é€Ÿåº¦: â˜…â˜…â˜†â˜†â˜†</span> | 
                <span class="magic-rating">é­”æ³•: â˜…â˜†â˜†â˜†â˜†</span>
            </div>
        </div>
        
        <div class="snake-option magic-snake" data-player="2" data-type="magic">
            <div class="snake-type" style="color: #9C27B0;">
                é­”æ³•è›‡ <span class="magic-rating">é­”æ³•: â˜…â˜…â˜…â˜…â˜…</span>
            </div>
            <div class="snake-desc">
                <span class="health-rating">ç”Ÿå‘½: â˜…â˜…â˜…â˜†â˜†</span> | 
                <span class="speed-rating">é€Ÿåº¦: â˜…â˜…â˜…â˜†â˜†</span>
            </div>
        </div>
    </div>
</div>  
            
            <button class="start-game-btn">å¼€å§‹æ¸¸æˆ</button>
        </div>
                <!-- æ·»åŠ åˆ°bodyçš„æœ«å°¾ -->
        <div id="snake-details-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2>è›‡ç±»ç‰¹æ€§è¯¦æƒ…</h2>
                <div id="snake-details-content"></div>
            </div>
        </div>
        <!-- æ·»åŠ åˆ°bodyçš„åˆé€‚ä½ç½® -->
    
<script>
// æ¸¸æˆå˜é‡
let snakes = {
    snake1: [],
    snake2: []
};
let foods = [];
let specialItems = []; // å­˜å‚¨ç‰¹æ®Šçƒ
let directions = {
    snake1: 'right',
    snake2: 'right'
};
let nextDirections = {
    snake1: 'right',
    snake2: 'right'
};
let gameInterval;
let gameSpeed = 100;
let health = {
    snake1: 10,
    snake2: 10
};
let scores = {
    snake1: 0,
    snake2: 0
};
let snakeTypes = {
    snake1: null,
    snake2: null
};
let collisionCount = {
    snake1: 0,
    snake2: 0
};
let defenseRate = {
    snake1: 1.0,
    snake2: 1.0
};
let immunity = {
    snake1: false,
    snake2: false,
    timer1: 0,
    timer2: 0
};
let reversedControls = {
    snake1: false,
    snake2: false,
    timer1: 0,
    timer2: 0
};
let ballStorage = {
    snake1: [],
    snake2: []
};
let attackMode = {
    snake1: false,
    snake2: false,
    timer1: 0,
    timer2: 0,
    lastShot1: 0,
    lastShot2: 0
};
let magicSnakeTimers = {
    snake1: 0,
    snake2: 0
};
let pausedSnakes = {
    snake1: false,
    snake2: false
};
let walls = [];
let bullets = []; // å­˜å‚¨å­å¼¹å¯¹è±¡
let lastSpecialItemSpawn = 0;
let gameStarted = false;
let lastTime = 0;
let lastWallHitTime = {
snake1: 0,
snake2: 0
};
// æ¸¸æˆå˜é‡ä¸­æ·»åŠ 
let volcanoes = [];
let lavaTiles = [];
let lastEruptionTime = 0;
let isErupting = false;
let nextEruptionTime = 30000; // 30ç§’åç¬¬ä¸€æ¬¡å–·å‘
// åœ¨æ¸¸æˆå˜é‡ä¸­æ·»åŠ 
let currentMap = 'default';
let blizzardActive = false;
let blizzardDirection = null;
let blizzardTimer = 0;
let coldWindTimer = 0;
let snakeSpeedModifiers = { snake1: 1, snake2: 1 };
let frozenSnakes = { snake1: false, snake2: false, timer1: 0, timer2: 0 };
let speedBoosts = {
    snake1: 0,
    snake2: 0
};
const gameBoard = document.getElementById('game-board');
const startBtn = document.querySelector('.start-btn');
const restartBtn = document.querySelector('.restart-btn');
const health1El = document.getElementById('health-1');
const health2El = document.getElementById('health-2');
const score1El = document.getElementById('score-1');
const score2El = document.getElementById('score-2');
const gameOverScreen = document.querySelector('.game-over');
const startScreen = document.querySelector('.start-screen');
const particlesContainer = document.getElementById('particles');
const winnerBanner = document.getElementById('winner-banner');
const winnerName = document.getElementById('winner-name');
const characterSelection = document.querySelector('.character-selection');
const viewRecords = document.getElementById("view-records");
let lastMoveTime = {
    snake1: 0,
    snake2: 0
};
        // åœ¨æ¸¸æˆå˜é‡ä¸­æ·»åŠ 
        let homes = {
            player1: {
                x: 20,
                y: 20,
                width: 100,
                height: 80,
                health: 20,
                maxHealth: 20,
                destroyed: false,
                lastHealTime: 0,
                lastDamageTime: 0
            },
            player2: {
                x: 0, // å°†åœ¨åˆå§‹åŒ–æ—¶è®¡ç®—
                y: 0, // å°†åœ¨åˆå§‹åŒ–æ—¶è®¡ç®—
                width: 100,
                height: 80,
                health: 20,
                maxHealth: 20,
                destroyed: false,
                lastHealTime: 0,
                lastDamageTime: 0
            }
        };
        
        // ä¿®æ”¹initGameå‡½æ•°ï¼Œåœ¨ç”Ÿæˆç«å±±ååˆå§‹åŒ–åŸºåœ°

        // åˆå§‹åŒ–åŸºåœ°çš„ä½ç½®
function initHomes() {
    const boardWidth = gameBoard.clientWidth;
    const boardHeight = gameBoard.clientHeight;
    
    // å¢å¤§åŸºåœ°çš„å°ºå¯¸
    const homeWidth = 250;
    const homeHeight = 200;
    
    // ç©åŸºåœ°1çš„åŸºåœ°åœ¨å·¦ä¸Šè§’
    homes.player1 = {
        x: 20,
        y: 110, // é¿å¼€è®¡åˆ†æ¿
        width: homeWidth,
        height: homeHeight,
        health: 20,
        maxHealth: 20,
        destroyed: false,
        lastHealTime: 0,
        lastDamageTime: 0
    };
    
    // ç©åŸºåœ°2çš„åŸºåœ°åœ¨å³ä¸‹è§’
    homes.player2 = {
        x: boardWidth - homeWidth - 20,
        y: boardHeight - homeHeight - 80, // é¿å¼€åº•éƒ¨UI
        width: homeWidth,
        height: homeHeight,
        health: 20,
        maxHealth: 20,
        destroyed: false,
        lastHealTime: 0,
        lastDamageTime: 0
    };
}
        // ç»˜åˆ¶åŸºåœ°
function drawHomes() {
    // ç§»é™¤ç°æœ‰çš„åŸºåœ°å…ƒç´ 
    document.querySelectorAll('.home-base').forEach(el => el.remove());
    
    // ç»˜åˆ¶ç©åŸºåœ°1çš„åŸºåœ°
    if (!homes.player1.destroyed) {
        const home1 = document.createElement('div');
        home1.className = `home-base player1 ${homes.player1.health < homes.player1.maxHealth * 0.3 ? 'home-under-attack' : ''}`;
        home1.style.left = `${homes.player1.x}px`;
        home1.style.top = `${homes.player1.y}px`;
        home1.style.width = `${homes.player1.width}px`;
        home1.style.height = `${homes.player1.height}px`;
        home1.style.zIndex = '2'; // ç¡®ä¿åŸºåœ°åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š
        
        // æ·»åŠ åŸºåœ°çš„å›¾æ ‡å’Œåç§°
        const name1 = document.createElement('div');
        name1.innerHTML = `<i class="fas fa-home"></i> ${localStorage.getItem('username') || 'ç©åŸºåœ°1'}çš„åŸºåœ°`;
        name1.style.textAlign = 'center';
        name1.style.marginTop = '15px';
        name1.style.fontSize = '14px';
        home1.appendChild(name1);
        
        // æ·»åŠ è¡€æ¡
        const healthBar1 = document.createElement('div');
        healthBar1.className = 'home-health-bar';
        
        const healthFill1 = document.createElement('div');
        healthFill1.className = 'home-health-fill home1-health-fill';
        healthFill1.style.width = `${(homes.player1.health / homes.player1.maxHealth) * 100}%`;
        
        const healthText1 = document.createElement('div');
        healthText1.className = 'home-health-text';
        healthText1.textContent = `HP: ${homes.player1.health}/${homes.player1.maxHealth}`;
        healthText1.style.fontSize = '11px';
        
        healthBar1.appendChild(healthFill1);
        home1.appendChild(healthText1);
        home1.appendChild(healthBar1);
        
        gameBoard.appendChild(home1);
    }
    
    // ç»˜åˆ¶ç©åŸºåœ°2çš„åŸºåœ°
    if (!homes.player2.destroyed) {
        const home2 = document.createElement('div');
        home2.className = `home-base player2 ${homes.player2.health < homes.player2.maxHealth * 0.3 ? 'home-under-attack' : ''}`;
        home2.style.left = `${homes.player2.x}px`;
        home2.style.top = `${homes.player2.y}px`;
        home2.style.width = `${homes.player2.width}px`;
        home2.style.height = `${homes.player2.height}px`;
        home2.style.zIndex = '2'; // ç¡®ä¿åŸºåœ°åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š
        
        // æ·»åŠ åŸºåœ°çš„å›¾æ ‡å’Œåç§°
        const name2 = document.createElement('div');
        name2.innerHTML = `<i class="fas fa-home"></i> ${localStorage.getItem('player2_username') || 'ç©åŸºåœ°2'}çš„åŸºåœ°`;
        name2.style.textAlign = 'center';
        name2.style.marginTop = '15px';
        name2.style.fontSize = '14px';
        home2.appendChild(name2);
        
        // æ·»åŠ è¡€æ¡
        const healthBar2 = document.createElement('div');
        healthBar2.className = 'home-health-bar';
        
        const healthFill2 = document.createElement('div');
        healthFill2.className = 'home-health-fill home2-health-fill';
        healthFill2.style.width = `${(homes.player2.health / homes.player2.maxHealth) * 100}%`;
        
        const healthText2 = document.createElement('div');
        healthText2.className = 'home-health-text';
        healthText2.textContent = `HP: ${homes.player2.health}/${homes.player2.maxHealth}`;
        healthText2.style.fontSize = '11px';
        
        healthBar2.appendChild(healthFill2);
        home2.appendChild(healthText2);
        home2.appendChild(healthBar2);
        
        gameBoard.appendChild(home2);
    }
}

// åˆå§‹åŒ–æ¸¸æˆ
function initGame() {
    document.getElementById("back").style.display ="none"
    viewRecords.style.display = 'none';
    const player1Name = localStorage.getItem('username') || 'ç©åŸºåœ°1';
    document.getElementById('player1-name').textContent = player1Name + ': ';
            
    // å¦‚æœç©åŸºåœ°2å·²ç™»å½•ï¼Œè®¾ç½®å…¶åç§°
    const player2Name = localStorage.getItem('player2_username') || 'ç©åŸºåœ°2';
    document.getElementById('player2-name').textContent = player2Name + ': '; 
    document.getElementById("player-label1").textContent =localStorage.getItem("username") + "(æ©™è‰²)" || 'ç©åŸºåœ°1'
    document.getElementById("player-label2").textContent =localStorage.getItem("player2_username") + "(è“è‰²)" || 'ç©åŸºåœ°2'
    document.getElementById("storage-title1").textContent =localStorage.getItem("username") + "å‚¨å­˜:" || 'ç©åŸºåœ°1å‚¨å­˜:'
    document.getElementById("storage-title2").textContent =localStorage.getItem("player2_username") + "å‚¨å­˜:"  || 'ç©åŸºåœ°2å‚¨å­˜:'    
    // æ¸…é™¤ç°æœ‰è›‡å’Œé£Ÿç‰©
    if (currentMap === 'snow') {
        document.body.style.background = 'linear-gradient(135deg, #1e3c72, #2a5298, #7b4397)';
        blizzardTimer = performance.now() + 30000; // 30ç§’åç¬¬ä¸€æ¬¡æš´é£é›ª
    } else if (currentMap === 'volcano') {
        document.body.style.background = 'linear-gradient(135deg, #8B0000, #FF4500, #FF8C00)';
        generateVolcanoes();
        nextEruptionTime = performance.now() + 30000;
    } else {
        document.body.style.background = 'linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d)';
    }
    clearBoard();
document.querySelectorAll('.bullet').forEach(bullet => bullet.remove());

// 2. å®Œå…¨é‡ç½®æ”»å‡»æ¨¡å¼çŠ¶æ€
if (attackMode.intervalId1) {
    clearInterval(attackMode.intervalId1);
    attackMode.intervalId1 = null;
}
if (attackMode.intervalId2) {
    clearInterval(attackMode.intervalId2);
    attackMode.intervalId2 = null;
}
        // é‡ç½®é€Ÿåº¦åŠ æˆ
    speedBoosts = {
        snake1: 0,
        snake2: 0
    };
// 3. é‡ç½®æ”»å‡»æ¨¡å¼çš„æ‰€æœ‰çŠ¶æ€
attackMode = {
    snake1: false,
    snake2: false,
    timer1: 0,
    timer2: 0,
    lastShot1: 0,
    lastShot2: 0,
    intervalId1: null,
    intervalId2: null
};

// 4. é‡ç½®å­å¼¹å‘å°„çš„è®¡æ—¶å™¨
lastMoveTime = {
    snake1: 0,
    snake2: 0
};

    // é‡ç½®ç‰¹æ®Šç‰©å“
    specialItems = [];
    lastSpecialItemSpawn = 0;
    
    // é‡ç½®çŠ¶æ€æ•ˆæœ
    immunity = { snake1: false, snake2: false, timer1: 0, timer2: 0 };
    reversedControls = { snake1: false, snake2: false, timer1: 0, timer2: 0 };
    
    // é‡ç½®å¢™ç¢°æ’è®¡æ—¶
    lastWallHitTime = {
        snake1: 0,
        snake2: 0
    };
    
    // åˆå§‹åŒ–çƒä½“å‚¨å­˜
    ballStorage = {
        snake1: [],
        snake2: []
    };
    pausedSnakes = {
        snake1: false,
        snake2: false
    };
    updateStorageDisplay();
    
    // åˆå§‹åŒ–åŸºåœ°
    initHomes();
    
    // åˆå§‹åŒ–è›‡
    snakes.snake1 = [
        { x: homes.player1.x + 75, y: homes.player1.y + 50 },
        { x: homes.player1.x + 55, y: homes.player1.y + 50 },
        { x: homes.player1.x + 35, y: homes.player1.y + 50 }
    ];
    
    snakes.snake2 = [
        { x: homes.player2.x + 75, y: homes.player2.y + 50 },
        { x: homes.player2.x + 55, y: homes.player2.y + 50 },
        { x: homes.player2.x + 35, y: homes.player2.y + 50 }
    ];
    
    // é‡ç½®æ–¹å‘å’Œè¡€é‡
    directions = {
        snake1: 'right',
        snake2: 'left'
    };
    nextDirections = {
        snake1: 'right',
        snake2: 'left'
    };
    health = {
        snake1: 10,
        snake2: 10
    };
    
    // æ¸¸æˆå¼€å§‹æ—¶ç»™è›‡3ç§’å…ç–«æ—¶é—´
    const currentTime = performance.now();
    immunity.snake1 = true;
    immunity.timer1 = currentTime + 3000; // 3ç§’å…ç–«
    
    immunity.snake2 = true;
    immunity.timer2 = currentTime + 3000; // 3ç§’å…ç–«
    
    // æ˜¾ç¤ºå…ç–«æç¤º
    showNotice('æ¸¸æˆå¼€å§‹! 3ç§’æ— æ•Œæ—¶é—´', '#FFFF00', 
              homes.player1.x + homes.player1.width/2, 
              homes.player1.y - 20);
    showNotice('æ¸¸æˆå¼€å§‹! 3ç§’æ— æ•Œæ—¶é—´', '#FFFF00', 
              homes.player2.x + homes.player2.width/2, 
              homes.player2.y - 20);
    
    // é‡ç½®åˆ†æ•°
    scores = {
        snake1: 0,
        snake2: 0
    };
    if (snakeTypes.snake1 === 'tough') {
        health.snake1 = 15;
    }
    if (snakeTypes.snake2 === 'tough') {
        health.snake2 = 15;
    }
    if (attackMode.intervalId1) clearInterval(attackMode.intervalId1);
    if (attackMode.intervalId2) clearInterval(attackMode.intervalId2);
    attackMode = {
        snake1: false,
        snake2: false,
        timer1: 0,
        timer2: 0,
        lastShot1: 0,
        lastShot2: 0,
        intervalId1: null,
        intervalId2: null
};
    walls = [];
    generateAllWalls();
    updateHealthBars();
    updateScoreDisplay();
    
    // ç”Ÿæˆé£Ÿç‰©
    foods = [];
    generateFood();
    generateFood();
    
    // ç»˜åˆ¶è›‡å’Œé£Ÿç‰©ï¼ˆå¸¦è¿›å…¥åŠ¨ç”»ï¼‰
    drawSnakes(true);
    drawFoods(true);
    
    // éšè—æ¸¸æˆç»“æŸå±å¹•
    gameOverScreen.classList.remove('show');
    gameOverScreen.style.display = 'none';
    // å¼€å§‹æ¸¸æˆå¾ªç¯
    if (gameInterval) clearInterval(gameInterval);
    lastTime = performance.now();
    requestAnimationFrame(gameLoop);
    
    gameStarted = true;
    
    // åˆ›å»ºèƒŒæ™¯å…ƒç´ 
    createBackgroundElements();
    
    // è¿›å…¥å…¨å±æ¨¡å¼
    requestFullscreen();
}

// è¯·æ±‚å…¨å±
function requestFullscreen() {
    const elem = document.documentElement;
    if (elem.requestFullscreen) {
        elem.requestFullscreen();
    } else if (elem.webkitRequestFullscreen) { /* Safari */
        elem.webkitRequestFullscreen();
    } else if (elem.msRequestFullscreen) { /* IE11 */
        elem.msRequestFullscreen();
    }
}
// æ·»åŠ æ–°çš„ç”Ÿæˆæ‰€æœ‰å¢™çš„å‡½æ•°
function generateAllWalls() {
    const boardWidth = gameBoard.clientWidth;
    const boardHeight = gameBoard.clientHeight;
    const gridSize = 20;
    const cols = Math.floor(boardWidth / gridSize);
    const rows = Math.floor(boardHeight / gridSize);
    
    // æ¸…ç©ºç°æœ‰å¢™
    walls = [];
    
    // è®¡ç®—è›‡å‰æ–¹çš„å®‰å…¨åŒºåŸŸï¼ˆ10æ ¼=200åƒç´ ï¼‰
    const safeZones = {
        snake1: getSnakeSafeZone('snake1', 10),
        snake2: getSnakeSafeZone('snake2', 10)
    };
    
    // ç”Ÿæˆæ°´å¹³å¢™
    const horizontalWallCount = Math.floor(rows * 0.1);
    for (let i = 0; i < horizontalWallCount; i++) {
        const row = Math.floor(3 + Math.random() * (rows - 6));
        const y = row * gridSize;
        const startCol = Math.floor(Math.random() * (cols - 5));
        const length = 8 + Math.floor(Math.random() * 4);
        
        const newWall = {
            segments: [],
            spawnTime: performance.now()
        };
        
        let validWall = true;
        
        // æ£€æŸ¥å¢™æ˜¯å¦ä¸è›‡é‡å æˆ–ä½äºå®‰å…¨åŒºåŸŸå†…
        for (let c = 0; c < length; c++) {
            const x = (startCol + c) * gridSize;
            
            // æ£€æŸ¥æ˜¯å¦ä¸è›‡é‡å 
            for (const segment of snakes.snake1) {
                if (segment.x === x && segment.y === y) {
                    validWall = false;
                    break;
                }
            }
            
            if (validWall) {
                for (const segment of snakes.snake2) {
                    if (segment.x === x && segment.y === y) {
                        validWall = false;
                        break;
                    }
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨å®‰å…¨åŒºåŸŸå†…
            if (validWall) {
                if (isInSafeZone(x, y, safeZones.snake1) || 
                    isInSafeZone(x, y, safeZones.snake2)) {
                    validWall = false;
                }
            }
            
            // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦åœ¨åŸºåœ°åŒºåŸŸå†…
            if (validWall) {
                if (isInHomeArea(x, y, homes.player1) || 
                    isInHomeArea(x, y, homes.player2)) {
                    validWall = false;
                }
            }
            
            if (!validWall) break;
        }
        
        if (validWall) {
            for (let c = 0; c < length; c++) {
                newWall.segments.push({
                    x: (startCol + c) * gridSize,
                    y: y
                });
            }
            walls.push(newWall);
        }
    }
    
    // ç”Ÿæˆå‚ç›´å¢™ï¼ˆç±»ä¼¼é€»è¾‘ï¼‰
    const verticalWallCount = Math.floor(cols * 0.1);
    for (let i = 0; i < verticalWallCount; i++) {
        const col = Math.floor(3 + Math.random() * (cols - 6));
        const x = col * gridSize;
        const startRow = Math.floor(Math.random() * (rows - 5));
        const length = 8 + Math.floor(Math.random() * 3);
        
        const newWall = {
            segments: [],
            spawnTime: performance.now()
        };
        
        let validWall = true;
        
        for (let r = 0; r < length; r++) {
            const y = (startRow + r) * gridSize;
            
            // æ£€æŸ¥æ˜¯å¦ä¸è›‡é‡å 
            for (const segment of snakes.snake1) {
                if (segment.x === x && segment.y === y) {
                    validWall = false;
                    break;
                }
            }
            
            if (validWall) {
                for (const segment of snakes.snake2) {
                    if (segment.x === x && segment.y === y) {
                        validWall = false;
                        break;
                    }
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨å®‰å…¨åŒºåŸŸå†…
            if (validWall) {
                if (isInSafeZone(x, y, safeZones.snake1) || 
                    isInSafeZone(x, y, safeZones.snake2)) {
                    validWall = false;
                }
            }
            
            // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦åœ¨åŸºåœ°åŒºåŸŸå†…
            if (validWall) {
                if (isInHomeArea(x, y, homes.player1) || 
                    isInHomeArea(x, y, homes.player2)) {
                    validWall = false;
                }
            }
            
            if (!validWall) break;
        }
        
        if (validWall) {
            for (let r = 0; r < length; r++) {
                newWall.segments.push({
                    x: x,
                    y: (startRow + r) * gridSize
                });
            }
            walls.push(newWall);
        }
    }
}

// æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦åœ¨åŸºåœ°åŒºåŸŸå†…
function isInHomeArea(x, y, home) {
    if (home.destroyed) return false;
    return x >= home.x && 
           x <= home.x + home.width && 
           y >= home.y && 
           y <= home.y + home.height;
}
// è·å–è›‡å‰æ–¹çš„å®‰å…¨åŒºåŸŸ
function getSnakeSafeZone(snakeId, distanceInGrids) {
    const head = snakes[snakeId][0];
    const direction = directions[snakeId];
    const gridSize = 20;
    const safeZone = [];
    
    // è®¡ç®—å‰æ–¹åŒºåŸŸ
    for (let i = 1; i <= distanceInGrids; i++) {
        let x = head.x, y = head.y;
        
        switch (direction) {
            case 'up': y -= i * gridSize; break;
            case 'down': y += i * gridSize; break;
            case 'left': x -= i * gridSize; break;
            case 'right': x += i * gridSize; break;
        }
        
        // ç¡®ä¿åæ ‡åœ¨æ¸¸æˆæ¿å†…
        if (x >= 0 && x < gameBoard.clientWidth && 
            y >= 0 && y < gameBoard.clientHeight) {
            safeZone.push({x, y});
        }
    }
    
    return safeZone;
}

// æ£€æŸ¥åæ ‡æ˜¯å¦åœ¨å®‰å…¨åŒºåŸŸå†…
function isInSafeZone(x, y, safeZone) {
    return safeZone.some(zone => zone.x === x && zone.y === y);
}
// æ¸…é™¤æ¸¸æˆæ¿
function clearBoard() {
    document.querySelectorAll('.bullet').forEach(bullet => bullet.remove());
    while (gameBoard.firstChild) {
        gameBoard.removeChild(gameBoard.firstChild);
    }
}

// æ·»åŠ æ›´æ–°å‚¨å­˜æ˜¾ç¤ºçš„å‡½æ•°
function updateStorageDisplay() {
    // æ›´æ–°ç©åŸºåœ°1çš„å‚¨å­˜æ˜¾ç¤º
    for (let i = 0; i < 5; i++) {
        const slot = document.getElementById(`p1-slot-${i+1}`);
        if (i < ballStorage.snake1.length) {
            slot.classList.add('filled');
            switch(ballStorage.snake1[i].type) {
                case 'immunity':
                    slot.style.background = 'linear-gradient(45deg, #FFFF00, #FFD700)';
                    slot.style.boxShadow = '0 0 10px #FFFF00';
                    break;
                case 'health':
                    slot.style.background = 'linear-gradient(45deg, #FF0000, #FF6B6B)';
                    slot.style.boxShadow = '0 0 10px #FF0000';
                    break;
                case 'reverse':
                    slot.style.background = 'linear-gradient(45deg, #800080, #DA70D6)';
                    slot.style.boxShadow = '0 0 10px #800080';
                    break;
                case 'attack':
                    slot.style.background = 'linear-gradient(45deg, #00BFFF, #87CEFA)'; // æµ…è“è‰²
                    slot.style.boxShadow = '0 0 10px #00BFFF';
                    break;
                case 'bomb':
                    slot.style.background = 'linear-gradient(45deg, #FF4500, #FF8C00)';
                    slot.style.boxShadow = '0 0 10px #FF4500';
                    break;
            
            }
        } else {
            slot.classList.remove('filled');
            slot.style.background = 'rgba(255, 255, 255, 0.2)';
            slot.style.boxShadow = 'none';
        }
    }
    
    // æ›´æ–°ç©åŸºåœ°2çš„å‚¨å­˜æ˜¾ç¤º
    for (let i = 0; i < 5; i++) {
        const slot = document.getElementById(`p2-slot-${i+1}`);
        if (i < ballStorage.snake2.length) {
            slot.classList.add('filled');
            switch(ballStorage.snake2[i].type) {
                case 'immunity':
                    slot.style.background = 'linear-gradient(45deg, #FFFF00, #FFD700)';
                    slot.style.boxShadow = '0 0 10px #FFFF00';
                    break;
                case 'health':
                    slot.style.background = 'linear-gradient(45deg, #FF0000, #FF6B6B)';
                    slot.style.boxShadow = '0 0 10px #FF0000';
                    break;
                case 'reverse':
                    slot.style.background = 'linear-gradient(45deg, #800080, #DA70D6)';
                    slot.style.boxShadow = '0 0 10px #800080';
                    break;
                case 'attack':
                    slot.style.background = 'linear-gradient(45deg, #00BFFF, #87CEFA)'; // æµ…è“è‰²
                    slot.style.boxShadow = '0 0 10px #00BFFF';
                    break;
                 case 'bomb':
                    slot.style.background = 'linear-gradient(45deg, #FF4500, #FF8C00)';
                    slot.style.boxShadow = '0 0 10px #FF4500';
                    break;    
            }
        } else {
            slot.classList.remove('filled');
            slot.style.background = 'rgba(255, 255, 255, 0.2)';
            slot.style.boxShadow = 'none';
        }
    }
}
    
    // æ›´æ–°ç©åŸºåœ°2çš„å‚¨å­˜æ˜¾ç¤º
    for (let i = 0; i < 5; i++) {
        const slot = document.getElementById(`p2-slot-${i+1}`);
        if (i < ballStorage.snake2.length) {
            slot.classList.add('filled');
            switch(ballStorage.snake2[i].type) {
                case 'immunity':
                    slot.style.background = 'linear-gradient(45deg, #FFFF00, #FFD700)';
                    slot.style.boxShadow = '0 0 10px #FFFF00';
                    break;
                case 'health':
                    slot.style.background = 'linear-gradient(45deg, #FF0000, #FF6B6B)';
                    slot.style.boxShadow = '0 0 10px #FF0000';
                    break;
                case 'reverse':
                    slot.style.background = 'linear-gradient(45deg, #800080, #DA70D6)';
                    slot.style.boxShadow = '0 0 10px #800080';
                    break;
            }
        } else {
            slot.classList.remove('filled');
            slot.style.background = 'rgba(255, 255, 255, 0.2)';
            slot.style.boxShadow = 'none';
        }
    }


// ç”Ÿæˆé£Ÿç‰©
function generateFood() {
    const boardWidth = gameBoard.clientWidth;
    const boardHeight = gameBoard.clientHeight;
    
    // ç¡®ä¿é£Ÿç‰©å‡ºç°åœ¨20pxçš„ç½‘æ ¼ä¸Š
    const maxX = Math.floor((boardWidth - 20) / 20);
    const maxY = Math.floor((boardHeight - 20) / 20);
    
    let validPosition = false;
    let foodX, foodY;
    let attempts = 0;
    const maxAttempts = 100; // é˜²æ­¢æ— é™å¾ªç¯
    
    while (!validPosition && attempts < maxAttempts) {
        attempts++;
        foodX = Math.floor(Math.random() * maxX) * 20;
        foodY = Math.floor(Math.random() * maxY) * 20;
        
        validPosition = true;
        
        // æ£€æŸ¥é£Ÿç‰©æ˜¯å¦ä¸è›‡é‡å 
        for (const snakeId in snakes) {
            for (const segment of snakes[snakeId]) {
                if (segment.x === foodX && segment.y === foodY) {
                    validPosition = false;
                    break;
                }
            }
            if (!validPosition) break;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ç°æœ‰é£Ÿç‰©é‡å 
        if (validPosition) {
            for (const food of foods) {
                if (food.x === foodX && food.y === foodY) {
                    validPosition = false;
                    break;
                }
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ç‰¹æ®Šç‰©å“é‡å 
        if (validPosition) {
            for (const item of specialItems) {
                if (item.x === foodX && item.y === foodY) {
                    validPosition = false;
                    break;
                }
            }
        }
        
        // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦åœ¨å¢™ä¸Š
        if (validPosition) {
            validPosition = !isPositionOnWall(foodX, foodY);
        }
    }
    
    if (validPosition) {
        foods.push({ 
            x: foodX, 
            y: foodY,
            type: Math.random() > 0.7 ? 'special' : 'normal'
        });
    } else {
        console.warn('æœªèƒ½æ‰¾åˆ°æœ‰æ•ˆä½ç½®ç”Ÿæˆé£Ÿç‰©');
    }
}

function drawSpecialItems() {
    specialItems.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'special-food';
        
        // æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒé¢œè‰²
        switch(item.type) {
            case 'immunity':
                itemElement.classList.add('immunity-ball'); // é»„è‰²
                break;
            case 'health':
                itemElement.classList.add('health-ball');   // çº¢è‰²
                break;
            case 'reverse':
                itemElement.classList.add('reverse-ball');  // ç´«è‰²
                break;
        }
        
        itemElement.style.left = `${item.x}px`;
        itemElement.style.top = `${item.y}px`;
        
        gameBoard.appendChild(itemElement);
    });
}    

// ç”Ÿæˆç‰¹æ®Šç‰©å“
function generateSpecialItem() {
    const boardWidth = gameBoard.clientWidth;
    const boardHeight = gameBoard.clientHeight;
    
    const maxX = Math.floor((boardWidth - 20) / 20);
    const maxY = Math.floor((boardHeight - 20) / 20);
    
    let validPosition = false;
    let itemX, itemY;
    let attempts = 0;
    const maxAttempts = 100;
    
    while (!validPosition && attempts < maxAttempts) {
        attempts++;
        itemX = Math.floor(Math.random() * maxX) * 20;
        itemY = Math.floor(Math.random() * maxY) * 20;
        
        validPosition = true;
        
        // æ£€æŸ¥æ˜¯å¦ä¸è›‡é‡å 
        for (const snakeId in snakes) {
            for (const segment of snakes[snakeId]) {
                if (segment.x === itemX && segment.y === itemY) {
                    validPosition = false;
                    break;
                }
            }
            if (!validPosition) break;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ç°æœ‰é£Ÿç‰©é‡å 
        if (validPosition) {
            for (const food of foods) {
                if (food.x === itemX && food.y === itemY) {
                    validPosition = false;
                    break;
                }
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ç°æœ‰ç‰¹æ®Šç‰©å“é‡å 
        if (validPosition) {
            for (const item of specialItems) {
                if (item.x === itemX && item.y === itemY) {
                    validPosition = false;
                    break;
                }
            }
        }
        
        // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦åœ¨å¢™ä¸Š
        if (validPosition) {
            validPosition = !isPositionOnWall(itemX, itemY);
        }
    }
    
    if (validPosition) {
        const itemTypes = ['immunity', 'health', 'reverse', 'attack'];
        const weights = [0, 0, 0, 1]; // å¹³å‡åˆ†é…æ¦‚ç‡
        let randomValue = Math.random();
        let selectedType = itemTypes[0];
        
        for (let i = 0; i < itemTypes.length; i++) {
            if (randomValue < weights[i]) {
                selectedType = itemTypes[i];
                break;
            }
            randomValue -= weights[i];
        }
        
        specialItems.push({ 
            x: itemX, 
            y: itemY,
            type: selectedType,
            spawnTime: performance.now()
        });
    } else {
        console.warn('æœªèƒ½æ‰¾åˆ°æœ‰æ•ˆä½ç½®ç”Ÿæˆç‰¹æ®Šç‰©å“');
    }
}

// ç»˜åˆ¶è›‡
function drawSnakes(withAnimation = false) {
    for (const snakeId in snakes) {
        const snake = snakes[snakeId];
        const isSnake1 = snakeId === 'snake1';
        
        snake.forEach((segment, index) => {
            const segmentElement = document.createElement('div');
            segmentElement.className = `snake-segment ${snakeId}`;
            
            // æ·»åŠ å†»ç»“æ•ˆæœ
            if (frozenSnakes[snakeId]) {
                segmentElement.classList.add('frozen-snake');
                if (index === 0) {
                    segmentElement.innerHTML = 'â„â„ï¸';
                    segmentElement.style.display = 'flex';
                    segmentElement.style.justifyContent = 'center';
                    segmentElement.style.alignItems = 'center';
                    segmentElement.style.fontSize = '14px';
                }
            }
            // æ·»åŠ å…ç–«æ•ˆæœè§†è§‰æç¤º
            if ((snakeId === 'snake1' && immunity.snake1) || 
                (snakeId === 'snake2' && immunity.snake2)) {
                segmentElement.style.boxShadow = '0 0 15px #FFFF00';
                segmentElement.style.animation = 'pulse 0.5s infinite alternate';
            }
            
            if (index === 0) segmentElement.classList.add('snake-head');
            
            if (withAnimation) {
                segmentElement.classList.add('snake-enter');
                segmentElement.style.animationDelay = `${index * 0.1}s`;
            }
            if (pausedSnakes[snakeId]) {
                segmentElement.style.opacity = '0.6';
                segmentElement.style.filter = 'grayscale(50%)';
                if (index === 0) { // è›‡å¤´æ·»åŠ æš‚åœå›¾æ ‡
                    segmentElement.innerHTML = 'â¸';
                    segmentElement.style.display = 'flex';
                    segmentElement.style.justifyContent = 'center';
                    segmentElement.style.alignItems = 'center';
                    segmentElement.style.fontSize = '14px';
                }
            }            
            segmentElement.style.left = `${segment.x}px`;
            segmentElement.style.top = `${segment.y}px`;
            
            gameBoard.appendChild(segmentElement);
        });
    }
}

// ç»˜åˆ¶é£Ÿç‰©
function drawFoods(withAnimation = false) {
    // ç»˜åˆ¶æ™®é€šé£Ÿç‰©å’Œç‰¹æ®Šé£Ÿç‰©
    foods.forEach(food => {
        const foodElement = document.createElement('div');
        foodElement.className = food.type === 'special' ? 'special-food' : 'food';
        
        if (withAnimation) {
            foodElement.classList.add('food-enter');
        }
        
        foodElement.style.left = `${food.x}px`;
        foodElement.style.top = `${food.y}px`;
        
        gameBoard.appendChild(foodElement);
    });
    
    // ç»˜åˆ¶ç‰¹æ®Šç‰©å“
    specialItems.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'special-food';
        
        // æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒæ ·å¼
        switch(item.type) {
            case 'immunity':
                itemElement.style.background = 'linear-gradient(45deg, #FFFF00, #FFD700)';
                itemElement.style.boxShadow = '0 0 15px #FFFF00';
                break;
            case 'health':
                itemElement.style.background = 'linear-gradient(45deg, #FF0000, #FF6B6B)';
                itemElement.style.boxShadow = '0 0 15px #FF0000';
                break;
            case 'reverse':
                itemElement.style.background = 'linear-gradient(45deg, #800080, #DA70D6)';
                itemElement.style.boxShadow = '0 0 15px #800080';
                break;
        }
        
        itemElement.style.left = `${item.x}px`;
        itemElement.style.top = `${item.y}px`;
        
        gameBoard.appendChild(itemElement);
    });
}
function handleHomes(timestamp) {
    for (const snakeId in snakes) {
        const head = snakes[snakeId][0];
        const playerNum = snakeId === 'snake1' ? 'player1' : 'player2';
        const opponentNum = snakeId === 'snake1' ? 'player2' : 'player1';
        
        // æ£€æŸ¥æ˜¯å¦åœ¨è‡ªå·±çš„åŸºåœ°ä¸­
        const inOwnHome = isPointInRect(head, homes[playerNum]);
        const inOpponentHome = isPointInRect(head, homes[opponentNum]);
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å…ç–«æ•ˆæœ
        const hasImmunity = (snakeId === 'snake1' && immunity.snake1) || 
                           (snakeId === 'snake2' && immunity.snake2);
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯åšç¡¬è›‡
        const isToughSnake = snakeId === 'snake1' ? snakeTypes.snake1 === 'tough' : snakeTypes.snake2 === 'tough';
        
        if (inOwnHome && !homes[playerNum].destroyed) {
            // åœ¨è‡ªå·±çš„åŸºåœ°ä¸­å›è¡€ï¼ˆå…ç–«ä¸å½±å“å›è¡€ï¼‰
            if (timestamp - homes[playerNum].lastHealTime > 1000) {
                const maxHealth = snakeTypes[snakeId] === 'tough' ? 15 : 10;
                if (health[snakeId] < maxHealth) {
                    health[snakeId] = Math.min(maxHealth, health[snakeId] + 1);
                    updateHealthBars();
                    
                    // æ˜¾ç¤ºå›è¡€æ•ˆæœ
                    showNotice('+1HP', '#4CAF50', 
                             homes[playerNum].x + homes[playerNum].width/2,
                             homes[playerNum].y + homes[playerNum].height/2);
                    
                    createParticles(
                        homes[playerNum].x + homes[playerNum].width/2,
                        homes[playerNum].y + homes[playerNum].height/2,
                        10,
                        '#4CAF50'
                    );
                }
                homes[playerNum].lastHealTime = timestamp;
            }
        } else if (inOpponentHome && !homes[opponentNum].destroyed) {
            // åœ¨å¯¹æ–¹åŸºåœ°ä¸­é€ æˆä¼¤å®³
            if (timestamp - homes[opponentNum].lastDamageTime > 1000) {
                
                let damageToHome = 1; // å¯¹åŸºåœ°çš„å›ºå®šä¼¤å®³
                let damageToSelf = 2; // å¯¹è‡ªå·±çš„ä¼¤å®³
                
                // å¦‚æœæ˜¯åšç¡¬è›‡ï¼Œè‡ªå·±å—åˆ°çš„ä¼¤å®³å‡åŠ
                if (isToughSnake) {
                    damageToSelf = Math.ceil(damageToSelf / 2);
                }
                
                if (!hasImmunity) {
                    // æ²¡æœ‰å…ç–«æ•ˆæœï¼šåŒæ–¹éƒ½æ‰è¡€
                    // å¯¹æ–¹åŸºåœ°æ‰è¡€ï¼ˆå›ºå®š1ç‚¹ï¼Œä¸å‡åŠï¼‰
                    homes[opponentNum].health = Math.max(0, homes[opponentNum].health - damageToHome);
                    
                    // è‡ªå·±æ‰è¡€ï¼ˆåšç¡¬è›‡å‡åŠï¼‰
                    health[snakeId] = Math.max(0, health[snakeId] - damageToSelf);
                    
                    // æ›´æ–°æ˜¾ç¤º
                    updateHealthBars();
                    
                    // æ˜¾ç¤ºä¼¤å®³æ•ˆæœ
                    let selfDamageMessage = `-${damageToSelf}HP`;
                    if (isToughSnake) {
                        selfDamageMessage += ' (åšç¡¬å‡åŠ)';
                        showNotice(`æ”»å‡»å¯¹æ–¹åŸºåœ°! ${selfDamageMessage}`, '#FFA500',
                                 homes[opponentNum].x + homes[opponentNum].width/2,
                                 homes[opponentNum].y + homes[opponentNum].height/2);
                        createParticles(head.x + 10, head.y + 10, 8, '#C0C0C0'); // é“¶è‰²ç²’å­
                    } else {
                        showNotice(`æ”»å‡»å¯¹æ–¹åŸºåœ°! ${selfDamageMessage}`, '#FF0000',
                                 homes[opponentNum].x + homes[opponentNum].width/2,
                                 homes[opponentNum].y + homes[opponentNum].height/2);
                        createParticles(head.x + 10, head.y + 10, 10, '#FF0000');
                    }
                    
                    // æ£€æŸ¥è‡ªå·±æ˜¯å¦æ­»äº¡
                    if (health[snakeId] <= 0) {
                        gameOver();
                    }
                } else {
                    // æœ‰å…ç–«æ•ˆæœï¼šåªå¯¹å¯¹æ–¹åŸºåœ°é€ æˆä¼¤å®³ï¼Œè‡ªå·±ä¸å—ä¼¤
                    homes[opponentNum].health = Math.max(0, homes[opponentNum].health - damageToHome);
                    
                    // æ˜¾ç¤ºå…ç–«æ”»å‡»æ•ˆæœ
                    showNotice('å…ç–«æ”»å‡»å¯¹æ–¹åŸºåœ°!', '#FFFF00',
                             homes[opponentNum].x + homes[opponentNum].width/2,
                             homes[opponentNum].y + homes[opponentNum].height/2);
                    
                    // åˆ›å»ºå…ç–«æ”»å‡»æ•ˆæœ
                    createParticles(
                        homes[opponentNum].x + homes[opponentNum].width/2,
                        homes[opponentNum].y + homes[opponentNum].height/2,
                        15,
                        '#FFFF00'
                    );
                }
                
                // æ£€æŸ¥åŸºåœ°æ˜¯å¦è¢«æ‘§æ¯ï¼ˆæ— è®ºæ˜¯å¦æœ‰å…ç–«ï¼‰
                if (homes[opponentNum].health <= 0) {
                    homes[opponentNum].destroyed = true;
                    const playerName = opponentNum === 'player1' ? 
                        (localStorage.getItem('username') || 'ç©åŸºåœ°1') : 
                        (localStorage.getItem('player2_username') || 'ç©åŸºåœ°2');
                    
                    showNotice(`${playerName}çš„åŸºåœ°è¢«æ‘§æ¯äº†!`, '#FF0000', 
                             homes[opponentNum].x + homes[opponentNum].width/2, 
                             homes[opponentNum].y + homes[opponentNum].height/2);
                    
                    // åŸºåœ°è¢«æ‘§æ¯çš„å¤§çˆ†ç‚¸æ•ˆæœ
                    createParticles(
                        homes[opponentNum].x + homes[opponentNum].width/2,
                        homes[opponentNum].y + homes[opponentNum].height/2,
                        30,
                        opponentNum === 'player1' ? '#FF5722' : '#2196F3'
                    );
                }
                
                homes[opponentNum].lastDamageTime = timestamp;
            }
        }
    }
}
        
        // æ£€æŸ¥ç‚¹æ˜¯å¦åœ¨çŸ©å½¢å†…
        function isPointInRect(point, rect) {
            return point.x >= rect.x && 
                   point.x <= rect.x + rect.width && 
                   point.y >= rect.y && 
                   point.y <= rect.y + rect.height;
        }
        
        // åœ¨clearBoardå‡½æ•°ä¸­æ·»åŠ æ¸…é™¤åŸºåœ°å…ƒç´ 
        function clearBoard() {
            document.querySelectorAll('.bullet').forEach(bullet => bullet.remove());
            document.querySelectorAll('.home-base').forEach(home => home.remove());
            while (gameBoard.firstChild) {
                gameBoard.removeChild(gameBoard.firstChild);
            }
        }
// æ¸¸æˆä¸»å¾ªç¯
function gameLoop(timestamp) {
    if (!gameStarted) return;
    
    if (currentMap === 'snow') {
        handleBlizzard(timestamp);
    } else if (currentMap === 'volcano') {
        handleVolcanoEruption(timestamp);
    }  
requestAnimationFrame(gameLoop);
                // å¤„ç†åŸºåœ°ç›¸å…³é€»è¾‘
    handleHomes(timestamp);
    // æ›´æ–°é­”æ³•è›‡è®¡æ—¶å™¨
    updateMagicSnakeTimers(timestamp);
    
    // æ›´æ–°çŠ¶æ€æ•ˆæœè®¡æ—¶å™¨
    updateStatusEffects(timestamp);
    
    // ç§»åŠ¨å­å¼¹
    moveBullets(timestamp);
        
    // ç”Ÿæˆç‰¹æ®Šç‰©å“
    if (timestamp - lastSpecialItemSpawn > (120 + Math.random() * 60) * 200) {
        generateSpecialItem();
        lastSpecialItemSpawn = timestamp;
    }
    
    // ç§»é™¤è¿‡æœŸçš„ç‰¹æ®Šç‰©å“ï¼ˆå­˜åœ¨30ç§’åæ¶ˆå¤±ï¼‰
    for (let i = specialItems.length - 1; i >= 0; i--) {
        if (timestamp - specialItems[i].spawnTime > 30000) {
            specialItems.splice(i, 1);
        }
    }
    
    // è®¡ç®—è›‡çš„é€Ÿåº¦ï¼ˆæ•´åˆæš´é£é›ªå‡é€Ÿæ•ˆæœï¼‰
    const snake1Speed = (snakeTypes.snake1 === 'speed' ? gameSpeed * 0.55 : 
                       (snakeTypes.snake1 === 'magic' ? gameSpeed * 0.85 : gameSpeed)) / 
                       (1 + speedBoosts.snake1) / 
                       (currentMap === 'snow' && blizzardActive && !immunity.snake1 ? snakeSpeedModifiers.snake1 : 1);
    
    const snake2Speed = (snakeTypes.snake2 === 'speed' ? gameSpeed * 0.55 : 
                       (snakeTypes.snake2 === 'magic' ? gameSpeed * 0.85 : gameSpeed)) / 
                       (1 + speedBoosts.snake2) / 
                       (currentMap === 'snow' && blizzardActive && !immunity.snake2 ? snakeSpeedModifiers.snake2 : 1);
    // ç§»åŠ¨è›‡1
    if (!pausedSnakes.snake1 && timestamp - lastMoveTime.snake1 > snake1Speed) {
        directions.snake1 = nextDirections.snake1;
        moveSnake('snake1');
        lastMoveTime.snake1 = timestamp;
    }
    
    // ç§»åŠ¨è›‡2ï¼ˆå¦‚æœæœªæš‚åœï¼‰
    if (!pausedSnakes.snake2 && timestamp - lastMoveTime.snake2 > snake2Speed) {
        directions.snake2 = nextDirections.snake2;
        moveSnake('snake2');
        lastMoveTime.snake2 = timestamp;
    }
    
    // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
    if (health.snake1 <= 0 || health.snake2 <= 0) {
        gameOver();
        return;
    }
    
    // æ£€æŸ¥å¢™ç¢°æ’
    checkWallCollisions(timestamp);
    // é‡æ–°ç»˜åˆ¶
    clearBoard();
    drawWalls();
    drawBullets(); // ç»˜åˆ¶å­å¼¹
    drawSpecialItems();
    drawVolcanoes();
    drawSnakes();
    drawHomes();
    drawFoods();
}
// åœ¨CSSä¸­æ·»åŠ 
const blizzardStyle = document.createElement('style');
blizzardStyle.textContent = `
    @keyframes blizzard-up {
        to { transform: translateY(-100vh); }
    }
    @keyframes blizzard-down {
        to { transform: translateY(100vh); }
    }
    @keyframes blizzard-left {
        to { transform: translateX(-100vw); }
    }
    @keyframes blizzard-right {
        to { transform: translateX(100vw); }
    }
    
    .blizzard-particle {
        position: absolute;
        border-radius: 50%;
        z-index: 1;
    }
    
    .frozen-snake {
        opacity: 0.7;
        filter: brightness(1.5) saturate(0.5);
        box-shadow: 0 0 10px #00BFFF;
    }
`;
document.head.appendChild(blizzardStyle);
function drawBlizzard() {
    if (!blizzardActive || !blizzardDirection) return;
    
    // åˆ›å»ºæš´é£é›ªç²’å­
    const particleCount = 30;
    const boardWidth = gameBoard.clientWidth;
    const boardHeight = gameBoard.clientHeight;
    
    for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'blizzard-particle';
        
        // æ ¹æ®æ–¹å‘è®¾ç½®ç²’å­åˆå§‹ä½ç½®å’ŒåŠ¨ç”»
        switch(blizzardDirection) {
            case 'up':
                particle.style.left = `${Math.random() * boardWidth}px`;
                particle.style.top = `${boardHeight}px`;
                particle.style.animation = `blizzard-up ${1 + Math.random() * 2}s linear`;
                break;
            case 'down':
                particle.style.left = `${Math.random() * boardWidth}px`;
                particle.style.top = `0px`;
                particle.style.animation = `blizzard-down ${1 + Math.random() * 2}s linear`;
                break;
            case 'left':
                particle.style.left = `${boardWidth}px`;
                particle.style.top = `${Math.random() * boardHeight}px`;
                particle.style.animation = `blizzard-left ${1 + Math.random() * 2}s linear`;
                break;
            case 'right':
                particle.style.left = `0px`;
                particle.style.top = `${Math.random() * boardHeight}px`;
                particle.style.animation = `blizzard-right ${1 + Math.random() * 2}s linear`;
                break;
        }
        
        // éšæœºå¤§å°
        const size = 3 + Math.random() * 7;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.backgroundColor = 'rgba(200, 240, 255, 0.7)';
        particle.style.boxShadow = '0 0 5px rgba(200, 240, 255, 0.9)';
        
        gameBoard.appendChild(particle);
        
        // åŠ¨ç”»ç»“æŸåç§»é™¤
        setTimeout(() => {
            particle.remove();
        }, 3000);
    }
}
// æš´é£é›ªå¤„ç†
function handleBlizzard(timestamp) {
    // æš´é£é›ªå‰5ç§’æ˜¾ç¤ºå†·é£æ–¹å‘
    if (!blizzardActive && timestamp > blizzardTimer - 5000 && timestamp < blizzardTimer) {
        if (!blizzardDirection) {
            // éšæœºé€‰æ‹©æš´é£é›ªæ–¹å‘
            const directions = ['up', 'down', 'left', 'right'];
            blizzardDirection = directions[Math.floor(Math.random() * directions.length)];
        }
        
        // æ˜¾ç¤ºå†·é£æ–¹å‘æç¤º
        const effect1 = document.getElementById('player1-effect');
        const effect2 = document.getElementById('player2-effect');
        effect1.textContent = `å†·é£æ¥è‡ª${getDirectionName(blizzardDirection)}!`;
        effect2.textContent = `å†·é£æ¥è‡ª${getDirectionName(blizzardDirection)}!`;
    }
    
    // å¼€å§‹æš´é£é›ª
    if (!blizzardActive && timestamp > blizzardTimer) {
        blizzardActive = true;
        coldWindTimer = timestamp;
        
        // æ˜¾ç¤ºæš´é£é›ªæç¤º
        showNotice(`æš´é£é›ªæ¥è¢­! æ¥è‡ª${getDirectionName(blizzardDirection)}`, '#00BFFF', 
                  gameBoard.clientWidth / 2, 20);
        
        // 10ç§’ååœæ­¢æš´é£é›ª
        setTimeout(() => {
            blizzardActive = false;
            blizzardDirection = null;
            blizzardTimer = timestamp + 30000; // 30ç§’åä¸‹æ¬¡æš´é£é›ª
            
            // é‡ç½®é€Ÿåº¦ä¿®æ”¹å™¨
            snakeSpeedModifiers.snake1 = 1;
            snakeSpeedModifiers.snake2 = 1;
            
            // ç§»é™¤æš´é£é›ªæ•ˆæœæ˜¾ç¤º
            document.getElementById('player1-effect').textContent = '';
            document.getElementById('player2-effect').textContent = '';
        }, 10000);
    }
    
    // æš´é£é›ªæœŸé—´å¤„ç†å‡é€Ÿå’Œå†»ç»“
    if (blizzardActive) {
        applyBlizzardEffects(timestamp);
    }
}

// è·å–æ–¹å‘åç§°
function getDirectionName(dir) {
    switch(dir) {
        case 'up': return 'ä¸Šæ–¹';
        case 'down': return 'ä¸‹æ–¹';
        case 'left': return 'å·¦ä¾§';
        case 'right': return 'å³ä¾§';
        default: return '';
    }
}

// åº”ç”¨æš´é£é›ªæ•ˆæœ
function applyBlizzardEffects(timestamp) {
    for (const snakeId in snakes) {
        // æ£€æŸ¥æ˜¯å¦æœ‰å…ç–«æ•ˆæœ
        if ((snakeId === 'snake1' && immunity.snake1) || 
            (snakeId === 'snake2' && immunity.snake2)) {
            continue; // å…ç–«æš´é£é›ªæ•ˆæœ
        }
        
        const head = snakes[snakeId][0];
        let affected = true;
        
        // æ£€æŸ¥æ˜¯å¦åœ¨å¢™åï¼ˆæœ‰é®æŒ¡ï¼‰
        for (const wall of walls) {
            for (const segment of wall.segments) {
                // æ ¹æ®æš´é£é›ªæ–¹å‘æ£€æŸ¥é®æŒ¡
                switch(blizzardDirection) {
                    case 'up':
                        if (segment.x === head.x && segment.y > head.y) affected = false;
                        break;
                    case 'down':
                        if (segment.x === head.x && segment.y < head.y) affected = false;
                        break;
                    case 'left':
                        if (segment.y === head.y && segment.x > head.x) affected = false;
                        break;
                    case 'right':
                        if (segment.y === head.y && segment.x < head.x) affected = false;
                        break;
                }
                if (!affected) break;
            }
            if (!affected) break;
        }
        
        if (affected) {
            // åº”ç”¨å‡é€Ÿæ•ˆæœ
            if (!frozenSnakes[snakeId]) {
                // æ¯2ç§’å‡é€Ÿä¸€æ¬¡
                if (timestamp - coldWindTimer > 2000) {
                    snakeSpeedModifiers[snakeId] = Math.max(0.2, snakeSpeedModifiers[snakeId] - 0.2);
                    coldWindTimer = timestamp;
                    
                    // æ˜¾ç¤ºå‡é€Ÿæç¤º
                    showNotice('é€Ÿåº¦ä¸‹é™!', '#00BFFF', head.x, head.y);
                    
                    // æ£€æŸ¥æ˜¯å¦å®Œå…¨å†»ç»“
                    if (snakeSpeedModifiers[snakeId] <= 0.2) {
                        frozenSnakes[snakeId] = true;
                        frozenSnakes[`timer${snakeId.slice(-1)}`] = timestamp + 4000; // å†»ç»“4ç§’
                        showNotice('è¢«å†»ä½äº†!', '#00BFFF', head.x, head.y);
                    }
                }
            }
        } else {
            // åœ¨å¢™åï¼Œé€æ¸æ¢å¤é€Ÿåº¦
            if (!frozenSnakes[snakeId]) {
                snakeSpeedModifiers[snakeId] = Math.min(1, snakeSpeedModifiers[snakeId] + 0.05);
            }
        }
        
        // å¤„ç†å†»ç»“çŠ¶æ€
        if (frozenSnakes[snakeId] && timestamp > frozenSnakes[`timer${snakeId.slice(-1)}`]) {
            frozenSnakes[snakeId] = false;
            snakeSpeedModifiers[snakeId] = 0.4; // è§£å†»ååˆå§‹é€Ÿåº¦ä¸º40%
            showNotice('è§£å†»äº†!', '#4CAF50', head.x, head.y);
        }
    }
}
function isPositionOnWall(x, y) {
    for (const wall of walls) {
        for (const segment of wall.segments) {
            if (segment.x === x && segment.y === y) {
                return true;
            }
        }
    }
    return false;
}
function generateVolcanoes() {
    const boardWidth = gameBoard.clientWidth;
    const boardHeight = gameBoard.clientHeight;
    const gridSize = 20;
    
    // æ¸…ç©ºç°æœ‰ç«å±±å’Œå²©æµ†
    volcanoes = [];
    lavaTiles = [];
    
    // ç”Ÿæˆ3-5ä¸ªç«å±±
    const volcanoCount = 4 + Math.floor(Math.random() * 3);
    
    for (let i = 0; i < volcanoCount; i++) {
        let validPosition = false;
        let volcanoX, volcanoY;
        let attempts = 0;
        
        while (!validPosition && attempts < 100) {
            attempts++;
            volcanoX = Math.floor(Math.random() * (boardWidth / gridSize - 2)) * gridSize;
            volcanoY = Math.floor(Math.random() * (boardHeight / gridSize - 2)) * gridSize;
            
            validPosition = true;
            
            // æ£€æŸ¥æ˜¯å¦ä¸è›‡é‡å 
            for (const snakeId in snakes) {
                for (const segment of snakes[snakeId]) {
                    if (Math.abs(segment.x - volcanoX) < 60 && Math.abs(segment.y - volcanoY) < 60) {
                        validPosition = false;
                        break;
                    }
                }
                if (!validPosition) break;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸å…¶ä»–ç«å±±å¤ªè¿‘
            if (validPosition) {
                for (const volcano of volcanoes) {
                    if (Math.abs(volcano.x - volcanoX) < 100 && Math.abs(volcano.y - volcanoY) < 100) {
                        validPosition = false;
                        break;
                    }
                }
            }
            
            // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦åœ¨åŸºåœ°åŒºåŸŸå†…
            if (validPosition) {
                if (isInHomeArea(volcanoX, volcanoY, homes.player1) || 
                    isInHomeArea(volcanoX, volcanoY, homes.player2)) {
                    validPosition = false;
                }
            }
        }
        
        if (validPosition) {
            volcanoes.push({
                x: volcanoX,
                y: volcanoY,
                warning: false
            });
        }
    }
}


// ç«å±±å–·å‘å¤„ç†
function handleVolcanoEruption(timestamp) {
    // å–·å‘å‰5ç§’è­¦å‘Š
    if (!isErupting && timestamp > nextEruptionTime - 5000 && timestamp < nextEruptionTime) {
        volcanoes.forEach(volcano => {
            volcano.warning = true;
        });
    }
    
    // å¼€å§‹å–·å‘
    if (!isErupting && timestamp > nextEruptionTime) {
        isErupting = true;
        lastEruptionTime = timestamp;
        
        // ç”Ÿæˆå²©æµ†
        generateLava();
        
        // 10ç§’ååœæ­¢å–·å‘
        setTimeout(() => {
            isErupting = false;
            lavaTiles = [];
            nextEruptionTime = timestamp + 30000; // 30ç§’åä¸‹æ¬¡å–·å‘
        }, 10000);
    }
    
    // æ£€æŸ¥å²©æµ†ä¼¤å®³
    if (isErupting) {
        checkLavaDamage(timestamp);
    }
}

// ç”Ÿæˆå²©æµ†
function generateLava() {
    lavaTiles = [];
    
    volcanoes.forEach(volcano => {
        // ç«å±±ä¸­å¿ƒ3x3åŒºåŸŸ
        for (let dx = -3; dx <= 3; dx++) {
            for (let dy = -3; dy <= 3; dy++) {
                const lavaX = volcano.x + dx * 20;
                const lavaY = volcano.y + dy * 20;
                
                // æ£€æŸ¥æ˜¯å¦åœ¨å¢™å
                let blockedByWall = false;
                for (const wall of walls) {
                    for (const segment of wall.segments) {
                        if (segment.x === lavaX && segment.y === lavaY) {
                            blockedByWall = true;
                            break;
                        }
                    }
                    if (blockedByWall) break;
                }
                
                if (!blockedByWall) {
                    lavaTiles.push({
                        x: lavaX,
                        y: lavaY,
                        spawnTime: performance.now()
                    });
                }
            }
        }
    });
}

// æ£€æŸ¥å²©æµ†ä¼¤å®³
// æ£€æŸ¥å²©æµ†ä¼¤å®³
function checkLavaDamage(timestamp) {
    for (const snakeId in snakes) {
        const head = snakes[snakeId][0];
        
        for (const lava of lavaTiles) {
            if (head.x === lava.x && head.y === lava.y) {
                // æ£€æŸ¥æ˜¯å¦æœ‰å…ç–«æ•ˆæœ
                const isImmune = (snakeId === 'snake1' && immunity.snake1) || 
                                (snakeId === 'snake2' && immunity.snake2);
                
                // æ¯ç§’é€ æˆ2ç‚¹ä¼¤å®³ï¼ˆå…ç–«çŠ¶æ€ä¸‹ä¸å—ä¼¤å®³ï¼‰
                if (timestamp - lava.spawnTime > 1000 && !isImmune) {
                    health[snakeId] -= 2;
                    updateHealthBars();
                    
                    // æ˜¾ç¤ºä¼¤å®³æç¤º
                    showNotice('-2HP', '#FF4500', head.x, head.y);
                    
                    // æ£€æŸ¥æ¸¸æˆç»“æŸ
                    if (health[snakeId] <= 0) {
                        gameOver();
                    }
                    
                    lava.spawnTime = timestamp;
                } else if (isImmune) {
                    // æ˜¾ç¤ºå…ç–«æç¤º
                    showNotice('å…ç–«å²©æµ†!', '#FFFF00', head.x, head.y);
                }
                break;
            }
        }
    }
}

// ç»˜åˆ¶ç«å±±å’Œå²©æµ†
function drawVolcanoes() {
    // ç»˜åˆ¶ç«å±±
    volcanoes.forEach(volcano => {
        const volcanoElement = document.createElement('div');
        volcanoElement.className = 'volcano';
        if (volcano.warning) {
            volcanoElement.classList.add('warning-volcano');
        }
        volcanoElement.style.left = `${volcano.x}px`;
        volcanoElement.style.top = `${volcano.y}px`;
        gameBoard.appendChild(volcanoElement);
    });
    
    // ç»˜åˆ¶å²©æµ†
    lavaTiles.forEach(lava => {
        const lavaElement = document.createElement('div');
        lavaElement.className = 'lava';
        lavaElement.style.left = `${lava.x}px`;
        lavaElement.style.top = `${lava.y}px`;
        gameBoard.appendChild(lavaElement);
    });
}
function checkWallCollisions(timestamp) {
    for (const snakeId in snakes) {
        const head = snakes[snakeId][0];
        const headCenterX = head.x + 10; // è›‡å¤´ä¸­å¿ƒXåæ ‡
        const headCenterY = head.y + 10; // è›‡å¤´ä¸­å¿ƒYåæ ‡
        
        // éå†æ‰€æœ‰å¢™
        for (let w = walls.length - 1; w >= 0; w--) {
            const wall = walls[w];
            
            // éå†å¢™çš„æ‰€æœ‰æ®µ
            for (let s = wall.segments.length - 1; s >= 0; s--) {
                const segment = wall.segments[s];
                const wallCenterX = segment.x + 10; // å¢™å—ä¸­å¿ƒXåæ ‡
                const wallCenterY = segment.y + 10; // å¢™å—ä¸­å¿ƒYåæ ‡
                
                // è®¡ç®—è›‡å¤´ä¸å¢™å—ä¸­å¿ƒçš„è·ç¦»
                const distance = Math.sqrt(
                    Math.pow(headCenterX - wallCenterX, 2) + 
                    Math.pow(headCenterY - wallCenterY, 2)
                );
                
                // è·ç¦»å°äº20åƒç´ å°±ç®—ç¢°æ’
                if (distance < 20) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°ç¢°æ’ï¼ˆé¿å…åŒä¸€é¢å¢™è¿ç»­æ‰£è¡€ï¼‰
                    if (timestamp - lastWallHitTime[snakeId] > 1000) {
                        lastWallHitTime[snakeId] = timestamp;
                        
                        if (!immunity[snakeId]) { // éå…ç–«çŠ¶æ€ä¸‹æ‰£è¡€
                            health[snakeId] -= 5; // ç›´æ¥æ‰£5è¡€
                            updateHealthBars();
                            
                            // æ˜¾ç¤ºæ’å¢™æç¤º
                            showNotice('æ’å¢™! -5HP', '#FF0000', head.x, head.y);
                        } else {
                            // å…ç–«çŠ¶æ€ä¸‹ä¸æ‰£è¡€
                            showNotice('æ— æ•Œæ’å¢™!', '#FFFF00', head.x, head.y);
                        }
                        
                        // æ— è®ºæ˜¯å¦å…ç–«ï¼Œéƒ½èƒ½æ’çƒ‚å¢™
                        createParticles(head.x + 10, head.y + 10, 10, '#FF0000');
                        wall.segments.splice(s, 1);
                        
                        // å¦‚æœè¿™é¢å¢™çš„æ‰€æœ‰æ®µéƒ½è¢«æ’çƒ‚äº†ï¼Œç§»é™¤æ•´é¢å¢™
                        if (wall.segments.length === 0) {
                            walls.splice(w, 1);
                        }
                        
                        // æ£€æŸ¥æ¸¸æˆç»“æŸï¼ˆåªåœ¨éå…ç–«çŠ¶æ€ä¸‹ï¼‰
                        if (!immunity[snakeId] && health[snakeId] <= 0) {
                            gameOver();
                        }
                    }
                    
                    // ç§»é™¤äº†å›å¼¹ä»£ç ï¼Œè›‡å¯ä»¥ç»§ç»­å‰è¿›
                    
                    break;
                }
            }
        }
    }
}

// ç»˜åˆ¶å¢™çš„å‡½æ•°ï¼ˆåœ¨drawSnakeså’ŒdrawFoodsä¹‹åè°ƒç”¨ï¼‰
function drawWalls() {
    walls.forEach(wall => {
        wall.segments.forEach(segment => {
            const wallElement = document.createElement('div');
            wallElement.className = 'wall-segment';
            wallElement.style.left = `${segment.x}px`;
            wallElement.style.top = `${segment.y}px`;
            wallElement.style.width = '20px';
            wallElement.style.height = '20px';
            wallElement.style.backgroundColor = '#555';
            wallElement.style.border = '1px solid #333';
            wallElement.style.position = 'absolute';
            wallElement.style.zIndex = '1';
            
            // æ·»åŠ é—ªçƒæ•ˆæœæç¤ºæ–°ç”Ÿæˆçš„å¢™
            const timeSinceSpawn = performance.now() - wall.spawnTime;
            if (timeSinceSpawn < 2000) {
                wallElement.style.animation = 'wallBlink 0.5s infinite';
            }
            
            gameBoard.appendChild(wallElement);
        });
    });
}

// åœ¨CSSä¸­æ·»åŠ å¢™çš„æ ·å¼
const wallStyle = document.createElement('style');
wallStyle.textContent = `
    @keyframes wallBlink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .wall-segment {
        background-color: #555;
        border: 1px solid #333;
        position: absolute;
        z-index: 1;
    }
`;
document.head.appendChild(wallStyle);
function updateMagicSnakeTimers(timestamp) {
    // æ£€æŸ¥ç©åŸºåœ°1æ˜¯å¦æ˜¯é­”æ³•è›‡
    if (snakeTypes.snake1 === 'magic' && timestamp - magicSnakeTimers.snake1 > 20000) {
        generateMagicBall('snake1');
        magicSnakeTimers.snake1 = timestamp;
    }
    
    // æ£€æŸ¥ç©åŸºåœ°2æ˜¯å¦æ˜¯é­”æ³•è›‡
    if (snakeTypes.snake2 === 'magic' && timestamp - magicSnakeTimers.snake2 > 20000) {
        generateMagicBall('snake2');
        magicSnakeTimers.snake2 = timestamp;
    }
}
function generateMagicBall(snakeId) {
    if (ballStorage[snakeId].length >= 5) {
        // å‚¨å­˜å·²æ»¡ï¼Œä¸ç”Ÿæˆæ–°çƒ
        return;
    }
    
    // æ ¹æ®æ¦‚ç‡åˆ†å¸ƒç”Ÿæˆçƒç±»å‹
    const randomValue = Math.random();
    let ballType;
    
    if (randomValue < 0.3) { // 30% æ”»å‡»çƒ
        ballType = 'attack';
    } else if (randomValue < 0.5) { // 20% è¡€çƒ
        ballType = 'health';
    } else if (randomValue < 0.6) { // 10% æ— æ•Œçƒ
        ballType = 'immunity';
    } else if (randomValue < 0.7) { // 10% åè½¬çƒ
        ballType = 'reverse';
    } else { // 30% ç‚¸å¼¹çƒ
        ballType = 'bomb';
    }
    
    // æ·»åŠ åˆ°å‚¨å­˜
    ballStorage[snakeId].push({ type: ballType });
    updateStorageDisplay();
    
    // æ˜¾ç¤ºæç¤º
    const head = snakes[snakeId][0];
    let message, color;
    switch(ballType) {
        case 'attack':
            message = 'è·å¾—æ”»å‡»çƒ!';
            color = '#00BFFF';
            break;
        case 'health':
            message = 'è·å¾—è¡€çƒ!';
            color = '#FF0000';
            break;
        case 'immunity':
            message = 'è·å¾—æ— æ•Œçƒ!';
            color = '#FFFF00';
            break;
        case 'reverse':
            message = 'è·å¾—åè½¬çƒ!';
            color = '#800080';
            break;
    }
    
    showNotice(message, color, head.x, head.y);
    createParticles(head.x + 10, head.y + 10, 15, color);
}
function drawBullets() {
    bullets.forEach(bullet => {
        const bulletElement = document.createElement('div');
        bulletElement.className = 'bullet';
        bulletElement.style.width = `${bullet.size}px`;
        bulletElement.style.height = `${bullet.size}px`;
        bulletElement.style.borderRadius = '50%';
        bulletElement.style.position = 'absolute';
        bulletElement.style.left = `${bullet.x}px`;
        bulletElement.style.top = `${bullet.y}px`;
        
        // æ ¹æ®ç©åŸºåœ°è®¾ç½®å­å¼¹é¢œè‰²
        if (bullet.player === 'snake1') {
            bulletElement.style.background = 'linear-gradient(45deg, #FF5722, #FF9800)';
            bulletElement.style.boxShadow = '0 0 5px #FF5722';
        } else {
            bulletElement.style.background = 'linear-gradient(45deg, #2196F3, #00BCD4)';
            bulletElement.style.boxShadow = '0 0 5px #2196F3';
        }
        
        gameBoard.appendChild(bulletElement);
    });
}
function checkBulletHitHome(bullet) {
    // æ ¹æ®å­å¼¹æ‰€å±ç©åŸºåœ°ç¡®å®šç›®æ ‡åŸºåœ°
    const targetHome = bullet.player === 'snake1' ? homes.player2 : homes.player1;
    
    // å¦‚æœç›®æ ‡åŸºåœ°å·²è¢«æ‘§æ¯ï¼Œè·³è¿‡æ£€æŸ¥
    if (targetHome.destroyed) return false;
    
    // æ£€æŸ¥å­å¼¹æ˜¯å¦åœ¨åŸºåœ°çš„èŒƒå›´å†…
    if (bullet.x >= targetHome.x && 
        bullet.x <= targetHome.x + targetHome.width &&
        bullet.y >= targetHome.y && 
        bullet.y <= targetHome.y + targetHome.height) {
        
        // å­å¼¹å¯¹åŸºåœ°é€ æˆä¼¤å®³
        targetHome.health = Math.max(0, targetHome.health - 0.5); // å­å¼¹é€ æˆ0.5ç‚¹ä¼¤å®³
        
        // æ˜¾ç¤ºä¼¤å®³æ•ˆæœ
        showNotice('-2HP', bullet.player === 'snake1' ? '#FF5722' : '#2196F3', 
                 targetHome.x + targetHome.width/2, targetHome.y + targetHome.height/2);
        
        // åˆ›å»ºå‡»ä¸­æ•ˆæœ
        createParticles(bullet.x, bullet.y, 15, bullet.player === 'snake1' ? '#FF5722' : '#2196F3');
        
        // æ£€æŸ¥åŸºåœ°æ˜¯å¦è¢«æ‘§æ¯
        if (targetHome.health <= 0) {
            targetHome.destroyed = true;
            const playerName = bullet.player === 'snake1' ? 
                (localStorage.getItem('player2_username') || 'ç©åŸºåœ°2') : 
                (localStorage.getItem('username') || 'ç©åŸºåœ°1');
            
            showNotice(`${playerName}çš„åŸºåœ°è¢«æ‘§æ¯äº†!`, '#FF0000', 
                     targetHome.x + targetHome.width/2, targetHome.y + targetHome.height/2);
            
            // åŸºåœ°è¢«æ‘§æ¯çš„å¤§çˆ†ç‚¸æ•ˆæœ
            createParticles(
                targetHome.x + targetHome.width/2,
                targetHome.y + targetHome.height/2,
                40,
                bullet.player === 'snake1' ? '#2196F3' : '#FF5722'
            );
        }
        
        return true; // å­å¼¹å·²å‡»ä¸­ç›®æ ‡
    }
    
    return false; // å­å¼¹æœªå‡»ä¸­
}

// æ›´æ–°çŠ¶æ€æ•ˆæœ
function updateStatusEffects(timestamp) {
    // æ›´æ–°å…ç–«çŠ¶æ€
    if (immunity.timer1 > 0 && timestamp > immunity.timer1) {
        immunity.snake1 = false;
        immunity.timer1 = 0;
        document.getElementById('player1-effect').textContent = '';
    }
    
    if (immunity.timer2 > 0 && timestamp > immunity.timer2) {
        immunity.snake2 = false;
        immunity.timer2 = 0;
        document.getElementById('player2-effect').textContent = '';
    }
    
    // æ›´æ–°åå‘æ§åˆ¶çŠ¶æ€
    if (reversedControls.timer1 > 0 && timestamp > reversedControls.timer1) {
        reversedControls.snake1 = false;
        reversedControls.timer1 = 0;
        document.getElementById('player1-effect').textContent = '';
    }
    
    if (reversedControls.timer2 > 0 && timestamp > reversedControls.timer2) {
        reversedControls.snake2 = false;
        reversedControls.timer2 = 0;
        document.getElementById('player2-effect').textContent = '';
    }
    
    // æ›´æ–°æ”»å‡»æ¨¡å¼çŠ¶æ€
    if (attackMode.timer1 > 0 && timestamp > attackMode.timer1) {
        attackMode.snake1 = false;
        attackMode.timer1 = 0;
        if (attackMode.intervalId1) clearInterval(attackMode.intervalId1);
        document.getElementById('player1-effect').textContent = '';
    }

    if (attackMode.timer2 > 0 && timestamp > attackMode.timer2) {
        attackMode.snake2 = false;
        attackMode.timer2 = 0;
        if (attackMode.intervalId2) clearInterval(attackMode.intervalId2);
        document.getElementById('player2-effect').textContent = '';
}
    
    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    updateStatusDisplay();
}
function fireBullet(snakeId) {
    if ((snakeId === 'snake1' && !attackMode.snake1) || 
        (snakeId === 'snake2' && !attackMode.snake2)) {
        return;
    }
    
    const currentTime = performance.now();
    const lastShot = snakeId === 'snake1' ? attackMode.lastShot1 : attackMode.lastShot2;
    
    // æ›´æ–°æœ€åå‘å°„æ—¶é—´
    if (snakeId === 'snake1') {
        attackMode.lastShot1 = currentTime;
    } else {
        attackMode.lastShot2 = currentTime;
    }
    
    const head = snakes[snakeId][0];
    const direction = directions[snakeId];
    
    // åˆ›å»ºå­å¼¹
    const bullet = {
        x: head.x,
        y: head.y,
        direction: direction,
        player: snakeId,
        speed: 30, // æ¯ç§’ç§»åŠ¨10ä¸ªåƒç´ 
        size: 8 // å­å¼¹å¤§å°
    };
    
    bullets.push(bullet);
    
    // æ’­æ”¾å‘å°„éŸ³æ•ˆæˆ–åŠ¨ç”»
    createParticles(head.x + 10, head.y + 10, 10, '#FF0000');
}
function moveBullets(timestamp) {
    for (let i = bullets.length - 1; i >= 0; i--) {
        const bullet = bullets[i];
        
        // æ ¹æ®æ–¹å‘ç§»åŠ¨å­å¼¹
        switch (bullet.direction) {
            case 'up':
                bullet.y -= bullet.speed;
                break;
            case 'down':
                bullet.y += bullet.speed;
                break;
            case 'left':
                bullet.x -= bullet.speed;
                break;
            case 'right':
                bullet.x += bullet.speed;
                break;
     
        }
            if (checkBulletHitHome(bullet)) {
            bullets.splice(i, 1);
            continue;
        } 
        // æ£€æŸ¥æ˜¯å¦è¶…å‡ºè¾¹ç•Œ
        const boardWidth = gameBoard.clientWidth;
        const boardHeight = gameBoard.clientHeight;
        
        if (bullet.x < 0 || bullet.x >= boardWidth || 
            bullet.y < 0 || bullet.y >= boardHeight) {
            bullets.splice(i, 1);
            continue;
        }
        
        // æ£€æŸ¥æ˜¯å¦å‡»ä¸­å¢™
        let hitWall = false;
        for (const wall of walls) {
            for (const segment of wall.segments) {
                const distance = Math.sqrt(
                    Math.pow(bullet.x - segment.x - 10, 2) + 
                    Math.pow(bullet.y - segment.y - 10, 2)
                );
                
                if (distance < 15) { // å­å¼¹ä¸å¢™å—ç¢°æ’æ£€æµ‹
                    hitWall = true;
                    // å­å¼¹å‡»ä¸­å¢™çš„ç‰¹æ•ˆ
                    createParticles(bullet.x, bullet.y, 5, '#FFFFFF');
                    break;
                }
            }
            if (hitWall) break;
        }
        
        if (hitWall) {
            bullets.splice(i, 1);
            continue;
        }
        
        // æ£€æŸ¥æ˜¯å¦å‡»ä¸­å¯¹æ–¹è›‡
        const targetSnakeId = bullet.player === 'snake1' ? 'snake2' : 'snake1';
        const targetSnake = snakes[targetSnakeId];
        
        for (let j = 0; j < targetSnake.length; j++) {
            const segment = targetSnake[j];
            const distance = Math.sqrt(Math.pow(bullet.x - segment.x, 2) + Math.pow(bullet.y - segment.y, 2));
            
            if (distance < (20 + bullet.size) / 2) {
                // å‡»ä¸­ç›®æ ‡
                bullets.splice(i, 1);
                
                // å¦‚æœç›®æ ‡æœ‰å…ç–«æ•ˆæœï¼Œåˆ™ä¸é€ æˆä¼¤å®³
                if ((targetSnakeId === 'snake1' && immunity.snake1) || 
                    (targetSnakeId === 'snake2' && immunity.snake2)) {
                    showNotice('å…ç–«å­å¼¹!', '#FFFF00', segment.x, segment.y);
                    createParticles(segment.x + 10, segment.y + 10, 15, '#FFFF00');
                } 
                // å¦‚æœæ˜¯åšç¡¬è›‡ï¼Œæœ‰50%æ¦‚ç‡å…ç–«å­å¼¹ä¼¤å®³
                else if ((targetSnakeId === 'snake1' && snakeTypes.snake1 === 'tough' && Math.random() < 0.5) ||
                        (targetSnakeId === 'snake2' && snakeTypes.snake2 === 'tough' && Math.random() < 0.5)) {
                    showNotice('åšç¡¬å…ç–«!', '#C0C0C0', segment.x, segment.y);
                    createParticles(segment.x + 10, segment.y + 10, 15, '#C0C0C0');
                }
                else {
                    // é€ æˆ0.5ç‚¹ä¼¤å®³
                    health[targetSnakeId] -= 0.5;
                    updateHealthBars();
                    
                    // æ˜¾ç¤ºä¼¤å®³æç¤º
                    showNotice('-0.5HP', '#FF0000', segment.x, segment.y);
                    createParticles(segment.x + 10, segment.y + 10, 20, '#FF0000');
                    
                    // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
                    if (health.snake1 <= 0 || health.snake2 <= 0) {
                        gameOver();
                    }
                }
                break;
            }
        }
    }
}
// æ›´æ–°çŠ¶æ€æ˜¾ç¤º
function updateStatusDisplay() {
    const effect1 = document.getElementById('player1-effect');
    const effect2 = document.getElementById('player2-effect');
    
    effect1.textContent = '';
    effect2.textContent = '';
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯é­”æ³•è›‡
    const isMagicSnake1 = snakeTypes.snake1 === 'magic';
    const isMagicSnake2 = snakeTypes.snake2 === 'magic';
    
    if (immunity.snake1) {
        effect1.textContent += 'å…ç–«' + (isMagicSnake1 ? ' (é­”æ³•)' : '') + ' ';
    }
    if (reversedControls.snake1) {
        effect1.textContent += 'åå‘æ§åˆ¶' + (isMagicSnake1 ? ' (é­”æ³•)' : '') + ' ';
    }
    if (attackMode.snake1) {
        effect1.textContent += 'æ”»å‡»æ¨¡å¼' + (isMagicSnake1 ? ' (é­”æ³•)' : '') + ' ';
    }
    
    if (immunity.snake2) {
        effect2.textContent += 'å…ç–«' + (isMagicSnake2 ? ' (é­”æ³•)' : '') + ' ';
    }
    if (reversedControls.snake2) {
        effect2.textContent += 'åå‘æ§åˆ¶' + (isMagicSnake2 ? ' (é­”æ³•)' : '') + ' ';
    }
    if (attackMode.snake2) {
        effect2.textContent += 'æ”»å‡»æ¨¡å¼' + (isMagicSnake2 ? ' (é­”æ³•)' : '') + ' ';
    }
        // æ£€æŸ¥æ˜¯å¦æ˜¯åšç¡¬è›‡
    const isToughSnake1 = snakeTypes.snake1 === 'tough';
    const isToughSnake2 = snakeTypes.snake2 === 'tough';
    
    // æ˜¾ç¤ºåšç¡¬è›‡çŠ¶æ€
    if (isToughSnake1) {
        effect1.textContent += 'åšç¡¬(ä¼¤å®³å‡åŠ) ';
    }
    if (isToughSnake2) {
        effect2.textContent += 'åšç¡¬(ä¼¤å®³å‡åŠ) ';
    }
}

// ç§»åŠ¨è›‡
function moveSnake(snakeId) {
    const snake = snakes[snakeId];
    const direction = directions[snakeId];
    
    // ç§»åŠ¨è›‡
    const head = { ...snake[0] };
    
    switch (direction) {
        case 'up':
            head.y -= 20;
            break;
        case 'down':
            head.y += 20;
            break;
        case 'left':
            head.x -= 20;
            break;
        case 'right':
            head.x += 20;
            break;
    }
    
    // ç©¿å¢™é€»è¾‘
    const boardWidth = gameBoard.clientWidth;
    const boardHeight = gameBoard.clientHeight;
    
    if (head.x < 0) head.x = boardWidth - 20;
    if (head.x >= boardWidth) head.x = 0;
    if (head.y < 0) head.y = boardHeight - 20;
    if (head.y >= boardHeight) head.y = 0;
    
    const otherSnakeId = snakeId === 'snake1' ? 'snake2' : 'snake1';
    const collisionResult = checkOtherSnakeCollision(otherSnakeId, head);
    
    // æ£€æŸ¥å½“å‰è›‡æ˜¯å¦æœ‰å…ç–«æ•ˆæœ
    const isImmune = (snakeId === 'snake1' && immunity.snake1) || 
                     (snakeId === 'snake2' && immunity.snake2);
    
    // æ£€æŸ¥å¯¹æ–¹è›‡æ˜¯å¦æœ‰å…ç–«æ•ˆæœ
    const isOtherImmune = (otherSnakeId === 'snake1' && immunity.snake1) || 
                         (otherSnakeId === 'snake2' && immunity.snake2);
    
// åœ¨ moveSnake å‡½æ•°ä¸­ä¿®æ”¹ç¢°æ’å¤„ç†éƒ¨åˆ†
        if (collisionResult.collided) {
            if (collisionResult.isHeadCollision) {
                // è›‡å¤´ç›¸æ’å¤„ç†
                if (!isImmune && !isOtherImmune) {
                    // åŒæ–¹éƒ½æ²¡æœ‰å…ç–«ï¼Œéƒ½æ‰£è¡€
                    // å¦‚æœæ˜¯åšç¡¬è›‡ï¼Œé€ æˆåŒå€ä¼¤å®³
                    const damage1 = snakeTypes.snake1 === 'tough' ? 5 : 1;
                    const damage2 = snakeTypes.snake2 === 'tough' ? 5 : 1;
                    
                    health.snake1 -= damage2;
                    health.snake2 -= damage1;
                    updateHealthBars();
                    
                    // åŒæ–¹ç¢°æ’ç‰¹æ•ˆ
                    createParticles(head.x + 10, head.y + 10, 30, '#FF0000');
                    createParticles(snakes[otherSnakeId][0].x + 10, snakes[otherSnakeId][0].y + 10, 30, '#FF0000');
                    
                    // æ˜¾ç¤ºåŒæ–¹ä¼¤å®³æç¤º
                    showNotice(`-${damage1}HP`, '#FF0000', head.x, head.y);
                    showNotice(`-${damage2}HP`, '#FF0000', snakes[otherSnakeId][0].x, snakes[otherSnakeId][0].y);
                } else if (isImmune && !isOtherImmune) {
                    // åªæœ‰å½“å‰è›‡æœ‰å…ç–«ï¼Œåªæ‰£å¯¹æ–¹è¡€
                    const damage = snakeTypes[otherSnakeId] === 'tough' ? 2 : 1;
                    health[otherSnakeId] -= damage;
                    updateHealthBars();
                    
                    // æ˜¾ç¤ºå…ç–«æç¤ºå’Œä¼¤å®³æç¤º
                    showNotice('å…ç–«!', '#FFFF00', head.x, head.y);
                    showNotice(`-${damage}HP`, '#FF0000', snakes[otherSnakeId][0].x, snakes[otherSnakeId][0].y);
                    
                    // ç‰¹æ•ˆ
                    createParticles(head.x + 10, head.y + 10, 15, '#FFFF00');
                    createParticles(snakes[otherSnakeId][0].x + 10, snakes[otherSnakeId][0].y + 10, 30, '#FF0000');
                } else if (!isImmune && isOtherImmune) {
                    // åªæœ‰å¯¹æ–¹è›‡æœ‰å…ç–«ï¼Œåªæ‰£å½“å‰è›‡è¡€
                    const damage = snakeTypes[snakeId] === 'tough' ? 2 : 1;
                    health[snakeId] -= damage;
                    updateHealthBars();
                    
                    // æ˜¾ç¤ºå…ç–«æç¤ºå’Œä¼¤å®³æç¤º
                    showNotice(`-${damage}HP`, '#FF0000', head.x, head.y);
                    showNotice('å…ç–«!', '#FFFF00', snakes[otherSnakeId][0].x, snakes[otherSnakeId][0].y);
                    
                    // ç‰¹æ•ˆ
                    createParticles(head.x + 10, head.y + 10, 30, '#FF0000');
                    createParticles(snakes[otherSnakeId][0].x + 10, snakes[otherSnakeId][0].y + 10, 15, '#FFFF00');
                } else {
                    // åŒæ–¹éƒ½æœ‰å…ç–«ï¼Œéƒ½ä¸æ‰£è¡€
                    showNotice('å…ç–«!', '#FFFF00', head.x, head.y);
                    showNotice('å…ç–«!', '#FFFF00', snakes[otherSnakeId][0].x, snakes[otherSnakeId][0].y);
                    
                    // ç‰¹æ•ˆ
                    createParticles(head.x + 10, head.y + 10, 15, '#FFFF00');
                    createParticles(snakes[otherSnakeId][0].x + 10, snakes[otherSnakeId][0].y + 10, 15, '#FFFF00');
                }
            } else if (!isImmune) {
                // æ™®é€šç¢°æ’ï¼šæ’çš„è›‡æ‰£è¡€ï¼Œè¢«æ’çš„è›‡æˆªæ–­
                // å¦‚æœæ˜¯åšç¡¬è›‡ï¼Œé€ æˆåŒå€ä¼¤å®³
                const damage = snakeTypes[snakeId] === 'tough' ? 2 : 1;
                health[snakeId] -= damage;
                updateHealthBars();
                
                // è¢«æ’çš„è›‡ä»ç¢°æ’ç‚¹å¼€å§‹æˆªæ–­
                snakes[otherSnakeId] = snakes[otherSnakeId].slice(0, collisionResult.collisionIndex);
                
                // ç¢°æ’ç‰¹æ•ˆ
                createParticles(head.x + 10, head.y + 10, 20, snakeId === 'snake1' ? '#FF5722' : '#2196F3');
                
                // æ˜¾ç¤ºä¼¤å®³æç¤º
                showNotice(`-${damage}HP`, snakeId === 'snake1' ? '#FF5722' : '#2196F3', head.x, head.y);
            } else {
                // å¦‚æœæœ‰å…ç–«æ•ˆæœï¼Œæ˜¾ç¤ºå…ç–«æç¤ºï¼Œä¸æ‰£è¡€
                showNotice('å…ç–«!', '#FFFF00', head.x, head.y);
                createParticles(head.x + 10, head.y + 10, 15, '#FFFF00');
            }
        }
    
    // æ£€æŸ¥æ˜¯å¦åƒåˆ°é£Ÿç‰©ï¼ˆä½¿ç”¨è·ç¦»åˆ¤æ–­ï¼‰
    // æ£€æŸ¥æ˜¯å¦åƒåˆ°é£Ÿç‰©ï¼ˆä½¿ç”¨è·ç¦»åˆ¤æ–­ï¼‰
    let ateFood = false;
    for (let i = 0; i < foods.length; i++) {
        const food = foods[i];
        const distance = Math.sqrt(Math.pow(head.x - food.x, 2) + Math.pow(head.y - food.y, 2));
        if (distance < 20) {
            // æ’­æ”¾åƒé£Ÿç‰©åŠ¨ç”»
            createParticles(food.x + 10, food.y + 10, 20, food.type === 'special' ? '#FFD700' : '#4CAF50');
            
            // ç§»é™¤è¢«åƒçš„é£Ÿç‰©
            foods.splice(i, 1);
            
            if (food.type === 'special') {
                // ç‰¹æ®Šé£Ÿç‰©ï¼šåŠ 100åˆ†å¹¶å‚¨å­˜
                scores[snakeId] += 100;
                updateScoreDisplay();
                
                // ç‰¹æ®Šé£Ÿç‰©å‚¨å­˜ä¸ºéšæœºç‰¹æ®Šçƒ
                const specialTypes = ['immunity', 'health', 'reverse',"bomb"];
                const randomType = specialTypes[Math.floor(Math.random() * specialTypes.length)];
                
                if (ballStorage[snakeId].length < 5) {
                    ballStorage[snakeId].push({type: randomType});
                    showNotice('+100åˆ†! å·²å‚¨å­˜!', '#FFD700', head.x, head.y);
                } else {
                    showNotice('+100åˆ†! å‚¨å­˜å·²æ»¡!', '#FF0000', head.x, head.y);
                }
            } else {
                // æ™®é€šé£Ÿç‰©ï¼šåŠ 10åˆ†ï¼Œè›‡èº«å¢é•¿ï¼Œé€Ÿåº¦å¢åŠ 3%ï¼ˆæœ€å¤š15%ï¼‰
                scores[snakeId] += 10;
                updateScoreDisplay();
                
                // å¢åŠ é€Ÿåº¦ï¼ˆæœ€å¤š15%ï¼‰
                if (speedBoosts[snakeId] < 0.3) {
                    speedBoosts[snakeId] = Math.min(0.30, speedBoosts[snakeId] + 0.03);
                    showNotice('+10åˆ†! é€Ÿåº¦+3%', '#4CAF50', head.x, head.y);
                } else {
                    showNotice('+10åˆ†! é€Ÿåº¦å·²è¾¾ä¸Šé™', '#4CAF50', head.x, head.y);
                }
                
                ateFood = true; // è›‡èº«å¢é•¿
            }
            
            // æ›´æ–°å‚¨å­˜æ˜¾ç¤º
            updateStorageDisplay();
            
            // ç”Ÿæˆæ–°é£Ÿç‰©
            generateFood();
            
            break;
        }
    }
    
    // æ£€æŸ¥æ˜¯å¦åƒåˆ°ç‰¹æ®Šç‰©å“
    let ateSpecialItem = false;
    for (let i = 0; i < specialItems.length; i++) {
        const item = specialItems[i];
        const distance = Math.sqrt(Math.pow(head.x - item.x, 2) + Math.pow(head.y - item.y, 2));
        if (distance < 20) {
            // æ’­æ”¾åƒç‰¹æ®Šç‰©å“åŠ¨ç”»
            createParticles(item.x + 10, item.y + 10, 30, 
                item.type === 'immunity' ? '#FFFF00' : 
                item.type === 'health' ? '#FF0000' : '#800080');
            
            // åº”ç”¨ç‰¹æ®Šç‰©å“æ•ˆæœ
            applySpecialItemEffect(snakeId, item.type);
            
            // ç§»é™¤è¢«åƒçš„ç‰¹æ®Šç‰©å“
            specialItems.splice(i, 1);
            
            ateSpecialItem = true;
            break;
        }
    }
    
    // å°†æ–°å¤´éƒ¨æ·»åŠ åˆ°è›‡èº«
    snake.unshift(head);
    
    // å¦‚æœæ²¡æœ‰åƒåˆ°é£Ÿç‰©æˆ–ç‰¹æ®Šç‰©å“ï¼Œç§»é™¤å°¾éƒ¨
    if (!ateFood && !ateSpecialItem) {
        snake.pop();
    }
}
// æ·»åŠ CSSæ ·å¼
const bombStyle = document.createElement('style');
bombStyle.textContent = `
    /* ç‚¸å¼¹çˆ†ç‚¸æ•ˆæœ */
    .bomb-wave {
        animation: bombWave 1s forwards;
    }
    
    @keyframes bombWave {
        0% { 
            transform: translate(-50%, -50%) scale(0);
            opacity: 1;
        }
        100% { 
            transform: translate(-50%, -50%) scale(10);
            opacity: 0;
        }
    }
    
    /* ç‚¸å¼¹çƒé¢œè‰²æç¤º */
    .ball-slot.filled[style*="FF4500"] {
        position: relative;
    }
    
    .ball-slot.filled[style*="FF4500"]::before {
        content: "ğŸ’£";
        font-size: 14px;
    }
`;
document.head.appendChild(bombStyle);
// åº”ç”¨ç‰¹æ®Šç‰©å“æ•ˆæœ
function applySpecialItemEffect(snakeId, itemType) {
    const currentTime = performance.now();
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯é­”æ³•è›‡ï¼Œå¦‚æœæ˜¯åˆ™å»¶é•¿æ•ˆæœæ—¶é—´50%
    const isMagicSnake = snakeId === 'snake1' ? snakeTypes.snake1 === 'magic' : snakeTypes.snake2 === 'magic';
    const timeMultiplier = isMagicSnake ? 1.5 : 1; // é­”æ³•è›‡æ•ˆæœæ—¶é—´å»¶é•¿50%
    
    switch(itemType) {
        case 'immunity':
            // å…ç–«æ•ˆæœï¼š10ç§’å†…å®Œå…¨å…ç–«ï¼ˆé”è¡€ï¼‰ï¼Œé­”æ³•è›‡ä¸º15ç§’
            const immunityDuration = 10000 * timeMultiplier;
            if (snakeId === 'snake1') {
                immunity.snake1 = true;
                immunity.timer1 = currentTime + immunityDuration;
                document.getElementById('player1-effect').textContent = 'å…ç–«' + (isMagicSnake ? ' (é­”æ³•)' : '');
                showNotice('å®Œå…¨å…ç–«æ¿€æ´»!' + (isMagicSnake ? ' (é­”æ³•å»¶é•¿)' : ''), '#FFFF00', snakes.snake1[0].x, snakes.snake1[0].y);
            } else {
                immunity.snake2 = true;
                immunity.timer2 = currentTime + immunityDuration;
                document.getElementById('player2-effect').textContent = 'å…ç–«' + (isMagicSnake ? ' (é­”æ³•)' : '');
                showNotice('å®Œå…¨å…ç–«æ¿€æ´»!' + (isMagicSnake ? ' (é­”æ³•å»¶é•¿)' : ''), '#FFFF00', snakes.snake2[0].x, snakes.snake2[0].y);
            }
            break;
            
        case 'health':
            // åŠ è¡€æ•ˆæœï¼šå¢åŠ 0.5ç‚¹ç”Ÿå‘½å€¼
            const maxHealth = snakeId === 'snake1' ? (snakeTypes.snake1 === 'tough' ? 15 : 10) : (snakeTypes.snake2 === 'tough' ? 15 : 10);
            health[snakeId] = Math.min(maxHealth, health[snakeId] + 5);
            updateHealthBars();
            showNotice('+0.5HP', '#FF0000', 
                snakeId === 'snake1' ? snakes.snake1[0].x : snakes.snake2[0].x, 
                snakeId === 'snake1' ? snakes.snake1[0].y : snakes.snake2[0].y);
            break;
            
        case 'reverse':
            // åå‘æ§åˆ¶æ•ˆæœï¼šå¯¹æ‰‹æ§åˆ¶åå‘ï¼Œé­”æ³•è›‡ä¸º22.5ç§’
            const reverseDuration = 8000 * timeMultiplier;
            const opponentId = snakeId === 'snake1' ? 'snake2' : 'snake1';
            if (opponentId === 'snake1') {
                reversedControls.snake1 = true;
                reversedControls.timer1 = currentTime + reverseDuration;
                document.getElementById('player1-effect').textContent = 'åå‘æ§åˆ¶' + (isMagicSnake ? ' (é­”æ³•)' : '');
                showNotice('æ§åˆ¶åå‘!' + (isMagicSnake ? ' (é­”æ³•å»¶é•¿)' : ''), '#800080', snakes.snake1[0].x, snakes.snake1[0].y);
            } else {
                reversedControls.snake2 = true;
                reversedControls.timer2 = currentTime + reverseDuration;
                document.getElementById('player2-effect').textContent = 'åå‘æ§åˆ¶' + (isMagicSnake ? ' (é­”æ³•)' : '');
                showNotice('æ§åˆ¶åå‘!' + (isMagicSnake ? ' (é­”æ³•å»¶é•¿)' : ''), '#800080', snakes.snake2[0].x, snakes.snake2[0].y);
            }
            break;
            
        case 'attack':
            // æ”»å‡»çƒï¼šå­˜å‚¨èµ·æ¥ï¼Œè€Œä¸æ˜¯ç«‹å³ä½¿ç”¨
            if (ballStorage[snakeId].length < 5) {
                ballStorage[snakeId].push({type: 'attack'});
                updateStorageDisplay();
                showNotice('æ”»å‡»çƒå·²å‚¨å­˜!', '#00BFFF', 
                    snakeId === 'snake1' ? snakes.snake1[0].x : snakes.snake2[0].x, 
                    snakeId === 'snake1' ? snakes.snake1[0].y : snakes.snake2[0].y);
            } else {
                showNotice('å‚¨å­˜å·²æ»¡!', '#FF0000', 
                    snakeId === 'snake1' ? snakes.snake1[0].x : snakes.snake2[0].x, 
                    snakeId === 'snake1' ? snakes.snake1[0].y : snakes.snake2[0].y);
            }
            break;
            case 'bomb':
            // ç‚¸å¼¹çƒï¼šå­˜å‚¨èµ·æ¥ï¼Œè€Œä¸æ˜¯ç«‹å³ä½¿ç”¨
            if (ballStorage[snakeId].length < 5) {
                ballStorage[snakeId].push({type: 'bomb'});
                updateStorageDisplay();
                showNotice('ç‚¸å¼¹çƒå·²å‚¨å­˜!', '#FF4500', 
                    snakeId === 'snake1' ? snakes.snake1[0].x : snakes.snake2[0].x, 
                    snakeId === 'snake1' ? snakes.snake1[0].y : snakes.snake2[0].y);
            } else {
                showNotice('å‚¨å­˜å·²æ»¡!', '#FF0000', 
                    snakeId === 'snake1' ? snakes.snake1[0].x : snakes.snake2[0].x, 
                    snakeId === 'snake1' ? snakes.snake1[0].y : snakes.snake2[0].y);
            }
            break;    
    }
}

function releaseBall(snakeId, slotIndex) {
    if (ballStorage[snakeId].length > slotIndex) {
        const ball = ballStorage[snakeId][slotIndex];
        
        // ä»å‚¨å­˜ä¸­ç§»é™¤
        ballStorage[snakeId].splice(slotIndex, 1);
        updateStorageDisplay();
        
        // å¦‚æœæ˜¯æ”»å‡»çƒï¼Œæ¿€æ´»æ”»å‡»æ¨¡å¼
        if (ball.type === 'bomb') {
            triggerBomb(snakeId);
        }
        else if (ball.type === 'attack') {
            activateAttackMode(snakeId);
        } else {
            // å…¶ä»–çƒç«‹å³ç”Ÿæ•ˆ
            applySpecialItemEffect(snakeId, ball.type);
        }
        
        // æ˜¾ç¤ºé‡Šæ”¾æ•ˆæœ
        const head = snakes[snakeId][0];
        const effect = document.createElement('div');
        effect.className = 'release-effect';
        effect.style.left = `${head.x}px`;
        effect.style.top = `${head.y}px`;
        
        // æ ¹æ®çƒä½“ç±»å‹è®¾ç½®æ•ˆæœé¢œè‰²
        switch(ball.type) {
            case 'immunity':
                effect.style.background = 'radial-gradient(circle, #FFFF00, transparent)';
                effect.style.width = '40px';
                effect.style.height = '40px';
                break;
            case 'health':
                effect.style.background = 'radial-gradient(circle, #FF0000, transparent)';
                effect.style.width = '40px';
                effect.style.height = '40px';
                break;
            case 'reverse':
                effect.style.background = 'radial-gradient(circle, #800080, transparent)';
                effect.style.width = '40px';
                effect.style.height = '40px';
                break;
            case 'attack':
                effect.style.background = 'radial-gradient(circle, #00BFFF, transparent)';
                effect.style.width = '40px';
                effect.style.height = '40px';
                break;
        }
        
        gameBoard.appendChild(effect);
        
        // åŠ¨ç”»ç»“æŸåç§»é™¤æ•ˆæœå…ƒç´ 
        setTimeout(() => {
            effect.remove();
        }, 500);
    }
}
function triggerBomb(snakeId) {
    const snakeHead = snakes[snakeId][0];
    const otherSnakeId = snakeId === 'snake1' ? 'snake2' : 'snake1';
    
    // åˆ›å»ºçˆ†ç‚¸è§†è§‰æ•ˆæœ
    createBombExplosion(snakeHead.x + 10, snakeHead.y + 10);
    
    // è®¡ç®—å¯¹å¯¹æ–¹è›‡çš„ä¼¤å®³
    applyBombDamageToSnake(snakeId, otherSnakeId, snakeHead);
    
    // è®¡ç®—å¯¹åŸºåœ°çš„ä¼¤å®³
    applyBombDamageToHomes(snakeId, snakeHead);
    
    // æ˜¾ç¤ºæç¤º
    showNotice('ç‚¸å¼¹çˆ†ç‚¸!', '#FF4500', snakeHead.x, snakeHead.y);
}

// æ–°å¢å‡½æ•°ï¼šåˆ›å»ºç‚¸å¼¹çˆ†ç‚¸æ•ˆæœ
function createBombExplosion(centerX, centerY) {
    // ä¸­å¿ƒçˆ†ç‚¸æ•ˆæœ
    createParticles(centerX, centerY, 50, '#FF4500');
    
    // å†²å‡»æ³¢æ•ˆæœ
    for (let i = 0; i < 5; i++) {
        const wave = document.createElement('div');
        wave.className = 'bomb-wave';
        wave.style.left = `${centerX}px`;
        wave.style.top = `${centerY}px`;
        wave.style.width = '0px';
        wave.style.height = '0px';
        wave.style.borderRadius = '50%';
        wave.style.border = '2px solid rgba(255, 69, 0, 0.8)';
        wave.style.position = 'absolute';
        wave.style.zIndex = '4';
        
        // åŠ¨ç”»
        wave.animate([
            { 
                width: '0px', 
                height: '0px',
                opacity: 1,
                transform: 'translate(-50%, -50%)'
            },
            { 
                width: '200px', 
                height: '200px',
                opacity: 0,
                transform: 'translate(-50%, -50%)'
            }
        ], {
            duration: 1000,
            easing: 'ease-out'
        });
        
        gameBoard.appendChild(wave);
        
        // ç§»é™¤æ•ˆæœå…ƒç´ 
        setTimeout(() => wave.remove(), 1000);
    }
}

// æ–°å¢å‡½æ•°ï¼šå¯¹è›‡åº”ç”¨ç‚¸å¼¹ä¼¤å®³
function applyBombDamageToSnake(snakeId, targetSnakeId, explosionCenter) {
    const targetSnake = snakes[targetSnakeId];
    const hasImmunity = targetSnakeId === 'snake1' ? immunity.snake1 : immunity.snake2;
    const isToughSnake = targetSnakeId === 'snake1' ? snakeTypes.snake1 === 'tough' : snakeTypes.snake2 === 'tough';
    
    let totalDamage = 0;
    let maxSegmentDistance = 0; // ç”¨äºè®°å½•æœ€è¿œè·ç¦»çš„è›‡èº«æ®µ
    
    // æ‰¾åˆ°ç¦»çˆ†ç‚¸ä¸­å¿ƒæœ€è¿‘çš„è›‡èº«æ®µ
    for (let i = 0; i < targetSnake.length; i++) {
        const segment = targetSnake[i];
        const distance = calculateDistance(segment, explosionCenter);
        
        if (i === 0 || distance < maxSegmentDistance) {
            maxSegmentDistance = distance;
        }
    }
    
    // æ ¹æ®æœ€è¿‘è›‡èº«æ®µè®¡ç®—åŸºç¡€ä¼¤å®³
    const gridDistance = Math.floor(maxSegmentDistance / 20);
    
    if (gridDistance <= 3) {
        // 3æ ¼å†…ï¼š5ç‚¹åŸºç¡€ä¼¤å®³
        totalDamage = 5;
    } else if (gridDistance <= 6) {
        // 3-6æ ¼ï¼š2ç‚¹åŸºç¡€ä¼¤å®³
        totalDamage = 2;
    } else if (gridDistance <= 10) {
        // 6-10æ ¼ï¼š1ç‚¹åŸºç¡€ä¼¤å®³
        totalDamage = 1;
    }
    
    // å¦‚æœæ˜¯åšç¡¬è›‡ï¼Œä¼¤å®³å‡åŠï¼ˆå‘ä¸Šå–æ•´ï¼‰
    if (isToughSnake && totalDamage > 0) {
        totalDamage = Math.floor(totalDamage / 2);
    }
    
    // åº”ç”¨ä¼¤å®³ï¼ˆå¦‚æœæœ‰ä¼¤å®³å¹¶ä¸”æ²¡æœ‰å…ç–«ï¼‰
    if (totalDamage > 0 && !hasImmunity) {
        health[targetSnakeId] -= totalDamage;
        
        // åœ¨å¯¹æ–¹è›‡å¤´ä½ç½®æ˜¾ç¤ºä¼¤å®³
        const targetHead = targetSnake[0];
        const damageColor = isToughSnake ? '#FFA500' : '#FF0000'; // æ©™è‰²è¡¨ç¤ºå‡ä¼¤åçš„ä¼¤å®³
        
        // æ˜¾ç¤ºä¼¤å®³æç¤ºï¼ˆå¦‚æœæ˜¯åšç¡¬è›‡ï¼Œæ˜¾ç¤ºå‡ä¼¤æç¤ºï¼‰
        if (isToughSnake) {
            showNotice(`-${totalDamage}HP (åšç¡¬å‡åŠ)`, damageColor, targetHead.x, targetHead.y);
            createParticles(targetHead.x + 10, targetHead.y + 10, totalDamage * 3, '#C0C0C0'); // é“¶è‰²ç²’å­
        } else {
            showNotice(`-${totalDamage}HP`, damageColor, targetHead.x, targetHead.y);
            createParticles(targetHead.x + 10, targetHead.y + 10, totalDamage * 3, '#FF0000');
        }
        
        // æ›´æ–°è¡€æ¡å¹¶æ£€æŸ¥æ¸¸æˆç»“æŸ
        updateHealthBars();
        if (health[targetSnakeId] <= 0) {
            gameOver();
        }
    } else if (totalDamage > 0 && hasImmunity) {
        // å…ç–«æƒ…å†µä¸‹çš„æç¤º
        const targetHead = targetSnake[0];
        showNotice('å…ç–«ç‚¸å¼¹ä¼¤å®³!', '#FFFF00', targetHead.x, targetHead.y);
        createParticles(targetHead.x + 10, targetHead.y + 10, 10, '#FFFF00');
    } else if (totalDamage === 0) {
        // åœ¨å®‰å…¨è·ç¦»å¤–
        const targetHead = targetSnake[0];
        showNotice('å®‰å…¨è·ç¦»', '#00FF00', targetHead.x, targetHead.y);
    }
}

function calculateDistanceToRect(point, rect) {
    // è®¡ç®—ç‚¹åˆ°çŸ©å½¢å››æ¡è¾¹çš„æœ€çŸ­è·ç¦»
    const dx = Math.max(rect.x - point.x, 0, point.x - (rect.x + rect.width));
    const dy = Math.max(rect.y - point.y, 0, point.y - (rect.y + rect.height));
    
    // å¦‚æœåœ¨çŸ©å½¢å†…ï¼Œè·ç¦»ä¸º0
    if (dx === 0 && dy === 0) {
        return 0;
    }
    
    // è®¡ç®—æ¬§å‡ é‡Œå¾—è·ç¦»
    return Math.sqrt(dx * dx + dy * dy);
}


// æ–°å¢å‡½æ•°ï¼šå¯¹åŸºåœ°åº”ç”¨ç‚¸å¼¹ä¼¤å®³
function applyBombDamageToHomes(snakeId, explosionCenter) {
    const otherHomeId = snakeId === 'snake1' ? 'player2' : 'player1';
    const otherHome = homes[otherHomeId];
    
    if (otherHome.destroyed) return;
    
    // è®¡ç®—çˆ†ç‚¸ä¸­å¿ƒåˆ°åŸºåœ°è¾¹æ¡†çš„æœ€çŸ­è·ç¦»
    const distance = calculateDistanceToRect(explosionCenter, otherHome);
    const gridDistance = Math.floor(distance / 20);
    
    let damage = 0;
    let message = '';
    
    if (gridDistance <= 3) {
        damage = 5;
        message = 'ç‚¸å¼¹å‡»ä¸­! -5HP';
    } else if (gridDistance <= 6) {
        damage = 2;
        message = 'ç‚¸å¼¹å†²å‡»! -2HP';
    } else if (gridDistance <= 10) {
        damage = 1;
        message = 'ç‚¸å¼¹æ³¢åŠ! -1HP';
    }
    
    if (damage > 0) {
        otherHome.health = Math.max(0, otherHome.health - damage);
        
        // åœ¨åŸºåœ°ä¸­å¿ƒæ˜¾ç¤ºä¼¤å®³æ•ˆæœ
        const homeCenter = {
            x: otherHome.x + otherHome.width / 2,
            y: otherHome.y + otherHome.height / 2
        };
        
        // æ˜¾ç¤ºä¼¤å®³æ•ˆæœ
        showNotice(message, '#FF4500', homeCenter.x, homeCenter.y);
        createParticles(homeCenter.x, homeCenter.y, damage * 3, '#FF4500');
        
        // æ£€æŸ¥åŸºåœ°æ˜¯å¦è¢«æ‘§æ¯
        if (otherHome.health <= 0) {
            otherHome.destroyed = true;
            const playerName = otherHomeId === 'player1' ? 
                (localStorage.getItem('username') || 'ç©åŸºåœ°1') : 
                (localStorage.getItem('player2_username') || 'ç©åŸºåœ°2');
            
            showNotice(`${playerName}çš„åŸºåœ°è¢«ç‚¸æ¯äº†!`, '#FF0000', homeCenter.x, homeCenter.y);
            
            // å¤§çˆ†ç‚¸æ•ˆæœ
            createParticles(homeCenter.x, homeCenter.y, 50, '#FF4500');
        }
    }
}
function calculateDistance(point1, point2) {
    // ç¡®ä¿point1å’Œpoint2éƒ½æœ‰xå’Œyå±æ€§
    const x1 = point1.x || point1.left || 0;
    const y1 = point1.y || point1.top || 0;
    const x2 = point2.x || point2.left || 0;
    const y2 = point2.y || point2.top || 0;
    
    return Math.sqrt(
        Math.pow(x1 - x2, 2) + 
        Math.pow(y1 - y2, 2)
    );
}

function activateAttackMode(snakeId) {
    const currentTime = performance.now();
    const isMagicSnake = snakeId === 'snake1' ? snakeTypes.snake1 === 'magic' : snakeTypes.snake2 === 'magic';
    const timeMultiplier = isMagicSnake ? 1.5 : 1;
    const attackDuration = 30000 * timeMultiplier; // 30ç§’ï¼Œé­”æ³•è›‡45ç§’

    if (snakeId === 'snake1') {
        attackMode.snake1 = true;
        attackMode.timer1 = currentTime + attackDuration;
        attackMode.intervalId1 = setInterval(() => {
            if (attackMode.snake1) {
                fireBullet(snakeId);
            } else {
                clearInterval(attackMode.intervalId1);
            }
        }, 400); // æ¯0.5ç§’å‘å°„ä¸€é¢—
    } else {
        attackMode.snake2 = true;
        attackMode.timer2 = currentTime + attackDuration;
        attackMode.intervalId2 = setInterval(() => {
            if (attackMode.snake2) {
                fireBullet(snakeId);
            } else {
                clearInterval(attackMode.intervalId2);
            }
        }, 400);
    }

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    updateStatusDisplay();
    showNotice('æ”»å‡»æ¨¡å¼æ¿€æ´»!' + (isMagicSnake ? ' (é­”æ³•å»¶é•¿)' : ''), '#00BFFF', 
        snakeId === 'snake1' ? snakes.snake1[0].x : snakes.snake2[0].x, 
        snakeId === 'snake1' ? snakes.snake1[0].y : snakes.snake2[0].y);
}
// æ£€æŸ¥ä¸å…¶ä»–è›‡ç¢°æ’
function checkOtherSnakeCollision(otherSnakeId, head) {
    const otherSnake = snakes[otherSnakeId];
    
    for (let i = 0; i < otherSnake.length; i++) {
        const segment = otherSnake[i];
        const distance = Math.sqrt(Math.pow(head.x - segment.x, 2) + Math.pow(head.y - segment.y, 2));
        
        if (distance < 20) {
            const isHeadCollision = (i === 0);
            
            // æ£€æŸ¥å¯¹æ–¹æ˜¯å¦è¢«å†»ç»“
            if (frozenSnakes[otherSnakeId]) {
                // æ’å†»ç»“çš„è›‡ä¸æ‰è¡€ï¼Œä½†å†»ç»“çš„è›‡ä¼šæ‰è¡€
                if (performance.now() - lastMoveTime[otherSnakeId] > 1000) {
                    health[otherSnakeId] -= 1;
                    updateHealthBars();
                    showNotice('-1HP (å†»ç»“ç¢°æ’)', '#00BFFF', segment.x, segment.y);
                    lastMoveTime[otherSnakeId] = performance.now();
                    
                    // æ£€æŸ¥æ¸¸æˆç»“æŸ
                    if (health[otherSnakeId] <= 0) {
                        gameOver();
                    }
                }
                return { collided: false }; // è¿”å›æœªç¢°æ’ï¼Œå› ä¸ºä¸æ‰è¡€
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯åšç¡¬è›‡å¹¶ä¸”æœ‰æŠµæŒ¡æ•ˆæœ
            const currentSnakeId = otherSnakeId === 'snake1' ? 'snake2' : 'snake1';
            const currentSnakeType = snakeTypes[currentSnakeId];
            
            if (currentSnakeType === 'tough' && defenseRate[currentSnakeId] > 0.2) {
                // åšç¡¬è›‡æœ‰æŠµæŒ¡æ•ˆæœ
                const damageReduction = defenseRate[currentSnakeId];
                
                // æ˜¾ç¤ºæŠµæŒ¡æç¤º
                showNotice(`æŠµæŒ¡${Math.round((1 - damageReduction) * 100)}%!`, '#FFFFFF', head.x, head.y);
                createParticles(head.x + 10, head.y + 10, 15, '#FFFFFF');
                
                // æ›´æ–°æŠµæŒ¡ç‡
                if (collisionCount[currentSnakeId] < 3) {
                    collisionCount[currentSnakeId]++;
                } else {
                    // ç¬¬4æ¬¡ç¢°æ’å¼€å§‹ï¼ŒæŠµæŒ¡ç‡é€æ­¥é™ä½
                    defenseRate[currentSnakeId] = Math.max(0.2, defenseRate[currentSnakeId] - 0.2);
                }
                
                return { collided: false }; // è¿”å›æœªç¢°æ’
            }
            
            return {
                collided: true,
                collisionIndex: i,
                isHeadCollision: isHeadCollision
            };
        }
    }
    
    return { collided: false };
}

// æ›´æ–°åˆ†æ•°æ˜¾ç¤º
function updateScoreDisplay() {
    document.getElementById('score-1').textContent = `${scores.snake1}åˆ†`;
    document.getElementById('score-2').textContent = `${scores.snake2}åˆ†`;
}

// æ›´æ–°è¡€é‡æ˜¾ç¤º
function updateHealthBars() {
    const maxHealth1 = snakeTypes.snake1 === 'tough' ? 13 : 10;
    const maxHealth2 = snakeTypes.snake2 === 'tough' ? 13 : 10;
    
    health1El.style.width = `${(health.snake1 / maxHealth1) * 100}%`;
    health2El.style.width = `${(health.snake2 / maxHealth2) * 100}%`;
    document.getElementById('health-text-1').textContent = `${health.snake1}HP`;
    document.getElementById('health-text-2').textContent = `${health.snake2}HP`;
}

// æ˜¾ç¤ºé€šçŸ¥
function showNotice(text, color, x, y) {
    const notice = document.createElement('div');
    notice.textContent = text;
    notice.style.position = 'absolute';
    notice.style.left = `${x}px`;
    notice.style.top = `${y}px`;
    notice.style.color = color;
    notice.style.fontSize = '16px';
    notice.style.fontWeight = 'bold';
    notice.style.textShadow = '0 0 5px white';
    notice.style.zIndex = '10';
    notice.style.animation = 'fadeOut 1s forwards';
    gameBoard.appendChild(notice);
    
    setTimeout(() => {
        notice.remove();
    }, 1000);
}

function gameOver() {
    gameOverScreen.style.display = '';
    gameStarted = false;
    let hasUploaded = false;
    if (attackMode.intervalId1) clearInterval(attackMode.intervalId1);
    if (attackMode.intervalId2) clearInterval(attackMode.intervalId2);
    attackMode = {
        snake1: false,
        snake2: false,
        timer1: 0,
        timer2: 0,
        lastShot1: 0,
        lastShot2: 0,
        intervalId1: null,
        intervalId2: null
    };
    homes.player1.destroyed = false;
    homes.player1.health = homes.player1.maxHealth;
    homes.player2.destroyed = false;
    homes.player2.health = homes.player2.maxHealth;
    document.querySelectorAll('.bullet').forEach(bullet => bullet.remove());
    document.getElementById("back").style.display = "block";
    viewRecords.style.display = 'block';
    gameOverScreen.classList.remove('show');
    document.getElementById("back").onclick = function(){ 
        if(!gameStarted){     
            gameOverScreen.classList.remove('show');
            characterSelection.classList.add('show');
            gameStarted = true;
        } else {
            document.getElementById("back").onclick=goBackOrHome();
        }
    }

    // ç¡®å®šè·èƒœè€…
    let winner = null;
    let currentWin1 = 0;
    let currentWin2 = 0;
    
    if (health.snake1 <= 0 && health.snake2 <= 0) {
        winner = 'draw';
    } else if (health.snake1 <= 0) {
        winner = 'snake2';
        currentWin2 = 1; // æ ‡è®°ç©åŸºåœ°2æœ¬æ¬¡è·èƒœ
    } else {
        winner = 'snake1';
        currentWin1 = 1; // æ ‡è®°ç©åŸºåœ°1æœ¬æ¬¡è·èƒœ
    }

    // è·å–æœåŠ¡å™¨æ•°æ®å¹¶æ˜¾ç¤º
    getServerRecords().then(serverData => {
        // åªæ˜¾ç¤ºå†å²æˆ˜ç»©ï¼Œä¸åŒ…å«æœ¬æ¬¡ç»“æœ
        let player1Wins = serverData?.player1Wins || 0;
        let player2Wins = serverData?.player2Wins || 0;
        // åˆ›å»ºæ¸¸æˆç»“æŸç•Œé¢
        gameOverScreen.innerHTML = `
            <div class="game-over-content">
                <div class="winner-container">
                    ${winner === 'draw' ? `
                        <div class="trophy-icon">
                            <i class="fas fa-trophy" style="color: #FFD700;"></i>
                            <i class="fas fa-trophy" style="color: #C0C0C0;"></i>
                        </div>
                        <h2 class="winner-banner">å¹³å±€!</h2>
                    ` : `
                        <div class="trophy-icon">
                            <i class="fas fa-trophy" style="color: ${winner === 'snake1' ? '#FFD700' : '#C0C0C0'};"></i>
                        </div>
                        <h2 class="winner-banner ${winner === 'snake1' ? 'player-1-win' : 'player-2-win'}">
                            ${winner === 'snake1' ? localStorage.getItem("username") : localStorage.getItem("player2_username")}è·èƒœ!
                        </h2>
                    `}
                </div>
                
                <div class="stats-container">
                    <div class="player-stats player-1-stats">
                        <div class="player-avatar">
                            <i class="fas fa-user" style="color: #FF5722;"></i>
                        </div>
                        <div class="player-name">${localStorage.getItem("username") || "ç©åŸºåœ°1"}</div>
                        <div class="win-count">
                            <span class="history-wins">${player1Wins}</span>
                            ${currentWin1 > 0 ? `<span class="current-win">+${currentWin1}</span>` : ''}
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${calculateWinPercentage(player1Wins, player2Wins)}%; background: linear-gradient(to right, #FF5722, #FF9800);"></div>
                        </div>
                    </div>
                    
                    <div class="vs-text">VS</div>
                    
                    <div class="player-stats player-2-stats">
                        <div class="player-avatar">
                            <i class="fas fa-user" style="color: #2196F3;"></i>
                        </div>
                        <div class="player-name">${localStorage.getItem("player2_username") || "ç©åŸºåœ°2"}</div>
                        <div class="win-count">
                            <span class="history-wins">${player2Wins}</span>
                            ${currentWin2 > 0 ? `<span class="current-win">+${currentWin2}</span>` : ''}
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${calculateWinPercentage(player2Wins, player1Wins)}%; background: linear-gradient(to right, #2196F3, #00BCD4);"></div>
                        </div>
                    </div>
                </div>
                
                <div class="buttons-container">
                    <button class="restart-btn" id="play-again">
                        <i class="fas fa-redo"></i> å†æ¥ä¸€å±€
                    </button>
                    <button class="restart-btn upload-btn" id="save-record">
                        <i class="fas fa-save"></i> ä¿å­˜æˆ˜ç»©
                    </button>
                </div>
            </div>
        `;

        // å†æ¥ä¸€å±€æŒ‰é’®äº‹ä»¶
        document.getElementById('play-again').addEventListener('click', () => {
            gameOverScreen.classList.remove('show');
            setTimeout(() => {
                initGame();
            }, 300);
        });

        // ä¿å­˜æˆ˜ç»©æŒ‰é’®äº‹ä»¶
        document.getElementById('save-record').addEventListener('click', () => {
            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            const saveBtn = document.getElementById('save-record');
            saveBtn.disabled = true;
            saveBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...`;
            
            // ä¸Šä¼ æœ¬æ¬¡æ¯”èµ›ç»“æœ
            uploadGameRecord(currentWin1, currentWin2).then(() => {
                // ä¸Šä¼ æˆåŠŸåæ›´æ–°æ˜¾ç¤º
                const historyWins1 = document.querySelector('.player-1-stats .history-wins');
                const historyWins2 = document.querySelector('.player-2-stats .history-wins');
                
                if (historyWins1 && historyWins2) {
                    // æ›´æ–°æ˜¾ç¤ºä¸ºå†å²æˆ˜ç»©+æœ¬æ¬¡ç»“æœ
                    historyWins1.textContent = player1Wins + currentWin1;
                    historyWins2.textContent = player2Wins + currentWin2;
                    
                    // éšè—+1æç¤º
                    const currentWinElements = document.querySelectorAll('.current-win');
                    currentWinElements.forEach(el => el.remove());
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    const progress1 = document.querySelector('.player-1-stats .progress-fill');
                    const progress2 = document.querySelector('.player-2-stats .progress-fill');
                    if (progress1 && progress2) {
                        progress1.style.width = `${calculateWinPercentage(player1Wins + currentWin1, player2Wins + currentWin2)}%`;
                        progress2.style.width = `${calculateWinPercentage(player2Wins + currentWin2, player1Wins + currentWin1)}%`;
                    }
                    
                    // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
                    showGameOverMessage('æˆ˜ç»©ä¿å­˜æˆåŠŸ!', '#4CAF50');
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    saveBtn.innerHTML = `<i class="fas fa-check"></i> å·²ä¿å­˜`;
                }
            }).catch(error => {
                console.error('ä¿å­˜æˆ˜ç»©å¤±è´¥:', error);
                showGameOverMessage('ä¿å­˜å¤±è´¥: ' + error.message, '#FF5722');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                saveBtn.disabled = false;
                saveBtn.innerHTML = `<i class="fas fa-save"></i> ä¿å­˜æˆ˜ç»©`;
            });
        });

        // æ˜¾ç¤ºæ¸¸æˆç»“æŸç•Œé¢
        gameOverScreen.classList.add('show');
        
        // æ·»åŠ åº†ç¥æ•ˆæœ
        if (winner !== 'draw') {
            createCelebrationEffect(winner === 'snake1' ? '#FF5722' : '#2196F3');
        }
    });
}

// ä¿®æ”¹ä¸Šä¼ æˆ˜ç»©å‡½æ•°ï¼Œç¡®ä¿åªä¸Šä¼ ä¸€æ¬¡
let hasUploaded = false;

function showGameOverMessage(message, color) {
    const messageEl = document.createElement('div');
    messageEl.className = 'game-over-message';
    messageEl.textContent = message;
    messageEl.style.color = color;
    
    const buttonsContainer = document.querySelector('.buttons-container');
    if (buttonsContainer) {
        buttonsContainer.insertAdjacentElement('beforebegin', messageEl);
        
        // 3ç§’åæ·¡å‡º
        setTimeout(() => {
            messageEl.style.opacity = '0';
            setTimeout(() => {
                messageEl.remove();
            }, 500);
        }, 3000);
    }
}

// è®¡ç®—èƒœç‡ç™¾åˆ†æ¯”
function calculateWinPercentage(wins, opponentWins) {
    const total = wins + opponentWins;
    return total > 0 ? Math.round((wins / total) * 100) : 50;
}


// åˆ›å»ºåº†ç¥æ•ˆæœ
function createCelebrationEffect(color) {
    const colors = [color, '#FFFFFF', '#FFD700'];
    
    for (let i = 0; i < 50; i++) {
        const particle = document.createElement('div');
        particle.className = 'celebration-particle';
        
        // éšæœºå±æ€§
        const size = 5 + Math.random() * 10;
        const duration = 1 + Math.random() * 2;
        const delay = Math.random() * 0.5;
        const distance = 50 + Math.random() * 100;
        const angle = Math.random() * Math.PI * 2;
        
        // è®¾ç½®æ ·å¼
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        particle.style.animationDuration = `${duration}s`;
        particle.style.animationDelay = `${delay}s`;
        
        // è®¾ç½®åˆå§‹ä½ç½®
        particle.style.left = '50%';
        particle.style.top = '30%';
        
        // è®¾ç½®åŠ¨ç”»ç»ˆç‚¹
        particle.style.setProperty('--tx', `${Math.cos(angle) * distance}px`);
        particle.style.setProperty('--ty', `${Math.sin(angle) * distance}px`);
        
        gameOverScreen.appendChild(particle);
        
        // åŠ¨ç”»ç»“æŸåç§»é™¤
        setTimeout(() => {
            particle.remove();
        }, duration * 1000);
    }
}
// è·å–æœåŠ¡å™¨è®°å½•
async function getServerRecords() {
    try {
        const userId = localStorage.getItem("userid");
        const player2UserId = localStorage.getItem("player2_userid");
        const currentUsername = localStorage.getItem("username");
        const player2Username = localStorage.getItem("player2_username");
        
        if (!userId || !player2UserId || !currentUsername || !player2Username) {
            return null;
        }
        
        // è·å–å½“å‰ç”¨æˆ·çš„è®°å½•
        const currentUserData = await getUserCustomData(userId);
        const player2Data = await getUserCustomData(player2UserId);
        
        let player1Wins = 0;
        let player2Wins = 0;
        
        // ä»å½“å‰ç”¨æˆ·æ•°æ®ä¸­è§£æ
        if (currentUserData) {
            const records = currentUserData.split(';');
            for (const record of records) {
                if (record.startsWith(`snakegame_record_with_${player2Username}`)) {
                    const parts = record.split(':')[1].split(',');
                    player1Wins += parseInt(parts[0]) || 0;
                    player2Wins += parseInt(parts[1]) || 0;
                }
            }
        }
        return {
            player1Wins,
            player2Wins
        };
    } catch (error) {
        console.error('è·å–æœåŠ¡å™¨è®°å½•å¤±è´¥:', error);
        return null;
    }
}
async function uploadGameRecord(player1Wins, player2Wins) {
    if (hasUploaded) {
        throw new Error('æˆ˜ç»©å·²ä¿å­˜ï¼Œè¯·å‹¿é‡å¤æäº¤');
    }
    
    try {
        const userId = localStorage.getItem("userid");
        const player2UserId = localStorage.getItem("player2_userid");
        const currentUsername = localStorage.getItem("username");
        const player2Username = localStorage.getItem("player2_username");
        
        if (!userId || !player2UserId || !currentUsername || !player2Username) {
            throw new Error('ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´');
        }
        
        // å‡†å¤‡ä¸Šä¼ çš„æ•°æ®
        const recordForCurrentUser = `snakegame_record_with_${player2Username}:${player1Wins},${player2Wins}`;
        const recordForPlayer2 = `snakegame_record_with_${currentUsername}:${player2Wins},${player1Wins}`;
        
        // è·å–å½“å‰ç”¨æˆ·çš„ç°æœ‰æ•°æ®
        const currentUserData = await getUserCustomData(userId);
        const player2Data = await getUserCustomData(player2UserId);
        
        // æ›´æ–°æ•°æ®
        const updatedCurrentUserData = updateRecord(currentUserData, recordForCurrentUser);
        const updatedPlayer2Data = updateRecord(player2Data, recordForPlayer2);
        
        // ä¸Šä¼ æ›´æ–°åçš„æ•°æ®
        await Promise.all([
            updateUserCustomData(userId, updatedCurrentUserData),
            updateUserCustomData(player2UserId, updatedPlayer2Data)
        ]);
        
        return true;
    } catch (error) {
        console.error('ä¸Šä¼ æˆ˜ç»©å¤±è´¥:', error);
        throw error;
    }
}
// è·å–ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®
async function getUserCustomData(userId) {
    try {
        const response = await fetch(`${serverurl}/get-custom-data-by-id`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                userId: userId
            })
        });
        
        const data = await response.json();
        if (data.success) {
            return data.data.customData || '';
        }
        throw new Error(data.message || 'è·å–ç”¨æˆ·æ•°æ®å¤±è´¥');
    } catch (error) {
        console.error('è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
        throw error;
    }
}

// æ›´æ–°è®°å½•
function updateRecord(currentData, newRecord) {
    if (!currentData) return newRecord;
    
    const recordKey = newRecord.split(':')[0];
    const records = currentData.split(';');
    let found = false;
    
    const updatedRecords = records.map(record => {
        if (record.startsWith(recordKey)) {
            found = true;
            const [oldP1Wins, oldP2Wins] = record.split(':')[1].split(',').map(Number);
            const [newP1Wins, newP2Wins] = newRecord.split(':')[1].split(',').map(Number);
            return `${recordKey}:${oldP1Wins + newP1Wins},${oldP2Wins + newP2Wins}`;
        }
        return record;
    });
    
    if (!found) {
        updatedRecords.push(newRecord);
    }
    
    return updatedRecords.filter(r => r).join(';');
}

// æ›´æ–°ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®
async function updateUserCustomData(userId, customData) {
    try {
        const response = await fetch(`${serverurl}/update-custom-data`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                userId: userId,
                customData: customData
            })
        });
        
        const data = await response.json();
        if (!data.success) {
            throw new Error(data.message || 'æ›´æ–°æ•°æ®å¤±è´¥');
        }
    } catch (error) {
        console.error('æ›´æ–°ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
        throw error;
    }
}
// åˆ›å»ºç²’å­æ•ˆæœ
function createParticles(x, y, count, color) {
    for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = `${x}px`;
        particle.style.top = `${y}px`;
        particle.style.backgroundColor = color;
        particle.style.animationDuration = `${2 + Math.random() * 3}s`;
        particle.style.animationDelay = `${Math.random() * 0.5}s`;
        
        // éšæœºå¤§å°
        const size = 2 + Math.random() * 6;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        
        // éšæœºæ–¹å‘
        const angle = Math.random() * Math.PI * 2;
        const distance = 5 + Math.random() * 20;
        particle.style.setProperty('--tx', `${Math.cos(angle) * distance}px`);
        particle.style.setProperty('--ty', `${Math.sin(angle) * distance}px`);
        
        particlesContainer.appendChild(particle);
        
        // åŠ¨ç”»ç»“æŸåç§»é™¤ç²’å­
        setTimeout(() => {
            particle.remove();
        }, 3000);
    }
}

// åˆ›å»ºèƒŒæ™¯å…ƒç´ 
function createBackgroundElements() {
    const colors = ['#FF5722', '#2196F3', '#4CAF50', '#FFC107', '#9C27B0'];
    
    for (let i = 0; i < 8; i++) {
        const element = document.createElement('div');
        element.className = 'bg-element';
        
        // éšæœºä½ç½®
        const left = Math.random() * 100;
        const top = Math.random() * 100;
        
        // éšæœºå¤§å°
        const size = 50 + Math.random() * 150;
        
        // éšæœºé¢œè‰²
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        element.style.left = `${left}%`;
        element.style.top = `${top}%`;
        element.style.width = `${size}px`;
        element.style.height = `${size}px`;
        element.style.backgroundColor = color;
        element.style.animationDuration = `${15 + Math.random() * 30}s`;
        element.style.animationDelay = `${Math.random() * 5}s`;
        
        document.body.appendChild(element);
    }
}

// åˆ›å»ºèƒŒæ™¯ç²’å­
function createBackgroundParticles() {
    for (let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = `${Math.random() * 100}%`;
        particle.style.top = `${Math.random() * 100}%`;
        particle.style.animationDuration = `${10 + Math.random() * 20}s`;
        particle.style.animationDelay = `${Math.random() * 5}s`;
        
        // éšæœºé¢œè‰²
        const hue = Math.random() * 360;
        particle.style.backgroundColor = `hsla(${hue}, 100%, 70%, 0.7)`;
        
        particlesContainer.appendChild(particle);
    }
}

// é”®ç›˜æ§åˆ¶
document.addEventListener('keydown', (e) => {
    // é˜»æ­¢ç©ºæ ¼å’ŒEnteré”®çš„é»˜è®¤è¡Œä¸ºï¼Œé¿å…è§¦å‘æŒ‰é’®ç‚¹å‡»
    if (e.key === ' ' || e.key === 'Enter') {
        e.preventDefault();
    }
    
    if (!gameStarted) return;
    if (e.key >= '1' && e.key <= '5') {
        const slotIndex = parseInt(e.key) - 1;
        releaseBall('snake1', slotIndex);
        return;
    }
    
    // ç©åŸºåœ°2é‡Šæ”¾çƒä½“ (æŒ‰é”®6-0)
    if ((e.key >= '6' && e.key <= '9') || e.key === '0') {
        const slotIndex = e.key === '0' ? 4 : parseInt(e.key) - 6;
        releaseBall('snake2', slotIndex);
        return;
    }
    if (e.key === 'z' || e.key === 'Z') {
        pausedSnakes.snake1 = !pausedSnakes.snake1;
        showNotice(pausedSnakes.snake1 ? 'ç©åŸºåœ°1å·²æš‚åœ' : 'ç©åŸºåœ°1å·²æ¢å¤', 
                  '#FF5722', snakes.snake1[0].x, snakes.snake1[0].y);
        return;
    }
    
    if (e.key === 'm' || e.key === 'M') {
        pausedSnakes.snake2 = !pausedSnakes.snake2;
        showNotice(pausedSnakes.snake2 ? 'ç©åŸºåœ°2å·²æš‚åœ' : 'ç©åŸºåœ°2å·²æ¢å¤', 
                  '#2196F3', snakes.snake2[0].x, snakes.snake2[0].y);
        return;
    }    
    // å¤„ç†ç©åŸºåœ°1æ§åˆ¶ (WASD)
    if (reversedControls.snake1) {
        // åå‘æ§åˆ¶
        switch (e.key) {
            case 'w':
            case 'W':
                if (directions.snake1 !== 'up') nextDirections.snake1 = 'down';
                break;
            case 's':
            case 'S':
                if (directions.snake1 !== 'down') nextDirections.snake1 = 'up';
                break;
            case 'a':
            case 'A':
                if (directions.snake1 !== 'left') nextDirections.snake1 = 'right';
                break;
            case 'd':
            case 'D':
                if (directions.snake1 !== 'right') nextDirections.snake1 = 'left';
                break;
        }
    } else {
        // æ­£å¸¸æ§åˆ¶
        switch (e.key) {
            case 'w':
            case 'W':
                if (directions.snake1 !== 'down') nextDirections.snake1 = 'up';
                break;
            case 's':
            case 'S':
                if (directions.snake1 !== 'up') nextDirections.snake1 = 'down';
                break;
            case 'a':
            case 'A':
                if (directions.snake1 !== 'right') nextDirections.snake1 = 'left';
                break;
            case 'd':
            case 'D':
                if (directions.snake1 !== 'left') nextDirections.snake1 = 'right';
                break;
        }
    }
    
    // å¤„ç†ç©åŸºåœ°2æ§åˆ¶ (æ–¹å‘é”®)
    if (reversedControls.snake2) {
        // åå‘æ§åˆ¶
        switch (e.key) {
            case 'ArrowUp':
                if (directions.snake2 !== 'up') nextDirections.snake2 = 'down';
                break;
            case 'ArrowDown':
                if (directions.snake2 !== 'down') nextDirections.snake2 = 'up';
                break;
            case 'ArrowLeft':
                if (directions.snake2 !== 'left') nextDirections.snake2 = 'right';
                break;
            case 'ArrowRight':
                if (directions.snake2 !== 'right') nextDirections.snake2 = 'left';
                break;
        }
    } else {
        // æ­£å¸¸æ§åˆ¶
        switch (e.key) {
            case 'ArrowUp':
                if (directions.snake2 !== 'down') nextDirections.snake2 = 'up';
                break;
            case 'ArrowDown':
                if (directions.snake2 !== 'up') nextDirections.snake2 = 'down';
                break;
            case 'ArrowLeft':
                if (directions.snake2 !== 'right') nextDirections.snake2 = 'left';
                break;
            case 'ArrowRight':
                if (directions.snake2 !== 'left') nextDirections.snake2 = 'right';
                break;
        }
    }
});

// å¼€å§‹æ¸¸æˆæŒ‰é’®
startBtn.addEventListener('click', () => {
    const player1Name = localStorage.getItem('username') || 'ç©åŸºåœ°1';
    document.getElementById('player1-name').textContent = player1Name + ': ';
    player2Name=localStorage.getItem("player2_username");
    if(!player2Name){
        loginPlayer2();
    }
    startBtn.style.animation = 'buttonClick 0.5s forwards';
    
    // å¼€å§‹å±å¹•é€€å‡ºåŠ¨ç”»
    startScreen.style.animation = 'startScreenExit 0.8s forwards';
    
    setTimeout(() => {
        startScreen.classList.add('hide');
        initGame();
    }, 800);
});

// é‡æ–°å¼€å§‹æŒ‰é’®
restartBtn.addEventListener('click', () => {
    gameOverScreen.classList.remove('show');
    setTimeout(() => {
        initGame();
    }, 300);
});

// åˆå§‹åŒ–èƒŒæ™¯ç²’å­
createBackgroundParticles();

// æ·»åŠ CSSåŠ¨ç”»
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeOut {
        to { opacity: 0; transform: translate(-50%, -100%); }
    }
    @keyframes buttonClick {
        50% { transform: scale(0.9); }
        100% { transform: scale(1); }
    }
    @keyframes startScreenExit {
        to { opacity: 0; transform: scale(1.2); }
    }
`;
document.head.appendChild(style);

// æ·»åŠ è§’è‰²é€‰æ‹©ç•Œé¢äº¤äº’é€»è¾‘
document.addEventListener('DOMContentLoaded', function() {
    const startScreen = document.querySelector('.start-screen');
    const startBtn = document.querySelector('.start-btn');
    const snakeOptions = document.querySelectorAll('.snake-option');
    const startGameBtn = document.querySelector('.start-game-btn');
    
    // å¼€å§‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    startBtn.addEventListener('click', () => {
        startScreen.classList.add('hide');
        setTimeout(() => {
            characterSelection.classList.add('show');
        }, 500);
    });
    
    // è›‡ç±»å‹é€‰æ‹©äº‹ä»¶
    snakeOptions.forEach(option => {
        option.addEventListener('click', function() {
            const player = this.getAttribute('data-player');
            const type = this.getAttribute('data-type');
            
            // ç§»é™¤åŒç©åŸºåœ°çš„å…¶ä»–é€‰æ‹©
            document.querySelectorAll(`.snake-option[data-player="${player}"]`).forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // æ·»åŠ å½“å‰é€‰æ‹©
            this.classList.add('selected');
            
            // ä¿å­˜é€‰æ‹©
            snakeTypes[`snake${player}`] = type;
            
            // æ£€æŸ¥æ˜¯å¦ä¸¤ä½ç©åŸºåœ°éƒ½å·²é€‰æ‹©
            if (snakeTypes.snake1 && snakeTypes.snake2) {
                startGameBtn.disabled = false;
            }
        });
    });
    
// ä¿®æ”¹è§’è‰²é€‰æ‹©åçš„æµç¨‹
document.querySelector('.character-selection .start-game-btn').addEventListener('click', () => {
    characterSelection.classList.remove('show');
    setTimeout(() => {
        document.querySelector('.map-selection').classList.add('show');
    }, 500);
});

// åœ°å›¾é€‰æ‹©äº¤äº’
document.querySelectorAll('.map-option').forEach(option => {
    option.addEventListener('click', function() {
        document.querySelectorAll('.map-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        this.classList.add('selected');
        currentMap = this.getAttribute('data-map');
        document.querySelector('.map-selection .start-game-btn').disabled = false;
    });
});

// å¼€å§‹æ¸¸æˆæŒ‰é’®
document.querySelector('.map-selection .start-game-btn').addEventListener('click', () => {
    document.querySelector('.map-selection').classList.remove('show');
    setTimeout(() => {
        initGame();
    }, 500);
});});

        // æ·»åŠ ç©åŸºåœ°2ç™»å½•åŠŸèƒ½
function loginPlayer2() {
        document.querySelector('.map-selection .start-game-btn').style.display = 'none';
    swal({
        title: "ç©åŸºåœ°2ç™»å½•",
        text: "è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ",
        type: "input",
        inputType: "text",
        inputPlaceholder: "è¯·è¾“å…¥ç”¨æˆ·å",
        showCancelButton: true,
        cancelButtonText: "å–æ¶ˆ",
        confirmButtonText: "ä¸‹ä¸€æ­¥",
        closeOnConfirm: false
    }, function(username) {
        if (username === false) return false;
        if (!username) {
            swal.showInputError("è¯·è¾“å…¥ç”¨æˆ·å");
            return false;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ç©åŸºåœ°1ç”¨æˆ·åç›¸åŒ
        const player1Username = localStorage.getItem('username');
        if (player1Username && username === player1Username) {
            swal.showInputError("ç”¨æˆ·åä¸èƒ½ä¸ç©åŸºåœ°1ç›¸åŒ");
            return false;
        }
        
        // ç¬¬äºŒæ­¥ï¼šè¯¢é—®å¯†ç 
        swal({
            title: "ç©åŸºåœ°2ç™»å½•",
            text: "è¯·è¾“å…¥å¯†ç ",
            type: "input",
            inputType: "password",
            inputPlaceholder: "è¯·è¾“å…¥å¯†ç ",
            showCancelButton: true,
            cancelButtonText: "ä¸Šä¸€æ­¥",
            confirmButtonText: "ç™»å½•",
            closeOnConfirm: false
        }, function(password) {
            if (password === false) {
                // ç‚¹å‡»å–æ¶ˆè¿”å›ä¸Šä¸€æ­¥
                loginPlayer2();
                return false;
            }
            if (!password) {
                swal.showInputError("è¯·è¾“å…¥å¯†ç ");
                return false;
            }
            
            // å‘é€ç™»å½•è¯·æ±‚
            fetch(`${serverurl}/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            })
            .then(response => response.text())
            .then(data => {
                if (data.includes('<h1>ç™»å½•æˆåŠŸ</h1>')) {
                    localStorage.setItem('player2_username', username);
                    fetch(`${serverurl}/get-user-id-by-username`, {
                                method: 'POST', // æŒ‡å®šè¯·æ±‚æ–¹æ³•
                                headers: {
                                    'Content-Type': 'application/json' // è®¾ç½®è¯·æ±‚å¤´
                                },
                                body: JSON.stringify({ username: username }) // è¯·æ±‚ä½“
                            })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Network response was not ok');
                                    }
                                    return response.json(); // è§£æJSONæ•°æ®
                                })
                                .then(data => {
                                    // å¤„ç†è¿”å›çš„æ•°æ®
                                    if (data.success) {
                                        // å‡è®¾data.dataä¸­åŒ…å«userId
                                        const userId = data.data.userId;
                                        localStorage.setItem("player2_userid",userId);
                                        document.getElementById('player2-name').textContent = username + ': ';
                                        document.getElementById("player-label1").textContent =localStorage.getItem("username") + "(æ©™è‰²)";
                                        document.getElementById("player-label2").textContent =localStorage.getItem("player2_username") + "(è“è‰²)";
                                        document.getElementById("storage-title1").textContent =localStorage.getItem("username") + "å‚¨å­˜:";
                                        document.getElementById("storage-title2").textContent =localStorage.getItem("player2_username") + "å‚¨å­˜:";
                                        document.querySelector('.map-selection .start-game-btn').style.display = "block";               
                                        swal("ç™»å½•æˆåŠŸ", "ç©åŸºåœ°2å·²ç™»å½•", "success");
                                    } else {
                                        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                                        console.log(data.message);
                                    }
                                })
                                .catch(error => {
                                    // å¤„ç†è¯·æ±‚è¿‡ç¨‹ä¸­çš„é”™è¯¯
                                    console.error('Fetch error:', error);
                                });
                } else if (data.includes('ç™»å½•å¤±è´¥')) {
                    swal("ç™»å½•å¤±è´¥", 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', 'error');
                    document.querySelector('.start-game-btn').style.display = "none";
                }
            })
            .catch(error => {
                console.error(error);
                swal("è¯·æ±‚å¤±è´¥", "è¯·ç¨åé‡è¯•", "error");
            });
        });
    });
}
// è›‡ç±»è¯¦ç»†æ•°æ®
const snakeDetails = {
    speed: {
        title: "é€Ÿåº¦è›‡",
        color: "#FFD700",
        ratings: [
            { name: "ç”Ÿå‘½", value: 3, max: 5 },
            { name: "é€Ÿåº¦", value: 5, max: 5 },
            { name: "é­”æ³•", value: 1, max: 5 }
        ],
        attributes: [
            { 
                name: "ç§»åŠ¨é€Ÿåº¦", 
                value: "<span class='speed-icon'></span> +50%", 
                desc: "ç§»åŠ¨é—´éš”å‡å°‘50%ï¼Œæ¯”æ™®é€šè›‡å¿«ä¸€å€" 
            },
            { 
                name: "ç”Ÿå‘½å€¼", 
                value: "<span class='health-icon'></span> 10HP", 
                desc: "æ ‡å‡†ç”Ÿå‘½å€¼ï¼Œç¢°æ’ä¼šå—åˆ°æ­£å¸¸ä¼¤å®³" 
            },
            { 
                name: "ç‰¹æ®Šèƒ½åŠ›", 
                value: "æ— ", 
                desc: "ä¸“æ³¨äºé«˜é€Ÿç§»åŠ¨ï¼Œæ²¡æœ‰å…¶ä»–ç‰¹æ®Šèƒ½åŠ›" 
            }
        ],
        tips: "é€‚åˆå–œæ¬¢å¿«èŠ‚å¥ã€é«˜æ“ä½œçš„ç©åŸºåœ°ã€‚åˆ©ç”¨é€Ÿåº¦ä¼˜åŠ¿å¿«é€ŸåŒ…å›´å¯¹æ‰‹ã€‚"
    },
    tough: {
        title: "åšç¡¬è›‡",
        color: "#C0C0C0",
        ratings: [
            { name: "ç”Ÿå‘½", value: 5, max: 5 },
            { name: "é€Ÿåº¦", value: 2, max: 5 },
            { name: "é­”æ³•", value: 1, max: 5 }
        ],
        attributes: [
            { 
                name: "ç”Ÿå‘½å€¼", 
                value: "<span class='health-icon'></span> 10HP(ä¸Šé™15)", 
                desc: "1.5å€ç”Ÿå‘½å€¼ï¼Œç”Ÿå­˜èƒ½åŠ›æ›´å¼º" 
            },
            { 
                name: "è¿›æ”»", 
                value: "æ’å‡»åˆ«äººä¼¤å®³å¢åŠ ", 
                desc: "ä»…æœ‰0.5æ¦‚ç‡å—åˆ°å­å¼¹ä¼¤å®³" 
            },
            { 
                name: "é€Ÿåº¦", 
                value: "æ ‡å‡†é€Ÿåº¦", 
                desc: "ç§»åŠ¨é€Ÿåº¦è¾ƒæ…¢" 
            }
        ],
        tips: "é€‚åˆç¨³å¥å‹ç©åŸºåœ°ã€‚é«˜ç”Ÿå‘½å€¼è®©ä½ å¯ä»¥æ‰¿å—æ›´å¤šå¤±è¯¯ï¼Œä½†è¦æ³¨æ„å­å¼¹ä¼¤å®³ä¸å‡ã€‚"
    },
    magic: {
        title: "é­”æ³•è›‡",
        color: "#9C27B0",
        ratings: [
            { name: "ç”Ÿå‘½", value: 3, max: 5 },
            { name: "é€Ÿåº¦", value: 3, max: 5 },
            { name: "é­”æ³•", value: 5, max: 5 }
        ],
        attributes: [
            { 
                name: "ç§»åŠ¨é€Ÿåº¦", 
                value: "<span class='speed-icon'></span> +15%", 
                desc: "æ¯”åšç¡¬è›‡ç¨å¿«ï¼Œä½†ä¸å¦‚é€Ÿåº¦è›‡" 
            },
            { 
                name: "æ•ˆæœæ—¶é•¿", 
                value: "<span class='magic-icon'></span> +50%", 
                desc: "æ‰€æœ‰ç‰¹æ®Šçƒæ•ˆæœæ—¶é—´å»¶é•¿50%" 
            },
            { 
                name: "è‡ªåŠ¨è·å¾—", 
                value: "æ¯20ç§’", 
                desc: "è‡ªåŠ¨è·å¾—ä¸€ä¸ªéšæœºç‰¹æ®Šçƒ(æ”»å‡»40%/è¡€çƒ30%/æ— æ•Œ20%/åè½¬10%)" 
            }
        ],
        tips: "é€‚åˆç­–ç•¥å‹ç©åŸºåœ°ã€‚åˆç†è§„åˆ’ç‰¹æ®Šçƒä½¿ç”¨æ—¶æœºï¼Œæ•ˆæœå»¶é•¿è®©ä½ æ›´æœ‰ä¼˜åŠ¿ã€‚"
    }
};

// æ˜¾ç¤ºè›‡ç±»è¯¦æƒ…
function showSnakeDetails(type) {
    const detail = snakeDetails[type];
    const modal = document.getElementById('snake-details-modal');
    const content = document.getElementById('snake-details-content');
    
    content.innerHTML = `
        <div class="snake-type-title" style="color: ${detail.color}">
            ${detail.title}
        </div>
        
        <!-- æ˜Ÿçº§è¯„åˆ† -->
        <div style="margin:15px 0;display:flex;justify-content:center;background:rgba(255,255,255,0.1);padding:10px;border-radius:8px;">
            ${detail.ratings.map(rating => `
                <div class="star-rating ${rating.name.toLowerCase()}-rating">
                    ${rating.name}:
                    ${'â˜…'.repeat(rating.value)}${'â˜†'.repeat(rating.max - rating.value)}
                    <span class="rating-value">${rating.value}/${rating.max}</span>
                </div>
            `).join('')}
        </div>
        
        ${detail.attributes.map(attr => `
            <div class="snake-attribute">
                <div class="attribute-name">${attr.name}:</div>
                <div class="attribute-value">
                    <div>${attr.value}</div>
                    <div style="font-size:12px;color:#ccc">${attr.desc}</div>
                </div>
            </div>
        `).join('')}
        
        <div style="margin-top:20px;padding:10px;background:rgba(255,255,255,0.1);border-radius:8px;">
            <strong>ç©æ³•æç¤ºï¼š</strong> ${detail.tips}
        </div>
    `;
    
    modal.style.display = 'block';
}

// ä¸ºæ‰€æœ‰è›‡ç±»é€‰é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
document.querySelectorAll('.snake-option').forEach(option => {
    option.addEventListener('click', function(e) {
        // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…ä¸é€‰æ‹©é€»è¾‘å†²çª
        if (e.target === this || e.target.classList.contains('snake-type')) {
            const type = this.getAttribute('data-type');
            showSnakeDetails(type);
        }
    });
});

// å…³é—­å¼¹çª—
document.querySelector('.close-modal').addEventListener('click', function() {
    document.getElementById('snake-details-modal').style.display = 'none';
});

// ç‚¹å‡»å¤–éƒ¨å…³é—­
window.addEventListener('click', function(event) {
    if (event.target === document.getElementById('snake-details-modal')) {
        document.getElementById('snake-details-modal').style.display = 'none';
    }
});
// æˆ˜ç»©æŸ¥è¯¢åŠŸèƒ½
document.getElementById('view-records').addEventListener('click', showAllRecords);

// æ˜¾ç¤ºæ‰€æœ‰æˆ˜ç»©è®°å½•
async function showAllRecords() {
    try {
        const modal = document.getElementById('records-modal');
        const container = document.getElementById('records-container');
        modal.style.zIndex = "100";
        // æ˜¾ç¤ºåŠ è½½ä¸­
        container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
        modal.style.display = 'block';
        
        // è·å–æ‰€æœ‰ç”¨æˆ·æ•°æ®
        const response = await fetch(`${serverurl}/get-all-custom-data`);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error('è·å–æ•°æ®å¤±è´¥');
        }
        
        // å¤„ç†å¹¶æ˜¾ç¤ºæ•°æ®
        displayRecords(data.data);
        
        // æ·»åŠ æœç´¢åŠŸèƒ½
        document.getElementById('search-username').addEventListener('input', (e) => {
            filterRecords(e.target.value, data.data);
        });
        
        // åˆ·æ–°æŒ‰é’®
        document.getElementById('refresh-records').addEventListener('click', showAllRecords);
        
    } catch (error) {
        console.error('è·å–æˆ˜ç»©å¤±è´¥:', error);
        document.getElementById('records-container').innerHTML = 
            `<div class="error">è·å–æˆ˜ç»©å¤±è´¥: ${error.message}</div>`;
    }
}

// æ˜¾ç¤ºæˆ˜ç»©è®°å½•
function displayRecords(users) {
    const container = document.getElementById('records-container');
    container.innerHTML = '';
    
    if (!users || users.length === 0) {
        container.innerHTML = '<div class="no-data">æš‚æ— æˆ˜ç»©æ•°æ®</div>';
        return;
    }
    
    // å¤„ç†æ¯ä¸ªç”¨æˆ·çš„è®°å½•
    users.forEach(user => {
        if (!user.customData) return;
        
        // è§£æå¯¹æˆ˜è®°å½•
        const records = parseRecords(user.customData);
        if (records.length === 0) return;
        
        // è®¡ç®—æ€»èƒœç‡
        const stats = calculateStats(records);
        
        // åˆ›å»ºè®°å½•å…ƒç´ 
        const recordElement = document.createElement('div');
        recordElement.className = 'record-item';
        recordElement.innerHTML = `
            
            <div class="record-details">
                <div class="record-username">${user.username}</div>
                <div class="record-stats">
                    <div class="record-stat">æ€»åœºæ¬¡: ${stats.totalMatches}</div>
                    <div class="record-stat">æ€»èƒœåœº: ${stats.totalWins}</div>
                    <div class="record-stat">èƒœç‡: ${stats.winRate}%</div>
                </div>
                ${records.map(record => `
                    <div class="record-match">
                        <div class="record-match-opponent">
                            
                            <span>å¯¹æˆ˜ ${record.opponentName}</span>
                        </div>
                        <div>æˆ˜ç»©: ${record.wins}èƒœ ${record.losses}è´Ÿ</div>
                        <div>èƒœç‡: ${record.winRate}%</div>
                    </div>
                `).join('')}
            </div>
        `;
        
        container.appendChild(recordElement);
    });
}

// è¿‡æ»¤è®°å½•
function filterRecords(searchTerm, allUsers) {
    const filteredUsers = allUsers.filter(user => {
        // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦åŒ¹é…
        if (user.username.toLowerCase().includes(searchTerm.toLowerCase())) {
            return true;
        }
        
        // æ£€æŸ¥å¯¹æˆ˜è®°å½•ä¸­æ˜¯å¦åŒ…å«æœç´¢è¯
        if (user.customData && user.customData.toLowerCase().includes(searchTerm.toLowerCase())) {
            return true;
        }
        
        return false;
    });
    
    displayRecords(filteredUsers);
}

// è§£æè®°å½•æ•°æ®
function parseRecords(customData) {
    if (!customData) return [];
    
    const records = [];
    const recordStrings = customData.split(';');
    
    recordStrings.forEach(str => {
        if (!str.startsWith('snakegame_record_with_')) return;
        
        const parts = str.split(':');
        if (parts.length !== 2) return;
        
        const opponentName = parts[0].replace('snakegame_record_with_', '');
        const [wins, losses] = parts[1].split(',').map(Number);
        
        if (isNaN(wins) || isNaN(losses)) return;
        
        const total = wins + losses;
        const winRate = total > 0 ? Math.round((wins / total) * 100) : 0;
        
        records.push({
            opponentName,
            wins,
            losses,
            winRate,
            opponentAvatar: `${serverurl}/get-icon-by-id?username=${encodeURIComponent(opponentName)}`
        });
    });
    
    return records;
}

// è®¡ç®—ç»Ÿè®¡æ•°æ®
function calculateStats(records) {
    let totalWins = 0;
    let totalLosses = 0;
    
    records.forEach(record => {
        totalWins += record.wins;
        totalLosses += record.losses;
    });
    
    const totalMatches = totalWins + totalLosses;
    const winRate = totalMatches > 0 ? Math.round((totalWins / totalMatches) * 100) : 0;
    
    return {
        totalMatches,
        totalWins,
        totalLosses,
        winRate
    };
}

// å…³é—­æ¨¡æ€æ¡†
document.querySelectorAll('.close-modal').forEach(btn => {
    btn.addEventListener('click', function() {
        document.getElementById('records-modal').style.display = 'none';
    });
});

// ç‚¹å‡»å¤–éƒ¨å…³é—­
window.addEventListener('click', function(event) {
    if (event.target === document.getElementById('records-modal')) {
        document.getElementById('records-modal').style.display = 'none';
    }
});
</script>
</body>
</html>