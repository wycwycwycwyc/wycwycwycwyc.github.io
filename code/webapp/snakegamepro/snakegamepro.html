<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒäººè´ªåƒè›‡å¤§ä½œæˆ˜</title>
<script src="/config/serverUrl.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/styles_button.css">
    <script src="/js/script4_goBackOrHome.js"></script>
    <script src="/js/script13_checkIslogin.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>
    <link href="/css/message.min.css" rel="stylesheet" />
    <script src="/js/message.min.js"></script>
<button id="back" class="custom-button" style="position: fixed; top: 120px; left: 10px;z-index: 10;" onclick="goBackOrHome()">è¿”å›</button>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }
        
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            touch-action: none;
        }
        
        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0.7);
            transform: scale(0.8);
            opacity: 0;
            animation: containerEnter 1s forwards 0.5s;
        }
        
        @keyframes containerEnter {
            0% { transform: scale(0.8); opacity: 0; }
            70% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        #game-board {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .snake-segment {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            transition: all 0.1s ease-out;
            z-index: 2;
        }
        
        .snake-head {
            transform: scale(1.2);
            z-index: 3;
        }
        
    .snake-segment.snake1 {
        background: linear-gradient(45deg, #FF5722, #FF9800);
        box-shadow: 0 0 10px #FF5722;
    }
    
    .snake-segment.snake2 {
        background: linear-gradient(45deg, #2196F3, #00BCD4);
        box-shadow: 0 0 10px #2196F3;
    }
    
    .snake-segment.snake1.snake-head {
        background: linear-gradient(45deg, #FF5722, #FF9800);
        box-shadow: 0 0 15px #FF5722;
        transform: scale(1.2);
        z-index: 3;
    }
    
    .snake-segment.snake2.snake-head {
        background: linear-gradient(45deg, #2196F3, #00BCD4);
        box-shadow: 0 0 15px #2196F3;
        transform: scale(1.2);
        z-index: 3;
    }
        .food {
            position: absolute;
            width: 20px;
            height: 20px;
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            border-radius: 50%;
            box-shadow: 0 0 10px #4CAF50;
            animation: pulse 1s infinite alternate;
            z-index: 1;
        }

        .special-food {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            z-index: 2;
            box-shadow: 0 0 15px white;
            animation: rainbowPulse 2s infinite alternate, rotate 5s infinite linear;
        }

        @keyframes rainbowPulse {
            0% { background: linear-gradient(45deg, #FF0000, #FF7F00); box-shadow: 0 0 15px #FF0000; }
            14% { background: linear-gradient(45deg, #FF7F00, #FFFF00); box-shadow: 0 0 15px #FF7F00; }
            28% { background: linear-gradient(45deg, #FFFF00, #00FF00); box-shadow: 0 0 15px #FFFF00; }
            42% { background: linear-gradient(45deg, #00FF00, #0000FF); box-shadow: 0 0 15px #00FF00; }
            57% { background: linear-gradient(45deg, #0000FF, #4B0082); box-shadow: 0 0 15px #0000FF; }
            71% { background: linear-gradient(45deg, #4B0082, #9400D3); box-shadow: 0 0 15px #4B0082; }
            85% { background: linear-gradient(45deg, #9400D3, #FF0000); box-shadow: 0 0 15px #9400D3; }
            100% { background: linear-gradient(45deg, #FF0000, #FF7F00); box-shadow: 0 0 15px #FF0000; }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.3); }
        }
        
        .score-board {
            position: absolute;
            top: 20px;
            width: 100%; /* æ”¹ä¸ºå…¨å®½åº¦ */
            display: flex;
            justify-content: space-between; /* ä¸¤ç«¯å¯¹é½ */
            padding: 0 20px; /* å·¦å³å†…è¾¹è· */
            color: white;
            font-size: 18px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            z-index: 4;
            transform: translateY(-50px);
            opacity: 0;
            animation: scoreEnter 0.5s forwards 1.5s;
            box-sizing: border-box;
        }
        
        /* ç§»é™¤åŸæ¥çš„å·¦å³å®šä½ */
        .player-score {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            padding: 10px 15px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            min-width: 150px;
        }
        
        .health-bar {
            width: 100px;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .health-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        
        .player-1 .health-fill {
            background: linear-gradient(to right, #FF5722, #FF9800);
        }
        
        .player-2 .health-fill {
            background: linear-gradient(to right, #2196F3, #00BCD4);
        }
        
        @keyframes scoreEnter {
            to { transform: translateY(0); opacity: 1; }
        }
        
        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 36px;
            z-index: 5;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        
        .game-over.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .restart-btn {
            margin-top: 20px;
            padding: 15px 40px;
            background: linear-gradient(45deg, #2196F3, #00BCD4);
            border: none;
            border-radius: 50px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.5);
            transition: all 0.3s;
            transform: scale(0);
            animation: buttonPop 0.5s forwards 0.3s;
        }
        
        @keyframes buttonPop {
            0% { transform: scale(0); }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .restart-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 25px rgba(33, 150, 243, 0.8);
        }
        
        .start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(26, 42, 108, 0.9), rgba(178, 31, 31, 0.9), rgba(253, 187, 45, 0.9));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10;
            transition: all 0.5s;
        }
        
        .start-screen.hide {
            opacity: 0;
            pointer-events: none;
        }
        
        .game-title {
            font-size: 48px;
            margin-bottom: 30px;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            animation: titleBounce 2s infinite;
            transform: translateY(-50px);
            opacity: 0;
            animation: titleEnter 1s forwards 0.2s, titleBounce 2s infinite 1.2s;
        }
        
        @keyframes titleEnter {
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes titleBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        .start-btn {
            padding: 15px 40px;
            background: linear-gradient(45deg, #FF5722, #FF9800);
            border: none;
            border-radius: 50px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 87, 34, 0.5);
            transition: all 0.3s;
            transform: scale(0);
            opacity: 0;
            animation: buttonPop 0.5s forwards 0.8s;
        }
        
        .start-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(255, 87, 34, 0.8);
        }
        .start-btn {
        /* ç¡®ä¿è¿™äº›å±æ€§å­˜åœ¨ */
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
        transform: scale(1) !important;
        }
        .instructions {
            margin-top: 30px;
            font-size: 16px;
            text-align: center;
            opacity: 0.8;
            transform: translateY(50px);
            opacity: 0;
            animation: instructionsEnter 0.8s forwards 1s;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            max-width: 500px;
        }
        
        .player-instructions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            gap: 40px;
        }
        
        .player-instruction {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .player-1-instruction {
            border: 2px solid #FF5722;
        }
        
        .player-2-instruction {
            border: 2px solid #2196F3;
        }
        
        .key {
            display: inline-block;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin: 5px;
            text-align: center;
            line-height: 40px;
            font-weight: bold;
        }
        
        @keyframes instructionsEnter {
            to { transform: translateY(0); opacity: 0.8; }
        }
        
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        
        .particle {
            position: absolute;
            width: 5px;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 10s infinite linear;
        }
        
        @keyframes float {
            0% { transform: translateY(0) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-500px) translateX(100px); opacity: 0; }
        }
        
        .snake-enter {
            animation: snakeEnter 0.8s forwards;
        }
        
        @keyframes snakeEnter {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            70% { transform: scale(1.2) rotate(360deg); opacity: 1; }
            100% { transform: scale(1) rotate(360deg); opacity: 1; }
        }
        
        .food-enter {
            animation: foodEnter 0.8s forwards;
        }
        
        @keyframes foodEnter {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            70% { transform: scale(1.3) rotate(360deg); opacity: 1; }
            100% { transform: scale(1) rotate(360deg); opacity: 1; }
        }
        
        .bg-element {
            position: absolute;
            border-radius: 50%;
            filter: blur(10px);
            opacity: 0.1;
            z-index: -1;
            animation: bgFloat 20s infinite linear;
        }
        
        @keyframes bgFloat {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(50px, 50px) rotate(180deg); }
            100% { transform: translate(0, 0) rotate(360deg); }
        }
        
        .winner-banner {
            font-size: 60px;
            margin-bottom: 30px;
            text-shadow: 0 0 20px currentColor;
            animation: winnerPulse 2s infinite;
        }
        
        @keyframes winnerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .player-1-win {
            color: #FF5722;
        }
        
        .player-2-win {
            color: #2196F3;
        }
                .player-score {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            padding: 10px 15px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            min-width: 150px;
        }
        
        .score-display {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        
        .score-text {
            font-size: 16px;
            font-weight: bold;
        }
                .character-selection {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(26, 42, 108, 0.9), rgba(178, 31, 31, 0.9), rgba(253, 187, 45, 0.9));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 9;
            opacity: 0;
            pointer-events: none;
            transition: all 0.5s;
        }
        
        .character-selection.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .selection-title {
            font-size: 36px;
            margin-bottom: 30px;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .player-selections {
            display: flex;
            gap: 50px;
            margin-bottom: 40px;
        }
        
        .player-selection {
            text-align: center;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            width: 250px;
        }
        
        .player-label {
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .snake-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .snake-option {
            padding: 12px 20px;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .snake-option:hover {
            transform: scale(1.05);
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .snake-option.selected {
            border-color: white;
            box-shadow: 0 0 15px white;
        }
        
        .speed-snake {
            border-color: #FFD700;
        }
        
        .tough-snake {
            border-color: #C0C0C0;
        }
        
        .snake-type {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .snake-desc {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .start-game-btn {
            padding: 15px 40px;
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            border: none;
            border-radius: 50px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
            transition: all 0.3s;
        }
        
        .start-game-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.8);
        }
        
        .start-game-btn:disabled {
            background: linear-gradient(45deg, #9E9E9E, #757575);
            cursor: not-allowed;
            transform: scale(1);
            box-shadow: 0 0 20px rgba(158, 158, 158, 0.5);
        }
        
        /* ç‰¹æ®Šç‰©å“æ ·å¼ */
        .immunity-ball {
            background: linear-gradient(45deg, #FFFF00, #FFD700) !important;
            box-shadow: 0 0 15px #FFFF00 !important;
            animation: pulse 1s infinite alternate !important;
        }
        
        .health-ball {
            background: linear-gradient(45deg, #FF0000, #e31010) !important;
            box-shadow: 0 0 15px #FF0000 !important;
            animation: pulse 1s infinite alternate !important;
        }
        
        .reverse-ball {
            background: linear-gradient(45deg, #001e80, #7079da) !important;
            box-shadow: 0 0 15px #002280 !important;
            animation: pulse 1s infinite alternate !important;
        }
        
        .status-effect {
            position: absolute;
            top: 10px;
            right: 20px;
            color: white;
            font-size: 14px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 10;
        }
        
        .player-1-effect {
            top: 50px;
        }
        
        .player-2-effect {
            top: 80px;
        }
                .ball-storage {
            position: absolute;
            bottom: 20px;
            display: flex;
            gap: 10px;
            z-index: 4;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
        }
        
        .player-1-storage {
            left: 20px;
        }
        
        .player-2-storage {
            right: 20px;
        }
        
        .storage-title {
            color: white;
            font-size: 14px;
            margin-right: 10px;
            display: flex;
            align-items: center;
        }
        
        .ball-slot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            position: relative;
            border: 2px solid transparent;
        }
        
        .ball-slot.filled {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            box-shadow: 0 0 10px #4CAF50;
        }
        
        .ball-slot.key-hint {
            position: absolute;
            bottom: -20px;
            font-size: 12px;
            color: white;
            width: 100%;
            text-align: center;
            left: 0;
        }
        
        /* çŠ¶æ€æ•ˆæœæ˜¾ç¤º */
        .status-effect {
            position: absolute;
            top: 10px;
            right: 20px;
            color: white;
            font-size: 14px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 10;
        }
        
        .player-1-effect {
            top: 50px;
            left: 20px;
            right: auto;
        }
        
        .player-2-effect {
            top: 80px;
            right: 20px;
        }
        
        /* é‡Šæ”¾æ•ˆæœåŠ¨ç”» */
        @keyframes releaseEffect {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }
        
        .release-effect {
            position: absolute;
            border-radius: 50%;
            animation: releaseEffect 0.5s forwards;
            z-index: 3;
        }
                .ball-storage {
            position: absolute;
            bottom: 20px;
            display: flex;
            gap: 10px;
            z-index: 4;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
        }
        
        .player-1-storage {
            left: 20px;
        }
        
        .player-2-storage {
            right: 20px;
        }
        
        .storage-title {
            color: white;
            font-size: 14px;
            margin-right: 10px;
            display: flex;
            align-items: center;
        }
        
        .ball-slot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            position: relative;
            border: 2px solid transparent;
        }
        
        .ball-slot.filled {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            box-shadow: 0 0 10px #4CAF50;
        }
        
        .ball-slot.key-hint {
            position: absolute;
            bottom: -20px;
            font-size: 12px;
            color: white;
            width: 100%;
            text-align: center;
            left: 0;
        }
        
        /* çŠ¶æ€æ•ˆæœæ˜¾ç¤º */
        .status-effect {
            position: absolute;
            top: 10px;
            right: 20px;
            color: white;
            font-size: 14px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 10;
        }
        
        .player-1-effect {
            top: 50px;
            left: 20px;
            right: auto;
        }
        
        .player-2-effect {
            top: 80px;
            right: 20px;
        }
        
        /* é‡Šæ”¾æ•ˆæœåŠ¨ç”» */
        @keyframes releaseEffect {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }
        
        .release-effect {
            position: absolute;
            border-radius: 50%;
            animation: releaseEffect 0.5s forwards;
            z-index: 3;
        }
        .magic-snake {
            border-color: #9C27B0;
        }
        .player-score .player-name {
            font-weight: bold;
            margin-right: 5px;
        }
        /* è›‡ç±»è¯¦æƒ…å¼¹çª—æ ·å¼ */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
}

.modal-content {
    background: linear-gradient(135deg, #1a2a6c, #b21f1f);
    margin: 10% auto;
    padding: 20px;
    border-radius: 15px;
    width: 80%;
    max-width: 600px;
    color: white;
    position: relative;
}

.close-modal {
    position: absolute;
    right: 20px;
    top: 10px;
    font-size: 28px;
    cursor: pointer;
}

/* è›‡ç±»è¯¦æƒ…å†…å®¹æ ·å¼ */
.snake-type-title {
    font-size: 24px;
    margin: 15px 0;
    padding-bottom: 5px;
    border-bottom: 2px solid;
}

.snake-attribute {
    margin: 10px 0;
    display: flex;
}

.attribute-name {
    font-weight: bold;
    width: 120px;
}

.attribute-value {
    flex: 1;
}

/* å›¾æ ‡æ ·å¼ */
.speed-icon {
    width: 20px;
    height: 20px;
    display: inline-block;
    background: linear-gradient(45deg, #FFD700, #FFA500);
    border-radius: 50%;
    margin-right: 5px;
}

.health-icon {
    width: 20px;
    height: 20px;
    display: inline-block;
    background: linear-gradient(45deg, #FF0000, #FF6B6B);
    border-radius: 50%;
    margin-right: 5px;
}

.magic-icon {
    width: 20px;
    height: 20px;
    display: inline-block;
    background: linear-gradient(45deg, #9C27B0, #DA70D6);
    border-radius: 50%;
    margin-right: 5px;
}

.tough-icon {
    width: 20px;
    height: 20px;
    display: inline-block;
    background: linear-gradient(45deg, #C0C0C0, #A9A9A9);
    border-radius: 50%;
    margin-right: 5px;
}

/* æ˜Ÿçº§è¯„åˆ†æ ·å¼ */
.star-rating {
    display: inline-flex;
    align-items: center;
    margin-right: 15px;
}

.star {
    font-size: 16px;
    margin-right: 2px;
}

.rating-value {
    margin-left: 5px;
    font-size: 14px;
}

.health-rating .star { 
    color: #FF6B6B;
}

.speed-rating .star { 
    color: #FFD700;
}

.magic-rating .star { 
    color: #DA70D6;
}

.health-rating .rating-value { color: #FF6B6B; }
.speed-rating .rating-value { color: #FFD700; }
.magic-rating .rating-value { color: #DA70D6; }

/* è§’è‰²é€‰æ‹©ç•Œé¢æ ·å¼ */
.snake-option {
    cursor: pointer;
    transition: all 0.3s;
}

.snake-option:hover {
    transform: scale(1.05);
}

.snake-type {
    font-weight: bold;
    font-size: 18px;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
}

.snake-desc {
    font-size: 14px;
    opacity: 0.8;
}    
/* æŒ‰é’®å®¹å™¨æ ·å¼ */
.buttons-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
}

/* ä¸Šä¼ æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
.upload-btn {
    background: linear-gradient(45deg, #4CAF50, #8BC34A) !important;
}

.upload-btn:hover {
    box-shadow: 0 0 20px rgba(76, 175, 80, 0.7) !important;
}
/* æˆ˜ç»©æŸ¥è¯¢æ¨¡æ€æ¡†æ ·å¼ */
#records-modal .modal-content {
    background: linear-gradient(135deg, #1a2a6c, #b21f1f);
    color: white;
    padding: 20px;
    border-radius: 15px;
    max-height: 80vh;
    overflow-y: auto;
}

.search-controls {
    display: flex;
    margin-bottom: 20px;
    gap: 10px;
}

.search-controls input {
    flex: 1;
    padding: 10px;
    border-radius: 5px;
    border: none;
    background-color: rgba(255,255,255,0.2);
    color: white;
}

.search-controls button {
    padding: 10px 20px;
    background: linear-gradient(45deg, #2196F3, #00BCD4);
    border: none;
    border-radius: 5px;
    color: white;
    cursor: pointer;
}

/* æˆ˜ç»©è®°å½•æ ·å¼ */
.record-item {
    background-color: rgba(0,0,0,0.3);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
}

.record-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-right: 15px;
    object-fit: cover;
    border: 2px solid white;
}

.record-details {
    flex: 1;
}

.record-username {
    font-weight: bold;
    font-size: 18px;
    margin-bottom: 5px;
}

.record-data {
    font-size: 14px;
    opacity: 0.8;
}

.record-match {
    margin-top: 10px;
    padding: 8px;
    background-color: rgba(255,255,255,0.1);
    border-radius: 5px;
}

.record-match-opponent {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
}

.record-match-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    margin-right: 10px;
    border: 1px solid white;
}

.record-stats {
    display: flex;
    gap: 15px;
    margin-top: 5px;
}

.record-stat {
    background-color: rgba(255,255,255,0.1);
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 12px;
}
/* æ¸¸æˆç»“æŸç•Œé¢æ ·å¼ */
.game-over {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    z-index: 100;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s;
    backdrop-filter: blur(5px);
}

.game-over.show {
    opacity: 1;
    pointer-events: all;
}

.game-over-content {
    text-align: center;
    max-width: 600px;
    width: 90%;
    animation: fadeInUp 0.8s;
}

.winner-container {
    margin-bottom: 30px;
}

.trophy-icon {
    font-size: 80px;
    margin-bottom: 20px;
    animation: bounce 1s infinite alternate;
}

.winner-banner {
    font-size: 48px;
    margin-bottom: 10px;
    text-shadow: 0 0 15px currentColor;
    animation: pulse 2s infinite;
}

.stats-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 30px 0;
    gap: 20px;
}

.player-stats {
    flex: 1;
    padding: 20px;
    border-radius: 15px;
    background: rgba(255, 255, 255, 0.1);
    transition: transform 0.3s;
}

.player-stats:hover {
    transform: translateY(-5px);
}

.player-1-stats {
    border: 2px solid #FF5722;
    box-shadow: 0 0 15px rgba(255, 87, 34, 0.3);
}

.player-2-stats {
    border: 2px solid #2196F3;
    box-shadow: 0 0 15px rgba(33, 150, 243, 0.3);
}

.player-avatar {
    font-size: 40px;
    margin-bottom: 10px;
}

.player-name {
    font-size: 20px;
    margin-bottom: 5px;
    font-weight: bold;
}

.win-count {
    font-size: 28px;
    font-weight: bold;
    margin: 10px 0;
}

.progress-bar {
    height: 10px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 5px;
    overflow: hidden;
    margin-top: 10px;
}

.progress-fill {
    height: 100%;
    border-radius: 5px;
    transition: width 1s ease-out;
}

.vs-text {
    font-size: 24px;
    font-weight: bold;
    margin: 0 10px;
}

.buttons-container {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 30px;
}

.restart-btn {
    padding: 15px 30px;
    border: none;
    border-radius: 50px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 10px;
}

.restart-btn i {
    font-size: 20px;
}

.restart-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.upload-btn {
    background: linear-gradient(45deg, #4CAF50, #8BC34A);
}

.restart-btn:not(.upload-btn) {
    background: linear-gradient(45deg, #2196F3, #00BCD4);
}

/* åº†ç¥ç²’å­æ•ˆæœ */
.celebration-particle {
    position: absolute;
    border-radius: 50%;
    pointer-events: none;
    animation: celebrate linear forwards;
    z-index: 101;
}

@keyframes celebrate {
    to {
        transform: translate(var(--tx), var(--ty));
        opacity: 0;
    }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes bounce {
    to {
        transform: translateY(-20px);
    }
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
}
/* æ¸¸æˆç»“æŸæ¶ˆæ¯æ ·å¼ */
.game-over-message {
    margin: 15px 0;
    padding: 10px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 5px;
    text-align: center;
    font-weight: bold;
    transition: opacity 0.5s;
}

/* å½“å‰èƒœåˆ©æ¬¡æ•°æç¤º */
.win-count .current-win {
    color: #4CAF50;
    font-weight: bold;
    margin-left: 5px;
    animation: pulse 1s infinite;
}

/* èƒœåˆ©æ¬¡æ•°æ ·å¼ */
.win-count {
    font-size: 28px;
    font-weight: bold;
    margin: 10px 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.history-wins {
    color: white;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.2);
    }
}
.map-selection {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(26, 42, 108, 0.9), rgba(178, 31, 31, 0.9), rgba(253, 187, 45, 0.9));
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    z-index: 8;
    opacity: 0;
    pointer-events: none;
    transition: all 0.5s;
}

.map-selection.show {
    opacity: 1;
    pointer-events: all;
}

.map-options {
    display: flex;
    gap: 30px;
    margin-bottom: 40px;
}

.map-option {
    padding: 20px;
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 15px;
    width: 250px;
    cursor: pointer;
    transition: all 0.3s;
}

.map-option:hover {
    transform: scale(1.05);
    background-color: rgba(255, 255, 255, 0.1);
}

.map-option.selected {
    border: 2px solid white;
    box-shadow: 0 0 15px white;
}

.map-preview {
    width: 100%;
    height: 150px;
    border-radius: 10px;
    margin-bottom: 15px;
}

.map-name {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 5px;
}

.map-desc {
    font-size: 14px;
    opacity: 0.8;
}

/* ç«å±±æ ·å¼ */
.volcano {
    position: absolute;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: radial-gradient(circle, #8B0000, #FF4500);
    z-index: 1;
    box-shadow: 0 0 15px #FF4500;
}

.lava {
    position: absolute;
    width: 20px;
    height: 20px;
    background: linear-gradient(45deg, #FF4500, #FF8C00);
    border-radius: 50%;
    z-index: 1;
    animation: lavaPulse 1s infinite alternate;
}

@keyframes lavaPulse {
    from { opacity: 0.7; transform: scale(1); }
    to { opacity: 1; transform: scale(1.1); }
}

.warning-volcano {
    animation: volcanoWarning 0.5s infinite alternate;
}

@keyframes volcanoWarning {
    from { box-shadow: 0 0 15px #FF4500; }
    to { box-shadow: 0 0 30px #FFFF00; }
}
        /* åŸºåœ°çš„æ ·å¼ */
        .home-base {
            position: absolute;
            border: 3px solid;
            border-radius: 15px;
            z-index: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 3px rgba(0,0,0,0.8);
            transition: all 0.3s ease;
        }
        
        .home-base.player1 {
            border-color: #FF5722;
            background: linear-gradient(135deg, rgba(255, 87, 34, 0.3), rgba(255, 152, 0, 0.2));
            box-shadow: 0 0 20px rgba(255, 87, 34, 0.5);
            left: 20px;
            top: 20px;
        }
        
        .home-base.player2 {
            border-color: #2196F3;
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.3), rgba(0, 188, 212, 0.2));
            box-shadow: 0 0 20px rgba(33, 150, 243, 0.5);
            right: 20px;
            bottom: 20px;
        }
        
        .home-health-bar {
            position: absolute;
            bottom: -15px;
            left: 10%;
            width: 80%;
            height: 6px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .home-health-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }
        
        .home1-health-fill {
            background: linear-gradient(to right, #FF5722, #FF9800);
        }
        
        .home2-health-fill {
            background: linear-gradient(to right, #2196F3, #00BCD4);
        }
        
        .home-health-text {
            position: absolute;
            top: -20px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 12px;
            color: white;
        }
        
        /* åŸºåœ°è¢«æ”»å‡»æ•ˆæœ */
        .home-under-attack {
            animation: homeUnderAttack 0.5s infinite alternate;
        }
        
        @keyframes homeUnderAttack {
            from { box-shadow: 0 0 20px; }
            to { box-shadow: 0 0 40px; }
        }
        
        /* åŸºåœ°è¢«æ‘§æ¯æ•ˆæœ */
        .home-destroyed {
            opacity: 0.3;
            filter: grayscale(100%);
            box-shadow: none;
        }
        
        /* åœ¨åŸºåœ°ä¸­çš„æ•ˆæœ */
        .in-home-effect {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 15px;
            background: radial-gradient(circle, transparent 50%, rgba(255,255,255,0.1) 100%);
            animation: homeHealing 2s infinite linear;
            z-index: -1;
        }
        
        @keyframes homeHealing {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
/* æ·»åŠ ç»Ÿè®¡è¯¦æƒ…æ ·å¼ */
.stats-details {
    animation: fadeInUp 0.8s ease-out;
    max-height: 500px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #FF5722 rgba(255,255,255,0.1);
}

.stats-details::-webkit-scrollbar {
    width: 8px;
}

.stats-details::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
}

.stats-details::-webkit-scrollbar-thumb {
    background: linear-gradient(45deg, #FF5722, #2196F3);
    border-radius: 4px;
}

.player-stats-detail {
    transition: transform 0.3s, box-shadow 0.3s;
    min-height: 400px;
    display: flex;
    flex-direction: column;
}

.player-stats-detail:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ç§»åŠ¨ç»Ÿè®¡æ ·å¼ */
.distance-stats {
    margin-top: 10px;
    padding: 10px;
    background: linear-gradient(135deg, rgba(0, 188, 212, 0.2), rgba(0, 150, 136, 0.2));
    border-radius: 8px;
    border-left: 4px solid #00BCD4;
}

/* ä¼¤å®³ç»Ÿè®¡è¡Œæ ·å¼ */
.damage-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 8px;
    margin: 2px 0;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.damage-row:hover {
    background-color: rgba(255, 255, 255, 0.05);
}

.damage-received .damage-row {
    border-left: 3px solid #ff6b6b;
}

.damage-dealt .damage-row {
    border-left: 3px solid #4CAF50;
}

/* æ€»è®¡è¡Œæ ·å¼ */
.total-row {
    font-weight: bold;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 2px solid rgba(255, 255, 255, 0.2);
    font-size: 14px;
}

/* æ¸¸æˆæ—¶é—´æ ·å¼ */
.game-time {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 5px 12px;
    background: rgba(255, 215, 0, 0.2);
    border-radius: 20px;
    margin-left: 15px;
    border: 1px solid rgba(255, 215, 0, 0.5);
}

/* å›¾æ ‡é¢œè‰² */
.fa-shield-alt {
    color: #FFA500;
}

.fa-crosshairs {
    color: #4CAF50;
}

.fa-road {
    color: #00BCD4;
}

.fa-fire {
    color: #FF5722;
}

.fa-tint {
    color: #2196F3;
}        
/* ç»Ÿè®¡æ¨¡æ€æ¡†æ ·å¼ */
#game-stats-modal .modal-content {
    background: linear-gradient(135deg, #1a2a6c, #b21f1f);
    color: white;
    padding: 20px;
    border-radius: 15px;
    max-height: 80vh;
    overflow-y: auto;
}

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
}

.player-stats-box {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    padding: 15px;
    border: 2px solid;
}

.player-stats-box.player1 {
    border-color: #FF5722;
}

.player-stats-box.player2 {
    border-color: #2196F3;
}

.stats-header {
    text-align: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.stats-header h3 {
    margin: 0;
    font-size: 20px;
}

.stats-section {
    margin-bottom: 15px;
}

.section-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #FFD700;
    margin-bottom: 8px;
    font-weight: bold;
}

.stats-items {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    font-size: 12px;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    padding: 5px 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 5px;
}

.stat-total {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    font-weight: bold;
}

.game-time-display {
    text-align: center;
    padding: 10px;
    background: rgba(255, 215, 0, 0.2);
    border-radius: 10px;
    margin-bottom: 20px;
    border: 1px solid rgba(255, 215, 0, 0.5);
}

.game-time-display i {
    margin-right: 8px;
    color: #FFD700;
}
/* å•†åº—ç³»ç»Ÿæ ·å¼ */
.store-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 20;
}

.store-container {
    width: 400px;

    border-radius: 15px;
    padding: 20px;
    color: white;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
    border: 2px solid rgba(255, 255, 255, 0.2);
}

.store-header {
    text-align: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
}

.store-header h2 {
    font-size: 28px;
    margin-bottom: 5px;
    text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
}

.store-player-name {
    font-size: 16px;
    opacity: 0.8;
}

.store-player-name.player1 {
    color: #FF9800;
}

.store-player-name.player2 {
    color: #2196F3;
}

.store-score {
    font-size: 18px;
    margin-top: 10px;
    color: #FFD700;
}

.store-items {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.store-item {
    display: flex;
    align-items: center;
    padding: 15px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
}

.store-item:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateX(5px);
}

.store-item.selected {
    border-color: #4CAF50;
    background: rgba(76, 175, 80, 0.2);
    box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
}

.store-item-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    margin-right: 15px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 24px;
    background: rgba(0, 0, 0, 0.3);
}

.store-item-info {
    flex: 1;
}

.store-item-name {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 5px;
}

.store-item-desc {
    font-size: 12px;
    opacity: 0.8;
    margin-bottom: 5px;
}

.store-item-price {
    font-size: 16px;
    color: #FFD700;
    display: flex;
    align-items: center;
}

.store-item-price i {
    margin-right: 5px;
}

.store-footer {
    margin-top: 20px;
    text-align: center;
}

.store-buy-btn {
    padding: 12px 30px;
    background: linear-gradient(45deg, #4CAF50, #8BC34A);
    border: none;
    border-radius: 25px;
    color: white;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
}

.store-buy-btn:hover:not(:disabled) {
    transform: scale(1.05);
    box-shadow: 0 0 20px rgba(76, 175, 80, 0.8);
}

.store-buy-btn:disabled {
    background: linear-gradient(45deg, #666, #888);
    cursor: not-allowed;
    box-shadow: none;
}

.store-hint {
    font-size: 12px;
    margin-top: 10px;
    opacity: 0.7;
    color: #aaa;
}

/* ç©å®¶1å•†åº—ä½ç½® */
.store-overlay.player1 {
    justify-content: flex-start;
}

.store-overlay.player1 .store-container {
    margin-left: 20px;
}

/* ç©å®¶2å•†åº—ä½ç½® */
.store-overlay.player2 {
    justify-content: flex-end;
}

.store-overlay.player2 .store-container {
    margin-right: 20px;
}


    </style>
</head>
<body>
    <div id="game-stats-modal" class="modal">
    <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
        <span class="close-modal" data-modal="game-stats-modal">&times;</span>
        <h2><i class="fas fa-chart-bar"></i> æœ¬å±€æ¸¸æˆè¯¦ç»†æ•°æ®</h2>
        <div id="game-stats-content"></div>
    </div>
</div>   
<!-- ç©å®¶1å•†åº— -->
<div id="store-player1" class="store-overlay player1">
    <div class="store-container">
        <div class="store-header">
            <h2><i class="fas fa-shopping-cart"></i> å•†åº—</h2>
            <div class="store-player-name player1" id="store-player1-name">ç©å®¶1</div>
            <div class="store-score">
                å½“å‰åˆ†æ•°: <span id="store-player1-score">0</span>åˆ†
            </div>
        </div>
        
        <div class="store-items" id="store-player1-items">
            <!-- å•†åº—é¡¹ç›®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="store-footer">
            <button class="store-buy-btn" id="store-player1-buy" disabled>
                è´­ä¹° (å·¦Alté”®)
            </button>
            <div class="store-hint">
                <i class="fas fa-info-circle"></i> WSADé€‰æ‹©ï¼Œå·¦Altè´­ä¹°ï¼Œå·¦Ctrlå…³é—­
            </div>
        </div>
    </div>
</div>

<!-- ç©å®¶2å•†åº— -->
<div id="store-player2" class="store-overlay player2">
    <div class="store-container">
        <div class="store-header">
            <h2><i class="fas fa-shopping-cart"></i> å•†åº—</h2>
            <div class="store-player-name player2" id="store-player2-name">ç©å®¶2</div>
            <div class="store-score">
                å½“å‰åˆ†æ•°: <span id="store-player2-score">0</span>åˆ†
            </div>
        </div>
        
        <div class="store-items" id="store-player2-items">
            <!-- å•†åº—é¡¹ç›®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="store-footer">
            <button class="store-buy-btn" id="store-player2-buy" disabled>
                è´­ä¹° (å³Alté”®)
            </button>
            <div class="store-hint">
                <i class="fas fa-info-circle"></i> æ–¹å‘é”®é€‰æ‹©ï¼Œå³Altè´­ä¹°ï¼Œå³Ctrlå…³é—­
            </div>
        </div>
    </div>
</div>
    <!-- æ·»åŠ åˆ°character-selection divä¹‹å -->
<div class="map-selection">
    <h2 class="selection-title">é€‰æ‹©åœ°å›¾</h2>
    <div class="map-options">
        <div class="map-option" data-map="default">
            <div class="map-preview" style="background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);"></div>
            <div class="map-name">é»˜è®¤åœ°å›¾</div>
            <div class="map-desc">ç»å…¸åŒè›‡å¯¹æˆ˜åœ°å›¾</div>
        </div>
        <div class="map-option" data-map="snow">
            <div class="map-preview" style="background: linear-gradient(135deg, #1e3c72, #2a5298, #7b4397);"></div>
            <div class="map-name">é›ªå±±åœ°å›¾</div>
            <div class="map-desc">æš´é£é›ªå¤©æ°”æŒ‘æˆ˜</div>
        </div>
        <div class="map-option" data-map="volcano">
            <div class="map-preview" style="background: linear-gradient(135deg, #8B0000, #FF4500, #FF8C00);"></div>
            <div class="map-name">ç«å±±åœ°å›¾</div>
            <div class="map-desc">ç«å±±å–·å‘æŒ‘æˆ˜</div>
        </div>        
    </div>
    <button class="start-game-btn" disabled>å¼€å§‹æ¸¸æˆ</button>
</div>
    <button id="view-records"style="position: absolute;top: 20px;right: 20px; background: rgba(255,255,255,0.2);border: none;color: white;padding: 5px 10px;border-radius: 5px;cursor: pointer;z-index: 10;">æŸ¥çœ‹æˆ˜ç»©</button>
            <div id="records-modal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <span class="close-modal">&times;</span>
                <h2>ç©å®¶å¯¹æˆ˜è®°å½•</h2>
                <div class="search-controls">
                    <input type="text" id="search-username" placeholder="æœç´¢ç©å®¶...">
                    <button id="refresh-records">åˆ·æ–°</button>
                </div>
                <div id="records-container"></div>
            </div>
        </div>
    <div class="game-container">
        <div class="start-screen">
            <h1 class="game-title">ğŸ åŒäººè´ªåƒè›‡ ğŸ</h1>
            <button class="start-btn">å¼€å§‹æ¸¸æˆ</button>
            <div class="instructions">
                <p>ä¸¤æ¡è›‡å„æœ‰10ç‚¹ç”Ÿå‘½å€¼ï¼Œæ’åˆ°å¯¹æ–¹è›‡èº«ä¼šæ‰£è¡€å¹¶ç¼©çŸ­</p>
                <p>æ´»åˆ°æœ€åçš„ç©å®¶è·èƒœï¼</p>
                
                <div class="player-instructions">
                    <div class="player-instruction player-1-instruction">
                        <h3><i class="fas fa-fire"></i> ç©å®¶1 (æ©™è‰²)</h3>
                        <p>ä½¿ç”¨WASDæ§åˆ¶</p>
                        <div>
                            <div class="key">W</div>
                            <div class="key">A</div>
                            <div class="key">S</div>
                            <div class="key">D</div>
                        </div>
                    </div>
                    
                    <div class="player-instruction player-2-instruction">
                        <h3><i class="fas fa-tint"></i> ç©å®¶2 (è“è‰²)</h3>
                        <p>ä½¿ç”¨æ–¹å‘é”®æ§åˆ¶</p>
                        <div>
                            <div class="key">â†‘</div>
                            <div class="key">â†</div>
                            <div class="key">â†“</div>
                            <div class="key">â†’</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="particles" id="particles"></div>
        
        <div id="game-board"></div>
        
        <!-- çŠ¶æ€æ•ˆæœæ˜¾ç¤º -->
        <div class="status-effect player-1-effect" id="player1-effect"></div>
        <div class="status-effect player-2-effect" id="player2-effect"></div>
        
    <div class="game-over">
        <h2 class="winner-banner" id="winner-banner">æ¸¸æˆç»“æŸ!</h2>
        <!-- æ–°å¢æ¯”åˆ†æ˜¾ç¤º -->
        <div class="score-display">
            <div id="winner-name">è·èƒœè€…: <span id="winner-player"></span></div>
            <div class="final-score" id="final-score">0:0</div>
        </div>
        <div class="buttons-container">
            <button class="restart-btn upload-btn" id="upload-record">ä¸Šä¼ æˆ˜ç»©</button>
            <button class="restart-btn">å†æ¥ä¸€å±€</button>
        </div>
    </div>
    </div>
        <div class="score-board">
            <div class="player-score player-1">
                <div class="score-display">
                    <span class="player-name" id="player1-name">ç©å®¶1: </span>
                    <span class="score-text" id="score-1">0åˆ†</span>
                </div>
                <div class="health-display">
                    <span>ç”Ÿå‘½å€¼: </span>
                    <div class="health-bar">
                        <div class="health-fill" id="health-1" style="width: 100%;"></div>
                    </div>
                    <span id="health-text-1">10HP</span>
                </div>
            </div>
            <div class="player-score player-2">
                <div class="score-display">
                    <span class="player-name" id="player2-name">ç©å®¶2: </span>
                    <span class="score-text" id="score-2">0åˆ†</span>
                </div>
                <div class="health-display">
                    <span>ç”Ÿå‘½å€¼: </span>
                    <div class="health-bar">
                        <div class="health-fill" id="health-2" style="width: 100%;"></div>
                    </div>
                    <span id="health-text-2">10HP</span>
                </div>
            </div>
        </div>
        <div class="ball-storage player-1-storage">
            <div id ="storage-title1" class="storage-title">ç©å®¶1å‚¨å­˜:</div>
            <div class="ball-slot" id="p1-slot-1"><span class="key-hint">1</span></div>
            <div class="ball-slot" id="p1-slot-2"><span class="key-hint">2</span></div>
            <div class="ball-slot" id="p1-slot-3"><span class="key-hint">3</span></div>
            <div class="ball-slot" id="p1-slot-4"><span class="key-hint">4</span></div>
            <div class="ball-slot" id="p1-slot-5"><span class="key-hint">5</span></div>
        </div>
        
        <div class="ball-storage player-2-storage">
            <div id ="storage-title2" class="storage-title">ç©å®¶2å‚¨å­˜:</div>
            <div class="ball-slot" id="p2-slot-1"><span class="key-hint">6</span></div>
            <div class="ball-slot" id="p2-slot-2"><span class="key-hint">7</span></div>
            <div class="ball-slot" id="p2-slot-3"><span class="key-hint">8</span></div>
            <div class="ball-slot" id="p2-slot-4"><span class="key-hint">9</span></div>
            <div class="ball-slot" id="p2-slot-5"><span class="key-hint">0</span></div>
        </div>       
        <!-- è§’è‰²é€‰æ‹©ç•Œé¢ -->
        <div class="character-selection">
            <h2 class="selection-title">é€‰æ‹©ä½ çš„è›‡</h2>
            
            <div class="player-selections">
<div class="player-selection">
    <div class="player-label" id="player-label1">ç©å®¶1 (æ©™è‰²)</div>
    <div class="snake-options">
        <div class="snake-option speed-snake" data-player="1" data-type="speed">
            <div class="snake-type" style="color: #FFD700;">
                é€Ÿåº¦è›‡ <span class="speed-rating">â˜…â˜…â˜…â˜…â˜…</span>
            </div>
            <div class="snake-desc">
                <span class="health-rating">ç”Ÿå‘½: â˜…â˜…â˜†â˜†â˜†</span> | 
                <span class="magic-rating">é­”æ³•: â˜…â˜†â˜†â˜†â˜†</span>
            </div>
        </div>
        
        <div class="snake-option tough-snake" data-player="1" data-type="tough">
            <div class="snake-type" style="color: #C0C0C0;">
                åšç¡¬è›‡ <span class="health-rating">ç”Ÿå‘½: â˜…â˜…â˜…â˜…â˜…</span>
            </div>
            <div class="snake-desc">
                <span class="speed-rating">é€Ÿåº¦: â˜…â˜…â˜†â˜†â˜†</span> | 
                <span class="magic-rating">é­”æ³•: â˜…â˜†â˜†â˜†â˜†</span>
            </div>
        </div>
        
        <div class="snake-option magic-snake" data-player="1" data-type="magic">
            <div class="snake-type" style="color: #9C27B0;">
                é­”æ³•è›‡ <span class="magic-rating">é­”æ³•: â˜…â˜…â˜…â˜…â˜…</span>
            </div>
            <div class="snake-desc">
                <span class="health-rating">ç”Ÿå‘½: â˜…â˜…â˜…â˜†â˜†</span> | 
                <span class="speed-rating">é€Ÿåº¦: â˜…â˜…â˜…â˜†â˜†</span>
            </div>
        </div>
    </div>
</div>

<div class="player-selection">
    <div class="player-label" id="player-label2">ç©å®¶2 (è“è‰²)</div>
    <div class="snake-options">
        <div class="snake-option speed-snake" data-player="2" data-type="speed">
            <div class="snake-type" style="color: #FFD700;">
                é€Ÿåº¦è›‡ <span class="speed-rating">â˜…â˜…â˜…â˜…â˜…</span>
            </div>
            <div class="snake-desc">
                <span class="health-rating">ç”Ÿå‘½: â˜…â˜…â˜†â˜†â˜†</span> | 
                <span class="magic-rating">é­”æ³•: â˜…â˜†â˜†â˜†â˜†</span>
            </div>
        </div>
        
        <div class="snake-option tough-snake" data-player="2" data-type="tough">
            <div class="snake-type" style="color: #C0C0C0;">
                åšç¡¬è›‡ <span class="health-rating">ç”Ÿå‘½: â˜…â˜…â˜…â˜…â˜…</span>
            </div>
            <div class="snake-desc">
                <span class="speed-rating">é€Ÿåº¦: â˜…â˜…â˜†â˜†â˜†</span> | 
                <span class="magic-rating">é­”æ³•: â˜…â˜†â˜†â˜†â˜†</span>
            </div>
        </div>
        
        <div class="snake-option magic-snake" data-player="2" data-type="magic">
            <div class="snake-type" style="color: #9C27B0;">
                é­”æ³•è›‡ <span class="magic-rating">é­”æ³•: â˜…â˜…â˜…â˜…â˜…</span>
            </div>
            <div class="snake-desc">
                <span class="health-rating">ç”Ÿå‘½: â˜…â˜…â˜…â˜†â˜†</span> | 
                <span class="speed-rating">é€Ÿåº¦: â˜…â˜…â˜…â˜†â˜†</span>
            </div>
        </div>
    </div>
</div>  
            
            <button class="start-game-btn">å¼€å§‹æ¸¸æˆ</button>
        </div>
                <!-- æ·»åŠ åˆ°bodyçš„æœ«å°¾ -->
        <div id="snake-details-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2>è›‡ç±»ç‰¹æ€§è¯¦æƒ…</h2>
                <div id="snake-details-content"></div>
            </div>
        </div>
        <!-- æ·»åŠ åˆ°bodyçš„åˆé€‚ä½ç½® -->
<!-- åœ¨HTMLæ–‡ä»¶çš„åˆé€‚ä½ç½®ï¼ˆæ¯”å¦‚åœ¨records-modalä¹‹åï¼‰æ·»åŠ ç»Ÿè®¡æ•°æ®æ¨¡æ€æ¡† -->


<script>
// æ¸¸æˆå˜é‡
let snakes = {
    snake1: [],
    snake2: []
};
let foods = [];
let specialItems = []; // å­˜å‚¨ç‰¹æ®Šçƒ
let directions = {
    snake1: 'right',
    snake2: 'right'
};
let nextDirections = {
    snake1: 'right',
    snake2: 'right'
};
let gameInterval;
let gameSpeed = 100;
let health = {
    snake1: 10,
    snake2: 10
};
let scores = {
    snake1: 0,
    snake2: 0
};
let snakeTypes = {
    snake1: null,
    snake2: null
};
let collisionCount = {
    snake1: 0,
    snake2: 0
};
let defenseRate = {
    snake1: 1.0,
    snake2: 1.0
};
let immunity = {
    snake1: false,
    snake2: false,
    timer1: 0,
    timer2: 0
};
let reversedControls = {
    snake1: false,
    snake2: false,
    timer1: 0,
    timer2: 0
};
let ballStorage = {
    snake1: [],
    snake2: []
};
let attackMode = {
    snake1: false,
    snake2: false,
    timer1: 0,
    timer2: 0,
    lastShot1: 0,
    lastShot2: 0
};
let magicSnakeTimers = {
    snake1: 0,
    snake2: 0
};
let pausedSnakes = {
    snake1: false,
    snake2: false
};
let walls = [];
let bullets = []; // å­˜å‚¨å­å¼¹å¯¹è±¡
let lastSpecialItemSpawn = 0;
let gameStarted = false;
let lastTime = 0;
let lastWallHitTime = {
snake1: 0,
snake2: 0
};
let deathCause = {
    snake1: null,
    snake2: null
};
// æ¸¸æˆå˜é‡ä¸­æ·»åŠ 
let volcanoes = [];
let lavaTiles = [];
let lastEruptionTime = 0;
let isErupting = false;
let nextEruptionTime = 30000; // 30ç§’åç¬¬ä¸€æ¬¡å–·å‘
// åœ¨æ¸¸æˆå˜é‡ä¸­æ·»åŠ 
let currentMap = 'default';
let blizzardActive = false;
let blizzardDirection = null;
let blizzardTimer = 0;
let coldWindTimer = 0;
let snakeSpeedModifiers = { snake1: 1, snake2: 1 };
let frozenSnakes = { snake1: false, snake2: false, timer1: 0, timer2: 0 };
let speedBoosts = {
    snake1: 0,
    snake2: 0
};
let baseDefense = {
    player1: {
        lastShotTime: 0,
        bulletSpeed: 1, // ç¨å¾®é™ä½é€Ÿåº¦
        attackRange: 15, // 20æ ¼ = 400åƒç´ 
        active: false,
        targetSnake: null,
        damage: 0.5,
        shootInterval: 1000 // 2ç§’é—´éš”
    },
    player2: {
        lastShotTime: 0,
        bulletSpeed: 1,
        attackRange: 15,
        active: false,
        targetSnake: null,
        damage: 0.5,
        shootInterval: 1000
    }
};
// åœ¨æ¸¸æˆå˜é‡ä¸­æ·»åŠ ç»Ÿè®¡å˜é‡
// ä¿®æ”¹æ¸¸æˆç»Ÿè®¡æ•°æ®åˆå§‹åŒ–
let gameStats = {
    startTime: 0,
    snake1: {
        // æ‰¿å—ä¼¤å®³ç»Ÿè®¡
        damageReceived: {
            wall: 0,
            snakeCollision: 0,
            bullet: 0,
            base: 0,
            lava: 0,
            home: 0,
            bomb: 0
        },
        originalDamageReceived: {
            wall: 0,
            snakeCollision: 0,
            bullet: 0,
            base: 0,
            lava: 0,
            home: 0,
            bomb: 0
        },
        
        // === è¾“å‡ºä¼¤å®³ç»Ÿè®¡ - ç¡®ä¿è¿™éƒ¨åˆ†å­˜åœ¨ ===
        damageDealt: {
            snakeCollision: 0,
            bullet: 0,
            bomb: 0,
            base: 0, // åŸºåœ°å­å¼¹ä¼¤å®³
            wall: 0  // æ’å¢™ä¼¤å®³ï¼ˆå¦‚æœæœ‰ï¼‰
        },
        originalDamageDealt: {
            snakeCollision: 0,
            bullet: 0,
            bomb: 0,
            base: 0,
            wall: 0
        },
        
        // é˜²å¾¡ç»Ÿè®¡
        shieldDamageAbsorbed: 0,
        shieldBlocks: 0,
        shieldBreaks: 0,
        immuneDamagePrevented: {},
        immuneBlocks: 0,
        toughImmuneDamagePrevented: {},
        toughImmuneBlocks: 0,
        toughReducedDamage: {},
        
        // ç§»åŠ¨ç»Ÿè®¡
        distanceTraveled: 0,
        
        // æ€»è®¡
        totalDamageReceived: 0,
        totalOriginalDamageReceived: 0,
        totalDamageDealt: 0,        // ç¡®ä¿è¿™ä¸ªå­˜åœ¨
        totalOriginalDamageDealt: 0 // ç¡®ä¿è¿™ä¸ªå­˜åœ¨
    },
    snake2: {
        // åŒæ ·çš„ç»“æ„
        damageReceived: {
            wall: 0,
            snakeCollision: 0,
            bullet: 0,
            base: 0,
            lava: 0,
            home: 0,
            bomb: 0
        },
        originalDamageReceived: {
            wall: 0,
            snakeCollision: 0,
            bullet: 0,
            base: 0,
            lava: 0,
            home: 0,
            bomb: 0
        },
        
        // === è¾“å‡ºä¼¤å®³ç»Ÿè®¡ ===
        damageDealt: {
            snakeCollision: 0,
            bullet: 0,
            bomb: 0,
            base: 0,
            wall: 0
        },
        originalDamageDealt: {
            snakeCollision: 0,
            bullet: 0,
            bomb: 0,
            base: 0,
            wall: 0
        },
        
        // é˜²å¾¡ç»Ÿè®¡
        shieldDamageAbsorbed: 0,
        shieldBlocks: 0,
        shieldBreaks: 0,
        immuneDamagePrevented: {},
        immuneBlocks: 0,
        toughImmuneDamagePrevented: {},
        toughImmuneBlocks: 0,
        toughReducedDamage: {},
        
        distanceTraveled: 0,
        totalDamageReceived: 0,
        totalOriginalDamageReceived: 0,
        totalDamageDealt: 0,
        totalOriginalDamageDealt: 0
    }
};
let storeOpen = {
    snake1: false,
    snake2: false
};

let storeSelectedItem = {
    snake1: 0,
    snake2: 0
};
// åœ¨æ¸¸æˆå˜é‡ä¸­æ·»åŠ æŠ¤ç›¾çŠ¶æ€
let shields = {
    snake1: {
        active: false,
        health: 0,
        maxHealth: 10
    },
    snake2: {
        active: false,
        health: 0,
        maxHealth: 10
    }
};
// å•†åº—é¡¹ç›®å®šä¹‰
const storeItems = [
    {
        id: 'shield',
        name: 'èƒ½é‡æŠ¤ç›¾',
        description: 'è·å¾—10ç‚¹æŠ¤ç›¾å€¼ï¼Œä¼˜å…ˆæŠµæŒ¡ä¼¤å®³',
        price: 800,
        icon: 'ğŸ›¡ï¸',
        color: '#00BCD4',
        type: 'shield',
        maxLevel: 1  // åªèƒ½è´­ä¹°ä¸€æ¬¡
    },
    {
        id: 'random_balls',
        name: 'éšæœºé­”æ³•çƒç¤¼åŒ…',
        description: 'è·å¾—3ä¸ªéšæœºé­”æ³•çƒ (æ”»å‡»/è¡€çƒ/æ— æ•Œ/åè½¬/ç‚¸å¼¹)',
        price: 800,
        icon: 'ğŸ',
        color: '#9C27B0',
        type: 'consumable'
    },
    {
        id: 'speed_upgrade',
        name: 'é€Ÿåº¦å±æ€§å‡çº§',
        description: 'æ°¸ä¹…å¢åŠ ç§»åŠ¨é€Ÿåº¦15% (æœ€å¤šå åŠ 2æ¬¡)',
        price: 1000,
        icon: 'âš¡',
        color: '#FFD700',
        type: 'upgrade',
        maxLevel: 2
    },
    {
        id: 'tough_upgrade',
        name: 'åšç¡¬å±æ€§å‡çº§',
        description: 'æ°¸ä¹…å¢åŠ ç”Ÿå‘½å€¼ä¸Šé™2ç‚¹ (æœ€å¤šå åŠ 2æ¬¡)',
        price: 1000,
        icon: 'ğŸ›¡ï¸',
        color: '#C0C0C0',
        type: 'upgrade',
        maxLevel: 2
    },
    {
        id: 'magic_upgrade',
        name: 'é­”æ³•å±æ€§å‡çº§',
        description: 'æ°¸ä¹…å»¶é•¿ç‰¹æ®Šæ•ˆæœæ—¶é—´20% (æœ€å¤šå åŠ 2æ¬¡)',
        price: 1000,
        icon: 'âœ¨',
        color: '#2196F3',
        type: 'upgrade',
        maxLevel: 2
    }
];

// ç©å®¶å‡çº§çŠ¶æ€
let playerUpgrades = {
    snake1: {
        speed: 0,
        tough: 0,
        magic: 0
    },
    snake2: {
        speed: 0,
        tough: 0,
        magic: 0
    }
};

const gameBoard = document.getElementById('game-board');
const startBtn = document.querySelector('.start-btn');
const restartBtn = document.querySelector('.restart-btn');
const health1El = document.getElementById('health-1');
const health2El = document.getElementById('health-2');
const score1El = document.getElementById('score-1');
const score2El = document.getElementById('score-2');
const gameOverScreen = document.querySelector('.game-over');
const startScreen = document.querySelector('.start-screen');
const particlesContainer = document.getElementById('particles');
const winnerBanner = document.getElementById('winner-banner');
const winnerName = document.getElementById('winner-name');
const characterSelection = document.querySelector('.character-selection');
const viewRecords = document.getElementById("view-records");
let lastMoveTime = {
    snake1: 0,
    snake2: 0
};
        // åœ¨æ¸¸æˆå˜é‡ä¸­æ·»åŠ 
        let homes = {
            player1: {
                x: 20,
                y: 20,
                width: 100,
                height: 80,
                health: 20,
                maxHealth: 20,
                destroyed: false,
                lastHealTime: 0,
                lastDamageTime: 0
            },
            player2: {
                x: 0, // å°†åœ¨åˆå§‹åŒ–æ—¶è®¡ç®—
                y: 0, // å°†åœ¨åˆå§‹åŒ–æ—¶è®¡ç®—
                width: 100,
                height: 80,
                health: 20,
                maxHealth: 20,
                destroyed: false,
                lastHealTime: 0,
                lastDamageTime: 0
            }
        };
        
        // ä¿®æ”¹initGameå‡½æ•°ï¼Œåœ¨ç”Ÿæˆç«å±±ååˆå§‹åŒ–åŸºåœ°

        // åˆå§‹åŒ–åŸºåœ°çš„ä½ç½®
function initHomes() {
    const boardWidth = gameBoard.clientWidth;
    const boardHeight = gameBoard.clientHeight;
    
    // å¢å¤§åŸºåœ°çš„å°ºå¯¸
    const homeWidth = 250;
    const homeHeight = 200;
    
    // ç©å®¶1çš„åŸºåœ°åœ¨å·¦ä¸Šè§’
    homes.player1 = {
        x: 20,
        y: 110, // é¿å¼€è®¡åˆ†æ¿
        width: homeWidth,
        height: homeHeight,
        health: 50,
        maxHealth: 50,
        destroyed: false,
        lastHealTime: 0,
        lastDamageTime: 0
    };
    
    // ç©å®¶2çš„åŸºåœ°åœ¨å³ä¸‹è§’
    homes.player2 = {
        x: boardWidth - homeWidth - 20,
        y: boardHeight - homeHeight - 80, // é¿å¼€åº•éƒ¨UI
        width: homeWidth,
        height: homeHeight,
        health: 50,
        maxHealth: 50,
        destroyed: false,
        lastHealTime: 0,
        lastDamageTime: 0
    };
}
function resetDeathCauses() {
    deathCause = {
        snake1: null,
        snake2: null
    };
}     
// ç»Ÿä¸€çš„ä¼¤å®³å¤„ç†å‡½æ•°
// åœ¨applyDamageå‡½æ•°ä¸­æ·»åŠ åšç¡¬è›‡å­å¼¹å…ç–«
// ä¿®æ”¹applyDamageå‡½æ•°ï¼Œæ·»åŠ æŠ¤ç›¾å¤„ç†
function applyDamage(snakeId, damage, source = 'unknown', details = {}) {
    if (!gameStarted || health[snakeId] <= 0) return false;
    
    const otherSnakeId = snakeId === 'snake1' ? 'snake2' : 'snake1';
    const snakeName = snakeId === 'snake1' ? 'ç©å®¶1' : 'ç©å®¶2';
    const head = snakes[snakeId][0];
    
    // === ç¬¬ä¸€æ­¥ï¼šè®°å½•åŸå§‹ä¼¤å®³ï¼ˆæ— è®ºæ˜¯å¦è¢«æŠµæŒ¡ï¼‰===
    // åˆå§‹åŒ–ä¼¤å®³ç±»å‹ç»Ÿè®¡ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if (!gameStats[snakeId].originalDamageReceived) {
        gameStats[snakeId].originalDamageReceived = {};
    }
    if (!gameStats[snakeId].originalDamageReceived[source]) {
        gameStats[snakeId].originalDamageReceived[source] = 0;
    }
    gameStats[snakeId].originalDamageReceived[source] += damage;
    
    // === ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æŠ¤ç›¾ ===
    if (shields[snakeId].active && shields[snakeId].health > 0) {
        // æŠ¤ç›¾ä¼˜å…ˆæŠµæŒ¡ä¼¤å®³
        const shield = shields[snakeId];
        const damageToShield = Math.min(damage, shield.health);
        const damageToHealth = damage - damageToShield;
        
        // å‡å°‘æŠ¤ç›¾å€¼
        shield.health -= damageToShield;
        
        // è®°å½•æŠ¤ç›¾ä¼¤å®³ç»Ÿè®¡
        if (!gameStats[snakeId].shieldDamageAbsorbed) {
            gameStats[snakeId].shieldDamageAbsorbed = 0;
        }
        gameStats[snakeId].shieldDamageAbsorbed += damageToShield;
        
        // æ˜¾ç¤ºæŠ¤ç›¾æŠµæŒ¡æç¤º
        showNotice(`æŠ¤ç›¾æŠµæŒ¡${damageToShield}ç‚¹ä¼¤å®³`, '#00BCD4', head.x, head.y);
        createParticles(head.x + 10, head.y + 10, damageToShield * 2, '#00BCD4');
        
        // æ›´æ–°æŠ¤ç›¾æ˜¾ç¤º
        updateShieldDisplay(snakeId);
        
        // æ·»åŠ æŠ¤ç›¾è¢«æ”»å‡»çš„è§†è§‰åé¦ˆ
        const shieldIndicator = document.getElementById(`shield-indicator-${snakeId === 'snake1' ? '1' : '2'}`);
        if (shieldIndicator) {
            shieldIndicator.classList.add('shield-hit');
            setTimeout(() => {
                shieldIndicator.classList.remove('shield-hit');
            }, 300);
        }
        
        // å¦‚æœæŠ¤ç›¾è¢«æ‰“ç ´
        if (shield.health <= 0) {
            shield.active = false;
            shield.health = 0;
            showNotice('æŠ¤ç›¾è¢«æ‰“ç ´!', '#FF5722', head.x, head.y);
            createParticles(head.x + 10, head.y + 10, 20, '#FF5722');
            
            // æ›´æ–°æŠ¤ç›¾æ˜¾ç¤º
            updateShieldDisplay(snakeId);
            
            // è®°å½•æŠ¤ç›¾è¢«æ‰“ç ´
            if (!gameStats[snakeId].shieldBreaks) {
                gameStats[snakeId].shieldBreaks = 0;
            }
            gameStats[snakeId].shieldBreaks++;
        }
        
        // è®°å½•æŠ¤ç›¾æŠµæŒ¡ç»Ÿè®¡
        if (!gameStats[snakeId].shieldBlocks) {
            gameStats[snakeId].shieldBlocks = 0;
        }
        gameStats[snakeId].shieldBlocks++;
        
        // å¦‚æœæœ‰å‰©ä½™ä¼¤å®³ï¼Œç»§ç»­å¤„ç†
        if (damageToHealth > 0) {
            // é€’å½’è°ƒç”¨å¤„ç†å‰©ä½™ä¼¤å®³
            return applyDamage(snakeId, damageToHealth, source, {
                ...details,
                shieldBroken: true,
                originalDamage: damage,
                shieldAbsorbed: damageToShield
            });
        }
        
        console.log(`${snakeName}çš„æŠ¤ç›¾æŠµæŒ¡äº†${damageToShield}ç‚¹${source}ä¼¤å®³`);
        return true;
    }
    
    // === ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥å…ç–«æ•ˆæœ ===
    const isImmune = (snakeId === 'snake1' && immunity.snake1) || 
                     (snakeId === 'snake2' && immunity.snake2);
    
    if (isImmune) {
        // è®°å½•å…ç–«ç»Ÿè®¡
        if (!gameStats[snakeId].immuneDamagePrevented) {
            gameStats[snakeId].immuneDamagePrevented = {};
        }
        if (!gameStats[snakeId].immuneDamagePrevented[source]) {
            gameStats[snakeId].immuneDamagePrevented[source] = 0;
        }
        gameStats[snakeId].immuneDamagePrevented[source] += damage;
        
        if (!gameStats[snakeId].immuneBlocks) {
            gameStats[snakeId].immuneBlocks = 0;
        }
        gameStats[snakeId].immuneBlocks++;
        
        // æ˜¾ç¤ºå…ç–«æç¤º
        showNotice('å…ç–«ä¼¤å®³!', '#FFFF00', head.x, head.y);
        createParticles(head.x + 10, head.y + 10, 15, '#FFFF00');
        
        console.log(`${snakeName}å…ç–«äº†${damage}ç‚¹${source}ä¼¤å®³`);
        return false;
    }
    
    // === ç¬¬å››æ­¥ï¼šæ£€æŸ¥åšç¡¬è›‡ç‰¹æ€§ ===
    let finalDamage = damage;
    const isToughSnake = snakeId === 'snake1' ? snakeTypes.snake1 === 'tough' : snakeTypes.snake2 === 'tough';
    let isToughImmune = false;
    let isToughReduced = false;
    
// å®Œæ•´ä¿®å¤åçš„åšç¡¬è›‡ä¼¤å®³å¤„ç†é€»è¾‘
if (isToughSnake) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯å­å¼¹ç±»ä¼¤å®³
    const isBulletType = source === 'bullet' || source === 'base';
    
    if (isBulletType) {
        // å¯¹å­å¼¹ç±»ä¼¤å®³æœ‰50%æ¦‚ç‡å…ç–«
        if (Math.random() < 0.5) {
            const bulletTypeName = source === 'bullet' ? 'å­å¼¹' : 'åŸºåœ°å­å¼¹';
            
            // è®°å½•å…ç–«ç»Ÿè®¡
            if (!gameStats[snakeId].toughImmuneDamagePrevented) {
                gameStats[snakeId].toughImmuneDamagePrevented = {};
            }
            if (!gameStats[snakeId].toughImmuneDamagePrevented[source]) {
                gameStats[snakeId].toughImmuneDamagePrevented[source] = 0;
            }
            gameStats[snakeId].toughImmuneDamagePrevented[source] += damage;
            
            if (!gameStats[snakeId].toughImmuneBlocks) {
                gameStats[snakeId].toughImmuneBlocks = 0;
            }
            gameStats[snakeId].toughImmuneBlocks++;
            
            showNotice(`åšç¡¬å…ç–«${bulletTypeName}!`, '#C0C0C0', head.x, head.y);
            createParticles(head.x + 10, head.y + 10, 15, '#C0C0C0');
            return false;
        }
    } else {
        // å¯¹éå­å¼¹ç±»ä¼¤å®³å‡åŠ
        const originalDamage = damage;
        finalDamage = Math.ceil(damage / 2);
        
        // è®°å½•å‡ä¼¤ç»Ÿè®¡
        if (!gameStats[snakeId].toughReducedDamage) {
            gameStats[snakeId].toughReducedDamage = {};
        }
        if (!gameStats[snakeId].toughReducedDamage[source]) {
            gameStats[snakeId].toughReducedDamage[source] = 0;
        }
        gameStats[snakeId].toughReducedDamage[source] += (originalDamage - finalDamage);
        
        if (finalDamage < damage) {
            showNotice(`åšç¡¬å‡ä¼¤! (-${finalDamage}HP)`, '#C0C0C0', head.x, head.y);
        }
    }
}
    // === ç¬¬äº”æ­¥ï¼šåº”ç”¨å®é™…ä¼¤å®³ ===
    health[snakeId] = Math.max(0, health[snakeId] - finalDamage);
    
    // æ›´æ–°è¡€æ¡æ˜¾ç¤º
    updateHealthBars();
    
    // æ˜¾ç¤ºä¼¤å®³æç¤º
    let damageMessage = `-${finalDamage}HP`;
    if (source !== 'unknown') {
        const sourceNames = {
            'wall': 'æ’å¢™',
            'snakeCollision': 'è›‡ç›¸æ’',
            'bullet': 'å­å¼¹',
            'base': 'åŸºåœ°é˜²å¾¡',
            'lava': 'å²©æµ†',
            'home': 'æ•Œæ–¹åŸºåœ°',
            'bomb': 'ç‚¸å¼¹'
        };
        damageMessage += ` (${sourceNames[source] || source})`;
    }
    
    // æ·»åŠ å¤‡æ³¨ä¿¡æ¯
    const notes = [];
    if (details.shieldBroken) notes.push('ç ´ç›¾å');
    if (isToughReduced) notes.push('åšç¡¬å‡ä¼¤');
    if (notes.length > 0) {
        damageMessage += ` (${notes.join('+')})`;
    }
    
    showNotice(damageMessage, '#FF0000', head.x, head.y);
    
    // åˆ›å»ºä¼¤å®³ç‰¹æ•ˆ
    createParticles(head.x + 10, head.y + 10, finalDamage * 3, '#FF0000');
    
    // === ç¬¬å…­æ­¥ï¼šè®°å½•å®é™…æ‰¿å—ä¼¤å®³ç»Ÿè®¡ ===
    if (!gameStats[snakeId].damageReceived[source]) {
        gameStats[snakeId].damageReceived[source] = 0;
    }
    gameStats[snakeId].damageReceived[source] += finalDamage;
    gameStats[snakeId].totalDamageReceived += finalDamage;
    
    // è®°å½•è¾“å‡ºä¼¤å®³ç»Ÿè®¡ï¼ˆå¦‚æœæœ‰æ”»å‡»è€…ï¼‰
// åœ¨applyDamageå‡½æ•°ä¸­æ‰¾åˆ°è¾“å‡ºä¼¤å®³ç»Ÿè®¡éƒ¨åˆ†ï¼Œç¡®ä¿å­˜åœ¨
// === è®°å½•è¾“å‡ºä¼¤å®³ç»Ÿè®¡ï¼ˆå¦‚æœæœ‰æ”»å‡»è€…ï¼‰===
if (details.attacker) {
    const attackerSnakeId = details.attacker === 'snake1' ? 'snake1' : 'snake2';
    
    // è®°å½•æ”»å‡»è€…çš„åŸå§‹ä¼¤å®³è¾“å‡º
    if (!gameStats[attackerSnakeId].originalDamageDealt) {
        gameStats[attackerSnakeId].originalDamageDealt = {};
    }
    if (!gameStats[attackerSnakeId].originalDamageDealt[source]) {
        gameStats[attackerSnakeId].originalDamageDealt[source] = 0;
    }
    gameStats[attackerSnakeId].originalDamageDealt[source] += damage;
    
    // è®°å½•æ”»å‡»è€…çš„å®é™…ä¼¤å®³è¾“å‡º
    if (!gameStats[attackerSnakeId].damageDealt) {
        gameStats[attackerSnakeId].damageDealt = {};
    }
    if (!gameStats[attackerSnakeId].damageDealt[source]) {
        gameStats[attackerSnakeId].damageDealt[source] = 0;
    }
    gameStats[attackerSnakeId].damageDealt[source] += finalDamage;
    gameStats[attackerSnakeId].totalDamageDealt += finalDamage;
    gameStats[attackerSnakeId].totalOriginalDamageDealt += damage;
}
    // === ç¬¬ä¸ƒæ­¥ï¼šæ£€æŸ¥æ­»äº¡ ===
    if (health[snakeId] <= 0) {
        // è®¾ç½®æ­»äº¡åŸå› 
        const causeNames = {
            'wall': 'æ’å¢™è€Œæ­»',
            'snakeCollision': 'è›‡ç›¸æ’è€Œæ­»',
            'bullet': 'è¢«å­å¼¹å‡»ä¸­',
            'base': 'è¢«åŸºåœ°é˜²å¾¡ç³»ç»Ÿå‡»æ€',
            'lava': 'è¢«å²©æµ†çƒ§æ­»',
            'home': 'åœ¨å¯¹æ–¹åŸºåœ°ä¸­è‡´æ­»',
            'bomb': 'è¢«ç‚¸å¼¹ç‚¸æ­»'
        };
        
        deathCause[snakeId] = causeNames[source] || 'æœªçŸ¥åŸå› æ­»äº¡';
        
        // æ·»åŠ å¤‡æ³¨ä¿¡æ¯
        const deathNotes = [];
        if (details.shieldBroken) deathNotes.push('æŠ¤ç›¾è¢«ç ´å');
        if (isToughSnake && isToughReduced) deathNotes.push('åšç¡¬è›‡å‡ä¼¤å');
        if (deathNotes.length > 0) {
            deathCause[snakeId] += ` (${deathNotes.join('+')})`;
        }
        
        console.log(`${snakeName}æ­»äº¡ï¼ŒåŸå› : ${deathCause[snakeId]}`);
        gameOver();
        return true;
    }

    return true;
}
// ç»Ÿä¸€çš„æ²»ç–—å‡½æ•°
function applyHealing(snakeId, amount, source = 'unknown') {
    if (!gameStarted || health[snakeId] <= 0) return false;
    
    // è®¡ç®—æœ€å¤§ç”Ÿå‘½å€¼ï¼ˆè€ƒè™‘åšç¡¬è›‡å’Œå‡çº§ï¼‰
    let maxHealth = 10;
    const isToughSnake = snakeId === 'snake1' ? snakeTypes.snake1 === 'tough' : snakeTypes.snake2 === 'tough';
    
    if (isToughSnake) {
        maxHealth = 15;
        // æ·»åŠ å‡çº§æ•ˆæœ
        const toughUpgradeLevel = playerUpgrades[snakeId]?.tough || 0;
        maxHealth += toughUpgradeLevel * 2;
    }
    
    const oldHealth = health[snakeId];
    health[snakeId] = Math.min(maxHealth, health[snakeId] + amount);
    const actualHeal = health[snakeId] - oldHealth;
    
    if (actualHeal > 0) {
        // æ›´æ–°è¡€æ¡
        updateHealthBars();
        
        // æ˜¾ç¤ºæ²»ç–—æç¤º
        const head = snakes[snakeId][0];
        showNotice(`+${actualHeal}HP`, '#4CAF50', head.x, head.y);
        
        // åˆ›å»ºæ²»ç–—ç‰¹æ•ˆ
        createParticles(head.x + 10, head.y + 10, actualHeal * 3, '#4CAF50');
        
        console.log(`${snakeId === 'snake1' ? 'ç©å®¶1' : 'ç©å®¶2'}æ¢å¤äº†${actualHeal}ç‚¹è¡€é‡`);
        return true;
    }
    
    return false;
}
// æ·»åŠ æŠ¤ç›¾æ˜¾ç¤ºæ›´æ–°å‡½æ•°
function updateShieldDisplay(snakeId) {
    const shield = shields[snakeId];
    const shieldElementId = snakeId === 'snake1' ? 'shield-indicator-1' : 'shield-indicator-2';
    let shieldElement = document.getElementById(shieldElementId);
    
    // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
    if (!shieldElement) {
        const scoreBoard = snakeId === 'snake1' ? 
            document.querySelector('.player-score.player-1') : 
            document.querySelector('.player-score.player-2');
        
        if (scoreBoard) {
            shieldElement = document.createElement('div');
            shieldElement.id = shieldElementId;
            shieldElement.className = 'shield-indicator';
            shieldElement.style.marginTop = '5px';
            shieldElement.style.padding = '3px 8px';
            shieldElement.style.borderRadius = '10px';
            shieldElement.style.fontSize = '12px';
            shieldElement.style.display = 'flex';
            shieldElement.style.alignItems = 'center';
            shieldElement.style.gap = '5px';
            
            scoreBoard.appendChild(shieldElement);
        }
    }
    
    if (shieldElement) {
        if (shield.active && shield.health > 0) {
            shieldElement.style.display = 'flex';
            shieldElement.style.background = 'linear-gradient(45deg, rgba(0, 188, 212, 0.3), rgba(0, 150, 136, 0.3))';
            shieldElement.style.border = '1px solid rgba(0, 188, 212, 0.5)';
            shieldElement.style.color = '#00BCD4';
            shieldElement.innerHTML = `
                <i class="fas fa-shield-alt"></i>
                <span>æŠ¤ç›¾: ${shield.health}/${shield.maxHealth}</span>
            `;
            
            // æ·»åŠ æŠ¤ç›¾åŠ¨ç”»æ•ˆæœ
            shieldElement.style.animation = 'shieldPulse 2s infinite';
        } else {
            shieldElement.style.display = 'none';
        }
    }
}

// æ·»åŠ æŠ¤ç›¾åŠ¨ç”»CSS
const shieldStyle = document.createElement('style');
shieldStyle.textContent = `
    @keyframes shieldPulse {
        0%, 100% { 
            box-shadow: 0 0 5px rgba(0, 188, 212, 0.5);
        }
        50% { 
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.8);
        }
    }
    
    .shield-indicator {
        transition: all 0.3s ease;
    }
    
    /* æŠ¤ç›¾è¢«æ”»å‡»æ—¶çš„æ•ˆæœ */
    .shield-hit {
        animation: shieldHit 0.3s ease;
    }
    
    @keyframes shieldHit {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); box-shadow: 0 0 20px #00BCD4; }
        100% { transform: scale(1); }
    }
`;
document.head.appendChild(shieldStyle);
// åˆ›å»ºæŠ¤ç›¾ç¯ç»•ç‰¹æ•ˆ
function createShieldEffect(snakeId) {
    // ç§»é™¤æ—§çš„æŠ¤ç›¾ç‰¹æ•ˆ
    const oldEffects = document.querySelectorAll(`.shield-effect-${snakeId}`);
    oldEffects.forEach(effect => effect.remove());
    
    // åˆ›å»ºæ–°çš„æŠ¤ç›¾ç‰¹æ•ˆ
    const shieldEffect = document.createElement('div');
    shieldEffect.className = `shield-effect shield-effect-${snakeId}`;
    shieldEffect.style.position = 'absolute';
    shieldEffect.style.width = '40px';
    shieldEffect.style.height = '40px';
    shieldEffect.style.borderRadius = '50%';
    shieldEffect.style.border = '2px solid rgba(0, 188, 212, 0.7)';
    shieldEffect.style.boxShadow = '0 0 20px rgba(0, 188, 212, 0.5)';
    shieldEffect.style.animation = 'shieldRotate 3s linear infinite';
    shieldEffect.style.zIndex = '2';
    shieldEffect.style.pointerEvents = 'none';
    
    // æ·»åŠ åˆ°æ¸¸æˆæ¿
    gameBoard.appendChild(shieldEffect);
    
    // æ›´æ–°æŠ¤ç›¾ä½ç½®
    function updateShieldPosition() {
        if (shields[snakeId].active && shields[snakeId].health > 0) {
            const head = snakes[snakeId][0];
            shieldEffect.style.left = `${head.x}px`;
            shieldEffect.style.top = `${head.y}px`;
            requestAnimationFrame(updateShieldPosition);
        } else {
            shieldEffect.remove();
        }
    }
    
    updateShieldPosition();
}

// æ·»åŠ æŠ¤ç›¾æ—‹è½¬åŠ¨ç”»CSS
const shieldRotateStyle = document.createElement('style');
shieldRotateStyle.textContent = `
    @keyframes shieldRotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(shieldRotateStyle);
function drawHomes() {
    // ç§»é™¤ç°æœ‰çš„åŸºåœ°å…ƒç´ 
    document.querySelectorAll('.home-base').forEach(el => el.remove());
    
    // ç»˜åˆ¶ç©å®¶1çš„åŸºåœ°ï¼ˆå·¦ä¸Šè§’ï¼‰
    if (!homes.player1.destroyed) {
        const home1 = document.createElement('div');
        home1.className = `home-base player1 ${homes.player1.health < homes.player1.maxHealth * 0.3 ? 'home-under-attack' : ''}`;
        
        // å¦‚æœåŸºåœ°é˜²å¾¡æ¿€æ´»ï¼Œæ·»åŠ æ¿€æ´»æ ·å¼
        if (baseDefense.player1.active && baseDefense.player1.targetSnake) {
            home1.classList.add('defense-active');
            
            const targetHead = snakes[baseDefense.player1.targetSnake][0];
            const isInside = isPointInRect(targetHead, homes.player1);
            const firingPoints = calculateFiringPoints(homes.player1, targetHead, isInside);
            
            // è®¡ç®—å“ªäº›è¾¹åœ¨æ”»å‡»
            const activeSides = {};
            firingPoints.forEach(point => {
                if (point.side) {
                    activeSides[point.side] = true;
                }
            });
            
            // ä¸ºæ¯ä¸ªæ”»å‡»è¾¹æ·»åŠ é«˜äº®è¾¹æ¡†
            Object.keys(activeSides).forEach(side => {
                const sideHighlighter = document.createElement('div');
                sideHighlighter.className = 'active-side-highlight';
                sideHighlighter.style.position = 'absolute';
                sideHighlighter.style.background = 'linear-gradient(90deg, transparent, rgba(255, 87, 34, 0.7), transparent)';
                sideHighlighter.style.animation = 'sidePulse 1s infinite alternate';
                sideHighlighter.style.zIndex = '1';
                
                switch(side) {
                    case 'top':
                        sideHighlighter.style.top = '-5px';
                        sideHighlighter.style.left = '0';
                        sideHighlighter.style.width = '100%';
                        sideHighlighter.style.height = '10px';
                        break;
                    case 'bottom':
                        sideHighlighter.style.bottom = '-5px';
                        sideHighlighter.style.left = '0';
                        sideHighlighter.style.width = '100%';
                        sideHighlighter.style.height = '10px';
                        break;
                    case 'left':
                        sideHighlighter.style.left = '-5px';
                        sideHighlighter.style.top = '0';
                        sideHighlighter.style.width = '10px';
                        sideHighlighter.style.height = '100%';
                        break;
                    case 'right':
                        sideHighlighter.style.right = '-5px';
                        sideHighlighter.style.top = '0';
                        sideHighlighter.style.width = '10px';
                        sideHighlighter.style.height = '100%';
                        break;
                }
                
                home1.appendChild(sideHighlighter);
            });
            
            // ä¸ºæ¯ä¸ªå‘å°„ç‚¹æ·»åŠ æŒ‡ç¤ºå™¨
            firingPoints.forEach(point => {
                const turretIndicator = document.createElement('div');
                turretIndicator.className = 'base-turret-indicator';
                turretIndicator.style.position = 'absolute';
                turretIndicator.style.left = `${point.x - homes.player1.x}px`;
                turretIndicator.style.top = `${point.y - homes.player1.y}px`;
                turretIndicator.style.transform = 'translate(-50%, -50%)';
                
                turretIndicator.style.width = '8px';
                turretIndicator.style.height = '8px';
                turretIndicator.style.background = 'radial-gradient(circle, #FF5722, #FF0000)';
                turretIndicator.style.borderRadius = '50%';
                turretIndicator.style.boxShadow = '0 0 8px #FF0000';
                turretIndicator.style.animation = 'turretPulse 1s infinite alternate';
                turretIndicator.style.zIndex = '3';
                
                home1.appendChild(turretIndicator);
            });
            
            // æ·»åŠ é˜²å¾¡æ¿€æ´»æ–‡å­—æç¤º
            const defenseText = document.createElement('div');
            defenseText.style.position = 'absolute';
            defenseText.style.top = '5px';
            defenseText.style.left = '0';
            defenseText.style.width = '100%';
            defenseText.style.textAlign = 'center';
            defenseText.style.fontSize = '12px';
            defenseText.style.color = '#FFFF00';
            defenseText.style.fontWeight = 'bold';
            defenseText.textContent = 'é˜²å¾¡æ¿€æ´»';
            defenseText.style.textShadow = '0 0 5px #000';
            defenseText.style.zIndex = '2';
            home1.appendChild(defenseText);
        }
        
        home1.style.left = `${homes.player1.x}px`;
        home1.style.top = `${homes.player1.y}px`;
        home1.style.width = `${homes.player1.width}px`;
        home1.style.height = `${homes.player1.height}px`;
        home1.style.zIndex = '2';
        
        // æ·»åŠ åŸºåœ°çš„å›¾æ ‡å’Œåç§°
        const name1 = document.createElement('div');
        name1.innerHTML = `<i class="fas fa-home"></i> ${localStorage.getItem('username') || 'ç©å®¶1'}çš„åŸºåœ°`;
        name1.style.textAlign = 'center';
        name1.style.marginTop = '25px';
        name1.style.fontSize = '16px';
        name1.style.fontWeight = 'bold';
        name1.style.zIndex = '2';
        home1.appendChild(name1);
        
        // æ·»åŠ è¡€æ¡
        const healthBar1 = document.createElement('div');
        healthBar1.className = 'home-health-bar';
        healthBar1.style.bottom = '-22px';
        healthBar1.style.zIndex = '2';
        
        const healthFill1 = document.createElement('div');
        healthFill1.className = 'home-health-fill home1-health-fill';
        healthFill1.style.width = `${(homes.player1.health / homes.player1.maxHealth) * 100}%`;
        
        const healthText1 = document.createElement('div');
        healthText1.className = 'home-health-text';
        healthText1.textContent = `HP: ${homes.player1.health}/${homes.player1.maxHealth}`;
        healthText1.style.fontSize = '12px';
        healthText1.style.zIndex = '2';
        
        healthBar1.appendChild(healthFill1);
        home1.appendChild(healthText1);
        home1.appendChild(healthBar1);
        
        gameBoard.appendChild(home1);
    }
    
    // ç»˜åˆ¶ç©å®¶2çš„åŸºåœ°ï¼ˆå³ä¸‹è§’ï¼‰
    if (!homes.player2.destroyed) {
        const home2 = document.createElement('div');
        home2.className = `home-base player2 ${homes.player2.health < homes.player2.maxHealth * 0.3 ? 'home-under-attack' : ''}`;
        
        // å¦‚æœåŸºåœ°é˜²å¾¡æ¿€æ´»ï¼Œæ·»åŠ æ¿€æ´»æ ·å¼
        if (baseDefense.player2.active && baseDefense.player2.targetSnake) {
            home2.classList.add('defense-active');
            
            const targetHead = snakes[baseDefense.player2.targetSnake][0];
            const isInside = isPointInRect(targetHead, homes.player2);
            const firingPoints = calculateFiringPoints(homes.player2, targetHead, isInside);
            
            // è®¡ç®—å“ªäº›è¾¹åœ¨æ”»å‡»
            const activeSides = {};
            firingPoints.forEach(point => {
                if (point.side) {
                    activeSides[point.side] = true;
                }
            });
            
            // ä¸ºæ¯ä¸ªæ”»å‡»è¾¹æ·»åŠ é«˜äº®è¾¹æ¡†
            Object.keys(activeSides).forEach(side => {
                const sideHighlighter = document.createElement('div');
                sideHighlighter.className = 'active-side-highlight';
                sideHighlighter.style.position = 'absolute';
                sideHighlighter.style.background = 'linear-gradient(90deg, transparent, rgba(33, 150, 243, 0.7), transparent)';
                sideHighlighter.style.animation = 'sidePulse 1s infinite alternate';
                sideHighlighter.style.zIndex = '1';
                sideHighlighter.style.boxShadow = '0 0 10px rgba(33, 150, 243, 0.5)';
                
                switch(side) {
                    case 'top':
                        sideHighlighter.style.top = '-5px';
                        sideHighlighter.style.left = '0';
                        sideHighlighter.style.width = '100%';
                        sideHighlighter.style.height = '10px';
                        break;
                    case 'bottom':
                        sideHighlighter.style.bottom = '-5px';
                        sideHighlighter.style.left = '0';
                        sideHighlighter.style.width = '100%';
                        sideHighlighter.style.height = '10px';
                        break;
                    case 'left':
                        sideHighlighter.style.left = '-5px';
                        sideHighlighter.style.top = '0';
                        sideHighlighter.style.width = '10px';
                        sideHighlighter.style.height = '100%';
                        break;
                    case 'right':
                        sideHighlighter.style.right = '-5px';
                        sideHighlighter.style.top = '0';
                        sideHighlighter.style.width = '10px';
                        sideHighlighter.style.height = '100%';
                        break;
                }
                
                home2.appendChild(sideHighlighter);
            });
            
            // ä¸ºæ¯ä¸ªå‘å°„ç‚¹æ·»åŠ æŒ‡ç¤ºå™¨
            firingPoints.forEach(point => {
                const turretIndicator = document.createElement('div');
                turretIndicator.className = 'base-turret-indicator';
                turretIndicator.style.position = 'absolute';
                turretIndicator.style.left = `${point.x - homes.player2.x}px`;
                turretIndicator.style.top = `${point.y - homes.player2.y}px`;
                turretIndicator.style.transform = 'translate(-50%, -50%)';
                
                turretIndicator.style.width = '8px';
                turretIndicator.style.height = '8px';
                turretIndicator.style.background = 'radial-gradient(circle, #2196F3, #0000FF)';
                turretIndicator.style.borderRadius = '50%';
                turretIndicator.style.boxShadow = '0 0 8px #0000FF';
                turretIndicator.style.animation = 'turretPulse 1s infinite alternate';
                turretIndicator.style.zIndex = '3';
                
                home2.appendChild(turretIndicator);
            });
            
            // æ·»åŠ é˜²å¾¡æ¿€æ´»æ–‡å­—æç¤º
            const defenseText = document.createElement('div');
            defenseText.style.position = 'absolute';
            defenseText.style.top = '5px';
            defenseText.style.left = '0';
            defenseText.style.width = '100%';
            defenseText.style.textAlign = 'center';
            defenseText.style.fontSize = '12px';
            defenseText.style.color = '#FFFF00';
            defenseText.style.fontWeight = 'bold';
            defenseText.textContent = 'é˜²å¾¡æ¿€æ´»';
            defenseText.style.textShadow = '0 0 5px #000';
            defenseText.style.zIndex = '2';
            home2.appendChild(defenseText);
        }
        
        home2.style.left = `${homes.player2.x}px`;
        home2.style.top = `${homes.player2.y}px`;
        home2.style.width = `${homes.player2.width}px`;
        home2.style.height = `${homes.player2.height}px`;
        home2.style.zIndex = '2';
        
        // æ·»åŠ åŸºåœ°çš„å›¾æ ‡å’Œåç§°
        const name2 = document.createElement('div');
        name2.innerHTML = `<i class="fas fa-home"></i> ${localStorage.getItem('player2_username') || 'ç©å®¶2'}çš„åŸºåœ°`;
        name2.style.textAlign = 'center';
        name2.style.marginTop = '25px';
        name2.style.fontSize = '16px';
        name2.style.fontWeight = 'bold';
        name2.style.zIndex = '2';
        home2.appendChild(name2);
        
        // æ·»åŠ è¡€æ¡
        const healthBar2 = document.createElement('div');
        healthBar2.className = 'home-health-bar';
        healthBar2.style.bottom = '-22px';
        healthBar2.style.zIndex = '2';
        
        const healthFill2 = document.createElement('div');
        healthFill2.className = 'home-health-fill home2-health-fill';
        healthFill2.style.width = `${(homes.player2.health / homes.player2.maxHealth) * 100}%`;
        
        const healthText2 = document.createElement('div');
        healthText2.className = 'home-health-text';
        healthText2.textContent = `HP: ${homes.player2.health}/${homes.player2.maxHealth}`;
        healthText2.style.fontSize = '12px';
        healthText2.style.zIndex = '2';
        
        healthBar2.appendChild(healthFill2);
        home2.appendChild(healthText2);
        home2.appendChild(healthBar2);
        
        gameBoard.appendChild(home2);
    }
}
const baseDefenseStyle = document.createElement('style');
baseDefenseStyle.textContent = `
    /* åŸºåœ°é˜²å¾¡ç‰¹æ•ˆ - æ›´æ–° */
    .base-turret-indicator {
        position: absolute;
        animation: turretPulse 1s infinite alternate;
    }
    
    @keyframes turretPulse {
        from {
            transform: scale(1);
            box-shadow: 0 0 10px;
            opacity: 0.7;
        }
        to {
            transform: scale(1.3);
            box-shadow: 0 0 20px;
            opacity: 1;
        }
    }
    
    /* é˜²å¾¡æ¿€æ´»æ—¶çš„åŸºåœ°è¾¹æ¡†æ•ˆæœ */
    .home-base.defense-active {
        box-shadow: 0 0 40px;
    }
    
    .home-base.defense-active.player1 {
        box-shadow: 0 0 40px rgba(255, 87, 34, 0.8);
    }
    
    .home-base.defense-active.player2 {
        box-shadow: 0 0 40px rgba(33, 150, 243, 0.8);
    }
`;
document.head.appendChild(baseDefenseStyle);
// æ·»åŠ æ–°çš„CSSæ ·å¼
const activeSideStyle = document.createElement('style');
activeSideStyle.textContent = `
    /* æ¿€æ´»è¾¹çš„é—ªçƒæ•ˆæœ */
    .active-side-highlight {
        z-index: 1;
    }
    
    @keyframes sidePulse {
        from {
            opacity: 0.3;
            box-shadow: 0 0 10px rgba(255, 87, 34, 0.5);
        }
        to {
            opacity: 0.7;
            box-shadow: 0 0 20px rgba(255, 87, 34, 0.8);
        }
    }
    
    /* ç©å®¶2çš„é¢œè‰² */
    .home-base.player2 .active-side-highlight {
        background: linear-gradient(90deg, transparent, rgba(33, 150, 243, 0.7), transparent) !important;
        box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
    }
`;
document.head.appendChild(activeSideStyle);
// åˆå§‹åŒ–æ¸¸æˆ
function initGame() {
    document.getElementById("back").style.display ="none"
    viewRecords.style.display = 'none';
    const player1Name = localStorage.getItem('username') || 'ç©å®¶1';
    document.getElementById('player1-name').textContent = player1Name + ': ';
    resetDeathCauses();        
    // å¦‚æœç©å®¶2å·²ç™»å½•ï¼Œè®¾ç½®å…¶åç§°
    const player2Name = localStorage.getItem('player2_username') || 'ç©å®¶2';
    document.getElementById('player2-name').textContent = player2Name + ': '; 
    document.getElementById("player-label1").textContent =localStorage.getItem("username") + "(æ©™è‰²)" || 'ç©å®¶1'
    document.getElementById("player-label2").textContent =localStorage.getItem("player2_username") + "(è“è‰²)" || 'ç©å®¶2'
    document.getElementById("storage-title1").textContent =localStorage.getItem("username") + "å‚¨å­˜:" || 'ç©å®¶1å‚¨å­˜:'
    document.getElementById("storage-title2").textContent =localStorage.getItem("player2_username") + "å‚¨å­˜:"  || 'ç©å®¶2å‚¨å­˜:'    
    // æ¸…é™¤ç°æœ‰è›‡å’Œé£Ÿç‰©
    if (currentMap === 'snow') {
        document.body.style.background = 'linear-gradient(135deg, #1e3c72, #2a5298, #7b4397)';
        blizzardTimer = performance.now() + 30000; // 30ç§’åç¬¬ä¸€æ¬¡æš´é£é›ª
    } else if (currentMap === 'volcano') {
        document.body.style.background = 'linear-gradient(135deg, #8B0000, #FF4500, #FF8C00)';
        generateVolcanoes();
        nextEruptionTime = performance.now() + 30000;
    } else {
        document.body.style.background = 'linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d)';
    }
    clearBoard();
document.querySelectorAll('.bullet').forEach(bullet => bullet.remove());
// ä¿®æ”¹æ¸¸æˆç»Ÿè®¡æ•°æ®åˆå§‹åŒ–
gameStats = {
    startTime: 0,
    snake1: {
        damageReceived: {
            wall: 0,
            snakeCollision: 0,
            bullet: 0,
            base: 0,
            lava: 0,
            home: 0,
            bomb: 0
        },
        originalDamageReceived: {
            wall: 0,
            snakeCollision: 0,
            bullet: 0,
            base: 0,
            lava: 0,
            home: 0,
            bomb: 0
        },
        damageDealt: {
            snakeCollision: 0,
            bullet: 0,
            bomb: 0
        },
        originalDamageDealt: {
            snakeCollision: 0,
            bullet: 0,
            bomb: 0
        },
        // é˜²å¾¡ç»Ÿè®¡
        shieldDamageAbsorbed: 0,
        shieldBlocks: 0,
        shieldBreaks: 0,
        immuneDamagePrevented: {},
        immuneBlocks: 0,
        toughImmuneDamagePrevented: {},
        toughImmuneBlocks: 0,
        toughReducedDamage: {},
        
        distanceTraveled: 0,
        totalDamageReceived: 0,
        totalOriginalDamageReceived: 0,
        totalDamageDealt: 0,
        totalOriginalDamageDealt: 0
    },
    snake2: {
        damageReceived: {
            wall: 0,
            snakeCollision: 0,
            bullet: 0,
            base: 0,
            lava: 0,
            home: 0,
            bomb: 0
        },
        originalDamageReceived: {
            wall: 0,
            snakeCollision: 0,
            bullet: 0,
            base: 0,
            lava: 0,
            home: 0,
            bomb: 0
        },
        damageDealt: {
            snakeCollision: 0,
            bullet: 0,
            bomb: 0
        },
        originalDamageDealt: {
            snakeCollision: 0,
            bullet: 0,
            bomb: 0
        },
        // é˜²å¾¡ç»Ÿè®¡
        shieldDamageAbsorbed: 0,
        shieldBlocks: 0,
        shieldBreaks: 0,
        immuneDamagePrevented: {},
        immuneBlocks: 0,
        toughImmuneDamagePrevented: {},
        toughImmuneBlocks: 0,
        toughReducedDamage: {},
        
        distanceTraveled: 0,
        totalDamageReceived: 0,
        totalOriginalDamageReceived: 0,
        totalDamageDealt: 0,
        totalOriginalDamageDealt: 0
    }
};
    
    // ç§»é™¤æŠ¤ç›¾æ˜¾ç¤º
    document.querySelectorAll('.shield-indicator, .shield-effect').forEach(el => el.remove());
    storeOpen = {
        snake1: false,
        snake2: false
    };
    storeSelectedItem = {
        snake1: 0,
        snake2: 0
    };
    
    // å…³é—­å•†åº—ç•Œé¢
    document.getElementById('store-player1').style.display = 'none';
    document.getElementById('store-player2').style.display = 'none';
    
    // ç§»é™¤æš‚åœæ•ˆæœ
    document.querySelector('.game-container').classList.remove('game-paused');
    
// 2. å®Œå…¨é‡ç½®æ”»å‡»æ¨¡å¼çŠ¶æ€
if (attackMode.intervalId1) {
    clearInterval(attackMode.intervalId1);
    attackMode.intervalId1 = null;
}
if (attackMode.intervalId2) {
    clearInterval(attackMode.intervalId2);
    attackMode.intervalId2 = null;
}
        // é‡ç½®é€Ÿåº¦åŠ æˆ
    speedBoosts = {
        snake1: 0,
        snake2: 0
    };
// 3. é‡ç½®æ”»å‡»æ¨¡å¼çš„æ‰€æœ‰çŠ¶æ€
attackMode = {
    snake1: false,
    snake2: false,
    timer1: 0,
    timer2: 0,
    lastShot1: 0,
    lastShot2: 0,
    intervalId1: null,
    intervalId2: null
};
// 4. é‡ç½®å­å¼¹å‘å°„çš„è®¡æ—¶å™¨
lastMoveTime = {
    snake1: 0,
    snake2: 0
};

    // é‡ç½®ç‰¹æ®Šç‰©å“
    specialItems = [];
    lastSpecialItemSpawn = 0;
    
    // é‡ç½®çŠ¶æ€æ•ˆæœ
    immunity = { snake1: false, snake2: false, timer1: 0, timer2: 0 };
    reversedControls = { snake1: false, snake2: false, timer1: 0, timer2: 0 };
    
    // é‡ç½®å¢™ç¢°æ’è®¡æ—¶
    lastWallHitTime = {
        snake1: 0,
        snake2: 0
    };
    
    // åˆå§‹åŒ–çƒä½“å‚¨å­˜
    ballStorage = {
        snake1: [],
        snake2: []
    };
    pausedSnakes = {
        snake1: false,
        snake2: false
    };
    updateStorageDisplay();
    
    // åˆå§‹åŒ–åŸºåœ°
    initHomes();
    
    // åˆå§‹åŒ–è›‡
    snakes.snake1 = [
        { x: homes.player1.x + 75, y: homes.player1.y + 50 },
        { x: homes.player1.x + 55, y: homes.player1.y + 50 },
        { x: homes.player1.x + 35, y: homes.player1.y + 50 }
    ];
    
    snakes.snake2 = [
        { x: homes.player2.x + 75, y: homes.player2.y + 50 },
        { x: homes.player2.x + 55, y: homes.player2.y + 50 },
        { x: homes.player2.x + 35, y: homes.player2.y + 50 }
    ];
    
    // é‡ç½®æ–¹å‘å’Œè¡€é‡
    directions = {
        snake1: 'right',
        snake2: 'left'
    };
    nextDirections = {
        snake1: 'right',
        snake2: 'left'
    };
    health = {
        snake1: 10,
        snake2: 10
    };
    
    // æ¸¸æˆå¼€å§‹æ—¶ç»™è›‡3ç§’å…ç–«æ—¶é—´
    const currentTime = performance.now();
    immunity.snake1 = true;
    immunity.timer1 = currentTime + 3000; // 3ç§’å…ç–«
    
    immunity.snake2 = true;
    immunity.timer2 = currentTime + 3000; // 3ç§’å…ç–«
    
    // æ˜¾ç¤ºå…ç–«æç¤º
    showNotice('æ¸¸æˆå¼€å§‹! 3ç§’æ— æ•Œæ—¶é—´', '#FFFF00', 
              homes.player1.x + homes.player1.width/2, 
              homes.player1.y - 20);
    showNotice('æ¸¸æˆå¼€å§‹! 3ç§’æ— æ•Œæ—¶é—´', '#FFFF00', 
              homes.player2.x + homes.player2.width/2, 
              homes.player2.y - 20);
    
    // é‡ç½®åˆ†æ•°
    scores = {
        snake1: 0,
        snake2: 0
    };
    if (snakeTypes.snake1 === 'tough') {
        health.snake1 = 15;
    }
    if (snakeTypes.snake2 === 'tough') {
        health.snake2 = 15;
    }
    if (attackMode.intervalId1) clearInterval(attackMode.intervalId1);
    if (attackMode.intervalId2) clearInterval(attackMode.intervalId2);
    attackMode = {
        snake1: false,
        snake2: false,
        timer1: 0,
        timer2: 0,
        lastShot1: 0,
        lastShot2: 0,
        intervalId1: null,
        intervalId2: null
};
let baseDefense = {
    player1: {
        lastShotTime: 0,
        bulletSpeed: 1, // ç¨å¾®é™ä½é€Ÿåº¦
        attackRange: 15, // 20æ ¼ = 400åƒç´ 
        active: false,
        targetSnake: null,
        damage: 0.5,
        shootInterval: 1000 // 2ç§’é—´éš”
    },
    player2: {
        lastShotTime: 0,
        bulletSpeed: 1,
        attackRange: 15,
        active: false,
        targetSnake: null,
        damage: 0.5,
        shootInterval: 1000
    }
};
    walls = [];
    generateAllWalls();
    updateHealthBars();
    updateScoreDisplay();
    
    // ç”Ÿæˆé£Ÿç‰©
    foods = [];
    generateFood();
    generateFood();
    
    // ç»˜åˆ¶è›‡å’Œé£Ÿç‰©ï¼ˆå¸¦è¿›å…¥åŠ¨ç”»ï¼‰
    drawSnakes(true);
    drawFoods(true);
    
    // éšè—æ¸¸æˆç»“æŸå±å¹•
    gameOverScreen.classList.remove('show');
    gameOverScreen.style.display = 'none';
    // å¼€å§‹æ¸¸æˆå¾ªç¯
    if (gameInterval) clearInterval(gameInterval);
    lastTime = performance.now();
    requestAnimationFrame(gameLoop);
    
    gameStarted = true;
    
    // åˆ›å»ºèƒŒæ™¯å…ƒç´ 
    createBackgroundElements();
    
    // è¿›å…¥å…¨å±æ¨¡å¼
    requestFullscreen();
}

// è¯·æ±‚å…¨å±
function requestFullscreen() {
    const elem = document.documentElement;
    if (elem.requestFullscreen) {
        elem.requestFullscreen();
    } else if (elem.webkitRequestFullscreen) { /* Safari */
        elem.webkitRequestFullscreen();
    } else if (elem.msRequestFullscreen) { /* IE11 */
        elem.msRequestFullscreen();
    }
}
// æ·»åŠ æ–°çš„ç”Ÿæˆæ‰€æœ‰å¢™çš„å‡½æ•°
function generateAllWalls() {
    const boardWidth = gameBoard.clientWidth;
    const boardHeight = gameBoard.clientHeight;
    const gridSize = 20;
    const cols = Math.floor(boardWidth / gridSize);
    const rows = Math.floor(boardHeight / gridSize);
    
    // æ¸…ç©ºç°æœ‰å¢™
    walls = [];
    
    // è®¡ç®—è›‡å‰æ–¹çš„å®‰å…¨åŒºåŸŸï¼ˆ10æ ¼=200åƒç´ ï¼‰
    const safeZones = {
        snake1: getSnakeSafeZone('snake1', 10),
        snake2: getSnakeSafeZone('snake2', 10)
    };
    
    // ç”Ÿæˆæ°´å¹³å¢™
    const horizontalWallCount = Math.floor(rows * 0.1);
    for (let i = 0; i < horizontalWallCount; i++) {
        const row = Math.floor(3 + Math.random() * (rows - 6));
        const y = row * gridSize;
        const startCol = Math.floor(Math.random() * (cols - 5));
        const length = 8 + Math.floor(Math.random() * 4);
        
        const newWall = {
            segments: [],
            spawnTime: performance.now()
        };
        
        let validWall = true;
        
        // æ£€æŸ¥å¢™æ˜¯å¦ä¸è›‡é‡å æˆ–ä½äºå®‰å…¨åŒºåŸŸå†…
        for (let c = 0; c < length; c++) {
            const x = (startCol + c) * gridSize;
            
            // æ£€æŸ¥æ˜¯å¦ä¸è›‡é‡å 
            for (const segment of snakes.snake1) {
                if (segment.x === x && segment.y === y) {
                    validWall = false;
                    break;
                }
            }
            
            if (validWall) {
                for (const segment of snakes.snake2) {
                    if (segment.x === x && segment.y === y) {
                        validWall = false;
                        break;
                    }
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨å®‰å…¨åŒºåŸŸå†…
            if (validWall) {
                if (isInSafeZone(x, y, safeZones.snake1) || 
                    isInSafeZone(x, y, safeZones.snake2)) {
                    validWall = false;
                }
            }
            
            // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦åœ¨åŸºåœ°åŒºåŸŸå†…
            if (validWall) {
                if (isInHomeArea(x, y, homes.player1) || 
                    isInHomeArea(x, y, homes.player2)) {
                    validWall = false;
                }
            }
            
            if (!validWall) break;
        }
        
        if (validWall) {
            for (let c = 0; c < length; c++) {
                newWall.segments.push({
                    x: (startCol + c) * gridSize,
                    y: y
                });
            }
            walls.push(newWall);
        }
    }
    
    // ç”Ÿæˆå‚ç›´å¢™ï¼ˆç±»ä¼¼é€»è¾‘ï¼‰
    const verticalWallCount = Math.floor(cols * 0.1);
    for (let i = 0; i < verticalWallCount; i++) {
        const col = Math.floor(3 + Math.random() * (cols - 6));
        const x = col * gridSize;
        const startRow = Math.floor(Math.random() * (rows - 5));
        const length = 8 + Math.floor(Math.random() * 3);
        
        const newWall = {
            segments: [],
            spawnTime: performance.now()
        };
        
        let validWall = true;
        
        for (let r = 0; r < length; r++) {
            const y = (startRow + r) * gridSize;
            
            // æ£€æŸ¥æ˜¯å¦ä¸è›‡é‡å 
            for (const segment of snakes.snake1) {
                if (segment.x === x && segment.y === y) {
                    validWall = false;
                    break;
                }
            }
            
            if (validWall) {
                for (const segment of snakes.snake2) {
                    if (segment.x === x && segment.y === y) {
                        validWall = false;
                        break;
                    }
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨å®‰å…¨åŒºåŸŸå†…
            if (validWall) {
                if (isInSafeZone(x, y, safeZones.snake1) || 
                    isInSafeZone(x, y, safeZones.snake2)) {
                    validWall = false;
                }
            }
            
            // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦åœ¨åŸºåœ°åŒºåŸŸå†…
            if (validWall) {
                if (isInHomeArea(x, y, homes.player1) || 
                    isInHomeArea(x, y, homes.player2)) {
                    validWall = false;
                }
            }
            
            if (!validWall) break;
        }
        
        if (validWall) {
            for (let r = 0; r < length; r++) {
                newWall.segments.push({
                    x: x,
                    y: (startRow + r) * gridSize
                });
            }
            walls.push(newWall);
        }
    }
}

// æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦åœ¨åŸºåœ°åŒºåŸŸå†…
function isInHomeArea(x, y, home) {
    if (home.destroyed) return false;
    return x >= home.x && 
           x <= home.x + home.width && 
           y >= home.y && 
           y <= home.y + home.height;
}
// è·å–è›‡å‰æ–¹çš„å®‰å…¨åŒºåŸŸ
function getSnakeSafeZone(snakeId, distanceInGrids) {
    const head = snakes[snakeId][0];
    const direction = directions[snakeId];
    const gridSize = 20;
    const safeZone = [];
    
    // è®¡ç®—å‰æ–¹åŒºåŸŸ
    for (let i = 1; i <= distanceInGrids; i++) {
        let x = head.x, y = head.y;
        
        switch (direction) {
            case 'up': y -= i * gridSize; break;
            case 'down': y += i * gridSize; break;
            case 'left': x -= i * gridSize; break;
            case 'right': x += i * gridSize; break;
        }
        
        // ç¡®ä¿åæ ‡åœ¨æ¸¸æˆæ¿å†…
        if (x >= 0 && x < gameBoard.clientWidth && 
            y >= 0 && y < gameBoard.clientHeight) {
            safeZone.push({x, y});
        }
    }
    
    return safeZone;
}

// æ£€æŸ¥åæ ‡æ˜¯å¦åœ¨å®‰å…¨åŒºåŸŸå†…
function isInSafeZone(x, y, safeZone) {
    return safeZone.some(zone => zone.x === x && zone.y === y);
}
// æ¸…é™¤æ¸¸æˆæ¿
function clearBoard() {
    // åªæ¸…é™¤DOMå…ƒç´ ï¼Œä¸æ¸…é™¤æ¸¸æˆæ•°æ®æ•°ç»„
    document.querySelectorAll('.bullet').forEach(bullet => bullet.remove());
    document.querySelectorAll('.home-base').forEach(home => home.remove());
    document.querySelectorAll('.snake-segment').forEach(segment => segment.remove());
    document.querySelectorAll('.food').forEach(food => food.remove());
    document.querySelectorAll('.special-food').forEach(item => item.remove());
    document.querySelectorAll('.wall-segment').forEach(wall => wall.remove());
}

// æ·»åŠ æ›´æ–°å‚¨å­˜æ˜¾ç¤ºçš„å‡½æ•°
function updateStorageDisplay() {
    // æ›´æ–°ç©å®¶1çš„å‚¨å­˜æ˜¾ç¤º
    for (let i = 0; i < 5; i++) {
        const slot = document.getElementById(`p1-slot-${i+1}`);
        if (i < ballStorage.snake1.length) {
            slot.classList.add('filled');
            switch(ballStorage.snake1[i].type) {
                case 'immunity':
                    slot.style.background = 'linear-gradient(45deg, #FFFF00, #FFD700)';
                    slot.style.boxShadow = '0 0 10px #FFFF00';
                    break;
                case 'health':
                    slot.style.background = 'linear-gradient(45deg, #FF0000, #FF6B6B)';
                    slot.style.boxShadow = '0 0 10px #FF0000';
                    break;
                case 'reverse':
                    slot.style.background = 'linear-gradient(45deg, #800080, #DA70D6)';
                    slot.style.boxShadow = '0 0 10px #800080';
                    break;
                case 'attack':
                    slot.style.background = 'linear-gradient(45deg, #00BFFF, #87CEFA)'; // æµ…è“è‰²
                    slot.style.boxShadow = '0 0 10px #00BFFF';
                    break;
                case 'bomb':
                    slot.style.background = 'linear-gradient(45deg, #FF4500, #FF8C00)';
                    slot.style.boxShadow = '0 0 10px #FF4500';
                    break;
            
            }
        } else {
            slot.classList.remove('filled');
            slot.style.background = 'rgba(255, 255, 255, 0.2)';
            slot.style.boxShadow = 'none';
        }
    }
    
    // æ›´æ–°ç©å®¶2çš„å‚¨å­˜æ˜¾ç¤º
    for (let i = 0; i < 5; i++) {
        const slot = document.getElementById(`p2-slot-${i+1}`);
        if (i < ballStorage.snake2.length) {
            slot.classList.add('filled');
            switch(ballStorage.snake2[i].type) {
                case 'immunity':
                    slot.style.background = 'linear-gradient(45deg, #FFFF00, #FFD700)';
                    slot.style.boxShadow = '0 0 10px #FFFF00';
                    break;
                case 'health':
                    slot.style.background = 'linear-gradient(45deg, #FF0000, #FF6B6B)';
                    slot.style.boxShadow = '0 0 10px #FF0000';
                    break;
                case 'reverse':
                    slot.style.background = 'linear-gradient(45deg, #800080, #DA70D6)';
                    slot.style.boxShadow = '0 0 10px #800080';
                    break;
                case 'attack':
                    slot.style.background = 'linear-gradient(45deg, #00BFFF, #87CEFA)'; // æµ…è“è‰²
                    slot.style.boxShadow = '0 0 10px #00BFFF';
                    break;
                 case 'bomb':
                    slot.style.background = 'linear-gradient(45deg, #FF4500, #FF8C00)';
                    slot.style.boxShadow = '0 0 10px #FF4500';
                    break;    
            }
        } else {
            slot.classList.remove('filled');
            slot.style.background = 'rgba(255, 255, 255, 0.2)';
            slot.style.boxShadow = 'none';
        }
    }
}
    
    // æ›´æ–°ç©å®¶2çš„å‚¨å­˜æ˜¾ç¤º
    for (let i = 0; i < 5; i++) {
        const slot = document.getElementById(`p2-slot-${i+1}`);
        if (i < ballStorage.snake2.length) {
            slot.classList.add('filled');
            switch(ballStorage.snake2[i].type) {
                case 'immunity':
                    slot.style.background = 'linear-gradient(45deg, #FFFF00, #FFD700)';
                    slot.style.boxShadow = '0 0 10px #FFFF00';
                    break;
                case 'health':
                    slot.style.background = 'linear-gradient(45deg, #FF0000, #FF6B6B)';
                    slot.style.boxShadow = '0 0 10px #FF0000';
                    break;
                case 'reverse':
                    slot.style.background = 'linear-gradient(45deg, #800080, #DA70D6)';
                    slot.style.boxShadow = '0 0 10px #800080';
                    break;
            }
        } else {
            slot.classList.remove('filled');
            slot.style.background = 'rgba(255, 255, 255, 0.2)';
            slot.style.boxShadow = 'none';
        }
    }


// ç”Ÿæˆé£Ÿç‰©
function generateFood() {
    const boardWidth = gameBoard.clientWidth;
    const boardHeight = gameBoard.clientHeight;
    
    // ç¡®ä¿é£Ÿç‰©å‡ºç°åœ¨20pxçš„ç½‘æ ¼ä¸Š
    const maxX = Math.floor((boardWidth - 20) / 20);
    const maxY = Math.floor((boardHeight - 20) / 20);
    
    let validPosition = false;
    let foodX, foodY;
    let attempts = 0;
    const maxAttempts = 100; // é˜²æ­¢æ— é™å¾ªç¯
    
    while (!validPosition && attempts < maxAttempts) {
        attempts++;
        foodX = Math.floor(Math.random() * maxX) * 20;
        foodY = Math.floor(Math.random() * maxY) * 20;
        
        validPosition = true;
        
        // æ£€æŸ¥é£Ÿç‰©æ˜¯å¦ä¸è›‡é‡å 
        for (const snakeId in snakes) {
            for (const segment of snakes[snakeId]) {
                if (segment.x === foodX && segment.y === foodY) {
                    validPosition = false;
                    break;
                }
            }
            if (!validPosition) break;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ç°æœ‰é£Ÿç‰©é‡å 
        if (validPosition) {
            for (const food of foods) {
                if (food.x === foodX && food.y === foodY) {
                    validPosition = false;
                    break;
                }
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ç‰¹æ®Šç‰©å“é‡å 
        if (validPosition) {
            for (const item of specialItems) {
                if (item.x === foodX && item.y === foodY) {
                    validPosition = false;
                    break;
                }
            }
        }
        
        // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦åœ¨å¢™ä¸Š
        if (validPosition) {
            validPosition = !isPositionOnWall(foodX, foodY);
        }
    }
    
    if (validPosition) {
        foods.push({ 
            x: foodX, 
            y: foodY,
            type: Math.random() > 0.7 ? 'special' : 'normal'
        });
    } else {
        console.warn('æœªèƒ½æ‰¾åˆ°æœ‰æ•ˆä½ç½®ç”Ÿæˆé£Ÿç‰©');
    }
}

function drawSpecialItems() {
    specialItems.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'special-food';
        
        // æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒé¢œè‰²
        switch(item.type) {
            case 'immunity':
                itemElement.classList.add('immunity-ball'); // é»„è‰²
                break;
            case 'health':
                itemElement.classList.add('health-ball');   // çº¢è‰²
                break;
            case 'reverse':
                itemElement.classList.add('reverse-ball');  // ç´«è‰²
                break;
        }
        
        itemElement.style.left = `${item.x}px`;
        itemElement.style.top = `${item.y}px`;
        
        gameBoard.appendChild(itemElement);
    });
}    

// ç”Ÿæˆç‰¹æ®Šç‰©å“
function generateSpecialItem() {
    const boardWidth = gameBoard.clientWidth;
    const boardHeight = gameBoard.clientHeight;
    
    const maxX = Math.floor((boardWidth - 20) / 20);
    const maxY = Math.floor((boardHeight - 20) / 20);
    
    let validPosition = false;
    let itemX, itemY;
    let attempts = 0;
    const maxAttempts = 100;
    
    while (!validPosition && attempts < maxAttempts) {
        attempts++;
        itemX = Math.floor(Math.random() * maxX) * 20;
        itemY = Math.floor(Math.random() * maxY) * 20;
        
        validPosition = true;
        
        // æ£€æŸ¥æ˜¯å¦ä¸è›‡é‡å 
        for (const snakeId in snakes) {
            for (const segment of snakes[snakeId]) {
                if (segment.x === itemX && segment.y === itemY) {
                    validPosition = false;
                    break;
                }
            }
            if (!validPosition) break;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ç°æœ‰é£Ÿç‰©é‡å 
        if (validPosition) {
            for (const food of foods) {
                if (food.x === itemX && food.y === itemY) {
                    validPosition = false;
                    break;
                }
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ç°æœ‰ç‰¹æ®Šç‰©å“é‡å 
        if (validPosition) {
            for (const item of specialItems) {
                if (item.x === itemX && item.y === itemY) {
                    validPosition = false;
                    break;
                }
            }
        }
        
        // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦åœ¨å¢™ä¸Š
        if (validPosition) {
            validPosition = !isPositionOnWall(itemX, itemY);
        }
    }
    
    if (validPosition) {
        const itemTypes = ['immunity', 'health', 'reverse', 'attack'];
        const weights = [0, 0, 0, 1]; // å¹³å‡åˆ†é…æ¦‚ç‡
        let randomValue = Math.random();
        let selectedType = itemTypes[0];
        
        for (let i = 0; i < itemTypes.length; i++) {
            if (randomValue < weights[i]) {
                selectedType = itemTypes[i];
                break;
            }
            randomValue -= weights[i];
        }
        
        specialItems.push({ 
            x: itemX, 
            y: itemY,
            type: selectedType,
            spawnTime: performance.now()
        });
    } else {
        console.warn('æœªèƒ½æ‰¾åˆ°æœ‰æ•ˆä½ç½®ç”Ÿæˆç‰¹æ®Šç‰©å“');
    }
}

// ç»˜åˆ¶è›‡
function drawSnakes(withAnimation = false) {
    for (const snakeId in snakes) {
        const snake = snakes[snakeId];
        const isSnake1 = snakeId === 'snake1';
        
        snake.forEach((segment, index) => {
            const segmentElement = document.createElement('div');
            segmentElement.className = `snake-segment ${snakeId}`;
            
            // æ·»åŠ å†»ç»“æ•ˆæœ
            if (frozenSnakes[snakeId]) {
                segmentElement.classList.add('frozen-snake');
                if (index === 0) {
                    segmentElement.innerHTML = 'â„â„ï¸';
                    segmentElement.style.display = 'flex';
                    segmentElement.style.justifyContent = 'center';
                    segmentElement.style.alignItems = 'center';
                    segmentElement.style.fontSize = '14px';
                }
            }
            // æ·»åŠ å…ç–«æ•ˆæœè§†è§‰æç¤º
            if ((snakeId === 'snake1' && immunity.snake1) || 
                (snakeId === 'snake2' && immunity.snake2)) {
                segmentElement.style.boxShadow = '0 0 15px #FFFF00';
                segmentElement.style.animation = 'pulse 0.5s infinite alternate';
            }
            
            if (index === 0) segmentElement.classList.add('snake-head');
            
            if (withAnimation) {
                segmentElement.classList.add('snake-enter');
                segmentElement.style.animationDelay = `${index * 0.1}s`;
            }
            if (pausedSnakes[snakeId]) {
                segmentElement.style.opacity = '0.6';
                segmentElement.style.filter = 'grayscale(50%)';
                if (index === 0) { // è›‡å¤´æ·»åŠ æš‚åœå›¾æ ‡
                    segmentElement.innerHTML = 'â¸';
                    segmentElement.style.display = 'flex';
                    segmentElement.style.justifyContent = 'center';
                    segmentElement.style.alignItems = 'center';
                    segmentElement.style.fontSize = '14px';
                }
            }            
            segmentElement.style.left = `${segment.x}px`;
            segmentElement.style.top = `${segment.y}px`;
            
            gameBoard.appendChild(segmentElement);
        });
    }
}

// ç»˜åˆ¶é£Ÿç‰©
function drawFoods(withAnimation = false) {
    // ç»˜åˆ¶æ™®é€šé£Ÿç‰©å’Œç‰¹æ®Šé£Ÿç‰©
    foods.forEach(food => {
        const foodElement = document.createElement('div');
        foodElement.className = food.type === 'special' ? 'special-food' : 'food';
        
        if (withAnimation) {
            foodElement.classList.add('food-enter');
        }
        
        foodElement.style.left = `${food.x}px`;
        foodElement.style.top = `${food.y}px`;
        
        gameBoard.appendChild(foodElement);
    });
    
    // ç»˜åˆ¶ç‰¹æ®Šç‰©å“
    specialItems.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'special-food';
        
        // æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒæ ·å¼
        switch(item.type) {
            case 'immunity':
                itemElement.style.background = 'linear-gradient(45deg, #FFFF00, #FFD700)';
                itemElement.style.boxShadow = '0 0 15px #FFFF00';
                break;
            case 'health':
                itemElement.style.background = 'linear-gradient(45deg, #FF0000, #FF6B6B)';
                itemElement.style.boxShadow = '0 0 15px #FF0000';
                break;
            case 'reverse':
                itemElement.style.background = 'linear-gradient(45deg, #800080, #DA70D6)';
                itemElement.style.boxShadow = '0 0 15px #800080';
                break;
        }
        
        itemElement.style.left = `${item.x}px`;
        itemElement.style.top = `${item.y}px`;
        
        gameBoard.appendChild(itemElement);
    });
}
function handleHomes(timestamp) {
    for (const snakeId in snakes) {
        const head = snakes[snakeId][0];
        const playerNum = snakeId === 'snake1' ? 'player1' : 'player2';
        const opponentNum = snakeId === 'snake1' ? 'player2' : 'player1';
        
        // æ£€æŸ¥æ˜¯å¦åœ¨è‡ªå·±çš„åŸºåœ°ä¸­
        const inOwnHome = isPointInRect(head, homes[playerNum]);
        const inOpponentHome = isPointInRect(head, homes[opponentNum]);
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å…ç–«æ•ˆæœ
        const hasImmunity = (snakeId === 'snake1' && immunity.snake1) || 
                           (snakeId === 'snake2' && immunity.snake2);
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯åšç¡¬è›‡
        const isToughSnake = snakeId === 'snake1' ? snakeTypes.snake1 === 'tough' : snakeTypes.snake2 === 'tough';
        
        if (inOwnHome && !homes[playerNum].destroyed) {
            // åœ¨è‡ªå·±çš„åŸºåœ°ä¸­å›è¡€
            if (timestamp - homes[playerNum].lastHealTime > 1000) {
                // ä½¿ç”¨ç»Ÿä¸€çš„æ²»ç–—å‡½æ•°
                const healed = applyHealing(snakeId, 1, 'home');
                
                if (healed) {
                    createParticles(
                        homes[playerNum].x + homes[playerNum].width/2,
                        homes[playerNum].y + homes[playerNum].height/2,
                        10,
                        '#4CAF50'
                    );
                }
                
                homes[playerNum].lastHealTime = timestamp;
            }
        } else if (inOpponentHome && !homes[opponentNum].destroyed) {
            // åœ¨å¯¹æ–¹åŸºåœ°ä¸­é€ æˆä¼¤å®³
            if (timestamp - homes[opponentNum].lastDamageTime > 1000) {
                
                let damageToHome = 3; // å¯¹åŸºåœ°çš„å›ºå®šä¼¤å®³
                let damageToSelf = 1; // å¯¹è‡ªå·±çš„ä¼¤å®³
                
                // å¦‚æœæ˜¯åšç¡¬è›‡ï¼Œè‡ªå·±å—åˆ°çš„ä¼¤å®³å‡åŠ
                if (isToughSnake) {
                    damageToSelf = Math.ceil(damageToSelf / 2);
                }
                
                if (!hasImmunity) {
                    // æ²¡æœ‰å…ç–«æ•ˆæœï¼šåŒæ–¹éƒ½æ‰è¡€
                    // å¯¹æ–¹åŸºåœ°æ‰è¡€
                    homes[opponentNum].health = Math.max(0, homes[opponentNum].health - damageToHome);
                    
                    // è®°å½•è›‡å¯¹åŸºåœ°çš„ä¼¤å®³ï¼ˆè¾“å‡ºä¼¤å®³ï¼‰- è¿™éƒ¨åˆ†ç»Ÿè®¡å·²ç»åœ¨applyDamageä¸­å¤„ç†
                    
                    // è‡ªå·±æ‰è¡€ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„ä¼¤å®³å‡½æ•°ï¼‰
                    const damageApplied = applyDamage(snakeId, damageToSelf, 'home', {
                        home: opponentNum,
                        damageToHome: damageToHome,
                        isToughSnake: isToughSnake
                    });
                    
                    if (damageApplied) {
                        // æ˜¾ç¤ºä¼¤å®³æ•ˆæœ
                        let selfDamageMessage = `-${damageToSelf}HP`;
                        if (isToughSnake) {
                            selfDamageMessage += ' (åšç¡¬å‡åŠ)';
                            showNotice(`æ”»å‡»å¯¹æ–¹åŸºåœ°! ${selfDamageMessage}`, '#FFA500',
                                     homes[opponentNum].x + homes[opponentNum].width/2,
                                     homes[opponentNum].y + homes[opponentNum].height/2);
                            createParticles(head.x + 10, head.y + 10, 8, '#C0C0C0'); // é“¶è‰²ç²’å­
                        } else {
                            showNotice(`æ”»å‡»å¯¹æ–¹åŸºåœ°! ${selfDamageMessage}`, '#FF0000',
                                     homes[opponentNum].x + homes[opponentNum].width/2,
                                     homes[opponentNum].y + homes[opponentNum].height/2);
                            createParticles(head.x + 10, head.y + 10, 10, '#FF0000');
                        }
                    }
                    
                } else {
                    // æœ‰å…ç–«æ•ˆæœï¼šåªå¯¹å¯¹æ–¹åŸºåœ°é€ æˆä¼¤å®³ï¼Œè‡ªå·±ä¸å—ä¼¤
                    homes[opponentNum].health = Math.max(0, homes[opponentNum].health - damageToHome);
                    
                    // æ˜¾ç¤ºå…ç–«æ”»å‡»æ•ˆæœ
                    showNotice('å…ç–«æ”»å‡»å¯¹æ–¹åŸºåœ°!', '#FFFF00',
                             homes[opponentNum].x + homes[opponentNum].width/2,
                             homes[opponentNum].y + homes[opponentNum].height/2);
                    
                    // åˆ›å»ºå…ç–«æ”»å‡»æ•ˆæœ
                    createParticles(
                        homes[opponentNum].x + homes[opponentNum].width/2,
                        homes[opponentNum].y + homes[opponentNum].height/2,
                        15,
                        '#FFFF00'
                    );
                }
                
                // æ£€æŸ¥åŸºåœ°æ˜¯å¦è¢«æ‘§æ¯ï¼ˆæ— è®ºæ˜¯å¦æœ‰å…ç–«ï¼‰
                if (homes[opponentNum].health <= 0) {
                    homes[opponentNum].destroyed = true;
                    const playerName = opponentNum === 'player1' ? 
                        (localStorage.getItem('username') || 'ç©å®¶1') : 
                        (localStorage.getItem('player2_username') || 'ç©å®¶2');
                    
                    showNotice(`${playerName}çš„åŸºåœ°è¢«æ‘§æ¯äº†!`, '#FF0000', 
                             homes[opponentNum].x + homes[opponentNum].width/2, 
                             homes[opponentNum].y + homes[opponentNum].height/2);
                    
                    // åŸºåœ°è¢«æ‘§æ¯çš„å¤§çˆ†ç‚¸æ•ˆæœ
                    createParticles(
                        homes[opponentNum].x + homes[opponentNum].width/2,
                        homes[opponentNum].y + homes[opponentNum].height/2,
                        30,
                        opponentNum === 'player1' ? '#FF5722' : '#2196F3'
                    );
                }
                
                homes[opponentNum].lastDamageTime = timestamp;
            }
        }
    }
}
function calculateFiringPoints(home, targetPoint, isInsideHome) {
    const points = [];
    
    if (isInsideHome) {
        // å¦‚æœåœ¨åŸºåœ°å†…éƒ¨ï¼Œä»æ‰€æœ‰è¾¹çš„æ‰€æœ‰ç‚¹å‘å°„
        return getAllHomeBorderPoints(home);
    }
    
    // è®¡ç®—ç›®æ ‡ç›¸å¯¹äºåŸºåœ°çš„ä½ç½®
    const targetX = targetPoint.x;
    const targetY = targetPoint.y;
    const homeLeft = home.x;
    const homeRight = home.x + home.width;
    const homeTop = home.y;
    const homeBottom = home.y + home.height;
    
    // ç¡®å®šç›®æ ‡åœ¨åŸºåœ°çš„å“ªä¸ªè±¡é™/æ–¹å‘
    const isLeft = targetX < homeLeft;
    const isRight = targetX > homeRight;
    const isAbove = targetY < homeTop;
    const isBelow = targetY > homeBottom;
    
    // æ ¹æ®ç›®æ ‡ä½ç½®ç¡®å®šæ”»å‡»çš„è¾¹
    if (isAbove && !isLeft && !isRight) {
        // æ­£ä¸Šæ–¹ â†’ ä¸Šè¾¹æ•´æ¡è¾¹æ”»å‡»
        points.push(...getHomeBorderPointsBySide(home, 'top'));
    } 
    else if (isBelow && !isLeft && !isRight) {
        // æ­£ä¸‹æ–¹ â†’ ä¸‹è¾¹æ•´æ¡è¾¹æ”»å‡»
        points.push(...getHomeBorderPointsBySide(home, 'bottom'));
    }
    else if (isLeft && !isAbove && !isBelow) {
        // æ­£å·¦æ–¹ â†’ å·¦è¾¹æ•´æ¡è¾¹æ”»å‡»
        points.push(...getHomeBorderPointsBySide(home, 'left'));
    }
    else if (isRight && !isAbove && !isBelow) {
        // æ­£å³æ–¹ â†’ å³è¾¹æ•´æ¡è¾¹æ”»å‡»
        points.push(...getHomeBorderPointsBySide(home, 'right'));
    }
    else {
        // æ–œæ–¹å‘ â†’ ç”¨æ¥è¿‘çš„ä¸¤æ¡è¾¹æ•´æ¡è¾¹æ”»å‡»
        // ä¼˜å…ˆè€ƒè™‘æ›´æ¥è¿‘çš„è¾¹
        const horizontalSide = targetX < (homeLeft + homeRight) / 2 ? 'left' : 'right';
        const verticalSide = targetY < (homeTop + homeBottom) / 2 ? 'top' : 'bottom';
        
        // è®¡ç®—è·ç¦»æƒé‡
        const horizontalDistance = horizontalSide === 'left' ? homeLeft - targetX : targetX - homeRight;
        const verticalDistance = verticalSide === 'top' ? homeTop - targetY : targetY - homeBottom;
        
        // å¦‚æœç›®æ ‡æ›´æ¥è¿‘æ°´å¹³è¾¹ï¼Œä¸»è¦ä»æ°´å¹³è¾¹æ”»å‡»ï¼Œæ¬¡è¦ä»å‚ç›´è¾¹æ”»å‡»
        if (Math.abs(horizontalDistance) < Math.abs(verticalDistance)) {
            // ä¸»è¦æ”»å‡»æ°´å¹³è¾¹ï¼ˆæ•´æ¡è¾¹ï¼‰
            points.push(...getHomeBorderPointsBySide(home, horizontalSide));
            
            // æ¬¡è¦æ”»å‡»å‚ç›´è¾¹çš„æ¥è¿‘éƒ¨åˆ†
            const verticalPoints = getHomeBorderPointsBySide(home, verticalSide);
            const closestVerticalPoints = getClosestBorderPoints(home, verticalSide, targetPoint, 0.5); // 50%çš„è¾¹
            points.push(...closestVerticalPoints);
        } else {
            // ä¸»è¦æ”»å‡»å‚ç›´è¾¹ï¼ˆæ•´æ¡è¾¹ï¼‰
            points.push(...getHomeBorderPointsBySide(home, verticalSide));
            
            // æ¬¡è¦æ”»å‡»æ°´å¹³è¾¹çš„æ¥è¿‘éƒ¨åˆ†
            const horizontalPoints = getHomeBorderPointsBySide(home, horizontalSide);
            const closestHorizontalPoints = getClosestBorderPoints(home, horizontalSide, targetPoint, 0.5);
            points.push(...closestHorizontalPoints);
        }
    }
    
    return points;
}


// æ–°å¢å‡½æ•°ï¼šæ£€æŸ¥æŠ•å½±ç‚¹æ˜¯å¦åœ¨è¾¹ä¸Š
function isProjectionOnSide(home, side, projectionPoint) {
    switch(side) {
        case 'top':
        case 'bottom':
            return projectionPoint.x >= home.x && projectionPoint.x <= home.x + home.width;
        case 'left':
        case 'right':
            return projectionPoint.y >= home.y && projectionPoint.y <= home.y + home.height;
        default:
            return false;
    }
}

// æ–°å¢å‡½æ•°ï¼šè®¡ç®—ç‚¹åˆ°è¾¹çš„è·ç¦»
function getDistanceToSide(point, home, side) {
    switch(side) {
        case 'top':
            return Math.abs(point.y - home.y);
        case 'bottom':
            return Math.abs(point.y - (home.y + home.height));
        case 'left':
            return Math.abs(point.x - home.x);
        case 'right':
            return Math.abs(point.x - (home.x + home.width));
        default:
            return Infinity;
    }
}

// æ–°å¢å‡½æ•°ï¼šè·å–è¾¹æ¥è¿‘ç›®æ ‡çš„éƒ¨åˆ†
function getClosestBorderPoints(home, side, targetPoint, proportion = 0.3) {
    const points = [];
    const allPoints = getHomeBorderPointsBySide(home, side);
    
    if (allPoints.length <= 3) {
        return allPoints;
    }
    
    // æ‰¾åˆ°è¾¹ä¸Šè·ç¦»ç›®æ ‡æœ€è¿‘çš„ç‚¹
    let closestIndex = 0;
    let minDistance = Infinity;
    
    allPoints.forEach((point, index) => {
        const distance = Math.sqrt(
            Math.pow(point.x - targetPoint.x, 2) + 
            Math.pow(point.y - targetPoint.y, 2)
        );
        
        if (distance < minDistance) {
            minDistance = distance;
            closestIndex = index;
        }
    });
    
    // æ ¹æ®æ¯”ä¾‹è®¡ç®—åº”è¯¥å–å¤šå°‘ç‚¹
    const pointsToTake = Math.max(3, Math.floor(allPoints.length * proportion));
    const halfPoints = Math.floor(pointsToTake / 2);
    
    const startIndex = Math.max(0, closestIndex - halfPoints);
    const endIndex = Math.min(allPoints.length - 1, startIndex + pointsToTake - 1);
    
    for (let i = startIndex; i <= endIndex; i++) {
        points.push(allPoints[i]);
    }
    
    return points;
}
// æ–°å¢å‡½æ•°ï¼šè·å–æ‰€æœ‰è¾¹çš„æ‰€æœ‰ç‚¹
function getAllHomeBorderPoints(home) {
    const points = [];
    const gridSize = 20;
    
    const startX = home.x;
    const startY = home.y;
    const endX = home.x + home.width;
    const endY = home.y + home.height;
    
    // ä¸Šè¾¹æ¡†
    for (let x = startX; x < endX; x += gridSize) {
        points.push({ x: x, y: startY, side: 'top' });
    }
    
    // ä¸‹è¾¹æ¡†
    for (let x = startX; x < endX; x += gridSize) {
        points.push({ x: x, y: endY - 2, side: 'bottom' });
    }
    
    // å·¦è¾¹æ¡†
    for (let y = startY; y < endY; y += gridSize) {
        points.push({ x: startX, y: y, side: 'left' });
    }
    
    // å³è¾¹æ¡†
    for (let y = startY; y < endY; y += gridSize) {
        points.push({ x: endX - 2, y: y, side: 'right' });
    }
    
    return points;
}
        
        // æ£€æŸ¥ç‚¹æ˜¯å¦åœ¨çŸ©å½¢å†…
        function isPointInRect(point, rect) {
            return point.x >= rect.x && 
                   point.x <= rect.x + rect.width && 
                   point.y >= rect.y && 
                   point.y <= rect.y + rect.height;
        }
        
        // åœ¨clearBoardå‡½æ•°ä¸­æ·»åŠ æ¸…é™¤åŸºåœ°å…ƒç´ 
        function clearBoard() {
            document.querySelectorAll('.bullet').forEach(bullet => bullet.remove());
            document.querySelectorAll('.home-base').forEach(home => home.remove());
            while (gameBoard.firstChild) {
                gameBoard.removeChild(gameBoard.firstChild);
            }
        }
function updateBaseDefense(playerHomeId, timestamp) {
    const defense = baseDefense[playerHomeId];
    const home = homes[playerHomeId];
    const targetSnakeId = playerHomeId === 'player1' ? 'snake2' : 'snake1';
    const targetSnake = snakes[targetSnakeId];
    const targetHead = targetSnake[0];
    
    // æ£€æŸ¥æ˜¯å¦åœ¨æ”»å‡»èŒƒå›´å†…ï¼ˆ20æ ¼ = 400åƒç´ ï¼‰
    const distance = calculateDistanceToRect(targetHead, home);
    const inRange = distance <= defense.attackRange * 20;
    
    // æ£€æŸ¥ç›®æ ‡è›‡æ˜¯å¦åœ¨åŸºåœ°å†…éƒ¨
    const isInsideHome = isPointInRect(targetHead, home);
    
    // æ¿€æ´»é˜²å¾¡æ¡ä»¶ï¼šç›®æ ‡åœ¨æ”»å‡»èŒƒå›´å†…
    defense.active = inRange || isInsideHome;
    defense.targetSnake = defense.active ? targetSnakeId : null;
    
    // å¦‚æœé˜²å¾¡æ¿€æ´»ï¼Œå‘å°„å­å¼¹
    if (defense.active && timestamp - defense.lastShotTime > defense.shootInterval) {
        // è®¡ç®—åº”è¯¥å‘å°„å­å¼¹çš„è¾¹å’Œå…·ä½“ä½ç½®
        const firingPoints = calculateFiringPoints(home, targetHead, isInsideHome);
        
        if (firingPoints.length > 0) {
            fireBaseBullet(playerHomeId, targetHead, firingPoints, timestamp);
            defense.lastShotTime = timestamp;
            
            // æ˜¾ç¤ºæ”»å‡»æ–¹å‘æç¤ºï¼ˆå¯é€‰ï¼‰
            showAttackDirectionHint(playerHomeId, targetHead, home);
        }
    }
}
function showAttackDirectionHint(playerHomeId, targetHead, home) {
    const targetX = targetHead.x;
    const targetY = targetHead.y;
    const homeCenterX = home.x + home.width / 2;
    const homeCenterY = home.y + home.height / 2;
    
    // è®¡ç®—æ–¹å‘
    const isLeft = targetX < home.x;
    const isRight = targetX > home.x + home.width;
    const isAbove = targetY < home.y;
    const isBelow = targetY > home.y + home.height;
    
    let direction = '';
    
    if (isAbove && !isLeft && !isRight) {
        direction = 'ä¸Šæ–¹';
    } else if (isBelow && !isLeft && !isRight) {
        direction = 'ä¸‹æ–¹';
    } else if (isLeft && !isAbove && !isBelow) {
        direction = 'å·¦æ–¹';
    } else if (isRight && !isAbove && !isBelow) {
        direction = 'å³æ–¹';
    } else if (isAbove && isLeft) {
        direction = 'å·¦ä¸Šæ–¹';
    } else if (isAbove && isRight) {
        direction = 'å³ä¸Šæ–¹';
    } else if (isBelow && isLeft) {
        direction = 'å·¦ä¸‹æ–¹';
    } else if (isBelow && isRight) {
        direction = 'å³ä¸‹æ–¹';
    } else {
        direction = 'å†…éƒ¨';
    }
    
    // æ˜¾ç¤ºæ–¹å‘æç¤ºï¼ˆåªåœ¨åŸºåœ°ä¸­å¿ƒé™„è¿‘æ˜¾ç¤ºï¼Œé¿å…å¹²æ‰°ï¼‰
    const showX = home.x + home.width / 2;
    const showY = home.y + home.height / 2 - 20;
    
    showNotice(`${direction}é˜²å¾¡!`, playerHomeId === 'player1' ? '#FF5722' : '#2196F3',
              showX, showY);
}

function handleBaseDefense(timestamp) {
    // æ£€æŸ¥ç©å®¶1çš„åŸºåœ°é˜²å¾¡
    if (!homes.player1.destroyed) {
        updateBaseDefense('player1', timestamp);
    }
    
    // æ£€æŸ¥ç©å®¶2çš„åŸºåœ°é˜²å¾¡
    if (!homes.player2.destroyed) {
        updateBaseDefense('player2', timestamp);
    }
}
// æ–°å¢å‡½æ•°ï¼šè®¡ç®—åº”è¯¥ä»å“ªè¾¹å‘å°„å­å¼¹
function calculateFiringSides(home, targetPoint, isInsideHome) {
    const sides = [];
    
    if (isInsideHome) {
        // å¦‚æœåœ¨åŸºåœ°å†…éƒ¨ï¼Œä»æ‰€æœ‰è¾¹å‘å°„
        return ['top', 'bottom', 'left', 'right'];
    }
    
    // è®¡ç®—ç›®æ ‡ç›¸å¯¹äºåŸºåœ°çš„ä½ç½®
    const homeCenterX = home.x + home.width / 2;
    const homeCenterY = home.y + home.height / 2;
    
    // è®¡ç®—è§’åº¦ï¼ˆ0åº¦æ˜¯æ­£å³æ–¹ï¼Œé€†æ—¶é’ˆå¢åŠ ï¼‰
    const angle = Math.atan2(targetPoint.y - homeCenterY, targetPoint.x - homeCenterX) * 180 / Math.PI;
    
    // æ ‡å‡†åŒ–è§’åº¦åˆ°0-360åº¦
    const normalizedAngle = (angle + 360) % 360;
    
    // æ ¹æ®è§’åº¦ç¡®å®šåº”è¯¥ä»å“ªè¾¹å‘å°„
    if (normalizedAngle >= 45 && normalizedAngle < 135) {
        // ä¸‹æ–¹ï¼ˆç›®æ ‡åœ¨åŸºåœ°ä¸‹æ–¹ï¼‰
        sides.push('bottom');
    } else if (normalizedAngle >= 135 && normalizedAngle < 225) {
        // å·¦æ–¹ï¼ˆç›®æ ‡åœ¨åŸºåœ°å·¦æ–¹ï¼‰
        sides.push('left');
    } else if (normalizedAngle >= 225 && normalizedAngle < 315) {
        // ä¸Šæ–¹ï¼ˆç›®æ ‡åœ¨åŸºåœ°ä¸Šæ–¹ï¼‰
        sides.push('top');
    } else {
        // å³æ–¹ï¼ˆç›®æ ‡åœ¨åŸºåœ°å³æ–¹ï¼‰
        sides.push('right');
    }
    
    return sides;
}

// ä¿®æ”¹fireBaseBulletå‡½æ•°ï¼Œåªä»æŒ‡å®šè¾¹å‘å°„
function fireBaseBullet(playerHomeId, targetHead, firingPoints, timestamp) {
    const defense = baseDefense[playerHomeId];
    const home = homes[playerHomeId];
    const targetSnakeId = playerHomeId === 'player1' ? 'snake2' : 'snake1';
    
    // ä»æ‰€æœ‰å‘å°„ç‚¹å‘å°„å­å¼¹
    firingPoints.forEach(point => {
        // è®¡ç®—å­å¼¹æ–¹å‘ï¼ˆæœå‘ç›®æ ‡è›‡å¤´ï¼‰
        const angle = Math.atan2(
            targetHead.y + 10 - point.y,
            targetHead.x + 10 - point.x
        );
        
        const bullet = {
            x: point.x,
            y: point.y,
            angle: angle,
            speed: defense.bulletSpeed,
            player: 'base_' + playerHomeId, // ç¡®ä¿æ­£ç¡®æ ‡è¯†åŸºåœ°
            size: 6,
            damage: defense.damage,
            fromSide: point.side || 'unknown'
        };
        
        bullets.push(bullet);
        
        // å‘å°„ç‰¹æ•ˆ
        const particleColor = playerHomeId === 'player1' ? '#FF5722' : '#2196F3';
        createParticles(point.x, point.y, 3, particleColor);
    });
    
    // æ˜¾ç¤ºåŸºåœ°æ”»å‡»æç¤º
    if (timestamp - defense.lastShotTime > 4000) {
        const sideCount = {};
        firingPoints.forEach(point => {
            if (point.side) {
                sideCount[point.side] = (sideCount[point.side] || 0) + 1;
            }
        });
        
        const sides = Object.keys(sideCount);
        if (sides.length > 0) {
            const directionText = sides.map(side => {
                switch(side) {
                    case 'top': return 'ä¸Šæ–¹';
                    case 'bottom': return 'ä¸‹æ–¹';
                    case 'left': return 'å·¦æ–¹';
                    case 'right': return 'å³æ–¹';
                    default: return '';
                }
            }).join('ã€');
            
            showNotice(`åŸºåœ°${directionText}é˜²å¾¡æ¿€æ´»!`, playerHomeId === 'player1' ? '#FF5722' : '#2196F3',
                      home.x + home.width/2, home.y + home.height/2);
        }
    }
}
// æ·»åŠ å­å¼¹æ ·å¼åˆ°CSS
const bulletStyles = document.createElement('style');
bulletStyles.textContent = `
    /* å­å¼¹æ ·å¼ */
    .bullet {
        transition: transform 0.1s ease-out;
    }
    
    .bullet:hover {
        transform: scale(1.2);
    }
    
    /* å­å¼¹æ—‹è½¬åŠ¨ç”» */
    @keyframes bulletSpin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }
    
    /* å­å¼¹æ‹–å°¾æ•ˆæœ */
    .bullet-tail {
        transition: opacity 0.2s ease-out;
    }
    
    /* ä¸åŒç©å®¶å­å¼¹çš„ç‰¹æ®Šæ•ˆæœ */
    .bullet[style*="FF5722"] {
        animation: pulseOrange 0.5s infinite alternate;
    }
    
    .bullet[style*="2196F3"] {
        animation: pulseBlue 0.5s infinite alternate;
    }
    
    @keyframes pulseOrange {
        from {
            box-shadow: 0 0 8px #FF5722;
        }
        to {
            box-shadow: 0 0 15px #FF5722;
        }
    }
    
    @keyframes pulseBlue {
        from {
            box-shadow: 0 0 8px #2196F3;
        }
        to {
            box-shadow: 0 0 15px #2196F3;
        }
    }
`;
document.head.appendChild(bulletStyles);

// æ–°å¢å‡½æ•°ï¼šè·å–åŸºåœ°æŒ‡å®šè¾¹çš„å‘å°„ç‚¹
function getHomeBorderPointsBySide(home, side) {
    const points = [];
    const gridSize = 20;
    
    const startX = home.x;
    const startY = home.y;
    const endX = home.x + home.width;
    const endY = home.y + home.height;
    
    switch(side) {
        case 'top':
            for (let x = startX; x < endX; x += gridSize) {
                points.push({ x: x, y: startY, side: 'top' });
            }
            break;
            
        case 'bottom':
            for (let x = startX; x < endX; x += gridSize) {
                points.push({ x: x, y: endY - 2, side: 'bottom' });
            }
            break;
            
        case 'left':
            for (let y = startY; y < endY; y += gridSize) {
                points.push({ x: startX, y: y, side: 'left' });
            }
            break;
            
        case 'right':
            for (let y = startY; y < endY; y += gridSize) {
                points.push({ x: endX - 2, y: y, side: 'right' });
            }
            break;
    }
    
    return points;
}

// æ¸¸æˆä¸»å¾ªç¯
function gameLoop(timestamp) {
    if (!gameStarted) return;
    
    if (currentMap === 'snow') {
        handleBlizzard(timestamp);
    } else if (currentMap === 'volcano') {
        handleVolcanoEruption(timestamp);
    }  
requestAnimationFrame(gameLoop);
                // å¤„ç†åŸºåœ°ç›¸å…³é€»è¾‘
    handleHomes(timestamp);
    // æ›´æ–°é­”æ³•è›‡è®¡æ—¶å™¨
    updateMagicSnakeTimers(timestamp);
    
    // æ›´æ–°çŠ¶æ€æ•ˆæœè®¡æ—¶å™¨
    updateStatusEffects(timestamp);
    
    // ç§»åŠ¨å­å¼¹
    moveBullets(timestamp);
        
    // ç”Ÿæˆç‰¹æ®Šç‰©å“
    if (timestamp - lastSpecialItemSpawn > (120 + Math.random() * 60) * 200) {
        generateSpecialItem();
        lastSpecialItemSpawn = timestamp;
    }
    
    // ç§»é™¤è¿‡æœŸçš„ç‰¹æ®Šç‰©å“ï¼ˆå­˜åœ¨30ç§’åæ¶ˆå¤±ï¼‰
    for (let i = specialItems.length - 1; i >= 0; i--) {
        if (timestamp - specialItems[i].spawnTime > 30000) {
            specialItems.splice(i, 1);
        }
    }
    
    // è®¡ç®—è›‡çš„é€Ÿåº¦ï¼ˆæ•´åˆæš´é£é›ªå‡é€Ÿæ•ˆæœï¼‰
// åœ¨moveSnakeå‡½æ•°å¼€å¤´é™„è¿‘ï¼Œä¿®æ”¹é€Ÿåº¦è®¡ç®—
const snake1Speed = (snakeTypes.snake1 === 'speed' ? gameSpeed * 0.55 : 
                   (snakeTypes.snake1 === 'magic' ? gameSpeed * 0.85 : gameSpeed)) / 
                   (1 + speedBoosts.snake1) / 
                   (currentMap === 'snow' && blizzardActive && !immunity.snake1 ? snakeSpeedModifiers.snake1 : 1);

const snake2Speed = (snakeTypes.snake2 === 'speed' ? gameSpeed * 0.55 : 
                   (snakeTypes.snake2 === 'magic' ? gameSpeed * 0.85 : gameSpeed)) / 
                   (1 + speedBoosts.snake2) / 
                   (currentMap === 'snow' && blizzardActive && !immunity.snake2 ? snakeSpeedModifiers.snake2 : 1);
    // ç§»åŠ¨è›‡1
    if (!pausedSnakes.snake1 && timestamp - lastMoveTime.snake1 > snake1Speed) {
        directions.snake1 = nextDirections.snake1;
        moveSnake('snake1');
        lastMoveTime.snake1 = timestamp;
    }
    
    // ç§»åŠ¨è›‡2ï¼ˆå¦‚æœæœªæš‚åœï¼‰
    if (!pausedSnakes.snake2 && timestamp - lastMoveTime.snake2 > snake2Speed) {
        directions.snake2 = nextDirections.snake2;
        moveSnake('snake2');
        lastMoveTime.snake2 = timestamp;
    }
    
    
    // æ£€æŸ¥å¢™ç¢°æ’
    checkWallCollisions(timestamp);
    // é‡æ–°ç»˜åˆ¶
    clearBoard();
    drawWalls();
    drawBullets(); // ç»˜åˆ¶å­å¼¹
    drawSpecialItems();
    drawVolcanoes();
    drawSnakes();
    handleBaseDefense(timestamp);
    drawHomes();
    drawFoods();
}
// åœ¨CSSä¸­æ·»åŠ 
const blizzardStyle = document.createElement('style');
blizzardStyle.textContent = `
    @keyframes blizzard-up {
        to { transform: translateY(-100vh); }
    }
    @keyframes blizzard-down {
        to { transform: translateY(100vh); }
    }
    @keyframes blizzard-left {
        to { transform: translateX(-100vw); }
    }
    @keyframes blizzard-right {
        to { transform: translateX(100vw); }
    }
    
    .blizzard-particle {
        position: absolute;
        border-radius: 50%;
        z-index: 1;
    }
    
    .frozen-snake {
        opacity: 0.7;
        filter: brightness(1.5) saturate(0.5);
        box-shadow: 0 0 10px #00BFFF;
    }
`;
document.head.appendChild(blizzardStyle);
function drawBlizzard() {
    if (!blizzardActive || !blizzardDirection) return;
    
    // åˆ›å»ºæš´é£é›ªç²’å­
    const particleCount = 30;
    const boardWidth = gameBoard.clientWidth;
    const boardHeight = gameBoard.clientHeight;
    
    for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'blizzard-particle';
        
        // æ ¹æ®æ–¹å‘è®¾ç½®ç²’å­åˆå§‹ä½ç½®å’ŒåŠ¨ç”»
        switch(blizzardDirection) {
            case 'up':
                particle.style.left = `${Math.random() * boardWidth}px`;
                particle.style.top = `${boardHeight}px`;
                particle.style.animation = `blizzard-up ${1 + Math.random() * 2}s linear`;
                break;
            case 'down':
                particle.style.left = `${Math.random() * boardWidth}px`;
                particle.style.top = `0px`;
                particle.style.animation = `blizzard-down ${1 + Math.random() * 2}s linear`;
                break;
            case 'left':
                particle.style.left = `${boardWidth}px`;
                particle.style.top = `${Math.random() * boardHeight}px`;
                particle.style.animation = `blizzard-left ${1 + Math.random() * 2}s linear`;
                break;
            case 'right':
                particle.style.left = `0px`;
                particle.style.top = `${Math.random() * boardHeight}px`;
                particle.style.animation = `blizzard-right ${1 + Math.random() * 2}s linear`;
                break;
        }
        
        // éšæœºå¤§å°
        const size = 3 + Math.random() * 7;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.backgroundColor = 'rgba(200, 240, 255, 0.7)';
        particle.style.boxShadow = '0 0 5px rgba(200, 240, 255, 0.9)';
        
        gameBoard.appendChild(particle);
        
        // åŠ¨ç”»ç»“æŸåç§»é™¤
        setTimeout(() => {
            particle.remove();
        }, 3000);
    }
}
// æš´é£é›ªå¤„ç†
function handleBlizzard(timestamp) {
    // æš´é£é›ªå‰5ç§’æ˜¾ç¤ºå†·é£æ–¹å‘
    if (!blizzardActive && timestamp > blizzardTimer - 5000 && timestamp < blizzardTimer) {
        if (!blizzardDirection) {
            // éšæœºé€‰æ‹©æš´é£é›ªæ–¹å‘
            const directions = ['up', 'down', 'left', 'right'];
            blizzardDirection = directions[Math.floor(Math.random() * directions.length)];
        }
        
        // æ˜¾ç¤ºå†·é£æ–¹å‘æç¤º
        const effect1 = document.getElementById('player1-effect');
        const effect2 = document.getElementById('player2-effect');
        effect1.textContent = `å†·é£æ¥è‡ª${getDirectionName(blizzardDirection)}!`;
        effect2.textContent = `å†·é£æ¥è‡ª${getDirectionName(blizzardDirection)}!`;
    }
    
    // å¼€å§‹æš´é£é›ª
    if (!blizzardActive && timestamp > blizzardTimer) {
        blizzardActive = true;
        coldWindTimer = timestamp;
        
        // æ˜¾ç¤ºæš´é£é›ªæç¤º
        showNotice(`æš´é£é›ªæ¥è¢­! æ¥è‡ª${getDirectionName(blizzardDirection)}`, '#00BFFF', 
                  gameBoard.clientWidth / 2, 20);
        
        // 10ç§’ååœæ­¢æš´é£é›ª
        setTimeout(() => {
            blizzardActive = false;
            blizzardDirection = null;
            blizzardTimer = timestamp + 30000; // 30ç§’åä¸‹æ¬¡æš´é£é›ª
            
            // é‡ç½®é€Ÿåº¦ä¿®æ”¹å™¨
            snakeSpeedModifiers.snake1 = 1;
            snakeSpeedModifiers.snake2 = 1;
            
            // ç§»é™¤æš´é£é›ªæ•ˆæœæ˜¾ç¤º
            document.getElementById('player1-effect').textContent = '';
            document.getElementById('player2-effect').textContent = '';
        }, 10000);
    }
    
    // æš´é£é›ªæœŸé—´å¤„ç†å‡é€Ÿå’Œå†»ç»“
    if (blizzardActive) {
        applyBlizzardEffects(timestamp);
    }
}

// è·å–æ–¹å‘åç§°
function getDirectionName(dir) {
    switch(dir) {
        case 'up': return 'ä¸Šæ–¹';
        case 'down': return 'ä¸‹æ–¹';
        case 'left': return 'å·¦ä¾§';
        case 'right': return 'å³ä¾§';
        default: return '';
    }
}

// åº”ç”¨æš´é£é›ªæ•ˆæœ
function applyBlizzardEffects(timestamp) {
    for (const snakeId in snakes) {
        // æ£€æŸ¥æ˜¯å¦æœ‰å…ç–«æ•ˆæœ
        if ((snakeId === 'snake1' && immunity.snake1) || 
            (snakeId === 'snake2' && immunity.snake2)) {
            continue; // å…ç–«æš´é£é›ªæ•ˆæœ
        }
        
        const head = snakes[snakeId][0];
        let affected = true;
        
        // æ£€æŸ¥æ˜¯å¦åœ¨å¢™åï¼ˆæœ‰é®æŒ¡ï¼‰
        for (const wall of walls) {
            for (const segment of wall.segments) {
                // æ ¹æ®æš´é£é›ªæ–¹å‘æ£€æŸ¥é®æŒ¡
                switch(blizzardDirection) {
                    case 'up':
                        if (segment.x === head.x && segment.y > head.y) affected = false;
                        break;
                    case 'down':
                        if (segment.x === head.x && segment.y < head.y) affected = false;
                        break;
                    case 'left':
                        if (segment.y === head.y && segment.x > head.x) affected = false;
                        break;
                    case 'right':
                        if (segment.y === head.y && segment.x < head.x) affected = false;
                        break;
                }
                if (!affected) break;
            }
            if (!affected) break;
        }
        
        if (affected) {
            // åº”ç”¨å‡é€Ÿæ•ˆæœ
            if (!frozenSnakes[snakeId]) {
                // æ¯2ç§’å‡é€Ÿä¸€æ¬¡
                if (timestamp - coldWindTimer > 2000) {
                    snakeSpeedModifiers[snakeId] = Math.max(0.2, snakeSpeedModifiers[snakeId] - 0.2);
                    coldWindTimer = timestamp;
                    
                    // æ˜¾ç¤ºå‡é€Ÿæç¤º
                    showNotice('é€Ÿåº¦ä¸‹é™!', '#00BFFF', head.x, head.y);
                    
                    // æ£€æŸ¥æ˜¯å¦å®Œå…¨å†»ç»“
                    if (snakeSpeedModifiers[snakeId] <= 0.2) {
                        frozenSnakes[snakeId] = true;
                        frozenSnakes[`timer${snakeId.slice(-1)}`] = timestamp + 4000; // å†»ç»“4ç§’
                        showNotice('è¢«å†»ä½äº†!', '#00BFFF', head.x, head.y);
                    }
                }
            }
        } else {
            // åœ¨å¢™åï¼Œé€æ¸æ¢å¤é€Ÿåº¦
            if (!frozenSnakes[snakeId]) {
                snakeSpeedModifiers[snakeId] = Math.min(1, snakeSpeedModifiers[snakeId] + 0.05);
            }
        }
        
        // å¤„ç†å†»ç»“çŠ¶æ€
        if (frozenSnakes[snakeId] && timestamp > frozenSnakes[`timer${snakeId.slice(-1)}`]) {
            frozenSnakes[snakeId] = false;
            snakeSpeedModifiers[snakeId] = 0.4; // è§£å†»ååˆå§‹é€Ÿåº¦ä¸º40%
            showNotice('è§£å†»äº†!', '#4CAF50', head.x, head.y);
        }
    }
}
function isPositionOnWall(x, y) {
    for (const wall of walls) {
        for (const segment of wall.segments) {
            if (segment.x === x && segment.y === y) {
                return true;
            }
        }
    }
    return false;
}
function generateVolcanoes() {
    const boardWidth = gameBoard.clientWidth;
    const boardHeight = gameBoard.clientHeight;
    const gridSize = 20;
    
    // æ¸…ç©ºç°æœ‰ç«å±±å’Œå²©æµ†
    volcanoes = [];
    lavaTiles = [];
    
    // ç”Ÿæˆ3-5ä¸ªç«å±±
    const volcanoCount = 4 + Math.floor(Math.random() * 3);
    
    for (let i = 0; i < volcanoCount; i++) {
        let validPosition = false;
        let volcanoX, volcanoY;
        let attempts = 0;
        
        while (!validPosition && attempts < 100) {
            attempts++;
            volcanoX = Math.floor(Math.random() * (boardWidth / gridSize - 2)) * gridSize;
            volcanoY = Math.floor(Math.random() * (boardHeight / gridSize - 2)) * gridSize;
            
            validPosition = true;
            
            // æ£€æŸ¥æ˜¯å¦ä¸è›‡é‡å 
            for (const snakeId in snakes) {
                for (const segment of snakes[snakeId]) {
                    if (Math.abs(segment.x - volcanoX) < 60 && Math.abs(segment.y - volcanoY) < 60) {
                        validPosition = false;
                        break;
                    }
                }
                if (!validPosition) break;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸å…¶ä»–ç«å±±å¤ªè¿‘
            if (validPosition) {
                for (const volcano of volcanoes) {
                    if (Math.abs(volcano.x - volcanoX) < 100 && Math.abs(volcano.y - volcanoY) < 100) {
                        validPosition = false;
                        break;
                    }
                }
            }
            
            // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦åœ¨åŸºåœ°åŒºåŸŸå†…
            if (validPosition) {
                if (isInHomeArea(volcanoX, volcanoY, homes.player1) || 
                    isInHomeArea(volcanoX, volcanoY, homes.player2)) {
                    validPosition = false;
                }
            }
        }
        
        if (validPosition) {
            volcanoes.push({
                x: volcanoX,
                y: volcanoY,
                warning: false
            });
        }
    }
}


// ç«å±±å–·å‘å¤„ç†
function handleVolcanoEruption(timestamp) {
    // å–·å‘å‰5ç§’è­¦å‘Š
    if (!isErupting && timestamp > nextEruptionTime - 5000 && timestamp < nextEruptionTime) {
        volcanoes.forEach(volcano => {
            volcano.warning = true;
        });
    }
    
    // å¼€å§‹å–·å‘
    if (!isErupting && timestamp > nextEruptionTime) {
        isErupting = true;
        lastEruptionTime = timestamp;
        
        // ç”Ÿæˆå²©æµ†
        generateLava();
        
        // 10ç§’ååœæ­¢å–·å‘
        setTimeout(() => {
            isErupting = false;
            lavaTiles = [];
            nextEruptionTime = timestamp + 20; // 30ç§’åä¸‹æ¬¡å–·å‘
        }, 15000);
    }
    
    // æ£€æŸ¥å²©æµ†ä¼¤å®³
    if (isErupting) {
        checkLavaDamage(timestamp);
    }
}

// ç”Ÿæˆå²©æµ†
function generateLava() {
    lavaTiles = [];
    
    volcanoes.forEach(volcano => {
        // ç«å±±ä¸­å¿ƒ3x3åŒºåŸŸ
        for (let dx = -3; dx <= 3; dx++) {
            for (let dy = -3; dy <= 3; dy++) {
                const lavaX = volcano.x + dx * 20;
                const lavaY = volcano.y + dy * 20;
                
                // æ£€æŸ¥æ˜¯å¦åœ¨å¢™å
                let blockedByWall = false;
                for (const wall of walls) {
                    for (const segment of wall.segments) {
                        if (segment.x === lavaX && segment.y === lavaY) {
                            blockedByWall = true;
                            break;
                        }
                    }
                    if (blockedByWall) break;
                }
                
                if (!blockedByWall) {
                    lavaTiles.push({
                        x: lavaX,
                        y: lavaY,
                        spawnTime: performance.now()
                    });
                }
            }
        }
    });
}

// æ£€æŸ¥å²©æµ†ä¼¤å®³
// æ£€æŸ¥å²©æµ†ä¼¤å®³
function checkLavaDamage(timestamp) {
    for (const snakeId in snakes) {
        const head = snakes[snakeId][0];
        const headGridX = Math.floor(head.x / 20) * 20;
        const headGridY = Math.floor(head.y / 20) * 20;
        
        for (const lava of lavaTiles) {
            // ç²¾ç¡®ç½‘æ ¼å¯¹é½æ£€æŸ¥
            if (headGridX === lava.x && headGridY === lava.y) {
                // æ£€æŸ¥æ˜¯å¦ç§»åŠ¨åˆ°è¿™ä¸ªå²©æµ†æ ¼
                const lastMove = lastMoveTime[snakeId];
                const justMovedToLava = timestamp - lastMove < 200;
                
                // åªåœ¨åˆšåˆšç§»åŠ¨è¿‡æ¥æ—¶é€ æˆä¼¤å®³
                if (justMovedToLava) {
                    // æ£€æŸ¥è·ç¦»ä¸Šæ¬¡ä¼¤å®³æ˜¯å¦è¶…è¿‡1ç§’
                    const lastDamageTime = lava.lastDamageTime || 0;
                    if (timestamp - lastDamageTime > 1000) {
                        // ä½¿ç”¨ç»Ÿä¸€çš„ä¼¤å®³å‡½æ•°
                        applyDamage(snakeId, 2, 'lava', {
                            lavaTile: lava,
                            timestamp: timestamp
                        });
                        
                        // è®°å½•ä¼¤å®³æ—¶é—´
                        lava.lastDamageTime = timestamp;
                    }
                }
                
                // æ›´æ–°å²©æµ†æ¥è§¦æ—¶é—´
                if (!lava.lastContactTime || timestamp - lava.lastContactTime > 500) {
                    createParticles(head.x + 10, head.y + 10, 5, '#FF4500');
                    lava.lastContactTime = timestamp;
                }
                
                break;
            }
        }
    }
}

// ç»˜åˆ¶ç«å±±å’Œå²©æµ†
function drawVolcanoes() {
    // ç»˜åˆ¶ç«å±±
    volcanoes.forEach(volcano => {
        const volcanoElement = document.createElement('div');
        volcanoElement.className = 'volcano';
        if (volcano.warning) {
            volcanoElement.classList.add('warning-volcano');
        }
        volcanoElement.style.left = `${volcano.x}px`;
        volcanoElement.style.top = `${volcano.y}px`;
        gameBoard.appendChild(volcanoElement);
    });
    
    // ç»˜åˆ¶å²©æµ†
    lavaTiles.forEach(lava => {
        const lavaElement = document.createElement('div');
        lavaElement.className = 'lava';
        lavaElement.style.left = `${lava.x}px`;
        lavaElement.style.top = `${lava.y}px`;
        gameBoard.appendChild(lavaElement);
    });
}
// ä¿®æ”¹checkWallCollisionså‡½æ•°ä¸­çš„ä¼¤å®³å¤„ç†
function checkWallCollisions(timestamp) {
    for (const snakeId in snakes) {
        const head = snakes[snakeId][0];
        const headCenterX = head.x + 10;
        const headCenterY = head.y + 10;
        
        // éå†æ‰€æœ‰å¢™
        for (let w = walls.length - 1; w >= 0; w--) {
            const wall = walls[w];
            
            // éå†å¢™çš„æ‰€æœ‰æ®µ
            for (let s = wall.segments.length - 1; s >= 0; s--) {
                const segment = wall.segments[s];
                const wallCenterX = segment.x + 10;
                const wallCenterY = segment.y + 10;
                
                // è®¡ç®—è·ç¦»
                const distance = Math.sqrt(
                    Math.pow(headCenterX - wallCenterX, 2) + 
                    Math.pow(headCenterY - wallCenterY, 2)
                );
                
                // è·ç¦»å°äº20åƒç´ å°±ç®—ç¢°æ’
                if (distance < 20) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°ç¢°æ’
                    if (timestamp - lastWallHitTime[snakeId] > 1000) {
                        lastWallHitTime[snakeId] = timestamp;
                        
                        // ä½¿ç”¨ç»Ÿä¸€çš„ä¼¤å®³å‡½æ•°
                        applyDamage(snakeId, 5, 'wall', {
                            wallSegment: segment,
                            distance: distance
                        });
                        
                        // æ— è®ºæ˜¯å¦å…ç–«ï¼Œéƒ½èƒ½æ’çƒ‚å¢™
                        createParticles(head.x + 10, head.y + 10, 10, '#FF0000');
                        wall.segments.splice(s, 1);
                        
                        // å¦‚æœè¿™é¢å¢™çš„æ‰€æœ‰æ®µéƒ½è¢«æ’çƒ‚äº†ï¼Œç§»é™¤æ•´é¢å¢™
                        if (wall.segments.length === 0) {
                            walls.splice(w, 1);
                        }
                    }
                    break;
                }
            }
        }
    }
}

// ç»˜åˆ¶å¢™çš„å‡½æ•°ï¼ˆåœ¨drawSnakeså’ŒdrawFoodsä¹‹åè°ƒç”¨ï¼‰
function drawWalls() {
    walls.forEach(wall => {
        wall.segments.forEach(segment => {
            const wallElement = document.createElement('div');
            wallElement.className = 'wall-segment';
            wallElement.style.left = `${segment.x}px`;
            wallElement.style.top = `${segment.y}px`;
            wallElement.style.width = '20px';
            wallElement.style.height = '20px';
            wallElement.style.backgroundColor = '#555';
            wallElement.style.border = '1px solid #333';
            wallElement.style.position = 'absolute';
            wallElement.style.zIndex = '1';
            
            // æ·»åŠ é—ªçƒæ•ˆæœæç¤ºæ–°ç”Ÿæˆçš„å¢™
            const timeSinceSpawn = performance.now() - wall.spawnTime;
            if (timeSinceSpawn < 2000) {
                wallElement.style.animation = 'wallBlink 0.5s infinite';
            }
            
            gameBoard.appendChild(wallElement);
        });
    });
}

// åœ¨CSSä¸­æ·»åŠ å¢™çš„æ ·å¼
const wallStyle = document.createElement('style');
wallStyle.textContent = `
    @keyframes wallBlink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .wall-segment {
        background-color: #555;
        border: 1px solid #333;
        position: absolute;
        z-index: 1;
    }
`;
document.head.appendChild(wallStyle);
function updateMagicSnakeTimers(timestamp) {
    // æ£€æŸ¥ç©å®¶1æ˜¯å¦æ˜¯é­”æ³•è›‡
    if (snakeTypes.snake1 === 'magic' && timestamp - magicSnakeTimers.snake1 > 20000) {
        generateMagicBall('snake1');
        magicSnakeTimers.snake1 = timestamp;
    }
    
    // æ£€æŸ¥ç©å®¶2æ˜¯å¦æ˜¯é­”æ³•è›‡
    if (snakeTypes.snake2 === 'magic' && timestamp - magicSnakeTimers.snake2 > 20000) {
        generateMagicBall('snake2');
        magicSnakeTimers.snake2 = timestamp;
    }
}
function generateMagicBall(snakeId) {
    if (ballStorage[snakeId].length >= 5) {
        // å‚¨å­˜å·²æ»¡ï¼Œä¸ç”Ÿæˆæ–°çƒ
        return;
    }
    
    // æ ¹æ®æ¦‚ç‡åˆ†å¸ƒç”Ÿæˆçƒç±»å‹
    const randomValue = Math.random();
    let ballType;
    
    if (randomValue < 0.3) { // 30% æ”»å‡»çƒ
        ballType = 'attack';
    } else if (randomValue < 0.5) { // 20% è¡€çƒ
        ballType = 'health';
    } else if (randomValue < 0.6) { // 10% æ— æ•Œçƒ
        ballType = 'immunity';
    } else if (randomValue < 0.7) { // 10% åè½¬çƒ
        ballType = 'reverse';
    } else { // 30% ç‚¸å¼¹çƒ
        ballType = 'bomb';
    }
    
    // æ·»åŠ åˆ°å‚¨å­˜
    ballStorage[snakeId].push({ type: ballType });
    updateStorageDisplay();
    
    // æ˜¾ç¤ºæç¤º
    const head = snakes[snakeId][0];
    let message, color;
    switch(ballType) {
        case 'attack':
            message = 'è·å¾—æ”»å‡»çƒ!';
            color = '#00BFFF';
            break;
        case 'health':
            message = 'è·å¾—è¡€çƒ!';
            color = '#FF0000';
            break;
        case 'immunity':
            message = 'è·å¾—æ— æ•Œçƒ!';
            color = '#FFFF00';
            break;
        case 'reverse':
            message = 'è·å¾—åè½¬çƒ!';
            color = '#800080';
            break;
    }
    
    showNotice(message, color, head.x, head.y);
    createParticles(head.x + 10, head.y + 10, 15, color);
}
function drawBullets() {
    bullets.forEach(bullet => {
        const bulletElement = document.createElement('div');
        bulletElement.className = 'bullet';
        bulletElement.style.width = `${bullet.size}px`;
        bulletElement.style.height = `${bullet.size}px`;
        bulletElement.style.borderRadius = '50%';
        bulletElement.style.position = 'absolute';
        bulletElement.style.left = `${bullet.x}px`;
        bulletElement.style.top = `${bullet.y}px`;
        
        // æ ¹æ®å­å¼¹æ‰€å±ç©å®¶è®¾ç½®é¢œè‰²
        if (bullet.player === 'snake1') {
            // ç©å®¶1å­å¼¹ï¼šæ©™è‰²æ¸å˜
            bulletElement.style.background = 'linear-gradient(45deg, #FF5722, #FF9800)';
            bulletElement.style.boxShadow = '0 0 8px #FF5722, 0 0 12px rgba(255, 87, 34, 0.7)';
        } else if (bullet.player === 'snake2') {
            // ç©å®¶2å­å¼¹ï¼šè“è‰²æ¸å˜
            bulletElement.style.background = 'linear-gradient(45deg, #2196F3, #00BCD4)';
            bulletElement.style.boxShadow = '0 0 8px #2196F3, 0 0 12px rgba(33, 150, 243, 0.7)';
        } else if (bullet.player === 'base_player1') {
            // ç©å®¶1åŸºåœ°å­å¼¹ï¼šæ·±æ©™è‰²ï¼Œæ›´æ˜æ˜¾
            bulletElement.style.background = 'radial-gradient(circle, #FF5722, #FF3300)';
            bulletElement.style.boxShadow = '0 0 10px #FF3300, 0 0 15px rgba(255, 51, 0, 0.8)';
            // æ·»åŠ æ—‹è½¬åŠ¨ç”»
            bulletElement.style.animation = 'bulletSpin 1s linear infinite';
        } else if (bullet.player === 'base_player2') {
            // ç©å®¶2åŸºåœ°å­å¼¹ï¼šæ·±è“è‰²ï¼Œæ›´æ˜æ˜¾
            bulletElement.style.background = 'radial-gradient(circle, #2196F3, #0066FF)';
            bulletElement.style.boxShadow = '0 0 10px #0066FF, 0 0 15px rgba(0, 102, 255, 0.8)';
            bulletElement.style.animation = 'bulletSpin 1s linear infinite';
        }
        
        // æ·»åŠ æ‹–å°¾æ•ˆæœ
        const tail = document.createElement('div');
        tail.className = 'bullet-tail';
        tail.style.position = 'absolute';
        tail.style.left = '50%';
        tail.style.top = '50%';
        tail.style.width = `${bullet.size * 3}px`;
        tail.style.height = '2px';
        tail.style.background = 'inherit';
        tail.style.transform = 'translate(-50%, -50%) rotate(180deg)';
        tail.style.opacity = '0.6';
        tail.style.filter = 'blur(1px)';
        bulletElement.appendChild(tail);
        
        gameBoard.appendChild(bulletElement);
    });
}
function checkBulletHitHome(bullet) {
    // æ ¹æ®å­å¼¹æ‰€å±ç©å®¶ç¡®å®šç›®æ ‡åŸºåœ°
    const targetHome = bullet.player === 'snake1' ? homes.player2 : homes.player1;
    
    // å¦‚æœç›®æ ‡åŸºåœ°å·²è¢«æ‘§æ¯ï¼Œè·³è¿‡æ£€æŸ¥
    if (targetHome.destroyed) return false;
    
    // æ£€æŸ¥å­å¼¹æ˜¯å¦åœ¨åŸºåœ°çš„èŒƒå›´å†…
    if (bullet.x >= targetHome.x && 
        bullet.x <= targetHome.x + targetHome.width &&
        bullet.y >= targetHome.y && 
        bullet.y <= targetHome.y + targetHome.height) {
        
        // å­å¼¹å¯¹åŸºåœ°é€ æˆä¼¤å®³
        targetHome.health = Math.max(0, targetHome.health - 2); // å­å¼¹é€ æˆ0.5ç‚¹ä¼¤å®³
        
        // æ˜¾ç¤ºä¼¤å®³æ•ˆæœ
        showNotice('-2HP', bullet.player === 'snake1' ? '#FF5722' : '#2196F3', 
                 targetHome.x + targetHome.width/2, targetHome.y + targetHome.height/2);
        
        // åˆ›å»ºå‡»ä¸­æ•ˆæœ
        createParticles(bullet.x, bullet.y, 15, bullet.player === 'snake1' ? '#FF5722' : '#2196F3');
        
        // æ£€æŸ¥åŸºåœ°æ˜¯å¦è¢«æ‘§æ¯
        if (targetHome.health <= 0) {
            targetHome.destroyed = true;
            const playerName = bullet.player === 'snake1' ? 
                (localStorage.getItem('player2_username') || 'ç©å®¶2') : 
                (localStorage.getItem('username') || 'ç©å®¶1');
            
            showNotice(`${playerName}çš„åŸºåœ°è¢«æ‘§æ¯äº†!`, '#FF0000', 
                     targetHome.x + targetHome.width/2, targetHome.y + targetHome.height/2);
            
            // åŸºåœ°è¢«æ‘§æ¯çš„å¤§çˆ†ç‚¸æ•ˆæœ
            createParticles(
                targetHome.x + targetHome.width/2,
                targetHome.y + targetHome.height/2,
                40,
                bullet.player === 'snake1' ? '#2196F3' : '#FF5722'
            );
        }
        
        return true; // å­å¼¹å·²å‡»ä¸­ç›®æ ‡
    }
    
    return false; // å­å¼¹æœªå‡»ä¸­
}

// æ›´æ–°çŠ¶æ€æ•ˆæœ
function updateStatusEffects(timestamp) {
    // æ›´æ–°å…ç–«çŠ¶æ€
    if (immunity.timer1 > 0 && timestamp > immunity.timer1) {
        immunity.snake1 = false;
        immunity.timer1 = 0;
        document.getElementById('player1-effect').textContent = '';
    }
    
    if (immunity.timer2 > 0 && timestamp > immunity.timer2) {
        immunity.snake2 = false;
        immunity.timer2 = 0;
        document.getElementById('player2-effect').textContent = '';
    }
    
    // æ›´æ–°åå‘æ§åˆ¶çŠ¶æ€
    if (reversedControls.timer1 > 0 && timestamp > reversedControls.timer1) {
        reversedControls.snake1 = false;
        reversedControls.timer1 = 0;
        document.getElementById('player1-effect').textContent = '';
    }
    
    if (reversedControls.timer2 > 0 && timestamp > reversedControls.timer2) {
        reversedControls.snake2 = false;
        reversedControls.timer2 = 0;
        document.getElementById('player2-effect').textContent = '';
    }
    
    // æ›´æ–°æ”»å‡»æ¨¡å¼çŠ¶æ€
    if (attackMode.timer1 > 0 && timestamp > attackMode.timer1) {
        attackMode.snake1 = false;
        attackMode.timer1 = 0;
        if (attackMode.intervalId1) clearInterval(attackMode.intervalId1);
        document.getElementById('player1-effect').textContent = '';
    }

    if (attackMode.timer2 > 0 && timestamp > attackMode.timer2) {
        attackMode.snake2 = false;
        attackMode.timer2 = 0;
        if (attackMode.intervalId2) clearInterval(attackMode.intervalId2);
        document.getElementById('player2-effect').textContent = '';
}
    
    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    updateStatusDisplay();
}
function fireBullet(snakeId) {
    if ((snakeId === 'snake1' && !attackMode.snake1) || 
        (snakeId === 'snake2' && !attackMode.snake2)) {
        return;
    }
    
    const currentTime = performance.now();
    const lastShot = snakeId === 'snake1' ? attackMode.lastShot1 : attackMode.lastShot2;
    
    // æ›´æ–°æœ€åå‘å°„æ—¶é—´
    if (snakeId === 'snake1') {
        attackMode.lastShot1 = currentTime;
    } else {
        attackMode.lastShot2 = currentTime;
    }
    
    const head = snakes[snakeId][0];
    const direction = directions[snakeId];
    
    // åˆ›å»ºå­å¼¹
    const bullet = {
        x: head.x + 10, // ä»è›‡å¤´ä¸­å¿ƒå‘å°„
        y: head.y + 10,
        direction: direction,
        player: snakeId, // ç¡®ä¿æ­£ç¡®æ ‡è¯†ç©å®¶
        speed: 30,
        size: 8
    };
    
    bullets.push(bullet);
    
    // æ’­æ”¾å‘å°„éŸ³æ•ˆæˆ–åŠ¨ç”»
    const particleColor = snakeId === 'snake1' ? '#FF5722' : '#2196F3';
    createParticles(head.x + 10, head.y + 10, 10, particleColor);
}
// æ–°å¢/ä¿®æ”¹å‡½æ•°ï¼šæ£€æŸ¥è›‡å­å¼¹æ˜¯å¦å‡»ä¸­
function checkSnakeBulletHit(bullet, targetSnakeId, bulletIndex) {
    const targetSnake = snakes[targetSnakeId];
    
    for (let j = 0; j < targetSnake.length; j++) {
        const segment = targetSnake[j];
        const distance = Math.sqrt(
            Math.pow(bullet.x - segment.x - 10, 2) + 
            Math.pow(bullet.y - segment.y - 10, 2)
        );
        
        if (distance < (20 + bullet.size) / 2) {
            // å‡»ä¸­ç›®æ ‡
            bullets.splice(bulletIndex, 1);
            
            // ä½¿ç”¨ç»Ÿä¸€çš„ä¼¤å®³å‡½æ•°
            const damageApplied = applyDamage(targetSnakeId, 0.5, 'bullet', {
                attacker: bullet.player,
                bulletSize: bullet.size,
                hitSegment: j
            });
            
            // å¦‚æœæ²¡æœ‰åº”ç”¨ä¼¤å®³ï¼ˆå…ç–«æˆ–åšç¡¬å…ç–«ï¼‰ï¼Œå·²ç»æ˜¾ç¤ºè¿‡æç¤º
            if (!damageApplied) {
                break;
            }
            
            break;
        }
    }
}


// ä¿®æ”¹åçš„moveBulletså‡½æ•°
function moveBullets(timestamp) {
    for (let i = bullets.length - 1; i >= 0; i--) {
        const bullet = bullets[i];
        
        // æ ¹æ®å­å¼¹ç±»å‹ç§»åŠ¨
        if (bullet.player.startsWith('base_')) {
            // åŸºåœ°å­å¼¹ï¼šæŒ‰è§’åº¦ç§»åŠ¨
            bullet.x += Math.cos(bullet.angle) * bullet.speed;
            bullet.y += Math.sin(bullet.angle) * bullet.speed;
        } else {
            // è›‡å­å¼¹ï¼šæŒ‰æ–¹å‘ç§»åŠ¨
            switch (bullet.direction) {
                case 'up':
                    bullet.y -= bullet.speed;
                    break;
                case 'down':
                    bullet.y += bullet.speed;
                    break;
                case 'left':
                    bullet.x -= bullet.speed;
                    break;
                case 'right':
                    bullet.x += bullet.speed;
                    break;
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦è¶…å‡ºè¾¹ç•Œ
        const boardWidth = gameBoard.clientWidth;
        const boardHeight = gameBoard.clientHeight;
        
        if (bullet.x < 0 || bullet.x >= boardWidth || 
            bullet.y < 0 || bullet.y >= boardHeight) {
            bullets.splice(i, 1);
            continue;
        }
        
        // æ£€æŸ¥æ˜¯å¦å‡»ä¸­å¢™
        let hitWall = false;
        for (const wall of walls) {
            for (const segment of wall.segments) {
                const distance = Math.sqrt(
                    Math.pow(bullet.x - segment.x - 10, 2) + 
                    Math.pow(bullet.y - segment.y - 10, 2)
                );
                
                if (distance < 15) {
                    hitWall = true;
                    createParticles(bullet.x, bullet.y, 5, '#FFFFFF');
                    break;
                }
            }
            if (hitWall) break;
        }
        
        if (hitWall) {
            bullets.splice(i, 1);
            continue;
        }
        
        // æ£€æŸ¥æ˜¯å¦å‡»ä¸­è›‡
        if (bullet.player.startsWith('base_')) {
            // åŸºåœ°å­å¼¹æ£€æŸ¥
            const targetSnakeId = bullet.player === 'base_player1' ? 'snake2' : 'snake1';
            checkBaseBulletHit(bullet, targetSnakeId, i);
        } else {
            // è›‡å­å¼¹æ£€æŸ¥
            const targetSnakeId = bullet.player === 'snake1' ? 'snake2' : 'snake1';
            checkSnakeBulletHit(bullet, targetSnakeId, i);
        }
        
        // æ£€æŸ¥æ˜¯å¦å‡»ä¸­åŸºåœ°
        if (!bullet.player.startsWith('base_')) { // åªæœ‰è›‡å­å¼¹å¯ä»¥ä¼¤å®³åŸºåœ°
            checkBulletHitHome(bullet, i);
        }
    }
}

// æ–°å¢å‡½æ•°ï¼šæ£€æŸ¥å­å¼¹æ˜¯å¦å‡»ä¸­åŸºåœ°ï¼ˆä»åŸcheckBulletHitHomeåˆ†ç¦»ï¼‰
function checkBulletHitHome(bullet, bulletIndex) {
    // æ ¹æ®å­å¼¹æ‰€å±ç©å®¶ç¡®å®šç›®æ ‡åŸºåœ°
    const targetHome = bullet.player === 'snake1' ? homes.player2 : homes.player1;
    
    // å¦‚æœç›®æ ‡åŸºåœ°å·²è¢«æ‘§æ¯ï¼Œè·³è¿‡æ£€æŸ¥
    if (targetHome.destroyed) return false;
    
    // æ£€æŸ¥å­å¼¹æ˜¯å¦åœ¨åŸºåœ°çš„èŒƒå›´å†…
    if (bullet.x >= targetHome.x && 
        bullet.x <= targetHome.x + targetHome.width &&
        bullet.y >= targetHome.y && 
        bullet.y <= targetHome.y + targetHome.height) {
        
        // æ£€æŸ¥ç›®æ ‡åŸºåœ°æ‰€å±ç©å®¶æ˜¯å¦æœ‰å…ç–«æ•ˆæœ
        const targetSnakeId = bullet.player === 'snake1' ? 'snake2' : 'snake1';
        const hasImmunity = (targetSnakeId === 'snake1' && immunity.snake1) || 
                           (targetSnakeId === 'snake2' && immunity.snake2);
        
        if (!hasImmunity) {
            // æ²¡æœ‰å…ç–«æ•ˆæœï¼šå­å¼¹å¯¹åŸºåœ°é€ æˆä¼¤å®³
            targetHome.health = Math.max(0, targetHome.health - 1);
            
            // æ˜¾ç¤ºä¼¤å®³æ•ˆæœ
            showNotice('-1HP', bullet.player === 'snake1' ? '#FF5722' : '#2196F3', 
                     targetHome.x + targetHome.width/2, targetHome.y + targetHome.height/2);
            
            // åˆ›å»ºå‡»ä¸­æ•ˆæœ
            createParticles(bullet.x, bullet.y, 15, bullet.player === 'snake1' ? '#FF5722' : '#2196F3');
            
            // ç§»é™¤å­å¼¹
            bullets.splice(bulletIndex, 1);
            
        } else {
            // æœ‰å…ç–«æ•ˆæœï¼šæ˜¾ç¤ºå…ç–«æç¤º
            showNotice('å…ç–«å­å¼¹ä¼¤å®³!', '#FFFF00', 
                     targetHome.x + targetHome.width/2, targetHome.y + targetHome.height/2);
            
            // åˆ›å»ºå…ç–«æ•ˆæœ
            createParticles(bullet.x, bullet.y, 15, '#FFFF00');
        }
        
        // æ£€æŸ¥åŸºåœ°æ˜¯å¦è¢«æ‘§æ¯ï¼ˆæ— è®ºæ˜¯å¦æœ‰å…ç–«ï¼‰
        if (targetHome.health <= 0) {
            targetHome.destroyed = true;
            const playerName = bullet.player === 'snake1' ? 
                (localStorage.getItem('player2_username') || 'ç©å®¶2') : 
                (localStorage.getItem('username') || 'ç©å®¶1');
            
            showNotice(`${playerName}çš„åŸºåœ°è¢«æ‘§æ¯äº†!`, '#FF0000', 
                     targetHome.x + targetHome.width/2, targetHome.y + targetHome.height/2);
            
            // åŸºåœ°è¢«æ‘§æ¯çš„å¤§çˆ†ç‚¸æ•ˆæœ
            createParticles(
                targetHome.x + targetHome.width/2,
                targetHome.y + targetHome.height/2,
                40,
                bullet.player === 'snake1' ? '#2196F3' : '#FF5722'
            );
        }
        
        return true; // å­å¼¹å·²å‡»ä¸­ç›®æ ‡
    }
    
    return false; // å­å¼¹æœªå‡»ä¸­
}
function checkBaseBulletHit(bullet, targetSnakeId, bulletIndex) {
    const targetSnake = snakes[targetSnakeId];
    
    for (let j = 0; j < targetSnake.length; j++) {
        const segment = targetSnake[j];
        const distance = Math.sqrt(
            Math.pow(bullet.x - segment.x - 10, 2) + 
            Math.pow(bullet.y - segment.y - 10, 2)
        );
        
        if (distance < (20 + bullet.size) / 2) {
            // å‡»ä¸­ç›®æ ‡
            bullets.splice(bulletIndex, 1);
            
            // ä½¿ç”¨ç»Ÿä¸€çš„ä¼¤å®³å‡½æ•°
            const damageApplied = applyDamage(targetSnakeId, bullet.damage, 'base', {
                attacker: bullet.player,
                fromBase: true,
                bulletSize: bullet.size,
                hitSegment: j
            });
            
            if (!damageApplied) {
                break;
            }
            
            break;
        }
    }
}
// æ›´æ–°çŠ¶æ€æ˜¾ç¤º
function updateStatusDisplay() {
    const effect1 = document.getElementById('player1-effect');
    const effect2 = document.getElementById('player2-effect');
    
    effect1.textContent = '';
    effect2.textContent = '';
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯é­”æ³•è›‡
    const isMagicSnake1 = snakeTypes.snake1 === 'magic';
    const isMagicSnake2 = snakeTypes.snake2 === 'magic';
    
    if (immunity.snake1) {
        effect1.textContent += 'å…ç–«' + (isMagicSnake1 ? ' (é­”æ³•)' : '') + ' ';
    }
    if (reversedControls.snake1) {
        effect1.textContent += 'åå‘æ§åˆ¶' + (isMagicSnake1 ? ' (é­”æ³•)' : '') + ' ';
    }
    if (attackMode.snake1) {
        effect1.textContent += 'æ”»å‡»æ¨¡å¼' + (isMagicSnake1 ? ' (é­”æ³•)' : '') + ' ';
    }
    
    if (immunity.snake2) {
        effect2.textContent += 'å…ç–«' + (isMagicSnake2 ? ' (é­”æ³•)' : '') + ' ';
    }
    if (reversedControls.snake2) {
        effect2.textContent += 'åå‘æ§åˆ¶' + (isMagicSnake2 ? ' (é­”æ³•)' : '') + ' ';
    }
    if (attackMode.snake2) {
        effect2.textContent += 'æ”»å‡»æ¨¡å¼' + (isMagicSnake2 ? ' (é­”æ³•)' : '') + ' ';
    }
        // æ£€æŸ¥æ˜¯å¦æ˜¯åšç¡¬è›‡
    const isToughSnake1 = snakeTypes.snake1 === 'tough';
    const isToughSnake2 = snakeTypes.snake2 === 'tough';
    
    // æ˜¾ç¤ºåšç¡¬è›‡çŠ¶æ€
    if (isToughSnake1) {
        effect1.textContent += 'åšç¡¬(ä¼¤å®³å‡åŠ) ';
    }
    if (isToughSnake2) {
        effect2.textContent += 'åšç¡¬(ä¼¤å®³å‡åŠ) ';
    }
}

// ç§»åŠ¨è›‡
function moveSnake(snakeId) {
    const snake = snakes[snakeId];
    const direction = directions[snakeId];
    
    // ç§»åŠ¨è›‡
    const head = { ...snake[0] };
    
    switch (direction) {
        case 'up':
            head.y -= 20;
            break;
        case 'down':
            head.y += 20;
            break;
        case 'left':
            head.x -= 20;
            break;
        case 'right':
            head.x += 20;
            break;
    }
    gameStats[snakeId].distanceTraveled += 1;
    // ç©¿å¢™é€»è¾‘
    const boardWidth = gameBoard.clientWidth;
    const boardHeight = gameBoard.clientHeight;
    
    if (head.x < 0) head.x = boardWidth - 20;
    if (head.x >= boardWidth) head.x = 0;
    if (head.y < 0) head.y = boardHeight - 20;
    if (head.y >= boardHeight) head.y = 0;
    
    const otherSnakeId = snakeId === 'snake1' ? 'snake2' : 'snake1';
    const collisionResult = checkOtherSnakeCollision(otherSnakeId, head);
    
    // æ£€æŸ¥å½“å‰è›‡æ˜¯å¦æœ‰å…ç–«æ•ˆæœ
    const isImmune = (snakeId === 'snake1' && immunity.snake1) || 
                     (snakeId === 'snake2' && immunity.snake2);
    
    // æ£€æŸ¥å¯¹æ–¹è›‡æ˜¯å¦æœ‰å…ç–«æ•ˆæœ
    const isOtherImmune = (otherSnakeId === 'snake1' && immunity.snake1) || 
                         (otherSnakeId === 'snake2' && immunity.snake2);
    
    // åœ¨ moveSnake å‡½æ•°ä¸­ä¿®æ”¹ç¢°æ’å¤„ç†éƒ¨åˆ†
    if (collisionResult.collided) {
        if (collisionResult.isHeadCollision) {
            // è›‡å¤´ç›¸æ’å¤„ç†
            if (!isImmune && !isOtherImmune) {
                // åŒæ–¹éƒ½æ²¡æœ‰å…ç–«ï¼Œéƒ½æ‰£è¡€
                // å¦‚æœæ˜¯åšç¡¬è›‡ï¼Œé€ æˆåŒå€ä¼¤å®³
                const damage1 = snakeTypes.snake1 === 'tough' ? 5 : 1;
                const damage2 = snakeTypes.snake2 === 'tough' ? 5 : 1;
                
                // ä½¿ç”¨ç»Ÿä¸€çš„ä¼¤å®³å‡½æ•° - ç©å®¶1å—åˆ°ç©å®¶2çš„ä¼¤å®³
                applyDamage('snake1', damage2, 'snakeCollision', {
                    attacker: 'snake2',
                    isHeadCollision: true,
                    collisionPoint: head
                });
                
                // ä½¿ç”¨ç»Ÿä¸€çš„ä¼¤å®³å‡½æ•° - ç©å®¶2å—åˆ°ç©å®¶1çš„ä¼¤å®³
                applyDamage('snake2', damage1, 'snakeCollision', {
                    attacker: 'snake1',
                    isHeadCollision: true,
                    collisionPoint: snakes[otherSnakeId][0]
                });
                
                // åŒæ–¹ç¢°æ’ç‰¹æ•ˆ
                createParticles(head.x + 10, head.y + 10, 30, '#FF0000');
                createParticles(snakes[otherSnakeId][0].x + 10, snakes[otherSnakeId][0].y + 10, 30, '#FF0000');
                
            } else if (isImmune && !isOtherImmune) {
                // åªæœ‰å½“å‰è›‡æœ‰å…ç–«ï¼Œåªæ‰£å¯¹æ–¹è¡€
                const damage = snakeTypes[otherSnakeId] === 'tough' ? 2 : 1;
                
                // ä½¿ç”¨ç»Ÿä¸€çš„ä¼¤å®³å‡½æ•° - å¯¹æ–¹å—åˆ°ä¼¤å®³
                const damageApplied = applyDamage(otherSnakeId, damage, 'snakeCollision', {
                    attacker: snakeId,
                    isHeadCollision: true,
                    collisionPoint: head,
                    immuneAttacker: true
                });
                
                if (damageApplied) {
                    // æ˜¾ç¤ºå…ç–«æç¤º
                    showNotice('å…ç–«!', '#FFFF00', head.x, head.y);
                    
                    // ç‰¹æ•ˆ
                    createParticles(head.x + 10, head.y + 10, 15, '#FFFF00');
                    createParticles(snakes[otherSnakeId][0].x + 10, snakes[otherSnakeId][0].y + 10, 30, '#FF0000');
                }
                
            } else if (!isImmune && isOtherImmune) {
                // åªæœ‰å¯¹æ–¹è›‡æœ‰å…ç–«ï¼Œåªæ‰£å½“å‰è›‡è¡€
                const damage = snakeTypes[snakeId] === 'tough' ? 2 : 1;
                
                // ä½¿ç”¨ç»Ÿä¸€çš„ä¼¤å®³å‡½æ•° - å½“å‰è›‡å—åˆ°ä¼¤å®³
                const damageApplied = applyDamage(snakeId, damage, 'snakeCollision', {
                    attacker: otherSnakeId,
                    isHeadCollision: true,
                    collisionPoint: snakes[otherSnakeId][0],
                    immuneTarget: true
                });
                
                if (damageApplied) {
                    // æ˜¾ç¤ºå…ç–«æç¤º
                    showNotice('å…ç–«!', '#FFFF00', snakes[otherSnakeId][0].x, snakes[otherSnakeId][0].y);
                    
                    // ç‰¹æ•ˆ
                    createParticles(head.x + 10, head.y + 10, 30, '#FF0000');
                    createParticles(snakes[otherSnakeId][0].x + 10, snakes[otherSnakeId][0].y + 10, 15, '#FFFF00');
                }
                
            } else {
                // åŒæ–¹éƒ½æœ‰å…ç–«ï¼Œéƒ½ä¸æ‰£è¡€
                showNotice('å…ç–«!', '#FFFF00', head.x, head.y);
                showNotice('å…ç–«!', '#FFFF00', snakes[otherSnakeId][0].x, snakes[otherSnakeId][0].y);
                
                // ç‰¹æ•ˆ
                createParticles(head.x + 10, head.y + 10, 15, '#FFFF00');
                createParticles(snakes[otherSnakeId][0].x + 10, snakes[otherSnakeId][0].y + 10, 15, '#FFFF00');
            }
        } else if (!isImmune) {
            // æ™®é€šç¢°æ’ï¼šæ’çš„è›‡æ‰£è¡€ï¼Œè¢«æ’çš„è›‡æˆªæ–­
            // å¦‚æœæ˜¯åšç¡¬è›‡ï¼Œé€ æˆåŒå€ä¼¤å®³
            const damage = snakeTypes[snakeId] === 'tough' ? 2 : 1;
            
            // ä½¿ç”¨ç»Ÿä¸€çš„ä¼¤å®³å‡½æ•°
            const damageApplied = applyDamage(snakeId, damage, 'snakeCollision', {
                attacker: otherSnakeId,
                isHeadCollision: false,
                collisionIndex: collisionResult.collisionIndex
            });
            
            if (damageApplied) {
                // è¢«æ’çš„è›‡ä»ç¢°æ’ç‚¹å¼€å§‹æˆªæ–­
                snakes[otherSnakeId] = snakes[otherSnakeId].slice(0, collisionResult.collisionIndex);
                
                // ç¢°æ’ç‰¹æ•ˆ
                createParticles(head.x + 10, head.y + 10, 20, snakeId === 'snake1' ? '#FF5722' : '#2196F3');
            }
            
        } else {
            // å¦‚æœæœ‰å…ç–«æ•ˆæœï¼Œæ˜¾ç¤ºå…ç–«æç¤ºï¼Œä¸æ‰£è¡€
            showNotice('å…ç–«!', '#FFFF00', head.x, head.y);
            createParticles(head.x + 10, head.y + 10, 15, '#FFFF00');
        }
    }
    
    // æ£€æŸ¥æ˜¯å¦åƒåˆ°é£Ÿç‰©ï¼ˆä½¿ç”¨è·ç¦»åˆ¤æ–­ï¼‰
    let ateFood = false;
    for (let i = 0; i < foods.length; i++) {
        const food = foods[i];
        const distance = Math.sqrt(Math.pow(head.x - food.x, 2) + Math.pow(head.y - food.y, 2));
        if (distance < 20) {
            // æ’­æ”¾åƒé£Ÿç‰©åŠ¨ç”»
            createParticles(food.x + 10, food.y + 10, 20, food.type === 'special' ? '#FFD700' : '#4CAF50');
            
            // ç§»é™¤è¢«åƒçš„é£Ÿç‰©
            foods.splice(i, 1);
            
            if (food.type === 'special') {
                // ç‰¹æ®Šé£Ÿç‰©ï¼šåŠ 100åˆ†å¹¶å‚¨å­˜
                scores[snakeId] += 100;
                updateScoreDisplay();
                
                // ç‰¹æ®Šé£Ÿç‰©å‚¨å­˜ä¸ºéšæœºç‰¹æ®Šçƒ
                const specialTypes = ['immunity', 'health', 'reverse'];
                const randomType = specialTypes[Math.floor(Math.random() * specialTypes.length)];
                
                if (ballStorage[snakeId].length < 5) {
                    ballStorage[snakeId].push({type: randomType});
                    showNotice('+100åˆ†! å·²å‚¨å­˜!', '#FFD700', head.x, head.y);
                } else {
                    showNotice('+100åˆ†! å‚¨å­˜å·²æ»¡!', '#FF0000', head.x, head.y);
                }
            } else {
                // æ™®é€šé£Ÿç‰©ï¼šåŠ 10åˆ†ï¼Œè›‡èº«å¢é•¿ï¼Œé€Ÿåº¦å¢åŠ 3%ï¼ˆæœ€å¤š15%ï¼‰
                scores[snakeId] += 50;
                updateScoreDisplay();
                
                // å¢åŠ é€Ÿåº¦ï¼ˆæœ€å¤š15%ï¼‰
                if (speedBoosts[snakeId] < 0.3) {
                    speedBoosts[snakeId] = Math.min(0.30, speedBoosts[snakeId] + 0.03);
                    showNotice('+50åˆ†! é€Ÿåº¦+3%', '#4CAF50', head.x, head.y);
                } else {
                    showNotice('+50åˆ†! é€Ÿåº¦å·²è¾¾ä¸Šé™', '#4CAF50', head.x, head.y);
                }
                
                ateFood = true; // è›‡èº«å¢é•¿
            }
            
            // æ›´æ–°å‚¨å­˜æ˜¾ç¤º
            updateStorageDisplay();
            
            // ç”Ÿæˆæ–°é£Ÿç‰©
            generateFood();
            
            break;
        }
    }
    
    // æ£€æŸ¥æ˜¯å¦åƒåˆ°ç‰¹æ®Šç‰©å“
    let ateSpecialItem = false;
    for (let i = 0; i < specialItems.length; i++) {
        const item = specialItems[i];
        const distance = Math.sqrt(Math.pow(head.x - item.x, 2) + Math.pow(head.y - item.y, 2));
        if (distance < 20) {
            // æ’­æ”¾åƒç‰¹æ®Šç‰©å“åŠ¨ç”»
            createParticles(item.x + 10, item.y + 10, 30, 
                item.type === 'immunity' ? '#FFFF00' : 
                item.type === 'health' ? '#FF0000' : '#800080');
            
            // åº”ç”¨ç‰¹æ®Šç‰©å“æ•ˆæœ
            applySpecialItemEffect(snakeId, item.type);
            
            // ç§»é™¤è¢«åƒçš„ç‰¹æ®Šç‰©å“
            specialItems.splice(i, 1);
            
            ateSpecialItem = true;
            break;
        }
    }
    
    // å°†æ–°å¤´éƒ¨æ·»åŠ åˆ°è›‡èº«
    snake.unshift(head);
    
    // å¦‚æœæ²¡æœ‰åƒåˆ°é£Ÿç‰©æˆ–ç‰¹æ®Šç‰©å“ï¼Œç§»é™¤å°¾éƒ¨
    if (!ateFood && !ateSpecialItem) {
        snake.pop();
    }
}
// æ·»åŠ CSSæ ·å¼
const bombStyle = document.createElement('style');
bombStyle.textContent = `
    /* ç‚¸å¼¹çˆ†ç‚¸æ•ˆæœ */
    .bomb-wave {
        animation: bombWave 1s forwards;
    }
    
    @keyframes bombWave {
        0% { 
            transform: translate(-50%, -50%) scale(0);
            opacity: 1;
        }
        100% { 
            transform: translate(-50%, -50%) scale(10);
            opacity: 0;
        }
    }
    
    /* ç‚¸å¼¹çƒé¢œè‰²æç¤º */
    .ball-slot.filled[style*="FF4500"] {
        position: relative;
    }
    
    .ball-slot.filled[style*="FF4500"]::before {
        content: "ğŸ’£";
        font-size: 14px;
    }
`;
document.head.appendChild(bombStyle);
// åº”ç”¨ç‰¹æ®Šç‰©å“æ•ˆæœ
function applySpecialItemEffect(snakeId, itemType) {
    const currentTime = performance.now();
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯é­”æ³•è›‡ï¼Œå¦‚æœæ˜¯åˆ™å»¶é•¿æ•ˆæœæ—¶é—´50%
    const isMagicSnake = snakeId === 'snake1' ? snakeTypes.snake1 === 'magic' : snakeTypes.snake2 === 'magic';
    const timeMultiplier = isMagicSnake ? 1.5 : 1; // é­”æ³•è›‡æ•ˆæœæ—¶é—´å»¶é•¿50%
    
    switch(itemType) {
        case 'immunity':
            const immunityDuration = 10000 * timeMultiplier;
            if (snakeId === 'snake1') {
                immunity.snake1 = true;
                immunity.timer1 = currentTime + immunityDuration;
                document.getElementById('player1-effect').textContent = 'å…ç–«' + (isMagicSnake || magicUpgradeLevel > 0 ? ' (å»¶é•¿)' : '');
                showNotice('å®Œå…¨å…ç–«æ¿€æ´»!' + (isMagicSnake || magicUpgradeLevel > 0 ? ' (æ•ˆæœå»¶é•¿)' : ''), '#FFFF00', snakes.snake1[0].x, snakes.snake1[0].y);
            } else {
                immunity.snake2 = true;
                immunity.timer2 = currentTime + immunityDuration;
                document.getElementById('player2-effect').textContent = 'å…ç–«' + (isMagicSnake || magicUpgradeLevel > 0 ? ' (å»¶é•¿)' : '');
                showNotice('å®Œå…¨å…ç–«æ¿€æ´»!' + (isMagicSnake || magicUpgradeLevel > 0 ? ' (æ•ˆæœå»¶é•¿)' : ''), '#FFFF00', snakes.snake2[0].x, snakes.snake2[0].y);
            }
            break;
            
        case 'health':
            // åŠ è¡€æ•ˆæœï¼šå¢åŠ 5ç‚¹ç”Ÿå‘½å€¼
            applyHealing(snakeId, 5, 'special_item');
            break;
            
        case 'reverse':
            // åå‘æ§åˆ¶æ•ˆæœï¼šå¯¹æ‰‹æ§åˆ¶åå‘ï¼Œé­”æ³•è›‡ä¸º22.5ç§’
            const reverseDuration = 8000 * timeMultiplier;
            const opponentId = snakeId === 'snake1' ? 'snake2' : 'snake1';
            if (opponentId === 'snake1') {
                reversedControls.snake1 = true;
                reversedControls.timer1 = currentTime + reverseDuration;
                document.getElementById('player1-effect').textContent = 'åå‘æ§åˆ¶' + (isMagicSnake ? ' (é­”æ³•)' : '');
                showNotice('æ§åˆ¶åå‘!' + (isMagicSnake ? ' (é­”æ³•å»¶é•¿)' : ''), '#800080', snakes.snake1[0].x, snakes.snake1[0].y);
            } else {
                reversedControls.snake2 = true;
                reversedControls.timer2 = currentTime + reverseDuration;
                document.getElementById('player2-effect').textContent = 'åå‘æ§åˆ¶' + (isMagicSnake ? ' (é­”æ³•)' : '');
                showNotice('æ§åˆ¶åå‘!' + (isMagicSnake ? ' (é­”æ³•å»¶é•¿)' : ''), '#800080', snakes.snake2[0].x, snakes.snake2[0].y);
            }
            break;
            
        case 'attack':
            // æ”»å‡»çƒï¼šå­˜å‚¨èµ·æ¥ï¼Œè€Œä¸æ˜¯ç«‹å³ä½¿ç”¨
            if (ballStorage[snakeId].length < 5) {
                ballStorage[snakeId].push({type: 'attack'});
                updateStorageDisplay();
                showNotice('æ”»å‡»çƒå·²å‚¨å­˜!', '#00BFFF', 
                    snakeId === 'snake1' ? snakes.snake1[0].x : snakes.snake2[0].x, 
                    snakeId === 'snake1' ? snakes.snake1[0].y : snakes.snake2[0].y);
            } else {
                showNotice('å‚¨å­˜å·²æ»¡!', '#FF0000', 
                    snakeId === 'snake1' ? snakes.snake1[0].x : snakes.snake2[0].x, 
                    snakeId === 'snake1' ? snakes.snake1[0].y : snakes.snake2[0].y);
            }
            break;
            case 'bomb':
            // ç‚¸å¼¹çƒï¼šå­˜å‚¨èµ·æ¥ï¼Œè€Œä¸æ˜¯ç«‹å³ä½¿ç”¨
            if (ballStorage[snakeId].length < 5) {
                ballStorage[snakeId].push({type: 'bomb'});
                updateStorageDisplay();
                showNotice('ç‚¸å¼¹çƒå·²å‚¨å­˜!', '#FF4500', 
                    snakeId === 'snake1' ? snakes.snake1[0].x : snakes.snake2[0].x, 
                    snakeId === 'snake1' ? snakes.snake1[0].y : snakes.snake2[0].y);
            } else {
                showNotice('å‚¨å­˜å·²æ»¡!', '#FF0000', 
                    snakeId === 'snake1' ? snakes.snake1[0].x : snakes.snake2[0].x, 
                    snakeId === 'snake1' ? snakes.snake1[0].y : snakes.snake2[0].y);
            }
            break;    
    }
}

function releaseBall(snakeId, slotIndex) {
    if (ballStorage[snakeId].length > slotIndex) {
        const ball = ballStorage[snakeId][slotIndex];
        
        // ä»å‚¨å­˜ä¸­ç§»é™¤
        ballStorage[snakeId].splice(slotIndex, 1);
        updateStorageDisplay();
        
        // å¦‚æœæ˜¯æ”»å‡»çƒï¼Œæ¿€æ´»æ”»å‡»æ¨¡å¼
        if (ball.type === 'bomb') {
            triggerBomb(snakeId);
        }
        else if (ball.type === 'attack') {
            activateAttackMode(snakeId);
        } else {
            // å…¶ä»–çƒç«‹å³ç”Ÿæ•ˆ
            applySpecialItemEffect(snakeId, ball.type);
        }
        
        // æ˜¾ç¤ºé‡Šæ”¾æ•ˆæœ
        const head = snakes[snakeId][0];
        const effect = document.createElement('div');
        effect.className = 'release-effect';
        effect.style.left = `${head.x}px`;
        effect.style.top = `${head.y}px`;
        
        // æ ¹æ®çƒä½“ç±»å‹è®¾ç½®æ•ˆæœé¢œè‰²
        switch(ball.type) {
            case 'immunity':
                effect.style.background = 'radial-gradient(circle, #FFFF00, transparent)';
                effect.style.width = '40px';
                effect.style.height = '40px';
                break;
            case 'health':
                effect.style.background = 'radial-gradient(circle, #FF0000, transparent)';
                effect.style.width = '40px';
                effect.style.height = '40px';
                break;
            case 'reverse':
                effect.style.background = 'radial-gradient(circle, #800080, transparent)';
                effect.style.width = '40px';
                effect.style.height = '40px';
                break;
            case 'attack':
                effect.style.background = 'radial-gradient(circle, #00BFFF, transparent)';
                effect.style.width = '40px';
                effect.style.height = '40px';
                break;
        }
        
        gameBoard.appendChild(effect);
        
        // åŠ¨ç”»ç»“æŸåç§»é™¤æ•ˆæœå…ƒç´ 
        setTimeout(() => {
            effect.remove();
        }, 500);
    }
}
function triggerBomb(snakeId) {
    const snakeHead = snakes[snakeId][0];
    const otherSnakeId = snakeId === 'snake1' ? 'snake2' : 'snake1';
    
    // åˆ›å»ºçˆ†ç‚¸è§†è§‰æ•ˆæœ
    createBombExplosion(snakeHead.x + 10, snakeHead.y + 10);
    
    // è®¡ç®—å¯¹å¯¹æ–¹è›‡çš„ä¼¤å®³
    applyBombDamageToSnake(snakeId, otherSnakeId, snakeHead);
    
    // è®¡ç®—å¯¹åŸºåœ°çš„ä¼¤å®³
    applyBombDamageToHomes(snakeId, snakeHead);
    
    // æ˜¾ç¤ºæç¤º
    showNotice('ç‚¸å¼¹çˆ†ç‚¸!', '#FF4500', snakeHead.x, snakeHead.y);
}

// æ–°å¢å‡½æ•°ï¼šåˆ›å»ºç‚¸å¼¹çˆ†ç‚¸æ•ˆæœ
function createBombExplosion(centerX, centerY) {
    // ä¸­å¿ƒçˆ†ç‚¸æ•ˆæœ
    createParticles(centerX, centerY, 50, '#FF4500');
    
    // å†²å‡»æ³¢æ•ˆæœ
    for (let i = 0; i < 5; i++) {
        const wave = document.createElement('div');
        wave.className = 'bomb-wave';
        wave.style.left = `${centerX}px`;
        wave.style.top = `${centerY}px`;
        wave.style.width = '0px';
        wave.style.height = '0px';
        wave.style.borderRadius = '50%';
        wave.style.border = '2px solid rgba(255, 69, 0, 0.8)';
        wave.style.position = 'absolute';
        wave.style.zIndex = '4';
        
        // åŠ¨ç”»
        wave.animate([
            { 
                width: '0px', 
                height: '0px',
                opacity: 1,
                transform: 'translate(-50%, -50%)'
            },
            { 
                width: '200px', 
                height: '200px',
                opacity: 0,
                transform: 'translate(-50%, -50%)'
            }
        ], {
            duration: 1000,
            easing: 'ease-out'
        });
        
        gameBoard.appendChild(wave);
        
        // ç§»é™¤æ•ˆæœå…ƒç´ 
        setTimeout(() => wave.remove(), 1000);
    }
}

// æ–°å¢å‡½æ•°ï¼šå¯¹è›‡åº”ç”¨ç‚¸å¼¹ä¼¤å®³
function applyBombDamageToSnake(snakeId, targetSnakeId, explosionCenter) {
    const targetSnake = snakes[targetSnakeId];
    const hasImmunity = targetSnakeId === 'snake1' ? immunity.snake1 : immunity.snake2;
    const isToughSnake = targetSnakeId === 'snake1' ? snakeTypes.snake1 === 'tough' : snakeTypes.snake2 === 'tough';
    
    let totalDamage = 0;
    let maxSegmentDistance = 0;
    
    // æ‰¾åˆ°ç¦»çˆ†ç‚¸ä¸­å¿ƒæœ€è¿‘çš„è›‡èº«æ®µ
    for (let i = 0; i < targetSnake.length; i++) {
        const segment = targetSnake[i];
        const distance = calculateDistance(segment, explosionCenter);
        
        if (i === 0 || distance < maxSegmentDistance) {
            maxSegmentDistance = distance;
        }
    }
    
    // æ ¹æ®æœ€è¿‘è›‡èº«æ®µè®¡ç®—åŸºç¡€ä¼¤å®³
    const gridDistance = Math.floor(maxSegmentDistance / 20);
    
    if (gridDistance <= 3) {
        totalDamage = 5;
    } else if (gridDistance <= 6) {
        totalDamage = 2;
    } else if (gridDistance <= 10) {
        totalDamage = 1;
    }
    
    if (totalDamage > 0) {
        // ä½¿ç”¨ç»Ÿä¸€çš„ä¼¤å®³å‡½æ•°
        const damageApplied = applyDamage(targetSnakeId, totalDamage, 'bomb', {
            attacker: snakeId,
            explosionCenter: explosionCenter,
            distance: gridDistance,
            isToughSnake: isToughSnake
        });
        
        if (damageApplied) {
            // è®°å½•ç‚¸å¼¹è¾“å‡ºä¼¤å®³ç»Ÿè®¡
            gameStats[snakeId].damageDealt.bomb += totalDamage;
            gameStats[snakeId].totalDamageDealt += totalDamage;
        }
    } else {
        // åœ¨å®‰å…¨è·ç¦»å¤–
        const targetHead = targetSnake[0];
        showNotice('å®‰å…¨è·ç¦»', '#00FF00', targetHead.x, targetHead.y);
    }
}
function calculateDistanceToRect(point, rect) {
    // è®¡ç®—ç‚¹åˆ°çŸ©å½¢å››æ¡è¾¹çš„æœ€çŸ­è·ç¦»
    const dx = Math.max(rect.x - point.x, 0, point.x - (rect.x + rect.width));
    const dy = Math.max(rect.y - point.y, 0, point.y - (rect.y + rect.height));
    
    // å¦‚æœåœ¨çŸ©å½¢å†…ï¼Œè·ç¦»ä¸º0
    if (dx === 0 && dy === 0) {
        return 0;
    }
    
    // è®¡ç®—æ¬§å‡ é‡Œå¾—è·ç¦»
    return Math.sqrt(dx * dx + dy * dy);
}


// æ–°å¢å‡½æ•°ï¼šå¯¹åŸºåœ°åº”ç”¨ç‚¸å¼¹ä¼¤å®³
function applyBombDamageToHomes(snakeId, explosionCenter) {
    const otherHomeId = snakeId === 'snake1' ? 'player2' : 'player1';
    const otherHome = homes[otherHomeId];
    
    if (otherHome.destroyed) return;
    
    // è®¡ç®—çˆ†ç‚¸ä¸­å¿ƒåˆ°åŸºåœ°è¾¹æ¡†çš„æœ€çŸ­è·ç¦»
    const distance = calculateDistanceToRect(explosionCenter, otherHome);
    const gridDistance = Math.floor(distance / 20);
    
    let damage = 0;
    let message = '';
    
    if (gridDistance <= 3) {
        damage = 5;
        message = 'ç‚¸å¼¹å‡»ä¸­! -5HP';
    } else if (gridDistance <= 6) {
        damage = 2;
        message = 'ç‚¸å¼¹å†²å‡»! -2HP';
    } else if (gridDistance <= 10) {
        damage = 1;
        message = 'ç‚¸å¼¹æ³¢åŠ! -1HP';
    }
    
    if (damage > 0) {
        otherHome.health = Math.max(0, otherHome.health - damage);
        
        // åœ¨åŸºåœ°ä¸­å¿ƒæ˜¾ç¤ºä¼¤å®³æ•ˆæœ
        const homeCenter = {
            x: otherHome.x + otherHome.width / 2,
            y: otherHome.y + otherHome.height / 2
        };
        
        // æ˜¾ç¤ºä¼¤å®³æ•ˆæœ
        showNotice(message, '#FF4500', homeCenter.x, homeCenter.y);
        createParticles(homeCenter.x, homeCenter.y, damage * 3, '#FF4500');
        
        // æ£€æŸ¥åŸºåœ°æ˜¯å¦è¢«æ‘§æ¯
        if (otherHome.health <= 0) {
            otherHome.destroyed = true;
            const playerName = otherHomeId === 'player1' ? 
                (localStorage.getItem('username') || 'ç©å®¶1') : 
                (localStorage.getItem('player2_username') || 'ç©å®¶2');
            
            showNotice(`${playerName}çš„åŸºåœ°è¢«ç‚¸æ¯äº†!`, '#FF0000', homeCenter.x, homeCenter.y);
            
            // å¤§çˆ†ç‚¸æ•ˆæœ
            createParticles(homeCenter.x, homeCenter.y, 50, '#FF4500');
        }
    }
}
function calculateDistance(point1, point2) {
    // ç¡®ä¿point1å’Œpoint2éƒ½æœ‰xå’Œyå±æ€§
    const x1 = point1.x || point1.left || 0;
    const y1 = point1.y || point1.top || 0;
    const x2 = point2.x || point2.left || 0;
    const y2 = point2.y || point2.top || 0;
    
    return Math.sqrt(
        Math.pow(x1 - x2, 2) + 
        Math.pow(y1 - y2, 2)
    );
}

function activateAttackMode(snakeId) {
    const currentTime = performance.now();
    const isMagicSnake = snakeId === 'snake1' ? snakeTypes.snake1 === 'magic' : snakeTypes.snake2 === 'magic';
    const timeMultiplier = isMagicSnake ? 1.5 : 1;
    const attackDuration = 30000 * timeMultiplier; // 30ç§’ï¼Œé­”æ³•è›‡45ç§’

    if (snakeId === 'snake1') {
        attackMode.snake1 = true;
        attackMode.timer1 = currentTime + attackDuration;
        attackMode.intervalId1 = setInterval(() => {
            if (attackMode.snake1) {
                fireBullet(snakeId);
            } else {
                clearInterval(attackMode.intervalId1);
            }
        }, 400); // æ¯0.5ç§’å‘å°„ä¸€é¢—
    } else {
        attackMode.snake2 = true;
        attackMode.timer2 = currentTime + attackDuration;
        attackMode.intervalId2 = setInterval(() => {
            if (attackMode.snake2) {
                fireBullet(snakeId);
            } else {
                clearInterval(attackMode.intervalId2);
            }
        }, 400);
    }

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    updateStatusDisplay();
    showNotice('æ”»å‡»æ¨¡å¼æ¿€æ´»!' + (isMagicSnake ? ' (é­”æ³•å»¶é•¿)' : ''), '#00BFFF', 
        snakeId === 'snake1' ? snakes.snake1[0].x : snakes.snake2[0].x, 
        snakeId === 'snake1' ? snakes.snake1[0].y : snakes.snake2[0].y);
}
// æ£€æŸ¥ä¸å…¶ä»–è›‡ç¢°æ’
function checkOtherSnakeCollision(otherSnakeId, head) {
    const otherSnake = snakes[otherSnakeId];
    
    for (let i = 0; i < otherSnake.length; i++) {
        const segment = otherSnake[i];
        const distance = Math.sqrt(Math.pow(head.x - segment.x, 2) + Math.pow(head.y - segment.y, 2));
        
        if (distance < 20) {
            const isHeadCollision = (i === 0);
            
            // æ£€æŸ¥å¯¹æ–¹æ˜¯å¦è¢«å†»ç»“
            if (frozenSnakes[otherSnakeId]) {
                // æ’å†»ç»“çš„è›‡ä¸æ‰è¡€ï¼Œä½†å†»ç»“çš„è›‡ä¼šæ‰è¡€
                if (performance.now() - lastMoveTime[otherSnakeId] > 1000) {
                    health[otherSnakeId] -= 1;
                    updateHealthBars();
                    showNotice('-1HP (å†»ç»“ç¢°æ’)', '#00BFFF', segment.x, segment.y);
                    lastMoveTime[otherSnakeId] = performance.now();
                    
                    // æ£€æŸ¥æ¸¸æˆç»“æŸ
                    if (health[otherSnakeId] <= 0) {
                        gameOver();
                    }
                }
                return { collided: false }; // è¿”å›æœªç¢°æ’ï¼Œå› ä¸ºä¸æ‰è¡€
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯åšç¡¬è›‡å¹¶ä¸”æœ‰æŠµæŒ¡æ•ˆæœ
            const currentSnakeId = otherSnakeId === 'snake1' ? 'snake2' : 'snake1';
            const currentSnakeType = snakeTypes[currentSnakeId];
            
            if (currentSnakeType === 'tough' && defenseRate[currentSnakeId] > 0.2) {
                // åšç¡¬è›‡æœ‰æŠµæŒ¡æ•ˆæœ
                const damageReduction = defenseRate[currentSnakeId];
                
                // æ˜¾ç¤ºæŠµæŒ¡æç¤º
                showNotice(`æŠµæŒ¡${Math.round((1 - damageReduction) * 100)}%!`, '#FFFFFF', head.x, head.y);
                createParticles(head.x + 10, head.y + 10, 15, '#FFFFFF');
                
                // æ›´æ–°æŠµæŒ¡ç‡
                if (collisionCount[currentSnakeId] < 3) {
                    collisionCount[currentSnakeId]++;
                } else {
                    // ç¬¬4æ¬¡ç¢°æ’å¼€å§‹ï¼ŒæŠµæŒ¡ç‡é€æ­¥é™ä½
                    defenseRate[currentSnakeId] = Math.max(0.2, defenseRate[currentSnakeId] - 0.2);
                }
                
                return { collided: false }; // è¿”å›æœªç¢°æ’
            }
            
            return {
                collided: true,
                collisionIndex: i,
                isHeadCollision: isHeadCollision
            };
        }
    }
    
    return { collided: false };
}

// æ›´æ–°åˆ†æ•°æ˜¾ç¤º
function updateScoreDisplay() {
    document.getElementById('score-1').textContent = `${scores.snake1}åˆ†`;
    document.getElementById('score-2').textContent = `${scores.snake2}åˆ†`;
}

// æ›´æ–°è¡€é‡æ˜¾ç¤º
// åœ¨updateHealthBarså‡½æ•°ä¸­è°ƒç”¨æŠ¤ç›¾æ˜¾ç¤ºæ›´æ–°
function updateHealthBars() {
    const maxHealth1 = snakeTypes.snake1 === 'tough' ? 13 + (playerUpgrades.snake1?.tough || 0) * 2 : 10;
    const maxHealth2 = snakeTypes.snake2 === 'tough' ? 13 + (playerUpgrades.snake2?.tough || 0) * 2 : 10;
    
    health1El.style.width = `${(health.snake1 / maxHealth1) * 100}%`;
    health2El.style.width = `${(health.snake2 / maxHealth2) * 100}%`;
    document.getElementById('health-text-1').textContent = `${health.snake1}HP`;
    document.getElementById('health-text-2').textContent = `${health.snake2}HP`;
    
    // æ›´æ–°æŠ¤ç›¾æ˜¾ç¤º
    updateShieldDisplay('snake1');
    updateShieldDisplay('snake2');
}

// æ˜¾ç¤ºé€šçŸ¥
function showNotice(text, color, x, y) {
    const notice = document.createElement('div');
    notice.textContent = text;
    notice.style.position = 'absolute';
    notice.style.left = `${x}px`;
    notice.style.top = `${y}px`;
    notice.style.color = color;
    notice.style.fontSize = '16px';
    notice.style.fontWeight = 'bold';
    notice.style.textShadow = '0 0 5px white';
    notice.style.zIndex = '10';
    notice.style.animation = 'fadeOut 1s forwards';
    gameBoard.appendChild(notice);
    
    setTimeout(() => {
        notice.remove();
    }, 1000);
}
function getDeathCause(snakeId) {
    // å¦‚æœæ²¡æœ‰ç›´æ¥è®°å½•ï¼Œå°è¯•åˆ†æåŸå› 
    if (deathCause[snakeId]) {
        return deathCause[snakeId];
    }
    
    // åˆ†æå¯èƒ½çš„æ­»äº¡åŸå› 
    const otherSnakeId = snakeId === 'snake1' ? 'snake2' : 'snake1';
    
    // æ£€æŸ¥è¡€é‡
    if (health[snakeId] <= 0) {
        if (health[otherSnakeId] > 0) {
            // åªæœ‰è‡ªå·±æ­»äº†
            return 'æœªçŸ¥åŸå› æ­»äº¡';
        } else {
            // åŒæ–¹éƒ½æ­»äº†
            return 'åŒå½’äºå°½';
        }
    }
    
    return 'æœªçŸ¥åŸå› ';
}

// æ–°å¢å‡½æ•°ï¼šç”Ÿæˆè¯¦ç»†çš„æ­»äº¡åˆ†æ
function generateDeathAnalysis() {
    const analysis = {
        snake1: {
            cause: deathCause.snake1 || 'å­˜æ´»',
            health: health.snake1,
            score: scores.snake1,
            type: snakeTypes.snake1 || 'æœªé€‰æ‹©'
        },
        snake2: {
            cause: deathCause.snake2 || 'å­˜æ´»',
            health: health.snake2,
            score: scores.snake2,
            type: snakeTypes.snake2 || 'æœªé€‰æ‹©'
        }
    };
    
    return analysis;
}
const deathCauseStyle = document.createElement('style');
deathCauseStyle.textContent = `
    /* æ­»äº¡åŸå› æ ·å¼ */
    .death-cause {
        animation: fadeInDeath 1s ease-out;
    }
    
    @keyframes fadeInDeath {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .death-info {
        min-height: 18px;
    }
    
    /* ä¸åŒç±»å‹çš„æ­»äº¡å›¾æ ‡ */
    .death-cause[data-type="collision"] i {
        color: #FF5722;
    }
    
    .death-cause[data-type="bullet"] i {
        color: #2196F3;
    }
    
    .death-cause[data-type="bomb"] i {
        color: #FF4500;
    }
    
    .death-cause[data-type="wall"] i {
        color: #555;
    }
    
    .death-cause[data-type="home"] i {
        color: #4CAF50;
    }
`;
document.head.appendChild(deathCauseStyle);
// ä¿®æ”¹showGameStatså‡½æ•°ï¼Œæ˜¾ç¤ºæ›´è¯¦ç»†çš„ç»Ÿè®¡
function showGameStats() {
    const modal = document.getElementById('game-stats-modal');
    const content = document.getElementById('game-stats-content');
    
    // è®¡ç®—æ¸¸æˆæ€»æ—¶é—´
    let totalTime;
    if (gameStats.endTime) {
        totalTime = Math.floor((gameStats.endTime - gameStats.startTime) / 1000);
    } else {
        totalTime = Math.floor((performance.now() - gameStats.startTime) / 1000);
    }
    
    const minutes = Math.floor(totalTime / 60);
    const seconds = totalTime % 60;
    const timeString = `${minutes}åˆ†${seconds}ç§’`;
    
    // è®¡ç®—é˜²å¾¡æ•ˆç‡
    const calculateDefenseEfficiency = (snakeId) => {
        const stats = gameStats[snakeId];
        const totalOriginal = stats.totalOriginalDamageReceived || 0;
        const totalActual = stats.totalDamageReceived || 0;
        
        if (totalOriginal === 0) return 0;
        return Math.round(((totalOriginal - totalActual) / totalOriginal) * 100);
    };
    
    // ç”Ÿæˆç»Ÿè®¡æ•°æ®HTML
    content.innerHTML = `
        <div class="game-time-display">
            <i class="fas fa-clock"></i> æ¸¸æˆæ—¶é•¿: <strong>${timeString}</strong>
        </div>
        
        <div class="stats-grid">
            <!-- ç©å®¶1ç»Ÿè®¡ -->
            <div class="player-stats-box player1">
                <div class="stats-header">
                    <h3 style="color: #FF5722;">
                        <i class="fas fa-fire"></i> ${localStorage.getItem("username") || "ç©å®¶1"}
                    </h3>
                    <div style="font-size: 12px; color: #aaa;">
                        ${snakeTypes.snake1 === 'speed' ? 'âš¡ é€Ÿåº¦è›‡' : 
                          snakeTypes.snake1 === 'tough' ? 'ğŸ›¡ï¸ åšç¡¬è›‡' : 
                          snakeTypes.snake1 === 'magic' ? 'âœ¨ é­”æ³•è›‡' : 'æœªé€‰æ‹©'}
                    </div>
                </div>
                
                <!-- è¾“å‡ºä¼¤å®³ç»Ÿè®¡ -->
    <div class="stats-section">
        <div class="section-title">
            <i class="fas fa-crosshairs" style="color: #4CAF50;"></i>
            <span>è¾“å‡ºä¼¤å®³ç»Ÿè®¡</span>
        </div>
    <div class="stats-section">

            <div class="stats-items">
                ${gameStats.snake1.totalDamageDealt > 0 ? `
                    <div class="stat-item">
                        <span>æ€»è¾“å‡ºä¼¤å®³:</span>
                        <span style="color: #4CAF50;">${gameStats.snake1.totalDamageDealt.toFixed(1)}</span>
                    </div>
                ` : ''}
                
                ${gameStats.snake1.damageDealt.snakeCollision > 0 ? `
                    <div class="stat-item">
                        <span>è›‡ç›¸æ’ä¼¤å®³:</span>
                        <span style="color: #4CAF50;">${gameStats.snake1.damageDealt.snakeCollision.toFixed(1)}</span>
                    </div>
                ` : ''}
                
                ${gameStats.snake1.damageDealt.bullet > 0 ? `
                    <div class="stat-item">
                        <span>å­å¼¹ä¼¤å®³:</span>
                        <span style="color: #4CAF50;">${gameStats.snake1.damageDealt.bullet.toFixed(1)}</span>
                    </div>
                ` : ''}
                
                ${gameStats.snake1.damageDealt.bomb > 0 ? `
                    <div class="stat-item">
                        <span>ç‚¸å¼¹ä¼¤å®³:</span>
                        <span style="color: #4CAF50;">${gameStats.snake1.damageDealt.bomb.toFixed(1)}</span>
                    </div>
                ` : ''}
                
                ${(gameStats.snake1.damageDealt.base || 0) > 0 ? `
                    <div class="stat-item">
                        <span>åŸºåœ°å­å¼¹ä¼¤å®³:</span>
                        <span style="color: #4CAF50;">${(gameStats.snake1.damageDealt.base || 0).toFixed(1)}</span>
                    </div>
                ` : ''}
                
                ${gameStats.snake1.totalDamageDealt <= 0 ? `
                    <div class="stat-item">æ— è¾“å‡ºä¼¤å®³è®°å½•</div>
                ` : ''}
            </div>
        </div>
        </div>
                
                <!-- é˜²å¾¡ç»Ÿè®¡ -->
                <div class="stats-section">
                    <div class="section-title">
                        <i class="fas fa-shield-alt" style="color: #00BCD4;"></i>
                        <span>é˜²å¾¡ç»Ÿè®¡</span>
                    </div>
                    <div class="stats-items">
                        ${gameStats.snake1.shieldDamageAbsorbed > 0 ? `
                        <div class="stat-item">
                            <span>æŠ¤ç›¾å¸æ”¶:</span>
                            <span style="color: #00BCD4;">${gameStats.snake1.shieldDamageAbsorbed.toFixed(1)}</span>
                        </div>
                        <div class="stat-item">
                            <span>æŠ¤ç›¾æ ¼æŒ¡:</span>
                            <span style="color: #00BCD4;">${gameStats.snake1.shieldBlocks || 0}</span>
                        </div>
                        ` : ''}
                        
                        ${gameStats.snake1.immuneBlocks > 0 ? `
                        <div class="stat-item">
                            <span>å…ç–«æ ¼æŒ¡:</span>
                            <span style="color: #FFFF00;">${gameStats.snake1.immuneBlocks}</span>
                        </div>
                        <div class="stat-item">
                            <span>å…ç–«å…ä¼¤:</span>
                            <span style="color: #FFFF00;">${getTotalImmuneDamage('snake1').toFixed(1)}</span>
                        </div>
                        ` : ''}
                        
                        ${gameStats.snake1.toughImmuneBlocks > 0 ? `
                        <div class="stat-item">
                            <span>åšç¡¬å…ç–«:</span>
                            <span style="color: #C0C0C0;">${gameStats.snake1.toughImmuneBlocks}</span>
                        </div>
                        ` : ''}
                        
                        ${getTotalToughReducedDamage('snake1') > 0 ? `
                        <div class="stat-item">
                            <span>åšç¡¬å‡ä¼¤:</span>
                            <span style="color: #C0C0C0;">${getTotalToughReducedDamage('snake1').toFixed(1)}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- æ‰¿å—ä¼¤å®³è¯¦æƒ… -->
                <div class="stats-section">
                    <div class="section-title">
                        <i class="fas fa-heartbeat" style="color: #ff6b6b;"></i>
                        <span>æ‰¿å—ä¼¤å®³è¯¦æƒ…</span>
                    </div>
                    <div class="stats-items">
                        ${generateDamageDetailStats('snake1')}
                    </div>
                </div>
                
                <!-- ç§»åŠ¨ç»Ÿè®¡ -->
                <div class="stats-section">
                    <div class="section-title">
                        <i class="fas fa-road" style="color: #00BCD4;"></i>
                        <span>ç§»åŠ¨ç»Ÿè®¡</span>
                    </div>
                    <div style="text-align: center; padding: 10px; background: rgba(0, 188, 212, 0.2); border-radius: 8px;">
                        <div style="font-size: 24px; color: #00BCD4; font-weight: bold;">
                            ${gameStats.snake1.distanceTraveled}
                        </div>
                        <div style="font-size: 14px; color: white;">æ ¼ (20px/æ ¼)</div>
                    </div>
                </div>
            </div>
            <!-- ç©å®¶2ç»Ÿè®¡ -->
            <div class="player-stats-box player2">
                <div class="stats-header">
                    <h3 style="color: #2196F3;">
                        <i class="fas fa-tint"></i> ${localStorage.getItem("player2_username") || "ç©å®¶2"}
                    </h3>
                    <div style="font-size: 12px; color: #aaa;">
                        ${snakeTypes.snake2 === 'speed' ? 'âš¡ é€Ÿåº¦è›‡' : 
                          snakeTypes.snake2 === 'tough' ? 'ğŸ›¡ï¸ åšç¡¬è›‡' : 
                          snakeTypes.snake2 === 'magic' ? 'âœ¨ é­”æ³•è›‡' : 'æœªé€‰æ‹©'}

                    </div>
                </div>
                
                <!-- è¾“å‡ºä¼¤å®³ç»Ÿè®¡ -->
                <div class="stats-section">
    <div class="stats-section">
        <div class="section-title">
            <i class="fas fa-crosshairs" style="color: #4CAF50;"></i>
            <span>è¾“å‡ºä¼¤å®³ç»Ÿè®¡</span>
        </div>
        <div class="stats-items">
            ${gameStats.snake2.totalDamageDealt > 0 ? `
                <div class="stat-item">
                    <span>æ€»è¾“å‡ºä¼¤å®³:</span>
                    <span style="color: #4CAF50;">${gameStats.snake2.totalDamageDealt.toFixed(1)}</span>
                </div>
            ` : ''}
            
            ${gameStats.snake2.damageDealt.snakeCollision > 0 ? `
                <div class="stat-item">
                    <span>è›‡ç›¸æ’ä¼¤å®³:</span>
                    <span style="color: #4CAF50;">${gameStats.snake2.damageDealt.snakeCollision.toFixed(1)}</span>
                </div>
            ` : ''}
            
            ${gameStats.snake2.damageDealt.bullet > 0 ? `
                <div class="stat-item">
                    <span>å­å¼¹ä¼¤å®³:</span>
                    <span style="color: #4CAF50;">${gameStats.snake2.damageDealt.bullet.toFixed(1)}</span>
                </div>
            ` : ''}
            
            ${gameStats.snake2.damageDealt.bomb > 0 ? `
                <div class="stat-item">
                    <span>ç‚¸å¼¹ä¼¤å®³:</span>
                    <span style="color: #4CAF50;">${gameStats.snake2.damageDealt.bomb.toFixed(1)}</span>
                </div>
            ` : ''}
            
            ${(gameStats.snake2.damageDealt.base || 0) > 0 ? `
                <div class="stat-item">
                    <span>åŸºåœ°å­å¼¹ä¼¤å®³:</span>
                    <span style="color: #4CAF50;">${(gameStats.snake2.damageDealt.base || 0).toFixed(1)}</span>
                </div>
            ` : ''}
            
            ${gameStats.snake2.totalDamageDealt <= 0 ? `
                <div class="stat-item">æ— è¾“å‡ºä¼¤å®³è®°å½•</div>
            ` : ''}
        </div>
    </div>
                </div>
                
                <!-- é˜²å¾¡ç»Ÿè®¡ -->
                <div class="stats-section">
                    <div class="section-title">
                        <i class="fas fa-shield-alt" style="color: #00BCD4;"></i>
                        <span>é˜²å¾¡ç»Ÿè®¡</span>
                    </div>
                    <div class="stats-items">
                        ${gameStats.snake2.shieldDamageAbsorbed > 0 ? `
                        <div class="stat-item">
                            <span>æŠ¤ç›¾å¸æ”¶:</span>
                            <span style="color: #00BCD4;">${gameStats.snake2.shieldDamageAbsorbed.toFixed(1)}</span>
                        </div>
                        <div class="stat-item">
                            <span>æŠ¤ç›¾æ ¼æŒ¡:</span>
                            <span style="color: #00BCD4;">${gameStats.snake2.shieldBlocks || 0}</span>
                        </div>
                        ` : ''}
                        
                        ${gameStats.snake2.immuneBlocks > 0 ? `
                        <div class="stat-item">
                            <span>å…ç–«æ ¼æŒ¡:</span>
                            <span style="color: #FFFF00;">${gameStats.snake2.immuneBlocks}</span>
                        </div>
                        <div class="stat-item">
                            <span>å…ç–«å…ä¼¤:</span>
                            <span style="color: #FFFF00;">${getTotalImmuneDamage('snake2').toFixed(1)}</span>
                        </div>
                        ` : ''}
                        
                        ${gameStats.snake2.toughImmuneBlocks > 0 ? `
                        <div class="stat-item">
                            <span>åšç¡¬å…ç–«:</span>
                            <span style="color: #C0C0C0;">${gameStats.snake2.toughImmuneBlocks}</span>
                        </div>
                        ` : ''}
                        
                        ${getTotalToughReducedDamage('snake2') > 0 ? `
                        <div class="stat-item">
                            <span>åšç¡¬å‡ä¼¤:</span>
                            <span style="color: #C0C0C0;">${getTotalToughReducedDamage('snake2').toFixed(1)}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- æ‰¿å—ä¼¤å®³è¯¦æƒ… -->
                <div class="stats-section">
                    <div class="section-title">
                        <i class="fas fa-heartbeat" style="color: #ff6b6b;"></i>
                        <span>æ‰¿å—ä¼¤å®³è¯¦æƒ…</span>
                    </div>
                    <div class="stats-items">
                        ${generateDamageDetailStats('snake2')}
                    </div>
                </div>
                
                <!-- ç§»åŠ¨ç»Ÿè®¡ -->
                <div class="stats-section">
                    <div class="section-title">
                        <i class="fas fa-road" style="color: #00BCD4;"></i>
                        <span>ç§»åŠ¨ç»Ÿè®¡</span>
                    </div>
                    <div style="text-align: center; padding: 10px; background: rgba(0, 188, 212, 0.2); border-radius: 8px;">
                        <div style="font-size: 24px; color: #00BCD4; font-weight: bold;">
                            ${gameStats.snake2.distanceTraveled}
                        </div>
                        <div style="font-size: 14px; color: white;">æ ¼ (20px/æ ¼)</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px; padding: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 8px; font-size: 12px; color: #aaa;">
            <i class="fas fa-info-circle"></i> æ³¨ï¼šåŸå§‹ä¼¤å®³åŒ…æ‹¬æ‰€æœ‰å—åˆ°çš„æ”»å‡»ä¼¤å®³ï¼Œå®é™…ä¼¤å®³ä¸ºæ‰£é™¤é˜²å¾¡åçš„å®é™…è¡€é‡å‡å°‘
        </div>
    `;

    
    modal.style.display = 'block';
}
function generateDefenseStats(snakeId) {
    const stats = gameStats[snakeId];
    let html = '';
    
    if (stats.shieldDamageAbsorbed > 0) {
        html += `
            <div class="stat-item">
                <span>æŠ¤ç›¾å¸æ”¶:</span>
                <span style="color: #00BCD4;">${stats.shieldDamageAbsorbed.toFixed(1)}</span>
            </div>
            <div class="stat-item">
                <span>æŠ¤ç›¾æ ¼æŒ¡:</span>
                <span style="color: #00BCD4;">${stats.shieldBlocks || 0}</span>
            </div>
        `;
    }
    
    if (stats.immuneBlocks > 0) {
        html += `
            <div class="stat-item">
                <span>å…ç–«æ ¼æŒ¡:</span>
                <span style="color: #FFFF00;">${stats.immuneBlocks}</span>
            </div>
        `;
    }
    
    if (stats.toughImmuneBlocks > 0) {
        html += `
            <div class="stat-item">
                <span>åšç¡¬å…ç–«:</span>
                <span style="color: #C0C0C0;">${stats.toughImmuneBlocks}</span>
            </div>
        `;
    }
    
    const toughReduced = getTotalToughReducedDamage(snakeId);
    if (toughReduced > 0) {
        html += `
            <div class="stat-item">
                <span>åšç¡¬å‡ä¼¤:</span>
                <span style="color: #C0C0C0;">${toughReduced.toFixed(1)}</span>
            </div>
        `;
    }
    
    return html || '<div class="stat-item">æ— é˜²å¾¡è®°å½•</div>';
}
// è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—æ€»å…ç–«ä¼¤å®³
function getTotalImmuneDamage(snakeId) {
    const stats = gameStats[snakeId];
    if (!stats.immuneDamagePrevented) return 0;
    
    let total = 0;
    for (const source in stats.immuneDamagePrevented) {
        total += stats.immuneDamagePrevented[source];
    }
    return total;
}

// è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—æ€»åšç¡¬å‡ä¼¤
function getTotalToughReducedDamage(snakeId) {
    const stats = gameStats[snakeId];
    if (!stats.toughReducedDamage) return 0;
    
    let total = 0;
    for (const source in stats.toughReducedDamage) {
        total += stats.toughReducedDamage[source];
    }
    return total;
}

// è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆä¼¤å®³è¯¦æƒ…ç»Ÿè®¡
function generateDamageDetailStats(snakeId) {
    const stats = gameStats[snakeId];
    const damageTypes = ['wall', 'snakeCollision', 'bullet', 'base', 'lava', 'home', 'bomb'];
    const typeNames = {
        'wall': 'æ’å¢™',
        'snakeCollision': 'è›‡ç›¸æ’',
        'bullet': 'å­å¼¹',
        'base': 'åŸºåœ°é˜²å¾¡',
        'lava': 'å²©æµ†',
        'home': 'æ•Œæ–¹åŸºåœ°',
        'bomb': 'ç‚¸å¼¹'
    };
    
    let html = '';
    
    damageTypes.forEach(type => {
        const original = stats.originalDamageReceived?.[type] || 0;
        const actual = stats.damageReceived?.[type] || 0;
        
        if (original > 0) {
            const reduction = original - actual;
            const reductionPercent = original > 0 ? Math.round((reduction / original) * 100) : 0;
            
            html += `
                <div class="stat-item">
                    <span>${typeNames[type]}:</span>
                    <div style="display: flex; flex-direction: column; align-items: flex-end;">
                        <div style="font-size: 11px; color: #aaa;">
                            åŸå§‹: ${original.toFixed(1)}
                        </div>
                        <div style="font-size: 12px; color: #ff6b6b;">
                            å®é™…: ${actual.toFixed(1)}
                        </div>
                        ${reduction > 0 ? `
                        <div style="font-size: 10px; color: #4CAF50;">
                            å‡å…: ${reduction.toFixed(1)} (${reductionPercent}%)
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
    });
    
    return html || '<div class="stat-item">æ— ä¼¤å®³è®°å½•</div>';
}
function gameOver() {
    gameOverScreen.style.display = '';
    gameStarted = false;
    let hasUploaded = false;
        // 1. æ¸…é™¤æ‰€æœ‰å­å¼¹
    if (attackMode.intervalId1) {
        clearInterval(attackMode.intervalId1);
        attackMode.intervalId1 = null;
    }
    if (attackMode.intervalId2) {
        clearInterval(attackMode.intervalId2);
        attackMode.intervalId2 = null;
    }
      attackMode = {
        snake1: false,
        snake2: false,
        timer1: 0,
        timer2: 0,
        lastShot1: 0,
        lastShot2: 0,
        intervalId1: null,
        intervalId2: null
    };  
    // æ¸…é™¤å­å¼¹æ•°ç»„å’ŒDOMå…ƒç´ 
    bullets = [];
    document.querySelectorAll('.bullet').forEach(bullet => bullet.remove());
    
    // é‡ç½®æ”»å‡»æ¨¡å¼çŠ¶æ€
    attackMode = {
        snake1: false,
        snake2: false,
        timer1: 0,
        timer2: 0,
        lastShot1: 0,
        lastShot2: 0,
        intervalId1: null,
        intervalId2: null
    };
    if (attackMode.intervalId1) clearInterval(attackMode.intervalId1);
    if (attackMode.intervalId2) clearInterval(attackMode.intervalId2);
    attackMode = {
        snake1: false,
        snake2: false,
        timer1: 0,
        timer2: 0,
        lastShot1: 0,
        lastShot2: 0,
        intervalId1: null,
        intervalId2: null
    };
    homes.player1.destroyed = false;
    homes.player1.health = homes.player1.maxHealth;
    homes.player2.destroyed = false;
    homes.player2.health = homes.player2.maxHealth;
    document.querySelectorAll('.bullet').forEach(bullet => bullet.remove());
    document.getElementById("back").style.display = "block";
    viewRecords.style.display = 'block';
    gameOverScreen.classList.remove('show');
        if (health.snake1 <= 0) {
        deathCause.snake1 = getDeathCause('snake1');
    }
    if (health.snake2 <= 0) {
        deathCause.snake2 = getDeathCause('snake2');
    }
    document.getElementById("back").onclick = function(){ 
        if(!gameStarted){     
            gameOverScreen.classList.remove('show');
            characterSelection.classList.add('show');
            gameStarted = true;
        } else {
            document.getElementById("back").onclick=goBackOrHome();
        }
    }
document.getElementById("store-player1").style.display="none";
document.getElementById("store-player2").style.display="none";
    let winner = null;
    let loser = null;
    let currentWin1 = 0;
    let currentWin2 = 0;
    
    if (health.snake1 <= 0 && health.snake2 <= 0) {
        winner = 'draw';
    } else if (health.snake1 <= 0) {
        winner = 'snake2';
        loser = 'snake1';
        currentWin2 = 1;
    } else {
        winner = 'snake1';
        loser = 'snake2';
        currentWin1 = 1;
    }

    // è·å–æœåŠ¡å™¨æ•°æ®å¹¶æ˜¾ç¤º
    getServerRecords().then(serverData => {
        // åªæ˜¾ç¤ºå†å²æˆ˜ç»©ï¼Œä¸åŒ…å«æœ¬æ¬¡ç»“æœ
        let player1Wins = serverData?.player1Wins || 0;
        let player2Wins = serverData?.player2Wins || 0;
        const deathAnalysis = generateDeathAnalysis();
        const loserName = loser === 'snake1' ? 
        localStorage.getItem('username') || 'ç©å®¶1' : 
        localStorage.getItem('player2_username') || 'ç©å®¶2';
        const loserCause = deathAnalysis[loser]?.cause || 'æœªçŸ¥åŸå› ';
        
        const currentTime = performance.now();
        const totalTime = Math.floor((currentTime - gameStats.startTime) / 1000);
        gameStats.endTime = performance.now();
        const minutes = Math.floor(totalTime / 60);
        const seconds = totalTime % 60;
        const timeString = `${minutes}åˆ†${seconds}ç§’`;
        
        // åˆ›å»ºæ¸¸æˆç»“æŸç•Œé¢
    gameOverScreen.innerHTML = `
        <div class="game-over-content">
            <div class="winner-container">
                ${winner === 'draw' ? `
                    <div class="trophy-icon">
                        <i class="fas fa-trophy" style="color: #FFD700;"></i>
                        <i class="fas fa-trophy" style="color: #C0C0C0;"></i>
                    </div>
                    <h2 class="winner-banner">å¹³å±€!</h2>
                ` : `
                    <div class="trophy-icon">
                        <i class="fas fa-trophy" style="color: ${winner === 'snake1' ? '#FFD700' : '#C0C0C0'};"></i>
                    </div>
                    <h2 class="winner-banner ${winner === 'snake1' ? 'player-1-win' : 'player-2-win'}">
                        ${winner === 'snake1' ? localStorage.getItem("username") : localStorage.getItem("player2_username")}è·èƒœ!
                    </h2>
                `}
            </div>
            
            <!-- å¤±è´¥è€…æ­»äº¡åŸå›  -->
            ${loser ? `
                <div class="death-cause" style="
                    margin: 15px auto;
                    padding: 10px;
                    background: ${loser === 'snake1' ? 'rgba(255, 87, 34, 0.2)' : 'rgba(33, 150, 243, 0.2)'};
                    border-radius: 10px;
                    max-width: 400px;
                    text-align: center;
                    border: 1px solid ${loser === 'snake1' ? '#FF5722' : '#2196F3'};
                ">
                    <div style="font-size: 14px; color: #ccc; margin-bottom: 5px;">
                        <i class="fas fa-skull-crossbones"></i> åŸå› 
                    </div>
                    <div style="font-size: 18px; font-weight: bold; color: white;">
                        ${loserName}${loserCause}
                    </div>
                    <div style="font-size: 12px; color: #aaa; margin-top: 5px;">
                        è¡€é‡: ${deathAnalysis[loser].health} | åˆ†æ•°: ${deathAnalysis[loser].score}
                    </div>
                </div>
            ` : ''}
            
            <!-- è¯¦ç»†ç»Ÿè®¡ -->
            <div class="stats-container">
                <div class="player-stats player-1-stats">
                    <div class="player-avatar">
                        <i class="fas fa-user" style="color: #FF5722;"></i>
                    </div>
                    <div class="player-name">${localStorage.getItem("username") || "ç©å®¶1"}</div>
                    <div class="player-type" style="font-size: 12px; color: #FFA500; margin: 5px 0;">
                        ${snakeTypes.snake1 === 'speed' ? 'âš¡ é€Ÿåº¦è›‡' : 
                          snakeTypes.snake1 === 'tough' ? 'ğŸ›¡ï¸ åšç¡¬è›‡' : 
                          snakeTypes.snake1 === 'magic' ? 'âœ¨ é­”æ³•è›‡' : 'æœªé€‰æ‹©'}
                    </div>
                    <div class="win-count">
                        <span class="history-wins">${player1Wins}</span>
                        ${currentWin1 > 0 ? `<span class="current-win">+${currentWin1}</span>` : ''}
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${calculateWinPercentage(player1Wins, player2Wins)}%; background: linear-gradient(to right, #FF5722, #FF9800);"></div>
                    </div>
                    <div class="death-info" style="font-size: 12px; color: #ff6b6b; margin-top: 5px;">
                        ${deathCause.snake1 ? `ğŸ’€ ${deathCause.snake1}` : health.snake1 > 0 ? 'ğŸ‘ å­˜æ´»' : ''}
                    </div>
                </div>
                
                <div class="vs-text">VS</div>
                
                <div class="player-stats player-2-stats">
                    <div class="player-avatar">
                        <i class="fas fa-user" style="color: #2196F3;"></i>
                    </div>
                    <div class="player-name">${localStorage.getItem("player2_username") || "ç©å®¶2"}</div>
                    <div class="player-type" style="font-size: 12px; color: #00BCD4; margin: 5px 0;">
                        ${snakeTypes.snake2 === 'speed' ? 'âš¡ é€Ÿåº¦è›‡' : 
                          snakeTypes.snake2 === 'tough' ? 'ğŸ›¡ï¸ åšç¡¬è›‡' : 
                          snakeTypes.snake2 === 'magic' ? 'âœ¨ é­”æ³•è›‡' : 'æœªé€‰æ‹©'}
                    </div>
                    <div class="win-count">
                        <span class="history-wins">${player2Wins}</span>
                        ${currentWin2 > 0 ? `<span class="current-win">+${currentWin2}</span>` : ''}
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${calculateWinPercentage(player2Wins, player1Wins)}%; background: linear-gradient(to right, #2196F3, #00BCD4);"></div>
                    </div>
                    <div class="death-info" style="font-size: 12px; color: #ff6b6b; margin-top: 5px;">
                        ${deathCause.snake2 ? `ğŸ’€ ${deathCause.snake2}` : health.snake2 > 0 ? 'ğŸ‘ å­˜æ´»' : ''}
                    </div>
                </div>
            </div>
            
            <div class="buttons-container">
                <button class="restart-btn" id="show-game-stats">
                    <i class="fas fa-chart-bar"></i> æ˜¾ç¤ºæœ¬å±€æ•°æ®
                </button>
                <button class="restart-btn" id="play-again">
                    <i class="fas fa-redo"></i> å†æ¥ä¸€å±€
                </button>
                <button class="restart-btn upload-btn" id="save-record">
                    <i class="fas fa-save"></i> ä¿å­˜æˆ˜ç»©
                </button>
            </div>
        </div>
    `;
    
        // å†æ¥ä¸€å±€æŒ‰é’®äº‹ä»¶
        document.getElementById('play-again').addEventListener('click', () => {
            gameOverScreen.classList.remove('show');
            setTimeout(() => {
                initGame();
            }, 300);
        });
        // ä¿®æ”¹å…³é—­æ¨¡æ€æ¡†çš„äº‹ä»¶å¤„ç†
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', function() {
                const modalId = this.getAttribute('data-modal') || 'records-modal';
                document.getElementById(modalId).style.display = 'none';
            });
        });

        // ç‚¹å‡»å¤–éƒ¨å…³é—­æ‰€æœ‰æ¨¡æ€æ¡†
        window.addEventListener('click', function(event) {
            const modals = ['records-modal', 'game-stats-modal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
        document.getElementById('show-game-stats').addEventListener('click', showGameStats);
        resetDeathCauses();
        // ä¿å­˜æˆ˜ç»©æŒ‰é’®äº‹ä»¶
        document.getElementById('save-record').addEventListener('click', () => {
            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            const saveBtn = document.getElementById('save-record');
            saveBtn.disabled = true;
            saveBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...`;
            
            // ä¸Šä¼ æœ¬æ¬¡æ¯”èµ›ç»“æœ
            uploadGameRecord(currentWin1, currentWin2).then(() => {
                // ä¸Šä¼ æˆåŠŸåæ›´æ–°æ˜¾ç¤º
                const historyWins1 = document.querySelector('.player-1-stats .history-wins');
                const historyWins2 = document.querySelector('.player-2-stats .history-wins');
                
                if (historyWins1 && historyWins2) {
                    // æ›´æ–°æ˜¾ç¤ºä¸ºå†å²æˆ˜ç»©+æœ¬æ¬¡ç»“æœ
                    historyWins1.textContent = player1Wins + currentWin1;
                    historyWins2.textContent = player2Wins + currentWin2;
                    
                    // éšè—+1æç¤º
                    const currentWinElements = document.querySelectorAll('.current-win');
                    currentWinElements.forEach(el => el.remove());
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    const progress1 = document.querySelector('.player-1-stats .progress-fill');
                    const progress2 = document.querySelector('.player-2-stats .progress-fill');
                    if (progress1 && progress2) {
                        progress1.style.width = `${calculateWinPercentage(player1Wins + currentWin1, player2Wins + currentWin2)}%`;
                        progress2.style.width = `${calculateWinPercentage(player2Wins + currentWin2, player1Wins + currentWin1)}%`;
                    }
                    
                    // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
                    showGameOverMessage('æˆ˜ç»©ä¿å­˜æˆåŠŸ!', '#4CAF50');
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    saveBtn.innerHTML = `<i class="fas fa-check"></i> å·²ä¿å­˜`;
                }
            }).catch(error => {
                console.error('ä¿å­˜æˆ˜ç»©å¤±è´¥:', error);
                showGameOverMessage('ä¿å­˜å¤±è´¥: ' + error.message, '#FF5722');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                saveBtn.disabled = false;
                saveBtn.innerHTML = `<i class="fas fa-save"></i> ä¿å­˜æˆ˜ç»©`;
            });
        });

        // æ˜¾ç¤ºæ¸¸æˆç»“æŸç•Œé¢
        gameOverScreen.classList.add('show');
        
        // æ·»åŠ åº†ç¥æ•ˆæœ
        if (winner !== 'draw') {
            createCelebrationEffect(winner === 'snake1' ? '#FF5722' : '#2196F3');
        }
    });
}

// ä¿®æ”¹ä¸Šä¼ æˆ˜ç»©å‡½æ•°ï¼Œç¡®ä¿åªä¸Šä¼ ä¸€æ¬¡
let hasUploaded = false;

function showGameOverMessage(message, color) {
    const messageEl = document.createElement('div');
    messageEl.className = 'game-over-message';
    messageEl.textContent = message;
    messageEl.style.color = color;
    
    const buttonsContainer = document.querySelector('.buttons-container');
    if (buttonsContainer) {
        buttonsContainer.insertAdjacentElement('beforebegin', messageEl);
        
        // 3ç§’åæ·¡å‡º
        setTimeout(() => {
            messageEl.style.opacity = '0';
            setTimeout(() => {
                messageEl.remove();
            }, 500);
        }, 3000);
    }
}

// è®¡ç®—èƒœç‡ç™¾åˆ†æ¯”
function calculateWinPercentage(wins, opponentWins) {
    const total = wins + opponentWins;
    return total > 0 ? Math.round((wins / total) * 100) : 50;
}


// åˆ›å»ºåº†ç¥æ•ˆæœ
function createCelebrationEffect(color) {
    const colors = [color, '#FFFFFF', '#FFD700'];
    
    for (let i = 0; i < 50; i++) {
        const particle = document.createElement('div');
        particle.className = 'celebration-particle';
        
        // éšæœºå±æ€§
        const size = 5 + Math.random() * 10;
        const duration = 1 + Math.random() * 2;
        const delay = Math.random() * 0.5;
        const distance = 50 + Math.random() * 100;
        const angle = Math.random() * Math.PI * 2;
        
        // è®¾ç½®æ ·å¼
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        particle.style.animationDuration = `${duration}s`;
        particle.style.animationDelay = `${delay}s`;
        
        // è®¾ç½®åˆå§‹ä½ç½®
        particle.style.left = '50%';
        particle.style.top = '30%';
        
        // è®¾ç½®åŠ¨ç”»ç»ˆç‚¹
        particle.style.setProperty('--tx', `${Math.cos(angle) * distance}px`);
        particle.style.setProperty('--ty', `${Math.sin(angle) * distance}px`);
        
        gameOverScreen.appendChild(particle);
        
        // åŠ¨ç”»ç»“æŸåç§»é™¤
        setTimeout(() => {
            particle.remove();
        }, duration * 1000);
    }
}
// è·å–æœåŠ¡å™¨è®°å½•
async function getServerRecords() {
    try {
        const userId = localStorage.getItem("userid");
        const player2UserId = localStorage.getItem("player2_userid");
        const currentUsername = localStorage.getItem("username");
        const player2Username = localStorage.getItem("player2_username");
        
        if (!userId || !player2UserId || !currentUsername || !player2Username) {
            return null;
        }
        
        // è·å–å½“å‰ç”¨æˆ·çš„è®°å½•
        const currentUserData = await getUserCustomData(userId);
        const player2Data = await getUserCustomData(player2UserId);
        
        let player1Wins = 0;
        let player2Wins = 0;
        
        // ä»å½“å‰ç”¨æˆ·æ•°æ®ä¸­è§£æ
        if (currentUserData) {
            const records = currentUserData.split(';');
            for (const record of records) {
                if (record.startsWith(`snakegame_record_with_${player2Username}`)) {
                    const parts = record.split(':')[1].split(',');
                    player1Wins += parseInt(parts[0]) || 0;
                    player2Wins += parseInt(parts[1]) || 0;
                }
            }
        }
        return {
            player1Wins,
            player2Wins
        };
    } catch (error) {
        console.error('è·å–æœåŠ¡å™¨è®°å½•å¤±è´¥:', error);
        return null;
    }
}
async function uploadGameRecord(player1Wins, player2Wins) {
    if (hasUploaded) {
        throw new Error('æˆ˜ç»©å·²ä¿å­˜ï¼Œè¯·å‹¿é‡å¤æäº¤');
    }
    
    try {
        const userId = localStorage.getItem("userid");
        const player2UserId = localStorage.getItem("player2_userid");
        const currentUsername = localStorage.getItem("username");
        const player2Username = localStorage.getItem("player2_username");
        
        if (!userId || !player2UserId || !currentUsername || !player2Username) {
            throw new Error('ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´');
        }
        
        // å‡†å¤‡ä¸Šä¼ çš„æ•°æ®
        const recordForCurrentUser = `snakegame_record_with_${player2Username}:${player1Wins},${player2Wins}`;
        const recordForPlayer2 = `snakegame_record_with_${currentUsername}:${player2Wins},${player1Wins}`;
        
        // è·å–å½“å‰ç”¨æˆ·çš„ç°æœ‰æ•°æ®
        const currentUserData = await getUserCustomData(userId);
        const player2Data = await getUserCustomData(player2UserId);
        
        // æ›´æ–°æ•°æ®
        const updatedCurrentUserData = updateRecord(currentUserData, recordForCurrentUser);
        const updatedPlayer2Data = updateRecord(player2Data, recordForPlayer2);
        
        // ä¸Šä¼ æ›´æ–°åçš„æ•°æ®
        await Promise.all([
            updateUserCustomData(userId, updatedCurrentUserData),
            updateUserCustomData(player2UserId, updatedPlayer2Data)
        ]);
        
        return true;
    } catch (error) {
        console.error('ä¸Šä¼ æˆ˜ç»©å¤±è´¥:', error);
        throw error;
    }
}
// è·å–ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®
async function getUserCustomData(userId) {
    try {
        const response = await fetch(`${serverurl}/get-custom-data-by-id`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                userId: userId
            })
        });
        
        const data = await response.json();
        if (data.success) {
            return data.data.customData || '';
        }
        throw new Error(data.message || 'è·å–ç”¨æˆ·æ•°æ®å¤±è´¥');
    } catch (error) {
        console.error('è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
        throw error;
    }
}

// æ›´æ–°è®°å½•
function updateRecord(currentData, newRecord) {
    if (!currentData) return newRecord;
    
    const recordKey = newRecord.split(':')[0];
    const records = currentData.split(';');
    let found = false;
    
    const updatedRecords = records.map(record => {
        if (record.startsWith(recordKey)) {
            found = true;
            const [oldP1Wins, oldP2Wins] = record.split(':')[1].split(',').map(Number);
            const [newP1Wins, newP2Wins] = newRecord.split(':')[1].split(',').map(Number);
            return `${recordKey}:${oldP1Wins + newP1Wins},${oldP2Wins + newP2Wins}`;
        }
        return record;
    });
    
    if (!found) {
        updatedRecords.push(newRecord);
    }
    
    return updatedRecords.filter(r => r).join(';');
}

// æ›´æ–°ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®
async function updateUserCustomData(userId, customData) {
    try {
        const response = await fetch(`${serverurl}/update-custom-data`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                userId: userId,
                customData: customData
            })
        });
        
        const data = await response.json();
        if (!data.success) {
            throw new Error(data.message || 'æ›´æ–°æ•°æ®å¤±è´¥');
        }
    } catch (error) {
        console.error('æ›´æ–°ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
        throw error;
    }
}
// åˆ›å»ºç²’å­æ•ˆæœ
function createParticles(x, y, count, color) {
    for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = `${x}px`;
        particle.style.top = `${y}px`;
        particle.style.backgroundColor = color;
        particle.style.animationDuration = `${2 + Math.random() * 3}s`;
        particle.style.animationDelay = `${Math.random() * 0.5}s`;
        
        // éšæœºå¤§å°
        const size = 2 + Math.random() * 6;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        
        // éšæœºæ–¹å‘
        const angle = Math.random() * Math.PI * 2;
        const distance = 5 + Math.random() * 20;
        particle.style.setProperty('--tx', `${Math.cos(angle) * distance}px`);
        particle.style.setProperty('--ty', `${Math.sin(angle) * distance}px`);
        
        particlesContainer.appendChild(particle);
        
        // åŠ¨ç”»ç»“æŸåç§»é™¤ç²’å­
        setTimeout(() => {
            particle.remove();
        }, 3000);
    }
}

// åˆ›å»ºèƒŒæ™¯å…ƒç´ 
function createBackgroundElements() {
    const colors = ['#FF5722', '#2196F3', '#4CAF50', '#FFC107', '#9C27B0'];
    
    for (let i = 0; i < 8; i++) {
        const element = document.createElement('div');
        element.className = 'bg-element';
        
        // éšæœºä½ç½®
        const left = Math.random() * 100;
        const top = Math.random() * 100;
        
        // éšæœºå¤§å°
        const size = 50 + Math.random() * 150;
        
        // éšæœºé¢œè‰²
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        element.style.left = `${left}%`;
        element.style.top = `${top}%`;
        element.style.width = `${size}px`;
        element.style.height = `${size}px`;
        element.style.backgroundColor = color;
        element.style.animationDuration = `${15 + Math.random() * 30}s`;
        element.style.animationDelay = `${Math.random() * 5}s`;
        
        document.body.appendChild(element);
    }
}

// åˆ›å»ºèƒŒæ™¯ç²’å­
function createBackgroundParticles() {
    for (let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = `${Math.random() * 100}%`;
        particle.style.top = `${Math.random() * 100}%`;
        particle.style.animationDuration = `${10 + Math.random() * 20}s`;
        particle.style.animationDelay = `${Math.random() * 5}s`;
        
        // éšæœºé¢œè‰²
        const hue = Math.random() * 360;
        particle.style.backgroundColor = `hsla(${hue}, 100%, 70%, 0.7)`;
        
        particlesContainer.appendChild(particle);
    }
}
let isTabKeyPressed = false;
// é”®ç›˜æ§åˆ¶
document.addEventListener('keydown', (e) => {
    // ä¿®æ”¹æ‰‹åŠ¨æš‚åœ/æ¢å¤çš„é€»è¾‘
if (e.key === 'q' || e.key === 'Q') {
    // å¦‚æœå•†åº—æ‰“å¼€ï¼Œä¸å…è®¸æ‰‹åŠ¨æš‚åœ/æ¢å¤
    if (storeOpen.snake1) {
        e.preventDefault();
        return;
    }
    
    // åˆ‡æ¢æš‚åœçŠ¶æ€
    pausedSnakes.snake1 = !pausedSnakes.snake1;
    
    // æ˜¾ç¤ºçŠ¶æ€æç¤º
    const head = snakes.snake1[0];
    showNotice(pausedSnakes.snake1 ? 'ç©å®¶1å·²æš‚åœ' : 'ç©å®¶1å·²æ¢å¤', 
              '#FF5722', head.x, head.y);
    
    // æ·»åŠ éŸ³æ•ˆæˆ–ç‰¹æ•ˆï¼ˆå¯é€‰ï¼‰
    if (pausedSnakes.snake1) {
        // æš‚åœç‰¹æ•ˆ
        createParticles(head.x + 10, head.y + 10, 10, '#FF5722');
    } else {
        // æ¢å¤ç‰¹æ•ˆ
        createParticles(head.x + 10, head.y + 10, 10, '#4CAF50');
    }
    
    e.preventDefault();
    return;
}

if (e.key === '/' || e.key === '?') {
    // å¦‚æœå•†åº—æ‰“å¼€ï¼Œä¸å…è®¸æ‰‹åŠ¨æš‚åœ/æ¢å¤
    if (storeOpen.snake2) {
        e.preventDefault();
        return;
    }
    
    // åˆ‡æ¢æš‚åœçŠ¶æ€
    pausedSnakes.snake2 = !pausedSnakes.snake2;
    
    // æ˜¾ç¤ºçŠ¶æ€æç¤º
    const head = snakes.snake2[0];
    showNotice(pausedSnakes.snake2 ? 'ç©å®¶2å·²æš‚åœ' : 'ç©å®¶2å·²æ¢å¤', 
              '#2196F3', head.x, head.y);
    
    // æ·»åŠ éŸ³æ•ˆæˆ–ç‰¹æ•ˆï¼ˆå¯é€‰ï¼‰
    if (pausedSnakes.snake2) {
        // æš‚åœç‰¹æ•ˆ
        createParticles(head.x + 10, head.y + 10, 10, '#2196F3');
    } else {
        // æ¢å¤ç‰¹æ•ˆ
        createParticles(head.x + 10, head.y + 10, 10, '#4CAF50');
    }
    
    e.preventDefault();
    return;
}
    // é˜²æ­¢é»˜è®¤è¡Œä¸º
    if (e.key === ' ' || e.key === 'Enter') {
        e.preventDefault();
    }
    
    // === å•†åº—æ§åˆ¶é€»è¾‘ ===
    // ç©å®¶1å•†åº—ï¼šEé”®æ‰“å¼€/å…³é—­
    if (e.key === 'e' || e.key === 'E') {
        openStore('snake1');
        e.preventDefault();
        return;
    }
    
    // ç©å®¶2å•†åº—ï¼š.æˆ–>é”®æ‰“å¼€/å…³é—­
    if (e.key === '+' || e.key === '+') {
        openStore('snake2');
        e.preventDefault();
        return;
    }
    
    // === å•†åº—å†…æ§åˆ¶ï¼ˆä¿®æ”¹è¿™é‡Œï¼‰===
    // ç©å®¶1å•†åº—å†…æ§åˆ¶ - åªé˜»æ­¢ç©å®¶1çš„æ§åˆ¶é”®
    if (storeOpen.snake1) {
        // W/Sé€‰æ‹©
        if (e.key === 'w' || e.key === 'W' || e.key === 's' || e.key === 'S') {
            if (e.key === 'w' || e.key === 'W') {
                storeSelectedItem.snake1 = Math.max(0, storeSelectedItem.snake1 - 1);
            } else {
                storeSelectedItem.snake1 = Math.min(storeItems.length - 1, storeSelectedItem.snake1 + 1);
            }
            updateStoreDisplay('snake1');
            e.preventDefault();
            return;
        }
        
        // Ré”®è´­ä¹°å¹¶å…³é—­
        if (e.key === 'r' || e.key === 'R') {
            const selectedItem = storeItems[storeSelectedItem.snake1];
            const upgradeLevel = playerUpgrades.snake1[selectedItem.id.split('_')[0]] || 0;
            const isMaxLevel = selectedItem.type === 'upgrade' && selectedItem.maxLevel && upgradeLevel >= selectedItem.maxLevel;
            const canAfford = scores.snake1 >= selectedItem.price && !isMaxLevel;
            
            if (canAfford) {
                buyStoreItem('snake1');
                setTimeout(() => closeStore('snake1'), 300);
            } else {
                const head = snakes.snake1[0];
                if (isMaxLevel) {
                    showNotice('å·²ç»è¾¾åˆ°æœ€å¤§ç­‰çº§!', '#FF0000', head.x, head.y);
                } else {
                    showNotice('åˆ†æ•°ä¸è¶³!', '#FF0000', head.x, head.y);
                }
            }
            e.preventDefault();
            return;
        }
        
        // Eé”®å…³é—­å•†åº—
        if (e.key === 'e' || e.key === 'E') {
            closeStore('snake1');
            e.preventDefault();
            return;
        }
    }
    
    // ç©å®¶2å•†åº—å†…æ§åˆ¶ - åªé˜»æ­¢ç©å®¶2çš„æ§åˆ¶é”®
    if (storeOpen.snake2) {
        // ä¸Šä¸‹æ–¹å‘é”®é€‰æ‹©
        if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
            if (e.key === 'ArrowUp') {
                storeSelectedItem.snake2 = Math.max(0, storeSelectedItem.snake2 - 1);
            } else {
                storeSelectedItem.snake2 = Math.min(storeItems.length - 1, storeSelectedItem.snake2 + 1);
            }
            updateStoreDisplay('snake2');
            e.preventDefault();
            return;
        }
        
        // Enteré”®è´­ä¹°å¹¶å…³é—­
        if (e.key === 'Enter') {
            const selectedItem = storeItems[storeSelectedItem.snake2];
            const upgradeLevel = playerUpgrades.snake2[selectedItem.id.split('_')[0]] || 0;
            const isMaxLevel = selectedItem.type === 'upgrade' && selectedItem.maxLevel && upgradeLevel >= selectedItem.maxLevel;
            const canAfford = scores.snake2 >= selectedItem.price && !isMaxLevel;
            
            if (canAfford) {
                buyStoreItem('snake2');
                setTimeout(() => closeStore('snake2'), 300);
            } else {
                const head = snakes.snake2[0];
                if (isMaxLevel) {
                    showNotice('å·²ç»è¾¾åˆ°æœ€å¤§ç­‰çº§!', '#FF0000', head.x, head.y);
                } else {
                    showNotice('åˆ†æ•°ä¸è¶³!', '#FF0000', head.x, head.y);
                }
            }
            e.preventDefault();
            return;
        }
        
        // .æˆ–>é”®å…³é—­å•†åº—
        if (e.key === '+' || e.key === '+') {
            closeStore('snake2');
            e.preventDefault();
            return;
        }
    }
    
    // === åŸæœ‰æ¸¸æˆæ§åˆ¶é€»è¾‘ ===
    // æ³¨æ„ï¼šè¿™é‡Œä¸å†é˜»æ­¢æ‰€æœ‰æŒ‰é”®ï¼Œåªé˜»æ­¢ç‰¹å®šå•†åº—æ§åˆ¶é”®
    
    // æ£€æŸ¥è›‡æ˜¯å¦æš‚åœ
    if (pausedSnakes.snake1 && isPlayer1ControlKey(e.key)) {
        // å¦‚æœè›‡1æš‚åœï¼Œåªé˜»æ­¢ç©å®¶1çš„æ§åˆ¶é”®
        if (isPlayer1ControlKey(e.key)) {
            e.preventDefault();
            return;
        }
    }
    
    if (pausedSnakes.snake2 && isPlayer2ControlKey(e.key)) {
        // å¦‚æœè›‡2æš‚åœï¼Œåªé˜»æ­¢ç©å®¶2çš„æ§åˆ¶é”®
        if (isPlayer2ControlKey(e.key)) {
            e.preventDefault();
            return;
        }
    }
    // é˜»æ­¢ç©ºæ ¼å’ŒEnteré”®çš„é»˜è®¤è¡Œä¸ºï¼Œé¿å…è§¦å‘æŒ‰é’®ç‚¹å‡»
    if (e.key === ' ' || e.key === 'Enter') {
        e.preventDefault();
    }
    
    if (!gameStarted) return;
    if (e.key >= '1' && e.key <= '5') {
        const slotIndex = parseInt(e.key) - 1;
        releaseBall('snake1', slotIndex);
        return;
    }
    
    // ç©å®¶2é‡Šæ”¾çƒä½“ (æŒ‰é”®6-0)
    if ((e.key >= '6' && e.key <= '9') || e.key === '0') {
        const slotIndex = e.key === '0' ? 4 : parseInt(e.key) - 6;
        releaseBall('snake2', slotIndex);
        return;
    }
    if (e.key === 'q' || e.key === 'Q') {
        pausedSnakes.snake1 = !pausedSnakes.snake1;
        showNotice(pausedSnakes.snake1 ? 'ç©å®¶1å·²æš‚åœ' : 'ç©å®¶1å·²æ¢å¤', 
                  '#FF5722', snakes.snake1[0].x, snakes.snake1[0].y);
        return;
    }
    
    if (e.key === '/' || e.key === '?') {
        pausedSnakes.snake2 = !pausedSnakes.snake2;
        showNotice(pausedSnakes.snake2 ? 'ç©å®¶2å·²æš‚åœ' : 'ç©å®¶2å·²æ¢å¤', 
                  '#2196F3', snakes.snake2[0].x, snakes.snake2[0].y);
        return;
    }    
    // å¤„ç†ç©å®¶1æ§åˆ¶ (WASD)
    if (reversedControls.snake1) {
        // åå‘æ§åˆ¶
        switch (e.key) {
            case 'w':
            case 'W':
                if (directions.snake1 !== 'up') nextDirections.snake1 = 'down';
                break;
            case 's':
            case 'S':
                if (directions.snake1 !== 'down') nextDirections.snake1 = 'up';
                break;
            case 'a':
            case 'A':
                if (directions.snake1 !== 'left') nextDirections.snake1 = 'right';
                break;
            case 'd':
            case 'D':
                if (directions.snake1 !== 'right') nextDirections.snake1 = 'left';
                break;
        }
    } else {
        // æ­£å¸¸æ§åˆ¶
        switch (e.key) {
            case 'w':
            case 'W':
                if (directions.snake1 !== 'down') nextDirections.snake1 = 'up';
                break;
            case 's':
            case 'S':
                if (directions.snake1 !== 'up') nextDirections.snake1 = 'down';
                break;
            case 'a':
            case 'A':
                if (directions.snake1 !== 'right') nextDirections.snake1 = 'left';
                break;
            case 'd':
            case 'D':
                if (directions.snake1 !== 'left') nextDirections.snake1 = 'right';
                break;
        }
    }
    
    // å¤„ç†ç©å®¶2æ§åˆ¶ (æ–¹å‘é”®)
    if (reversedControls.snake2) {
        // åå‘æ§åˆ¶
        switch (e.key) {
            case 'ArrowUp':
                if (directions.snake2 !== 'up') nextDirections.snake2 = 'down';
                break;
            case 'ArrowDown':
                if (directions.snake2 !== 'down') nextDirections.snake2 = 'up';
                break;
            case 'ArrowLeft':
                if (directions.snake2 !== 'left') nextDirections.snake2 = 'right';
                break;
            case 'ArrowRight':
                if (directions.snake2 !== 'right') nextDirections.snake2 = 'left';
                break;
        }
    } else {
        // æ­£å¸¸æ§åˆ¶
        switch (e.key) {
            case 'ArrowUp':
                if (directions.snake2 !== 'down') nextDirections.snake2 = 'up';
                break;
            case 'ArrowDown':
                if (directions.snake2 !== 'up') nextDirections.snake2 = 'down';
                break;
            case 'ArrowLeft':
                if (directions.snake2 !== 'right') nextDirections.snake2 = 'left';
                break;
            case 'ArrowRight':
                if (directions.snake2 !== 'left') nextDirections.snake2 = 'right';
                break;
        }
    }
});
function isPlayer1ControlKey(key) {
    const player1Keys = ['w', 'W', 's', 'S', 'a', 'A', 'd', 'D', 'q', 'Q'];
    const player1Numbers = ['1', '2', '3', '4', '5'];
    return player1Keys.includes(key) || player1Numbers.includes(key);
}

function isPlayer2ControlKey(key) {
    const player2Keys = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
    const player2Numbers = ['6', '7', '8', '9', '0'];
    const player2Special = ['/', '?'];
    return player2Keys.includes(key) || player2Numbers.includes(key) || player2Special.includes(key);
}
// å¼€å§‹æ¸¸æˆæŒ‰é’®
startBtn.addEventListener('click', () => {
    const player1Name = localStorage.getItem('username') || 'ç©å®¶1';
    document.getElementById('player1-name').textContent = player1Name + ': ';
    player2Name=localStorage.getItem("player2_username");
    if(!player2Name){
        loginPlayer2();
    }
    startBtn.style.animation = 'buttonClick 0.5s forwards';
    
    // å¼€å§‹å±å¹•é€€å‡ºåŠ¨ç”»
    startScreen.style.animation = 'startScreenExit 0.8s forwards';
    
    setTimeout(() => {
        startScreen.classList.add('hide');
        initGame();
    }, 800);
});

// é‡æ–°å¼€å§‹æŒ‰é’®
restartBtn.addEventListener('click', () => {
    gameOverScreen.classList.remove('show');
    setTimeout(() => {
        initGame();
    }, 300);
});

// åˆå§‹åŒ–èƒŒæ™¯ç²’å­
createBackgroundParticles();

// æ·»åŠ CSSåŠ¨ç”»
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeOut {
        to { opacity: 0; transform: translate(-50%, -100%); }
    }
    @keyframes buttonClick {
        50% { transform: scale(0.9); }
        100% { transform: scale(1); }
    }
    @keyframes startScreenExit {
        to { opacity: 0; transform: scale(1.2); }
    }
`;
document.head.appendChild(style);

// æ·»åŠ è§’è‰²é€‰æ‹©ç•Œé¢äº¤äº’é€»è¾‘
document.addEventListener('DOMContentLoaded', function() {
    const startScreen = document.querySelector('.start-screen');
    const startBtn = document.querySelector('.start-btn');
    const snakeOptions = document.querySelectorAll('.snake-option');
    const startGameBtn = document.querySelector('.start-game-btn');
    
    // å¼€å§‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    startBtn.addEventListener('click', () => {
        startScreen.classList.add('hide');
        setTimeout(() => {
            characterSelection.classList.add('show');
        }, 500);
    });
    
    // è›‡ç±»å‹é€‰æ‹©äº‹ä»¶
    snakeOptions.forEach(option => {
        option.addEventListener('click', function() {
            const player = this.getAttribute('data-player');
            const type = this.getAttribute('data-type');
            
            // ç§»é™¤åŒç©å®¶çš„å…¶ä»–é€‰æ‹©
            document.querySelectorAll(`.snake-option[data-player="${player}"]`).forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // æ·»åŠ å½“å‰é€‰æ‹©
            this.classList.add('selected');
            
            // ä¿å­˜é€‰æ‹©
            snakeTypes[`snake${player}`] = type;
            
            // æ£€æŸ¥æ˜¯å¦ä¸¤ä½ç©å®¶éƒ½å·²é€‰æ‹©
            if (snakeTypes.snake1 && snakeTypes.snake2) {
                startGameBtn.disabled = false;
            }
        });
    });
    
// ä¿®æ”¹è§’è‰²é€‰æ‹©åçš„æµç¨‹
document.querySelector('.character-selection .start-game-btn').addEventListener('click', () => {
    characterSelection.classList.remove('show');
    setTimeout(() => {
        document.querySelector('.map-selection').classList.add('show');
    }, 500);
});

// åœ°å›¾é€‰æ‹©äº¤äº’
document.querySelectorAll('.map-option').forEach(option => {
    option.addEventListener('click', function() {
        document.querySelectorAll('.map-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        this.classList.add('selected');
        currentMap = this.getAttribute('data-map');
        document.querySelector('.map-selection .start-game-btn').disabled = false;
    });
});

// å¼€å§‹æ¸¸æˆæŒ‰é’®
document.querySelector('.map-selection .start-game-btn').addEventListener('click', () => {
    document.querySelector('.map-selection').classList.remove('show');
    setTimeout(() => {
        initGame();
    }, 500);
});});

        // æ·»åŠ ç©å®¶2ç™»å½•åŠŸèƒ½
function loginPlayer2() {
        document.querySelector('.map-selection .start-game-btn').style.display = 'none';
    swal({
        title: "ç©å®¶2ç™»å½•",
        text: "è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ",
        type: "input",
        inputType: "text",
        inputPlaceholder: "è¯·è¾“å…¥ç”¨æˆ·å",
        showCancelButton: true,
        cancelButtonText: "å–æ¶ˆ",
        confirmButtonText: "ä¸‹ä¸€æ­¥",
        closeOnConfirm: false
    }, function(username) {
        if (username === false) return false;
        if (!username) {
            swal.showInputError("è¯·è¾“å…¥ç”¨æˆ·å");
            return false;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ç©å®¶1ç”¨æˆ·åç›¸åŒ
        const player1Username = localStorage.getItem('username');
        if (player1Username && username === player1Username) {
            swal.showInputError("ç”¨æˆ·åä¸èƒ½ä¸ç©å®¶1ç›¸åŒ");
            return false;
        }
        
        // ç¬¬äºŒæ­¥ï¼šè¯¢é—®å¯†ç 
        swal({
            title: "ç©å®¶2ç™»å½•",
            text: "è¯·è¾“å…¥å¯†ç ",
            type: "input",
            inputType: "password",
            inputPlaceholder: "è¯·è¾“å…¥å¯†ç ",
            showCancelButton: true,
            cancelButtonText: "ä¸Šä¸€æ­¥",
            confirmButtonText: "ç™»å½•",
            closeOnConfirm: false
        }, function(password) {
            if (password === false) {
                // ç‚¹å‡»å–æ¶ˆè¿”å›ä¸Šä¸€æ­¥
                loginPlayer2();
                return false;
            }
            if (!password) {
                swal.showInputError("è¯·è¾“å…¥å¯†ç ");
                return false;
            }
            
            // å‘é€ç™»å½•è¯·æ±‚
            fetch(`${serverurl}/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            })
            .then(response => response.text())
            .then(data => {
                if (data.includes('<h1>ç™»å½•æˆåŠŸ</h1>')) {
                    localStorage.setItem('player2_username', username);
                    fetch(`${serverurl}/get-user-id-by-username`, {
                                method: 'POST', // æŒ‡å®šè¯·æ±‚æ–¹æ³•
                                headers: {
                                    'Content-Type': 'application/json' // è®¾ç½®è¯·æ±‚å¤´
                                },
                                body: JSON.stringify({ username: username }) // è¯·æ±‚ä½“
                            })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Network response was not ok');
                                    }
                                    return response.json(); // è§£æJSONæ•°æ®
                                })
                                .then(data => {
                                    // å¤„ç†è¿”å›çš„æ•°æ®
                                    if (data.success) {
                                        // å‡è®¾data.dataä¸­åŒ…å«userId
                                        const userId = data.data.userId;
                                        localStorage.setItem("player2_userid",userId);
                                        document.getElementById('player2-name').textContent = username + ': ';
                                        document.getElementById("player-label1").textContent =localStorage.getItem("username") + "(æ©™è‰²)";
                                        document.getElementById("player-label2").textContent =localStorage.getItem("player2_username") + "(è“è‰²)";
                                        document.getElementById("storage-title1").textContent =localStorage.getItem("username") + "å‚¨å­˜:";
                                        document.getElementById("storage-title2").textContent =localStorage.getItem("player2_username") + "å‚¨å­˜:";
                                        document.querySelector('.map-selection .start-game-btn').style.display = "block";               
                                        swal("ç™»å½•æˆåŠŸ", "ç©å®¶2å·²ç™»å½•", "success");
                                    } else {
                                        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                                        console.log(data.message);
                                    }
                                })
                                .catch(error => {
                                    // å¤„ç†è¯·æ±‚è¿‡ç¨‹ä¸­çš„é”™è¯¯
                                    console.error('Fetch error:', error);
                                });
                } else if (data.includes('ç™»å½•å¤±è´¥')) {
                    swal("ç™»å½•å¤±è´¥", 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', 'error');
                    document.querySelector('.start-game-btn').style.display = "none";
                }
            })
            .catch(error => {
                console.error(error);
                swal("è¯·æ±‚å¤±è´¥", "è¯·ç¨åé‡è¯•", "error");
            });
        });
    });
}
// è›‡ç±»è¯¦ç»†æ•°æ®
const snakeDetails = {
    speed: {
        title: "é€Ÿåº¦è›‡",
        color: "#FFD700",
        ratings: [
            { name: "ç”Ÿå‘½", value: 3, max: 5 },
            { name: "é€Ÿåº¦", value: 5, max: 5 },
            { name: "é­”æ³•", value: 1, max: 5 }
        ],
        attributes: [
            { 
                name: "ç§»åŠ¨é€Ÿåº¦", 
                value: "<span class='speed-icon'></span> +50%", 
                desc: "ç§»åŠ¨é—´éš”å‡å°‘50%ï¼Œæ¯”æ™®é€šè›‡å¿«ä¸€å€" 
            },
            { 
                name: "ç”Ÿå‘½å€¼", 
                value: "<span class='health-icon'></span> 10HP", 
                desc: "æ ‡å‡†ç”Ÿå‘½å€¼ï¼Œç¢°æ’ä¼šå—åˆ°æ­£å¸¸ä¼¤å®³" 
            },
            { 
                name: "ç‰¹æ®Šèƒ½åŠ›", 
                value: "æ— ", 
                desc: "ä¸“æ³¨äºé«˜é€Ÿç§»åŠ¨ï¼Œæ²¡æœ‰å…¶ä»–ç‰¹æ®Šèƒ½åŠ›" 
            }
        ],
        tips: "é€‚åˆå–œæ¬¢å¿«èŠ‚å¥ã€é«˜æ“ä½œçš„ç©å®¶ã€‚åˆ©ç”¨é€Ÿåº¦ä¼˜åŠ¿å¿«é€ŸåŒ…å›´å¯¹æ‰‹ã€‚"
    },
    tough: {
        title: "åšç¡¬è›‡",
        color: "#C0C0C0",
        ratings: [
            { name: "ç”Ÿå‘½", value: 5, max: 5 },
            { name: "é€Ÿåº¦", value: 2, max: 5 },
            { name: "é­”æ³•", value: 1, max: 5 }
        ],
        attributes: [
            { 
                name: "ç”Ÿå‘½å€¼", 
                value: "<span class='health-icon'></span> 10HP(ä¸Šé™15)", 
                desc: "1.5å€ç”Ÿå‘½å€¼ï¼Œç”Ÿå­˜èƒ½åŠ›æ›´å¼º" 
            },
            { 
                name: "è¿›æ”»", 
                value: "æ’å‡»åˆ«äººä¼¤å®³å¢åŠ ", 
                desc: "ä»…æœ‰0.5æ¦‚ç‡å—åˆ°å­å¼¹ä¼¤å®³" 
            },
            { 
                name: "é€Ÿåº¦", 
                value: "æ ‡å‡†é€Ÿåº¦", 
                desc: "ç§»åŠ¨é€Ÿåº¦è¾ƒæ…¢" 
            }
        ],
        tips: "é€‚åˆç¨³å¥å‹ç©å®¶ã€‚é«˜ç”Ÿå‘½å€¼è®©ä½ å¯ä»¥æ‰¿å—æ›´å¤šå¤±è¯¯ï¼Œä½†è¦æ³¨æ„å­å¼¹ä¼¤å®³ä¸å‡ã€‚"
    },
    magic: {
        title: "é­”æ³•è›‡",
        color: "#9C27B0",
        ratings: [
            { name: "ç”Ÿå‘½", value: 3, max: 5 },
            { name: "é€Ÿåº¦", value: 3, max: 5 },
            { name: "é­”æ³•", value: 5, max: 5 }
        ],
        attributes: [
            { 
                name: "ç§»åŠ¨é€Ÿåº¦", 
                value: "<span class='speed-icon'></span> +15%", 
                desc: "æ¯”åšç¡¬è›‡ç¨å¿«ï¼Œä½†ä¸å¦‚é€Ÿåº¦è›‡" 
            },
            { 
                name: "æ•ˆæœæ—¶é•¿", 
                value: "<span class='magic-icon'></span> +50%", 
                desc: "æ‰€æœ‰ç‰¹æ®Šçƒæ•ˆæœæ—¶é—´å»¶é•¿50%" 
            },
            { 
                name: "è‡ªåŠ¨è·å¾—", 
                value: "æ¯20ç§’", 
                desc: "è‡ªåŠ¨è·å¾—ä¸€ä¸ªéšæœºç‰¹æ®Šçƒ(æ”»å‡»40%/è¡€çƒ30%/æ— æ•Œ20%/åè½¬10%)" 
            }
        ],
        tips: "é€‚åˆç­–ç•¥å‹ç©å®¶ã€‚åˆç†è§„åˆ’ç‰¹æ®Šçƒä½¿ç”¨æ—¶æœºï¼Œæ•ˆæœå»¶é•¿è®©ä½ æ›´æœ‰ä¼˜åŠ¿ã€‚"
    }
};

// æ˜¾ç¤ºè›‡ç±»è¯¦æƒ…
function showSnakeDetails(type) {
    const detail = snakeDetails[type];
    const modal = document.getElementById('snake-details-modal');
    const content = document.getElementById('snake-details-content');
    
    content.innerHTML = `
        <div class="snake-type-title" style="color: ${detail.color}">
            ${detail.title}
        </div>
        
        <!-- æ˜Ÿçº§è¯„åˆ† -->
        <div style="margin:15px 0;display:flex;justify-content:center;background:rgba(255,255,255,0.1);padding:10px;border-radius:8px;">
            ${detail.ratings.map(rating => `
                <div class="star-rating ${rating.name.toLowerCase()}-rating">
                    ${rating.name}:
                    ${'â˜…'.repeat(rating.value)}${'â˜†'.repeat(rating.max - rating.value)}
                    <span class="rating-value">${rating.value}/${rating.max}</span>
                </div>
            `).join('')}
        </div>
        
        ${detail.attributes.map(attr => `
            <div class="snake-attribute">
                <div class="attribute-name">${attr.name}:</div>
                <div class="attribute-value">
                    <div>${attr.value}</div>
                    <div style="font-size:12px;color:#ccc">${attr.desc}</div>
                </div>
            </div>
        `).join('')}
        
        <div style="margin-top:20px;padding:10px;background:rgba(255,255,255,0.1);border-radius:8px;">
            <strong>ç©æ³•æç¤ºï¼š</strong> ${detail.tips}
        </div>
    `;
    
    modal.style.display = 'block';
}

// ä¸ºæ‰€æœ‰è›‡ç±»é€‰é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
document.querySelectorAll('.snake-option').forEach(option => {
    option.addEventListener('click', function(e) {
        // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…ä¸é€‰æ‹©é€»è¾‘å†²çª
        if (e.target === this || e.target.classList.contains('snake-type')) {
            const type = this.getAttribute('data-type');
            showSnakeDetails(type);
        }
    });
});

// å…³é—­å¼¹çª—
document.querySelector('.close-modal').addEventListener('click', function() {
    document.getElementById('snake-details-modal').style.display = 'none';
});

// ç‚¹å‡»å¤–éƒ¨å…³é—­
window.addEventListener('click', function(event) {
    if (event.target === document.getElementById('snake-details-modal')) {
        document.getElementById('snake-details-modal').style.display = 'none';
    }
});
// æˆ˜ç»©æŸ¥è¯¢åŠŸèƒ½
document.getElementById('view-records').addEventListener('click', showAllRecords);

// æ˜¾ç¤ºæ‰€æœ‰æˆ˜ç»©è®°å½•
async function showAllRecords() {
    try {
        const modal = document.getElementById('records-modal');
        const container = document.getElementById('records-container');
        modal.style.zIndex = "100";
        // æ˜¾ç¤ºåŠ è½½ä¸­
        container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
        modal.style.display = 'block';
        
        // è·å–æ‰€æœ‰ç”¨æˆ·æ•°æ®
        const response = await fetch(`${serverurl}/get-all-custom-data`);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error('è·å–æ•°æ®å¤±è´¥');
        }
        
        // å¤„ç†å¹¶æ˜¾ç¤ºæ•°æ®
        displayRecords(data.data);
        
        // æ·»åŠ æœç´¢åŠŸèƒ½
        document.getElementById('search-username').addEventListener('input', (e) => {
            filterRecords(e.target.value, data.data);
        });
        
        // åˆ·æ–°æŒ‰é’®
        document.getElementById('refresh-records').addEventListener('click', showAllRecords);
        
    } catch (error) {
        console.error('è·å–æˆ˜ç»©å¤±è´¥:', error);
        document.getElementById('records-container').innerHTML = 
            `<div class="error">è·å–æˆ˜ç»©å¤±è´¥: ${error.message}</div>`;
    }
}

// æ˜¾ç¤ºæˆ˜ç»©è®°å½•
function displayRecords(users) {
    const container = document.getElementById('records-container');
    container.innerHTML = '';
    
    if (!users || users.length === 0) {
        container.innerHTML = '<div class="no-data">æš‚æ— æˆ˜ç»©æ•°æ®</div>';
        return;
    }
    
    // å¤„ç†æ¯ä¸ªç”¨æˆ·çš„è®°å½•
    users.forEach(user => {
        if (!user.customData) return;
        
        // è§£æå¯¹æˆ˜è®°å½•
        const records = parseRecords(user.customData);
        if (records.length === 0) return;
        
        // è®¡ç®—æ€»èƒœç‡
        const stats = calculateStats(records);
        
        // åˆ›å»ºè®°å½•å…ƒç´ 
        const recordElement = document.createElement('div');
        recordElement.className = 'record-item';
        recordElement.innerHTML = `
            
            <div class="record-details">
                <div class="record-username">${user.username}</div>
                <div class="record-stats">
                    <div class="record-stat">æ€»åœºæ¬¡: ${stats.totalMatches}</div>
                    <div class="record-stat">æ€»èƒœåœº: ${stats.totalWins}</div>
                    <div class="record-stat">èƒœç‡: ${stats.winRate}%</div>
                </div>
                ${records.map(record => `
                    <div class="record-match">
                        <div class="record-match-opponent">
                            
                            <span>å¯¹æˆ˜ ${record.opponentName}</span>
                        </div>
                        <div>æˆ˜ç»©: ${record.wins}èƒœ ${record.losses}è´Ÿ</div>
                        <div>èƒœç‡: ${record.winRate}%</div>
                    </div>
                `).join('')}
            </div>
        `;
        
        container.appendChild(recordElement);
    });
}

// è¿‡æ»¤è®°å½•
function filterRecords(searchTerm, allUsers) {
    const filteredUsers = allUsers.filter(user => {
        // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦åŒ¹é…
        if (user.username.toLowerCase().includes(searchTerm.toLowerCase())) {
            return true;
        }
        
        // æ£€æŸ¥å¯¹æˆ˜è®°å½•ä¸­æ˜¯å¦åŒ…å«æœç´¢è¯
        if (user.customData && user.customData.toLowerCase().includes(searchTerm.toLowerCase())) {
            return true;
        }
        
        return false;
    });
    
    displayRecords(filteredUsers);
}

// è§£æè®°å½•æ•°æ®
function parseRecords(customData) {
    if (!customData) return [];
    
    const records = [];
    const recordStrings = customData.split(';');
    
    recordStrings.forEach(str => {
        if (!str.startsWith('snakegame_record_with_')) return;
        
        const parts = str.split(':');
        if (parts.length !== 2) return;
        
        const opponentName = parts[0].replace('snakegame_record_with_', '');
        const [wins, losses] = parts[1].split(',').map(Number);
        
        if (isNaN(wins) || isNaN(losses)) return;
        
        const total = wins + losses;
        const winRate = total > 0 ? Math.round((wins / total) * 100) : 0;
        
        records.push({
            opponentName,
            wins,
            losses,
            winRate,
            opponentAvatar: `${serverurl}/get-icon-by-id?username=${encodeURIComponent(opponentName)}`
        });
    });
    
    return records;
}

// è®¡ç®—ç»Ÿè®¡æ•°æ®
function calculateStats(records) {
    let totalWins = 0;
    let totalLosses = 0;
    
    records.forEach(record => {
        totalWins += record.wins;
        totalLosses += record.losses;
    });
    
    const totalMatches = totalWins + totalLosses;
    const winRate = totalMatches > 0 ? Math.round((totalWins / totalMatches) * 100) : 0;
    
    return {
        totalMatches,
        totalWins,
        totalLosses,
        winRate
    };
}

// å…³é—­æ¨¡æ€æ¡†
document.querySelectorAll('.close-modal').forEach(btn => {
    btn.addEventListener('click', function() {
        document.getElementById('records-modal').style.display = 'none';
    });
});

// ç‚¹å‡»å¤–éƒ¨å…³é—­
window.addEventListener('click', function(event) {
    if (event.target === document.getElementById('records-modal')) {
        document.getElementById('records-modal').style.display = 'none';
    }
});
// ä¿®æ”¹åçš„æ‰“å¼€å•†åº—å‡½æ•°
function openStore(snakeId) {
    if (gameOverScreen.classList.contains('show')) return;
    
    // ç§»é™¤æ£€æŸ¥å…¶ä»–å•†åº—æ˜¯å¦å·²æ‰“å¼€çš„ä»£ç 
    // const otherSnakeId = snakeId === 'snake1' ? 'snake2' : 'snake1';
    // if (storeOpen[otherSnakeId]) {
    //     // å…ˆå…³é—­å…¶ä»–å•†åº—
    //     closeStore(otherSnakeId);
    // }
    
    const storeId = snakeId === 'snake1' ? 'store-player1' : 'store-player2';
    const storeElement = document.getElementById(storeId);
    
    // å¦‚æœå•†åº—å·²ç»æ‰“å¼€ï¼Œåˆ™å…³é—­å®ƒï¼ˆåˆ‡æ¢åŠŸèƒ½ï¼‰
    if (storeOpen[snakeId]) {
        closeStore(snakeId);
        return;
    }
    
    // æš‚åœè›‡çš„ç§»åŠ¨
    pausedSnakes[snakeId] = true;
    
    // å¦‚æœä¸¤ä¸ªå•†åº—éƒ½æ‰“å¼€ï¼Œä¸éœ€è¦é‡å¤æ·»åŠ æ¨¡ç³Šæ•ˆæœ
    
    // æ›´æ–°å•†åº—ä¿¡æ¯
    updateStoreDisplay(snakeId);
    
    // æ˜¾ç¤ºå•†åº—
    storeElement.style.display = 'flex';
    storeOpen[snakeId] = true;
    
    // æ˜¾ç¤ºå•†åº—æç¤º
    const head = snakes[snakeId][0];
    showNotice('å•†åº—å·²æ‰“å¼€', snakeId === 'snake1' ? '#FF5722' : '#2196F3', head.x, head.y);
}

// å…³é—­å•†åº—
function closeStore(snakeId) {
    const storeId = snakeId === 'snake1' ? 'store-player1' : 'store-player2';
    const storeElement = document.getElementById(storeId);
    
    // æ¢å¤è›‡çš„ç§»åŠ¨
    pausedSnakes[snakeId] = false;
    
    // ç§»é™¤æ¨¡ç³Šæ•ˆæœ
    
    // éšè—å•†åº—
    storeElement.style.display = 'none';
    storeOpen[snakeId] = false;
    
    // é‡ç½®é€‰æ‹©
    storeSelectedItem[snakeId] = 0;
    
    // æ˜¾ç¤ºå…³é—­æç¤º
    const head = snakes[snakeId][0];
}

// æ›´æ–°å•†åº—æ˜¾ç¤º
// ä¿®æ”¹updateStoreDisplayå‡½æ•°ï¼Œæ·»åŠ æŠ¤ç›¾æ£€æŸ¥
// ä¿®æ”¹updateStoreDisplayå‡½æ•°ï¼Œä¿®å¤å˜é‡ä½œç”¨åŸŸé—®é¢˜
function updateStoreDisplay(snakeId) {
    const playerNum = snakeId === 'snake1' ? '1' : '2';
    const storeItemsElement = document.getElementById(`store-player${playerNum}-items`);
    const storeScoreElement = document.getElementById(`store-player${playerNum}-score`);
    const storeNameElement = document.getElementById(`store-player${playerNum}-name`);
    const storeBuyBtn = document.getElementById(`store-player${playerNum}-buy`);
    
    // æ›´æ–°ç©å®¶åç§°å’Œåˆ†æ•°
    const playerName = snakeId === 'snake1' ? 
        localStorage.getItem('username') || 'ç©å®¶1' : 
        localStorage.getItem('player2_username') || 'ç©å®¶2';
    storeNameElement.textContent = playerName;
    storeScoreElement.textContent = scores[snakeId];
    
    // ç”Ÿæˆå•†åº—é¡¹ç›®åˆ—è¡¨
    storeItemsElement.innerHTML = '';
    
    storeItems.forEach((item, index) => {
        const itemElement = document.createElement('div');
        itemElement.className = `store-item ${index === storeSelectedItem[snakeId] ? 'selected' : ''}`;
        itemElement.dataset.index = index;
        
        // æ£€æŸ¥æ˜¯å¦å·²è´­ä¹°å¹¶è¾¾åˆ°æœ€å¤§ç­‰çº§
        let isMaxLevel = false;
        let canAfford = scores[snakeId] >= item.price;
        let upgradeLevel = 0; // åœ¨è¿™é‡Œå®šä¹‰upgradeLevelå˜é‡
        
        if (item.type === 'upgrade') {
            upgradeLevel = playerUpgrades[snakeId][item.id.split('_')[0]] || 0;
            isMaxLevel = item.maxLevel && upgradeLevel >= item.maxLevel;
            canAfford = canAfford && !isMaxLevel;
        } else if (item.id === 'shield') {
            // æŠ¤ç›¾ï¼šå¦‚æœå·²ç»æœ‰æŠ¤ç›¾ï¼Œä¸èƒ½è´­ä¹°
            isMaxLevel = shields[snakeId].active && shields[snakeId].health > 0;
            canAfford = canAfford && !isMaxLevel;
        } else if (item.id === 'random_balls') {
            // éšæœºçƒç¤¼åŒ…ï¼šå¯ä»¥é‡å¤è´­ä¹°
            canAfford = canAfford;
        }
        
        // é¡¹ç›®å†…å®¹ - ç°åœ¨upgradeLevelåœ¨ä½œç”¨åŸŸå†…
        itemElement.innerHTML = `
            <div class="store-item-icon" style="background: ${item.color};">
                ${item.icon}
            </div>
            <div class="store-item-info">
                <div class="store-item-name">
                    ${item.name}
                    ${isMaxLevel ? '<span style="color:#4CAF50;">(å·²æ‹¥æœ‰)</span>' : ''}
                </div>
                <div class="store-item-desc">${item.description}</div>
                <div class="store-item-price">
                    <i class="fas fa-coins"></i> ${item.price}åˆ†
                    ${item.type === 'upgrade' ? 
                        `<span style="margin-left:10px;color:#aaa;">ç­‰çº§: ${upgradeLevel}/${item.maxLevel}</span>` : 
                        ''}
                </div>
            </div>
        `;
        
        // ç‚¹å‡»äº‹ä»¶
        itemElement.addEventListener('click', () => {
            if (!isMaxLevel) {
                storeSelectedItem[snakeId] = index;
                updateStoreDisplay(snakeId);
            }
        });
        
        storeItemsElement.appendChild(itemElement);
    });
    
    // æ›´æ–°è´­ä¹°æŒ‰é’®çŠ¶æ€
    const selectedItem = storeItems[storeSelectedItem[snakeId]];
    
    // é‡æ–°è®¡ç®—é€‰æ‹©é¡¹çš„çŠ¶æ€
    let selectedIsMaxLevel = false;
    let selectedUpgradeLevel = 0; // ä¸ºé€‰ä¸­é¡¹å®šä¹‰å˜é‡
    
    if (selectedItem.type === 'upgrade') {
        selectedUpgradeLevel = playerUpgrades[snakeId][selectedItem.id.split('_')[0]] || 0;
        selectedIsMaxLevel = selectedItem.maxLevel && selectedUpgradeLevel >= selectedItem.maxLevel;
    } else if (selectedItem.id === 'shield') {
        selectedIsMaxLevel = shields[snakeId].active && shields[snakeId].health > 0;
    }
    
    const selectedCanAfford = scores[snakeId] >= selectedItem.price && !selectedIsMaxLevel;
    
    storeBuyBtn.disabled = !selectedCanAfford;
    if (selectedIsMaxLevel) {
        if (selectedItem.id === 'shield') {
            storeBuyBtn.textContent = 'å·²æœ‰æŠ¤ç›¾';
        } else if (selectedItem.id === 'random_balls') {
            storeBuyBtn.textContent = 'å¯è´­ä¹°';
        } else {
            storeBuyBtn.textContent = 'å·²æ»¡çº§';
        }
    } else {
        storeBuyBtn.textContent = selectedCanAfford ? 'è´­ä¹°' : 'åˆ†æ•°ä¸è¶³';
    }
}

// è´­ä¹°å•†åº—ç‰©å“
function buyStoreItem(snakeId) {
    if (!storeOpen[snakeId]) return;
    
    const selectedIndex = storeSelectedItem[snakeId];
    const item = storeItems[selectedIndex];
    const playerName = snakeId === 'snake1' ? 
        localStorage.getItem('username') || 'ç©å®¶1' : 
        localStorage.getItem('player2_username') || 'ç©å®¶2';
    
    // æ£€æŸ¥æ˜¯å¦å·²æ»¡çº§
    const upgradeLevel = playerUpgrades[snakeId][item.id.split('_')[0]] || 0;
    if (item.type === 'upgrade' && item.maxLevel && upgradeLevel >= item.maxLevel) {
        showNotice('å·²ç»è¾¾åˆ°æœ€å¤§ç­‰çº§!', '#FF0000', 
                  snakes[snakeId][0].x, snakes[snakeId][0].y);
        return;
    }
    
    // æ£€æŸ¥åˆ†æ•°æ˜¯å¦è¶³å¤Ÿ
    if (scores[snakeId] < item.price) {
        showNotice('åˆ†æ•°ä¸è¶³!', '#FF0000', 
                  snakes[snakeId][0].x, snakes[snakeId][0].y);
        return;
    }
    
    // æ‰£é™¤åˆ†æ•°
    scores[snakeId] -= item.price;
    updateScoreDisplay();
    
    // åº”ç”¨ç‰©å“æ•ˆæœ
    applyStoreItemEffect(snakeId, item);
    
    // æ˜¾ç¤ºè´­ä¹°æˆåŠŸæç¤º
    showNotice(`è´­ä¹°æˆåŠŸ! -${item.price}åˆ†`, '#4CAF50', 
              snakes[snakeId][0].x, snakes[snakeId][0].y);
    
    // æ’­æ”¾è´­ä¹°ç‰¹æ•ˆ
    createParticles(snakes[snakeId][0].x + 10, snakes[snakeId][0].y + 10, 20, '#FFD700');
    
    // æ›´æ–°å•†åº—æ˜¾ç¤º
    updateStoreDisplay(snakeId);
}

// åº”ç”¨å•†åº—ç‰©å“æ•ˆæœ
// ä¿®æ”¹applyStoreItemEffectå‡½æ•°ï¼Œæ·»åŠ æŠ¤ç›¾æ•ˆæœ
function applyStoreItemEffect(snakeId, item) {
    const head = snakes[snakeId][0];
    
    switch(item.id) {
        case 'shield':
            // æ¿€æ´»æŠ¤ç›¾
            if (!shields[snakeId].active) {
                shields[snakeId].active = true;
                shields[snakeId].health = shields[snakeId].maxHealth;
                
                // æ›´æ–°æŠ¤ç›¾æ˜¾ç¤º
                updateShieldDisplay(snakeId);
                
                // æ˜¾ç¤ºæŠ¤ç›¾æ¿€æ´»ç‰¹æ•ˆ
                showNotice('æŠ¤ç›¾å·²æ¿€æ´»!', '#00BCD4', head.x, head.y);
                createParticles(head.x + 10, head.y + 10, 30, '#00BCD4');
                
                // åˆ›å»ºæŠ¤ç›¾ç¯ç»•ç‰¹æ•ˆ
                createShieldEffect(snakeId);
            }
            break;
            
        case 'random_balls':
            // ç»™äºˆ3ä¸ªéšæœºé­”æ³•çƒ
            for (let i = 0; i < 3; i++) {
                if (ballStorage[snakeId].length < 5) {
                    const ballTypes = ['attack', 'health', 'immunity', 'reverse', 'bomb'];
                    const randomType = ballTypes[Math.floor(Math.random() * ballTypes.length)];
                    ballStorage[snakeId].push({type: randomType});
                    
                    // æ˜¾ç¤ºè·å¾—æç¤º
                    showNotice(`è·å¾—${getBallName(randomType)}!`, getBallColor(randomType), 
                              head.x, head.y - i * 20);
                }
            }
            updateStorageDisplay();
            break;
            
        case 'speed_upgrade':
            // å¢åŠ é€Ÿåº¦
            playerUpgrades[snakeId].speed++;
            speedBoosts[snakeId] += 0.15; // å¢åŠ 15%é€Ÿåº¦
            showNotice('é€Ÿåº¦å¢åŠ 15%!', '#FFD700', head.x, head.y);
            break;
            
        case 'tough_upgrade':
            // å¢åŠ ç”Ÿå‘½å€¼ä¸Šé™
            playerUpgrades[snakeId].tough++;
            const maxHealthIncrease = 2;
            
            // æ›´æ–°æœ€å¤§ç”Ÿå‘½å€¼
            if (snakeId === 'snake1') {
                health.snake1 += maxHealthIncrease;
            } else {
                health.snake2 += maxHealthIncrease;
            }
            
            showNotice(`ç”Ÿå‘½å€¼ä¸Šé™+${maxHealthIncrease}!`, '#C0C0C0', head.x, head.y);
            updateHealthBars();
            break;
            
        case 'magic_upgrade':
            // å»¶é•¿ç‰¹æ®Šæ•ˆæœæ—¶é—´
            playerUpgrades[snakeId].magic++;
            showNotice('é­”æ³•æ•ˆæœæ—¶é—´å»¶é•¿20%!', '#2196F3', head.x, head.y);
            break;
    }
}

// è·å–çƒä½“åç§°
function getBallName(ballType) {
    const names = {
        'attack': 'æ”»å‡»çƒ',
        'health': 'è¡€çƒ',
        'immunity': 'æ— æ•Œçƒ',
        'reverse': 'åè½¬çƒ',
        'bomb': 'ç‚¸å¼¹çƒ'
    };
    return names[ballType] || 'é­”æ³•çƒ';
}

// è·å–çƒä½“é¢œè‰²
function getBallColor(ballType) {
    const colors = {
        'attack': '#00BFFF',
        'health': '#FF0000',
        'immunity': '#FFFF00',
        'reverse': '#800080',
        'bomb': '#FF4500'
    };
    return colors[ballType] || '#FFFFFF';
}
document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('store-player1-buy').addEventListener('click', () => {
        if (storeOpen.snake1) {
            buyStoreItem('snake1');
        }
    });
    
    document.getElementById('store-player2-buy').addEventListener('click', () => {
        if (storeOpen.snake2) {
            buyStoreItem('snake2');
        }
    });
    

});
</script>
</body>
</html>