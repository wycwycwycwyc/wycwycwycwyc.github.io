<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/css/styles_button.css">
    <link rel="stylesheet" href="/css/styles3_animation.css">
    <link rel="stylesheet" href="/css/styles4_eyeCare.js.css">
    <link rel="stylesheet" href="/css/styles5_brightness.css">
    <link rel="stylesheet" href="/css/styles6_glow.css">
    <script src="/js/script3_darkMode.js"></script>
    <script src="/js/script4_goBackOrHome.js"></script>
    <script src="/js/script5_setAnimations.js"></script>
    <script src="/js/script6_setFontSize.js"></script>
    <script src="/js/script7_setOpacityandBlur.js"></script>
    <script src="/js/script8_setEyeCare.js"></script>
    <script src="/js/script9_setbrightness.js"></script>
    <script src="/js/script10_setGlow.js"></script>
    <script src="/js/script11_setHighlight.js"></script>
    <script src="/js/script13_checkIslogin.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>
    <link href="/css/message.min.css" rel="stylesheet" />
    <script src="/js/message.min.js"></script>
    <title>多功能计算器</title>
<button class="custom-button" style="position: fixed; top: 10px; left: 10px;" onclick="goBackOrHome()">返回</button>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --text-color: #333;
            --panel-color: #fff;
            --button-color: #e0e0e0;
            --button-hover: #d0d0d0;
            --button-active: #bdbdbd;
            --operator-color: #ff9800;
            --operator-hover: #fb8c00;
            --operator-active: #f57c00;
            --special-color: #9e9e9e;
            --special-hover: #757575;
            --special-active: #616161;
            --border-color: #ddd;
            --graph-bg: #fff;
            --graph-line: #e0e0e0;
            --graph-curve: #ff5722;
        }

        .dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --panel-color: #1e1e1e;
            --button-color: #424242;
            --button-hover: #616161;
            --button-active: #757575;
            --operator-color: #ff9800;
            --operator-hover: #fb8c00;
            --operator-active: #f57c00;
            --special-color: #616161;
            --special-hover: #757575;
            --special-active: #9e9e9e;
            --border-color: #333;
            --graph-bg: #1e1e1e;
            --graph-line: #424242;
            --graph-curve: #ff7043;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s, transform 0.2s, box-shadow 0.2s;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .calculator-container {
            width: 100%;
            max-width: 900px;
            background-color: var(--panel-color);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            animation: fadeInUp 0.6s cubic-bezier(0.22, 1, 0.36, 1);
            transform-origin: center bottom;
        }

        @keyframes fadeInUp {
            0% { 
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            100% { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .tabs {
            display: flex;
            background-color: var(--button-color);
        }

        .tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        .tab:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 4px;
            background-color: var(--operator-color);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .tab:hover:after {
            left: 0;
            width: 100%;
        }

        .tab.active {
            background-color: var(--panel-color);
            transform: translateY(-2px);
        }

        .tab.active:after {
            left: 0;
            width: 100%;
        }

        .tab-content {
            display: none;
            padding: 20px;
            animation: slideInFade 0.5s cubic-bezier(0.22, 1, 0.36, 1);
        }

        @keyframes slideInFade {
            0% { 
                opacity: 0;
                transform: translateY(20px);
            }
            100% { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content.active {
            display: block;
        }

        /* 普通计算器样式 */
        .basic-calculator {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .display {
            grid-column: span 4;
            background-color: var(--panel-color);
            padding: 20px;
            text-align: right;
            font-size: 2.5rem;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 12px;
            height: 90px;
            overflow: hidden;
            position: relative;
        }

        .display-history {
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 1rem;
            opacity: 0.7;
        }

        .btn {
            padding: 24px 10px;
            font-size: 1.3rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            background-color: var(--button-color);
            color: var(--text-color);
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 4px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 1px rgba(255, 255, 255, 0.2),
                inset 0 -3px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            filter: brightness(1.1);
            box-shadow: 
                0 6px 12px rgba(0, 0, 0, 0.15),
                inset 0 1px 1px rgba(255, 255, 255, 0.2),
                inset 0 -3px 3px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(1px) scale(0.98);
            box-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.1),
                inset 0 1px 1px rgba(255, 255, 255, 0.1),
                inset 0 -1px 1px rgba(0, 0, 0, 0.1);
        }

        .operator {
            background-color: var(--operator-color);
            color: white;
            box-shadow: 
                0 4px 10px rgba(255, 152, 0, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.3),
                inset 0 -3px 3px rgba(0, 0, 0, 0.2);
        }

        .operator:hover {
            box-shadow: 
                0 6px 14px rgba(255, 152, 0, 0.4),
                inset 0 1px 1px rgba(255, 255, 255, 0.3),
                inset 0 -3px 3px rgba(0, 0, 0, 0.2);
        }

        .operator:active {
            box-shadow: 
                0 2px 6px rgba(255, 152, 0, 0.2),
                inset 0 1px 1px rgba(255, 255, 255, 0.2),
                inset 0 -1px 1px rgba(0, 0, 0, 0.2);
        }

        .special {
            background-color: var(--special-color);
            color: white;
            box-shadow: 
                0 4px 10px rgba(158, 158, 158, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.2),
                inset 0 -3px 3px rgba(0, 0, 0, 0.2);
        }

        .special:hover {
            box-shadow: 
                0 6px 14px rgba(158, 158, 158, 0.4),
                inset 0 1px 1px rgba(255, 255, 255, 0.2),
                inset 0 -3px 3px rgba(0, 0, 0, 0.2);
        }

        .special:active {
            box-shadow: 
                0 2px 6px rgba(158, 158, 158, 0.2),
                inset 0 1px 1px rgba(255, 255, 255, 0.1),
                inset 0 -1px 1px rgba(0, 0, 0, 0.2);
        }

        .span-2 {
            grid-column: span 2;
        }

        /* 科学计算器样式 */
        .scientific-calculator {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }

        .scientific-display {
            grid-column: span 5;
        }

        /* 函数绘图样式 */
        .graphing-calculator {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .graph-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .graph-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .graph-input input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--panel-color);
            color: var(--text-color);
            height: 42px;
            font-size: 0.95rem;
        }

        .graph-input button {
            padding: 10px 16px;
            background-color: var(--operator-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            height: 42px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .graph-input button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .graph-input button:active {
            transform: translateY(0);
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
        }

        .range-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .range-inputs input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--panel-color);
            color: var(--text-color);
            font-size: 0.9rem;
            height: 42px;
        }

        .graph-container {
            height: 400px;
            background-color: var(--graph-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        .function-list {
            margin-top: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .function-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .function-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .dark-mode .function-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .function-item button {
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .function-item button:hover {
            background-color: #e53935;
            transform: translateY(-1px);
        }

        .function-item button:active {
            transform: translateY(0);
        }

        @media (max-width: 768px) {
            .calculator-container {
                max-width: 100%;
            }
            
            .basic-calculator,
            .scientific-calculator {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .scientific-display {
                grid-column: span 4;
            }
            
            .btn {
                padding: 20px 8px;
                font-size: 1.1rem;
            }
            
            .graph-controls {
                grid-template-columns: 1fr;
            }
            
            .range-inputs {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .btn {
                padding: 18px 6px;
                font-size: 1rem;
            }
            
            .range-inputs {
                grid-template-columns: 1fr;
            }
        }
            /* 科学计算器容器 - 固定5行布局 */
    .scientific-calculator {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        grid-template-rows: repeat(5, 1fr);
        gap: 8px;
        aspect-ratio: 5/5; /* 保持正方形布局 */
    }

    /* 移动端适配 */
    @media (max-width: 768px) {
        .calculator-container {
            max-width: 100%;
            padding: 10px;
        }
        
        /* 科学计算器按钮调整 */
        .scientific-calculator {
            gap: 6px;
        }
        
        .scientific-calculator .btn {
            padding: 12px 4px;
            font-size: 0.85rem;
            min-height: 0; /* 允许按钮根据内容收缩 */
            line-height: 1.2;
        }
        
        /* 特殊按钮调整 */
        .scientific-calculator .operator,
        .scientific-calculator .special {
            font-size: 0.8rem;
            padding: 10px 2px;
        }
        
        /* 显示区域调整 */
        .scientific-display {
            grid-column: span 5;
            font-size: 1.8rem;
            padding: 12px;
            height: 70px;
        }
    }

    @media (max-width: 480px) {
        /* 更小屏幕的微调 */
        .scientific-calculator .btn {
            padding: 10px 2px;
            font-size: 0.75rem;
        }
        
        .scientific-calculator .operator,
        .scientific-calculator .special {
            font-size: 0.7rem;
        }
        
        /* 长文本按钮调整 */
        .scientific-calculator .btn[onclick*="pow("],
        .scientific-calculator .btn[onclick*="sqrt("] {
            font-size: 0.65rem;
        }
    }

    /* 极小屏幕特殊处理 */
    @media (max-width: 360px) {
        .scientific-calculator {
            gap: 4px;
        }
        
        .scientific-calculator .btn {
            padding: 8px 1px;
            font-size: 0.7rem;
        }
        
        /* 隐藏部分按钮文本 */
        .scientific-calculator .btn[onclick*="pow("]::after {
            content: "x^y";
            font-size: 0.6rem;
        }
        .scientific-calculator .btn[onclick*="pow("] span {
            display: none;
        }
    }
    </style>
</head>
<body>

    <div class="calculator-container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('basic')">普通计算</div>
            <div class="tab" onclick="switchTab('scientific')">科学运算</div>
            <div class="tab" onclick="switchTab('graphing')">函数画图</div>
        </div>
        
        <!-- 普通计算器 -->
        <div id="basic" class="tab-content active">
            <div class="basic-calculator">
                <div class="display">
                    <div class="display-history" id="basic-history"></div>
                    <div id="basic-display">0</div>
                </div>
                <button class="special" onclick="clearDisplay('basic')">AC</button>
                <button class="special" onclick="toggleSign('basic')">+/-</button>
                <button class="special" onclick="percentage('basic')">%</button>
                <button class="operator" onclick="appendOperator('basic', '/')">/</button>
                
                <button onclick="appendNumber('basic', '7')">7</button>
                <button onclick="appendNumber('basic', '8')">8</button>
                <button onclick="appendNumber('basic', '9')">9</button>
                <button class="operator" onclick="appendOperator('basic', '*')">×</button>
                
                <button onclick="appendNumber('basic', '4')">4</button>
                <button onclick="appendNumber('basic', '5')">5</button>
                <button onclick="appendNumber('basic', '6')">6</button>
                <button class="operator" onclick="appendOperator('basic', '-')">-</button>
                
                <button onclick="appendNumber('basic', '1')">1</button>
                <button onclick="appendNumber('basic', '2')">2</button>
                <button onclick="appendNumber('basic', '3')">3</button>
                <button class="operator" onclick="appendOperator('basic', '+')">+</button>
                
                <button class="span-2" onclick="appendNumber('basic', '0')">0</button>
                <button onclick="appendDecimal('basic')">.</button>
                <button class="operator" onclick="calculate('basic')">=</button>
            </div>
        </div>
        
        <!-- 科学计算器 -->
        <div id="scientific" class="tab-content">
            <div class="scientific-calculator">
                <div class="display scientific-display">
                    <div class="display-history" id="scientific-history"></div>
                    <div id="scientific-display">0</div>
                </div>
                
                <button class="special" onclick="clearDisplay('scientific')">AC</button>
                <button class="special" onclick="toggleSign('scientific')">+/-</button>
                <button class="special" onclick="percentage('scientific')">%</button>
                <button class="operator" onclick="appendOperator('scientific', '/')">/</button>
                <button class="special" onclick="factorial('scientific')">x!</button>
                
                <button onclick="scientificFunction('scientific', 'sin(')">sin</button>
                <button onclick="appendNumber('scientific', '7')">7</button>
                <button onclick="appendNumber('scientific', '8')">8</button>
                <button onclick="appendNumber('scientific', '9')">9</button>
                <button class="operator" onclick="appendOperator('scientific', '*')">×</button>
                
                <button onclick="scientificFunction('scientific', 'cos(')">cos</button>
                <button onclick="appendNumber('scientific', '4')">4</button>
                <button onclick="appendNumber('scientific', '5')">5</button>
                <button onclick="appendNumber('scientific', '6')">6</button>
                <button class="operator" onclick="appendOperator('scientific', '-')">-</button>
                
                <button onclick="scientificFunction('scientific', 'tan(')">tan</button>
                <button onclick="appendNumber('scientific', '1')">1</button>
                <button onclick="appendNumber('scientific', '2')">2</button>
                <button onclick="appendNumber('scientific', '3')">3</button>
                <button class="operator" onclick="appendOperator('scientific', '+')">+</button>
                
                <button onclick="scientificFunction('scientific', 'log(')">log</button>
                <button onclick="scientificFunction('scientific', 'ln(')">ln</button>
                <button class="span-2" onclick="appendNumber('scientific', '0')">0</button>
                <button class="operator" onclick="calculate('scientific')">=</button>
                
                <button onclick="scientificFunction('scientific', 'sqrt(')">√</button>
                <button onclick="scientificFunction('scientific', 'pow(')">x^y</button>
                <button onclick="appendDecimal('scientific')">.</button>
                <button onclick="scientificFunction('scientific', 'pi')">π</button>
                <button onclick="scientificFunction('scientific', 'e')">e</button>
                
                <button onclick="scientificFunction('scientific', '(')">(</button>
                <button onclick="scientificFunction('scientific', ')')">)</button>
                <button onclick="backspace('scientific')">⌫</button>
                <button onclick="scientificFunction('scientific', '^2')">x²</button>
                <button onclick="scientificFunction('scientific', '^3')">x³</button>
            </div>
        </div>
        
        <!-- 函数画图 -->
        <div id="graphing" class="tab-content">
            <div class="graphing-calculator">
                <div class="graph-controls">
                    <div class="graph-input">
                        <input type="text" id="function-input" placeholder="输入函数，如 sin(x) + x^2">
                        <button onclick="addFunction()">添加函数</button>
                    </div>
                    <div class="range-inputs">
                        <input type="number" id="x-min" placeholder="x最小值" value="-10">
                        <input type="number" id="x-max" placeholder="x最大值" value="10">
                        <input type="number" id="y-min" placeholder="y最小值" value="-10">
                        <input type="number" id="y-max" placeholder="y最大值" value="10">
                    </div>
                </div>
                
                <div class="graph-container">
                    <canvas id="graph-canvas"></canvas>
                </div>
                
                <div class="function-list" id="function-list">
                    <!-- 函数列表将在这里动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentMode = 'basic';
        let basicValue = '0';
        let basicHistory = '';
        let scientificValue = '0';
        let scientificHistory = '';
        
        let functions = [];
        let graph = null;
        
        // 切换标签页
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            currentMode = tabId;
            
            // 初始化图表
            if (tabId === 'graphing' && !graph) {
                initGraph();
            }
        }
        
        // 普通计算器功能
        function appendNumber(mode, num) {
            const display = document.getElementById(`${mode}-display`);
            let currentValue = mode === 'basic' ? basicValue : scientificValue;
            
            if (currentValue === '0' && num !== '.') {
                currentValue = num;
            } else {
                currentValue += num;
            }
            
            updateDisplay(mode, currentValue);
        }
        
        function appendDecimal(mode) {
            const display = document.getElementById(`${mode}-display`);
            let currentValue = mode === 'basic' ? basicValue : scientificValue;
            
            // 防止重复添加小数点
            if (!currentValue.includes('.')) {
                currentValue += '.';
                updateDisplay(mode, currentValue);
            }
        }
        
        function appendOperator(mode, operator) {
            const display = document.getElementById(`${mode}-display`);
            let currentValue = mode === 'basic' ? basicValue : scientificValue;
            let history = mode === 'basic' ? basicHistory : scientificHistory;
            
            // 如果当前值是0且历史记录为空，则不添加操作符
            if (currentValue === '0' && history === '') {
                return;
            }
            
            // 如果历史记录不为空且当前值不为空，则先计算结果
            if (history !== '' && currentValue !== '0') {
                calculate(mode);
                currentValue = mode === 'basic' ? basicValue : scientificValue;
            }
            
            history = currentValue + ' ' + operator + ' ';
            currentValue = '0';
            
            if (mode === 'basic') {
                basicHistory = history;
            } else {
                scientificHistory = history;
            }
            
            updateDisplay(mode, currentValue, history);
        }
        
        function clearDisplay(mode) {
            if (mode === 'basic') {
                basicValue = '0';
                basicHistory = '';
            } else {
                scientificValue = '0';
                scientificHistory = '';
            }
            updateDisplay(mode, '0', '');
        }
        
        function toggleSign(mode) {
            let currentValue = mode === 'basic' ? basicValue : scientificValue;
            
            if (currentValue !== '0') {
                if (currentValue.startsWith('-')) {
                    currentValue = currentValue.substring(1);
                } else {
                    currentValue = '-' + currentValue;
                }
            }
            
            updateDisplay(mode, currentValue);
        }
        
        function percentage(mode) {
            let currentValue = mode === 'basic' ? basicValue : scientificValue;
            
            currentValue = (parseFloat(currentValue) / 100).toString();
            updateDisplay(mode, currentValue);
        }
        
        function backspace(mode) {
            let currentValue = mode === 'basic' ? basicValue : scientificValue;
            
            if (currentValue.length === 1 || (currentValue.length === 2 && currentValue.startsWith('-'))) {
                currentValue = '0';
            } else {
                currentValue = currentValue.slice(0, -1);
            }
            
            updateDisplay(mode, currentValue);
        }
        
        function calculate(mode) {
            let currentValue = mode === 'basic' ? basicValue : scientificValue;
            let history = mode === 'basic' ? basicHistory : scientificHistory;
            
            if (history === '') {
                return;
            }
            
            // 替换显示的操作符为JavaScript可识别的操作符
            let expression = history.replace('×', '*') + currentValue;
            
            try {
                currentValue = eval(expression).toString();
                history = '';
            } catch (e) {
                currentValue = 'Error';
                history = '';
            }
            
            updateDisplay(mode, currentValue, history);
        }
        
        function updateDisplay(mode, value, history = null) {
            const display = document.getElementById(`${mode}-display`);
            const historyDisplay = document.getElementById(`${mode}-history`);
            
            if (mode === 'basic') {
                basicValue = value;
                if (history !== null) basicHistory = history;
            } else {
                scientificValue = value;
                if (history !== null) scientificHistory = history;
            }
            
            display.textContent = value;
            historyDisplay.textContent = history || '';
            
            // 添加动画效果
            display.style.transform = 'scale(1.05)';
            setTimeout(() => {
                display.style.transform = 'scale(1)';
            }, 100);
        }
        
        // 科学计算器功能
        function scientificFunction(mode, func) {
            let currentValue = mode === 'basic' ? basicValue : scientificValue;
            
            switch (func) {
                case 'sin(':
                case 'cos(':
                case 'tan(':
                case 'log(':
                case 'ln(':
                case 'sqrt(':
                case 'pow(':
                    currentValue = func;
                    break;
                case 'pi':
                    currentValue = Math.PI.toString();
                    break;
                case 'e':
                    currentValue = Math.E.toString();
                    break;
                case '^2':
                    currentValue = `Math.pow(${currentValue}, 2)`;
                    evaluateScientific(mode);
                    return;
                case '^3':
                    currentValue = `Math.pow(${currentValue}, 3)`;
                    evaluateScientific(mode);
                    return;
                case '(':
                case ')':
                    currentValue += func;
                    break;
                default:
                    break;
            }
            
            updateDisplay(mode, currentValue);
        }
        
        function factorial(mode) {
            let currentValue = mode === 'basic' ? basicValue : scientificValue;
            let num = parseInt(currentValue);
            
            if (num < 0) {
                currentValue = 'Error';
            } else if (num === 0 || num === 1) {
                currentValue = '1';
            } else {
                let result = 1;
                for (let i = 2; i <= num; i++) {
                    result *= i;
                }
                currentValue = result.toString();
            }
            
            updateDisplay(mode, currentValue);
        }
        
        function evaluateScientific(mode) {
            let currentValue = mode === 'basic' ? basicValue : scientificValue;
            
            try {
                // 替换数学函数为JavaScript可识别的函数
                let expression = currentValue
                    .replace(/sin\(/g, 'Math.sin(')
                    .replace(/cos\(/g, 'Math.cos(')
                    .replace(/tan\(/g, 'Math.tan(')
                    .replace(/log\(/g, 'Math.log10(')
                    .replace(/ln\(/g, 'Math.log(')
                    .replace(/sqrt\(/g, 'Math.sqrt(')
                    .replace(/\^/g, '**')
                    .replace(/pow\(/g, 'Math.pow(');
                
                currentValue = eval(expression).toString();
            } catch (e) {
                currentValue = 'Error';
            }
            
            updateDisplay(mode, currentValue);
        }
        
        // 函数画图功能
        function initGraph() {
            const canvas = document.getElementById('graph-canvas');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            graph = {
                canvas: canvas,
                ctx: canvas.getContext('2d'),
                xMin: -10,
                xMax: 10,
                yMin: -10,
                yMax: 10,
                functions: []
            };
            
            drawGraph();
        }
        
        function addFunction() {
            const input = document.getElementById('function-input');
            const funcText = input.value.trim();
            
            if (funcText === '') return;
            
            // 生成随机颜色
            const hue = Math.floor(Math.random() * 360);
            const color = `hsl(${hue}, 80%, 60%)`;
            
            const newFunc = {
                text: funcText,
                color: color,
                id: Date.now()
            };
            
            functions.push(newFunc);
            input.value = '';
            
            updateFunctionList();
            drawGraph();
        }
        
        function removeFunction(id) {
            functions = functions.filter(func => func.id !== id);
            updateFunctionList();
            drawGraph();
        }
        
        function updateFunctionList() {
            const list = document.getElementById('function-list');
            list.innerHTML = '';
            
            functions.forEach(func => {
                const item = document.createElement('div');
                item.className = 'function-item';
                item.innerHTML = `
                    <span style="color: ${func.color}">${func.text}</span>
                    <button onclick="removeFunction(${func.id})">删除</button>
                `;
                list.appendChild(item);
            });
        }
        
        function updateGraph() {
            const xMin = parseFloat(document.getElementById('x-min').value);
            const xMax = parseFloat(document.getElementById('x-max').value);
            const yMin = parseFloat(document.getElementById('y-min').value);
            const yMax = parseFloat(document.getElementById('y-max').value);
            
            if (isNaN(xMin) || isNaN(xMax) || isNaN(yMin) || isNaN(yMax)) {
                alert('请输入有效的范围值');
                return;
            }
            
            graph.xMin = xMin;
            graph.xMax = xMax;
            graph.yMin = yMin;
            graph.yMax = yMax;
            
            drawGraph();
        }
        
        function drawGraph() {
            if (!graph) return;
            
            const { canvas, ctx, xMin, xMax, yMin, yMax } = graph;
            const width = canvas.width;
            const height = canvas.height;
            
            // 清除画布
            ctx.clearRect(0, 0, width, height);
            
            // 设置背景
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--graph-bg');
            ctx.fillRect(0, 0, width, height);
            
            // 绘制网格线
            drawGrid();
            
            // 绘制坐标轴
            drawAxes();
            
            // 绘制所有函数
            functions.forEach(func => {
                drawFunction(func.text, func.color);
            });
        }
        
        function drawGrid() {
            const { ctx, xMin, xMax, yMin, yMax } = graph;
            const width = graph.canvas.width;
            const height = graph.canvas.height;
            
            ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--graph-line');
            ctx.lineWidth = 1;
            
            // 绘制垂直线
            const xStep = getStepSize(xMax - xMin);
            for (let x = Math.ceil(xMin / xStep) * xStep; x <= xMax; x += xStep) {
                if (Math.abs(x) < 0.0001) continue; // 跳过y轴
                
                const screenX = ((x - xMin) / (xMax - xMin)) * width;
                ctx.beginPath();
                ctx.moveTo(screenX, 0);
                ctx.lineTo(screenX, height);
                ctx.stroke();
                
                // 绘制刻度标签
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(x.toFixed(1), screenX, height - 5);
            }
            
            // 绘制水平线
            const yStep = getStepSize(yMax - yMin);
            for (let y = Math.ceil(yMin / yStep) * yStep; y <= yMax; y += yStep) {
                if (Math.abs(y) < 0.0001) continue; // 跳过x轴
                
                const screenY = height - ((y - yMin) / (yMax - yMin)) * height;
                ctx.beginPath();
                ctx.moveTo(0, screenY);
                ctx.lineTo(width, screenY);
                ctx.stroke();
                
                // 绘制刻度标签
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
                ctx.font = '10px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(y.toFixed(1), 5, screenY + 3);
            }
        }
        
        function drawAxes() {
            const { ctx, xMin, xMax, yMin, yMax } = graph;
            const width = graph.canvas.width;
            const height = graph.canvas.height;
            
            ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
            ctx.lineWidth = 2;
            
            // 绘制x轴
            const xAxisY = height - ((0 - yMin) / (yMax - yMin)) * height;
            if (xAxisY >= 0 && xAxisY <= height) {
                ctx.beginPath();
                ctx.moveTo(0, xAxisY);
                ctx.lineTo(width, xAxisY);
                ctx.stroke();
                
                // 绘制箭头
                ctx.beginPath();
                ctx.moveTo(width - 10, xAxisY - 5);
                ctx.lineTo(width, xAxisY);
                ctx.lineTo(width - 10, xAxisY + 5);
                ctx.stroke();
                
                // 绘制x轴标签
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText('x', width - 5, xAxisY - 10);
            }
            
            // 绘制y轴
            const yAxisX = ((0 - xMin) / (xMax - xMin)) * width;
            if (yAxisX >= 0 && yAxisX <= width) {
                ctx.beginPath();
                ctx.moveTo(yAxisX, 0);
                ctx.lineTo(yAxisX, height);
                ctx.stroke();
                
                // 绘制箭头
                ctx.beginPath();
                ctx.moveTo(yAxisX - 5, 10);
                ctx.lineTo(yAxisX, 0);
                ctx.lineTo(yAxisX + 5, 10);
                ctx.stroke();
                
                // 绘制y轴标签
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('y', yAxisX + 5, 15);
            }
            
            // 绘制原点标签
            if (xAxisY >= 0 && xAxisY <= height && yAxisX >= 0 && yAxisX <= width) {
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText('0', yAxisX - 5, xAxisY + 15);
            }
        }
        
        function drawFunction(funcText, color) {
            const { ctx, xMin, xMax, yMin, yMax } = graph;
            const width = graph.canvas.width;
            const height = graph.canvas.height;
            
            const step = (xMax - xMin) / width;
            const points = [];
            
            // 计算函数值
            for (let i = 0; i <= width; i++) {
                const x = xMin + (i / width) * (xMax - xMin);
                try {
                    // 替换数学函数和符号
                    const expr = funcText
                        .replace(/sin\(/g, 'Math.sin(')
                        .replace(/cos\(/g, 'Math.cos(')
                        .replace(/tan\(/g, 'Math.tan(')
                        .replace(/log\(/g, 'Math.log10(')
                        .replace(/ln\(/g, 'Math.log(')
                        .replace(/sqrt\(/g, 'Math.sqrt(')
                        .replace(/\^/g, '**')
                        .replace(/pow\(/g, 'Math.pow(')
                        .replace(/pi/g, 'Math.PI')
                        .replace(/e/g, 'Math.E');
                    
                    const y = eval(expr.replace(/x/g, `(${x})`));
                    
                    if (isFinite(y) && y >= yMin && y <= yMax) {
                        points.push({
                            x: i,
                            y: height - ((y - yMin) / (yMax - yMin)) * height
                        });
                    }
                } catch (e) {
                    console.error('Error evaluating function:', e);
                }
            }
            
            // 绘制函数曲线
            if (points.length > 0) {
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
                
                for (let i = 1; i < points.length; i++) {
                    ctx.lineTo(points[i].x, points[i].y);
                }
                
                ctx.stroke();
            }
        }
        
        function getStepSize(range) {
            const log10 = Math.log10(range);
            const power = Math.floor(log10);
            const fraction = log10 - power;
            
            let step;
            if (fraction < 0.15) {
                step = Math.pow(10, power) / 5;
            } else if (fraction < 0.5) {
                step = Math.pow(10, power) / 2;
            } else {
                step = Math.pow(10, power);
            }
            
            return step;
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 检查是否处于深色模式
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark-mode');
            }
            
            // 监听深色模式变化
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark-mode');
                } else {
                    document.documentElement.classList.remove('dark-mode');
                }
                
                if (currentMode === 'graphing') {
                    drawGraph();
                }
            });
            
            // 为范围输入框添加事件监听
            document.getElementById('x-min').addEventListener('change', updateGraph);
            document.getElementById('x-max').addEventListener('change', updateGraph);
            document.getElementById('y-min').addEventListener('change', updateGraph);
            document.getElementById('y-max').addEventListener('change', updateGraph);
        });
    </script>
</body>
</html>